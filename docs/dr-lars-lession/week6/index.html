<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Cardano2vn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Cardano2vn Blog Atom Feed"><title data-react-helmet="true">Week 06 - Oracles | Cardano2vn</title><meta data-react-helmet="true" property="og:url" content="https://cardano2vn.io/docs/dr-lars-lession/week6"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Week 06 - Oracles | Cardano2vn"><meta data-react-helmet="true" name="description" content="Ghi chÃº"><meta data-react-helmet="true" property="og:description" content="Ghi chÃº"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo/2.png"><link data-react-helmet="true" rel="canonical" href="https://cardano2vn.io/docs/dr-lars-lession/week6"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week6" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week6" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8b54419c.css">
<link rel="preload" href="/assets/js/runtime~main.af40557b.js" as="script">
<link rel="preload" href="/assets/js/main.97b62b7d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a><a class="navbar__item navbar__link" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><main class="docMainContainer_r8cw docMainContainerEnhanced_SOUu"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">Week 06 - Oracles</h1></header><div class="markdown"><p>Ghi chÃº</p><p>ÄÃ¢y lÃ  phiÃªn báº£n viáº¿t cá»§a <a href="https://www.youtube.com/watch?v=X9fOkkpj-aU" target="_blank" rel="noopener noreferrer">BÃ i giáº£ng sá»‘ 6</a>.</p><p>Trong bÃ i giáº£ng nÃ y, chÃºng ta há»c vá» oracles vÃ  sá»­ dá»¥ng PAB (Plutus Application Backend).</p><p>Nhá»¯ng ghi chÃº nÃ y sá»­ dá»¥ng Plutus cam káº¿t: 476409eaee94141e2fe076a7821fc2fcdec5dfcb</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="tá»•ng-quat"></a>Tá»•ng quat<a class="hash-link" href="#tá»•ng-quat" title="Direct link to heading">#</a></h2><p>Trong bÃ i giáº£ng nÃ y, chÃºng ta sáº½ xem xÃ©t má»™t nghiÃªn cá»©u Ä‘iá»ƒn hÃ¬nh, Ä‘á»ƒ xem lÃ m tháº¿ nÃ o nhá»¯ng gÃ¬ chÃºng ta Ä‘Ã£ há»c Ä‘Æ°á»£c cho Ä‘áº¿n nay cÃ³ thá»ƒ Ä‘Æ°á»£c biáº¿n thÃ nh má»™t á»©ng dá»¥ng thá»±c táº¿. Má»™t bá»™ sÆ°u táº­p cÃ¡c tá»‡p thá»±c thi tháº­m chÃ­ Ä‘i kÃ¨m vá»›i má»™t giao diá»‡n ngÆ°á»i dÃ¹ng nhá».</p><p>NÃ³ sáº½ lÃ  má»™t dApp thá»±c sá»±, ngoÃ i viá»‡c chÃºng ta chÆ°a cÃ³ sáºµn má»™t blockchain thá»±c sá»±. Äiá»u nÃ y sáº½ cháº¡y trÃªn má»™t chuá»—i khá»‘i mÃ´ phá»ng - má»™t chuá»—i mÃ´ hÃ¬nh.</p><p>VÃ­ dá»¥ chÃºng ta sáº½ sá»­ dá»¥ng cho viá»‡c nÃ y lÃ  triá»ƒn khai má»™t tiÃªn tri ráº¥t Ä‘Æ¡n giáº£n.</p><p>Ghi chÃº</p><p>Trong tháº¿ giá»›i blockchain, tiÃªn tri lÃ  má»™t cÃ¡ch Ä‘á»ƒ Ä‘Æ°a thÃ´ng tin tháº¿ giá»›i thá»±c vÃ o blockchain, Ä‘á»ƒ lÃ m cho nÃ³ cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c trong cÃ¡c há»£p Ä‘á»“ng thÃ´ng minh.</p><p>CÃ³ ráº¥t nhiá»u vÃ­ dá»¥ vá» cÃ¡c trÆ°á»ng há»£p sá»­ dá»¥ng cho oracles. ChÃºng ta cÃ³ thá»ƒ nghÄ© Ä‘áº¿n cÃ¡c nguá»“n dá»¯ liá»‡u bÃªn ngoÃ i nhÆ° dá»¯ liá»‡u thá»i tiáº¿t, káº¿t quáº£ báº§u cá»­, dá»¯ liá»‡u trao Ä‘á»•i chá»©ng khoÃ¡n hoáº·c sá»± ngáº«u nhiÃªn. VÃ­ dá»¥, báº¡n cÃ³ thá»ƒ cÃ³ má»™t há»£p Ä‘á»“ng cÃ¡ cÆ°á»£c phá»¥ thuá»™c vÃ o káº¿t quáº£ cá»§a má»™t trÃ² chÆ¡i thá»ƒ thao cá»¥ thá»ƒ.</p><p>CÃ³ nhiá»u cÃ¡ch khÃ¡c nhau Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cÃ¢u chuyá»‡n tháº§n thoáº¡i, vá»›i má»©c Ä‘á»™ phá»©c táº¡p khÃ¡c nhau.</p><p>ChÃºng tÃ´i sáº½ sá»­ dá»¥ng má»™t cÃ¡ch tiáº¿p cáº­n ráº¥t Ä‘Æ¡n giáº£n, nÆ¡i chÃºng tÃ´i cÃ³ má»™t nhÃ  cung cáº¥p dá»¯ liá»‡u Ä‘Ã¡ng tin cáº­y. VÃ , Ä‘á»ƒ lÃ m vÃ­ dá»¥ vá» dá»¯ liá»‡u, chÃºng tÃ´i sáº½ sá»­ dá»¥ng tá»· giÃ¡ há»‘i Ä‘oÃ¡i ADA / USD.</p><p>CÃ³ ráº¥t nhiá»u váº¥n Ä‘á» vá»›i cÃ¡ch tiáº¿p cáº­n nÃ y, vÃ¬ chÃºng ta pháº£i tin tÆ°á»Ÿng vÃ o nguá»“n dá»¯ liá»‡u. CÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ giáº£m thiá»ƒu rá»§i ro nguá»“n dá»¯ liá»‡u khÃ´ng Ä‘Ã¡ng tin cáº­y hoáº·c khÃ´ng Ä‘Ã¡ng tin cáº­y. VÃ­ dá»¥: chÃºng tÃ´i cÃ³ thá»ƒ yÃªu cáº§u nhÃ  cung cáº¥p Ä‘Æ°a ra má»™t sá»‘ tÃ i sáº£n tháº¿ cháº¥p bá»‹ máº¥t náº¿u dá»¯ liá»‡u khÃ´ng Ä‘Æ°á»£c cung cáº¥p hoáº·c khÃ´ng chÃ­nh xÃ¡c. Hoáº·c, báº¡n cÃ³ thá»ƒ káº¿t há»£p nhiá»u cÃ¢u tháº§n chÃº thÃ nh má»™t vÃ  chá»‰ cháº¥p nháº­n káº¿t quáº£ náº¿u táº¥t cáº£ chÃºng Ä‘á»u Ä‘á»“ng Ã½ hoáº·c láº¥y giÃ¡ trá»‹ trung bÃ¬nh hoáº·c giÃ¡ trá»‹ trung bÃ¬nh cá»§a cÃ¡c nguá»“n khÃ¡c nhau. Báº¡n cÅ©ng cÃ³ thá»ƒ nghÄ© ra cÃ¡c cÆ¡ cháº¿ phá»©c táº¡p hÆ¡n.</p><p>NhÆ° chÃºng ta Ä‘Ã£ biáº¿t, Ä‘á»‘i vá»›i báº¥t ká»³ Ä‘iá»u gÃ¬ xáº£y ra trÃªn blockchain, pháº£i cÃ³ UTxO, vÃ¬ váº­y Ä‘iá»u hiá»ƒn nhiÃªn cáº§n lÃ m lÃ  biá»ƒu thá»‹ nguá»“n cáº¥p dá»¯ liá»‡u dÆ°á»›i dáº¡ng UTxO. UTxO náº±m á»Ÿ Ä‘á»‹a chá»‰ táº­p lá»‡nh cá»§a oracle vÃ  trÆ°á»ng dá»¯ liá»‡u cá»§a nÃ³ mang giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a dá»¯ liá»‡u oracle.</p><p><img src="/assets/images/week06__00000-84dc8472c851f9d498e50158a6db82a3.png"></p><p>VÃ  Ä‘Ã¢y lÃ  nÆ¡i chÃºng tÃ´i tÃ¬m ra váº¥n Ä‘á» Ä‘áº§u tiÃªn cá»§a mÃ¬nh. NhÆ° chÃºng ta Ä‘Ã£ lÆ°u Ã½ trÆ°á»›c Ä‘Ã¢y, xÃ¡c thá»±c chá»‰ xáº£y ra khi báº¡n muá»‘n sá»­ dá»¥ng thá»© gÃ¬ Ä‘Ã³ tá»« Ä‘á»‹a chá»‰ táº­p lá»‡nh, chá»© khÃ´ng pháº£i khi báº¡n táº¡o Ä‘áº§u ra táº¡i Ä‘á»‹a chá»‰ táº­p lá»‡nh. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  chÃºng tÃ´i khÃ´ng thá»ƒ ngÄƒn cáº£n báº¥t ká»³ ai táº¡o ra káº¿t quáº£ Ä‘áº§u ra tÃ¹y Ã½ táº¡i Ä‘á»‹a chá»‰ táº­p lá»‡nh.</p><p><img src="/assets/images/week06__00001-ed7cda335f088c7048ac7c74b7c077a6.png"></p><p>Báº±ng cÃ¡ch nÃ o Ä‘Ã³, chÃºng ta cáº§n phÃ¢n biá»‡t Ä‘áº§u ra oracle thá»±c sá»± vá»›i cÃ¡c Ä‘áº§u ra khÃ¡c cÃ³ thá»ƒ á»Ÿ cÃ¹ng má»™t Ä‘á»‹a chá»‰ táº­p lá»‡nh. VÃ  cÃ¡ch chÃºng tÃ´i lÃ m Ä‘iá»u nÃ y lÃ  Ä‘áº·t má»™t NFT trÃªn Ä‘áº§u ra. VÃ¬ má»™t NFT chá»‰ cÃ³ thá»ƒ tá»“n táº¡i má»™t láº§n nÃªn chá»‰ cÃ³ thá»ƒ cÃ³ má»™t UTxO táº¡i Ä‘á»‹a chá»‰ táº­p lá»‡nh chá»©a NFT.</p><p><img src="/assets/images/week06__00002-44ef75fbc3b1e1a1a3e3419b14783066.png"></p><p>LÃ m tháº¿ nÃ o má»™t lá»i tiÃªn tri nhÆ° váº­y cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng?</p><p>á» Ä‘Ã¢y chÃºng ta Ä‘áº¿n vá»›i má»™t cÃ¡i gÃ¬ Ä‘Ã³ mÃ  chÃºng ta chÆ°a tá»«ng tháº¥y trÆ°á»›c Ä‘Ã¢y. Trong táº¥t cáº£ cÃ¡c há»£p Ä‘á»“ng vÃ  trÃ¬nh xÃ¡c thá»±c viáº¿t mÃ£ cá»§a chÃºng tÃ´i, chÃºng tÃ´i luÃ´n biáº¿t trÆ°á»›c toÃ n bá»™ API. Trong trÆ°á»ng há»£p cá»§a má»™t nhÃ  tiÃªn tri, Ä‘iá»u nÃ y lÃ  khÃ¡c nhau. Táº¡i thá»i Ä‘iá»ƒm mÃ  má»™t tiÃªn tri Ä‘Æ°á»£c táº¡o ra, báº¡n khÃ´ng biáº¿t má»i ngÆ°á»i cÃ³ thá»ƒ muá»‘n sá»­ dá»¥ng nÃ³ nhÆ° tháº¿ nÃ o. NÃ³ pháº£i giá»‘ng nhÆ° má»™t API má»Ÿ, cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng vá»›i cÃ¡c há»£p Ä‘á»“ng thÃ´ng minh chÆ°a Ä‘Æ°á»£c thiáº¿t káº¿.</p><p>VÃ­ dá»¥ vá» trÆ°á»ng há»£p sá»­ dá»¥ng cÃ³ thá»ƒ sá»­ dá»¥ng oracle cá»¥ thá»ƒ nÃ y, chÃºng ta hÃ£y xem xÃ©t má»™t há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i trong Ä‘Ã³, táº¡i Ä‘á»‹a chá»‰ hoÃ¡n Ä‘á»•i, ai Ä‘Ã³ cÃ³ thá»ƒ gá»­i ADA vÃ  sau Ä‘Ã³ ngÆ°á»i khÃ¡c cÃ³ thá»ƒ láº¥y nhá»¯ng ADA Ä‘Ã³ Ä‘á»ƒ Ä‘á»•i láº¥y USD.</p><p><img src="/assets/images/week06__00003-0b5bb3782b21d4bd0fca5389ea01645c.png"></p><p>Táº¥t nhiÃªn, chÃºng ta khÃ´ng cÃ³ USD trá»±c tiáº¿p trÃªn blockchain, nhÆ°ng chÃºng ta cÃ³ thá»ƒ tÆ°á»Ÿng tÆ°á»£ng ráº±ng chÃºng Ä‘Æ°á»£c Ä‘áº¡i diá»‡n bá»Ÿi má»™t sá»‘ mÃ£ thÃ´ng bÃ¡o gá»‘c.</p><p>Trong vÃ­ dá»¥ nÃ y, vÃ¬ giÃ¡ trá»‹ cá»§a oracle lÃ  1,75, thÃ¬ náº¿u ai Ä‘Ã³ cung cáº¥p 100 ADA, giÃ¡ cho Ä‘iá»u Ä‘Ã³ sáº½ lÃ  175 USD.</p><p>NgoÃ i ra, chÃºng tÃ´i cáº§n má»™t Ä‘á»™ng lá»±c Ä‘á»ƒ tiÃªn tri cung cáº¥p dá»¯ liá»‡u, bá»Ÿi vÃ¬ ngoÃ i cÃ¡c chi phÃ­ khÃ¡c Ä‘á»ƒ cung cáº¥p dá»¯ liá»‡u, thÃ¬ á»Ÿ má»©c tá»‘i thiá»ƒu há» sáº½ pháº£i tráº£ phÃ­ Ä‘á»ƒ táº¡o UTxO.</p><p>VÃ¬ váº­y, giáº£ sá»­ ráº±ng nhÃ  cung cáº¥p oracle xÃ¡c Ä‘á»‹nh má»™t khoáº£n phÃ­ 1 ADA pháº£i tráº£ má»—i khi oracle Ä‘Æ°á»£c sá»­ dá»¥ng.</p><p>Trong vÃ­ dá»¥ nÃ y, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  ngÆ°á»i muá»‘n ADA sáº½ pháº£i tráº£ 175 USD cho ngÆ°á»i bÃ¡n ADA vÃ  1 ADA cho nhÃ  tiÃªn tri.</p><p>Giao dá»‹ch sáº½ nhÆ° tháº¿ nÃ o?</p><p><img src="/assets/images/week06__00004-789b3973cd4c08a6f70363671d8f7219.png"></p><p>TrÆ°á»›c háº¿t, logic xÃ¡c thá»±c hoÃ¡n Ä‘á»•i sáº½ cáº§n quyá»n truy cáº­p vÃ o giÃ¡ trá»‹ oracle hiá»‡n táº¡i, cÃ³ nghÄ©a lÃ  UTxO oracle pháº£i lÃ  Ä‘áº§u vÃ o cho giao dá»‹ch.</p><p>Sau Ä‘Ã³, chÃºng ta cÃ³ logic xÃ¡c thá»±c tiÃªn tri. Trong trÆ°á»ng há»£p nÃ y, chÃºng tÃ´i muá»‘n sá»­ dá»¥ng tiÃªn tri. VÃ¬ váº­y, giáº£ sá»­ chÃºng ta cÃ³ má»™t cÃ´ng cá»¥ Ä‘á»•i quÃ  Ä‘Æ°á»£c gá»i lÃ  sá»­ dá»¥ng . BÃ¢y giá», trÃ¬nh xÃ¡c thá»±c tiÃªn tri pháº£i kiá»ƒm tra má»™t sá»‘ thá»©.</p><ol><li>NFT cÃ³ trong Ä‘áº§u vÃ o Ä‘Æ°á»£c tiÃªu thá»¥ khÃ´ng?</li><li>CÃ³ Ä‘áº§u ra tá»« giao dá»‹ch táº¡i cÃ¹ng má»™t Ä‘á»‹a chá»‰ cÃ³ chá»©a cÃ¹ng má»™t NFT khÃ´ng?</li><li>IGiÃ¡ trá»‹ trong UTxO Ä‘áº§u ra cÃ³ giá»‘ng vá»›i giÃ¡ trá»‹ Ä‘áº§u vÃ o khÃ´ng?</li><li>PhÃ­ cÃ³ pháº£i khÃ´ng?</li></ol><p>BÃ¢y giá» chÃºng ta cÃ³ thá»ƒ hoÃ n thÃ nh giao dá»‹ch.</p><p>ChÃºng tÃ´i sá»­ dá»¥ng hai Ä‘áº§u vÃ o bá»• sung - phÃ­ do ngÆ°á»i mua tráº£ vÃ  100 ADA do ngÆ°á»i bÃ¡n Ä‘áº·t cá»c. Sau Ä‘Ã³, chÃºng tÃ´i cÃ³ hai Ä‘áº§u ra bá»• sung - 175 USD cho ngÆ°á»i bÃ¡n vÃ  100 ADA cho ngÆ°á»i mua. VÃ  Ä‘á»‘i vá»›i nhá»¯ng Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra má»›i nÃ y, ngÆ°á»i xÃ¡c nháº­n hoÃ¡n Ä‘á»•i cÃ³ trÃ¡ch nhiá»‡m Ä‘áº£m báº£o ráº±ng nÃ³ chÃ­nh xÃ¡c. Trong khi Ä‘Ã³, trÃ¬nh xÃ¡c nháº­n tiÃªn tri chá»‰ quan tÃ¢m Ä‘áº¿n viá»‡c Ä‘áº£m báº£o ráº±ng má»i thá»© liÃªn quan Ä‘áº¿n tiÃªn tri lÃ  chÃ­nh xÃ¡c.</p><p><img src="/assets/images/week06__00005-a367da3cdd4e2bd0cdb39e22365539c5.png"></p><p>Chá»‰ cáº§n nháº¥n máº¡nh, há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i nÃ y chá»‰ lÃ  má»™t vÃ­ dá»¥. NhÃ  tiÃªn tri pháº£i cÃ³ kháº£ nÄƒng lÃ m viá»‡c vá»›i nhiá»u há»£p Ä‘á»“ng thÃ´ng minh khÃ¡c nhau muá»‘n sá»­ dá»¥ng dá»¯ liá»‡u cá»§a nÃ³.</p><p>Náº¿u Ä‘Ã¢y lÃ  táº¥t cáº£, thÃ¬ chÃºng ta sáº½ khÃ´ng cáº§n má»™t lá»i tiÃªn tri. Náº¿u giÃ¡ trá»‹ Ä‘Ã£ Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh, Ä‘á»ƒ nÃ³ luÃ´n lÃ  1,75 thÃ¬ chÃºng tÃ´i cÃ³ thá»ƒ chá»‰ cáº§n mÃ£ hÃ³a giÃ¡ trá»‹ nÃ y vÃ o há»£p Ä‘á»“ng cá»§a mÃ¬nh. VÃ¬ váº­y, giÃ¡ trá»‹ pháº£i cÃ³ thá»ƒ thay Ä‘á»•i. Ãt nháº¥t, trong má»™t vÃ­ dá»¥ cháº³ng háº¡n nhÆ° vÃ­ dá»¥ nÃ y, nÆ¡i chÃºng ta cÃ³ má»™t tá»· giÃ¡ há»‘i Ä‘oÃ¡i, táº¥t nhiÃªn, cÃ³ thá»ƒ thay Ä‘á»•i theo thá»i gian. CÃ³ thá»ƒ cÃ³ cÃ¡c vÃ­ dá»¥ khÃ¡c nhÆ° káº¿t quáº£ cá»§a má»™t tráº­n Ä‘áº¥u thá»ƒ thao, trong Ä‘Ã³ nÃ³ lÃ  má»™t sá»± kiá»‡n ká»³ â€‹â€‹láº¡ trong lá»‹ch sá»­, nhÆ°ng trong trÆ°á»ng há»£p nÃ y, Ä‘iá»u quan trá»ng lÃ  nÃ³ cÃ³ thá»ƒ thay Ä‘á»•i.</p><p>Äiá»u nÃ y cÃ³ nghÄ©a lÃ  trÃ¬nh xÃ¡c thá»±c oracle, ngoÃ i viá»‡c sá»­ dá»¥ng Redeemer, pháº£i cÃ³ kháº£ nÄƒng há»— trá»£ má»™t hoáº¡t Ä‘á»™ng khÃ¡c mÃ  nhÃ  cung cáº¥p oracle thá»±c sá»± cÃ³ thá»ƒ thay Ä‘á»•i dá»¯ liá»‡u.</p><p>VÃ¬ váº­y, giáº£ sá»­ giÃ¡ trá»‹ thay Ä‘á»•i tá»« 1,75 thÃ nh 1,77.</p><p>ChÃºng tÃ´i biáº¿t ráº±ng trÃªn blockchain UTxO (E), khÃ´ng cÃ³ gÃ¬ thay Ä‘á»•i, vÃ¬ váº­y báº¡n khÃ´ng thá»ƒ thay Ä‘á»•i dá»¯ liá»‡u cá»§a UTxO hiá»‡n cÃ³. Táº¥t cáº£ nhá»¯ng gÃ¬ báº¡n cÃ³ thá»ƒ lÃ m lÃ  sá»­ dá»¥ng UTxO vÃ  sáº£n xuáº¥t UTxO má»›i.</p><p>ChÃºng tÃ´i sáº½ cÃ³ má»™t giao dá»‹ch sá»­ dá»¥ng Redeemer báº£n cáº­p nháº­t . Logic xÃ¡c nháº­n hÆ¡i khÃ¡c. NÃ³ giá»‘ng nhÆ° trÆ°á»›c Ä‘Ã¢y á»Ÿ chá»— NFT cáº§n pháº£i cÃ³ máº·t trong Ä‘áº§u vÃ o oracle Ä‘Ã£ tiÃªu thá»¥, vÃ  cÅ©ng cáº§n cÃ³ máº·t trong Ä‘áº§u ra má»›i. NgoÃ i ra, giao dá»‹ch pháº£i Ä‘Æ°á»£c kÃ½ bá»Ÿi nhÃ  cung cáº¥p oracle. VÃ , chÃºng tÃ´i cÃ³ thá»ƒ sá»­ dá»¥ng giao dá»‹ch cáº­p nháº­t nÃ y nhÆ° má»™t cÆ¡ há»™i Ä‘á»ƒ nhÃ  cung cáº¥p oracle thu phÃ­.</p><p>ChÃºng tÃ´i nháº¥n máº¡nh ráº±ng NFT cÃ³ trong Ä‘áº§u ra, nhÆ°ng chÃºng tÃ´i khÃ´ng nÃ³i gÃ¬ vá» cÃ¡c giÃ¡ trá»‹ khÃ¡c. Táº¥t cáº£ cÃ¡c khoáº£n phÃ­ do cÃ¡c giao dá»‹ch khÃ¡c sá»­ dá»¥ng dá»¯ liá»‡u oracle nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c thu trong quÃ¡ trÃ¬nh cáº­p nháº­t giao dá»‹ch.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="báº£n-tÃ³m-táº¯t"></a>Báº£n tÃ³m táº¯t<a class="hash-link" href="#báº£n-tÃ³m-táº¯t" title="Direct link to heading">#</a></h3><p>TÃ³m láº¡i, chÃºng tÃ´i Ä‘áº¡i diá»‡n cho tiÃªn tri bá»Ÿi má»™t UTxO vÃ  xÃ¡c Ä‘á»‹nh UTxO chÃ­nh xÃ¡c báº±ng má»™t NFT. GiÃ¡ trá»‹ oracle lÃ  dá»¯ liá»‡u cá»§a UTxO. ChÃºng tÃ´i há»— trá»£ hai hoáº¡t Ä‘á»™ng.</p><p>Má»™t lÃ  sá»­ dá»¥ng sá»­ dá»¥ng tiÃªn tri trong má»™t sá»‘ giao dá»‹ch tÃ¹y Ã½. CÃ¡c sá»­ dá»¥ng validator sáº½ Ä‘áº£m báº£o ráº±ng cÃ¡c Ä‘áº§u vÃ o oracle tiÃªu thá»¥ mang NFT, ráº±ng cÃ³ má»™t Ä‘áº§u ra mÃ  láº¡i mang NFT, khÃ´ng lÃ m thay Ä‘á»•i dá»¯ kiá»‡n, vÃ  mang phÃ­ bá»• sung.</p><p>Thao tÃ¡c thá»© hai lÃ  cáº­p nháº­t chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi nhÃ  cung cáº¥p oracle. Äá»‘i vá»›i má»™t giao dá»‹ch cáº­p nháº­t , Ä‘áº§u vÃ o oracle láº¡i pháº£i mang NFT, pháº£i cÃ³ Ä‘áº§u ra oracle cÅ©ng mang NFT. KhÃ´ng cÃ³ háº¡n cháº¿ nÃ o ná»¯a. Sá»‘ liá»‡u cÃ³ thá»ƒ thay Ä‘á»•i vÃ  phÃ­ tÃ­ch lÅ©y cÃ³ thá»ƒ Ä‘Æ°á»£c láº¥y ra.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-core"></a>Oracle Core<a class="hash-link" href="#oracle-core" title="Direct link to heading">#</a></h2><p>BÃ¢y giá» chÃºng ta biáº¿t nÃ³ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o, hÃ£y xem má»™t sá»‘ Ä‘oáº¡n mÃ£.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="on-chain"></a>On-chain<a class="hash-link" href="#on-chain" title="Direct link to heading">#</a></h3><p>Äáº§u tiÃªn, hÃ£y xem mÃ£ Plutus tá»± thá»±c thi oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.Core</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The oracle sáº½ lÃ  má»™t há»£p Ä‘á»“ng Ä‘Æ°á»£c tham sá»‘ hÃ³a vÃ  nÃ³ sáº½ phá»¥ thuá»™c vÃ o bá»‘n trÆ°á»ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { oSymbol   :: !CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oOperator :: !PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oFee      :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oAsset    :: !AssetClass</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    } deriving (Show, Generic, FromJSON, ToJSON, Prelude.Eq, Prelude.Ord)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><ul><li><code>oSymbol</code>  lÃ  biá»ƒu tÆ°á»£ng tiá»n tá»‡ cá»§a NFT Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giao dá»‹ch. ChÃºng tÃ´i khÃ´ng cáº§n tÃªn mÃ£ thÃ´ng bÃ¡o vÃ¬ chÃºng tÃ´i sáº½ chá»‰ sá»­ dá»¥ng chuá»—i trá»‘ng lÃ m tÃªn mÃ£ thÃ´ng bÃ¡o.</li><li><code>oOperator</code>  lÃ  chá»§ sá»Ÿ há»¯u cá»§a oracle - hÃ m bÄƒm cá»§a chá»§ sá»Ÿ há»¯u khÃ³a cÃ´ng khai cÃ³ thá»ƒ thá»±c hiá»‡n cáº­p nháº­t</li><li><code>oFee</code>  lÃ  khoáº£n phÃ­ trong tÃ¬nh yÃªu pháº£i tráº£ má»—i khi sá»­ dá»¥ng oracle</li><li><code>oAsset</code>  Ä‘áº¡i diá»‡n cho loáº¡i tÃ i sáº£n mÃ  chÃºng tÃ´i muá»‘n trao Ä‘á»•i tá»· giÃ¡ so vá»›i Ada, trong trÆ°á»ng há»£p cá»§a chÃºng tÃ´i sáº½ lÃ  má»™t sá»‘ loáº¡i mÃ£ thÃ´ng bÃ¡o USD</li></ul><p>Redeemer sáº½ há»— trá»£ hai hoáº¡t Ä‘á»™ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data OracleRedeemer = Update | Use</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deriving Show</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">PlutusTx.unstableMakeIsData &#x27;&#x27;OracleRedeemer</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cáº§n xÃ¡c Ä‘á»‹nh lá»›p tÃ i sáº£n NFT. NhÆ° Ä‘Ã£ Ä‘á» cáº­p, chÃºng ta sáº½ sá»­ dá»¥ng chuá»—i trá»‘ng cho tÃªn mÃ£ thÃ´ng bÃ¡o.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleTokenName #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleTokenName :: TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleTokenName = TokenName emptyByteString</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>CÃ¡c <code>oracleAsset</code> sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c NFT - Ä‘Ã¢y khÃ´ng pháº£i lÃ  <code>oAsset</code> Ä‘á»‹nh nghÄ©a á»Ÿ trÃªn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleAsset #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAsset :: Oracle -&gt; AssetClass</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAsset oracle = AssetClass (oSymbol oracle, oracleTokenName)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i táº¡o má»™t hÃ m trá»£ giÃºp nhá» gá»i lÃ  <code>oracleValue</code> . Äiá»u nÃ y nháº­n má»™t giao dá»‹ch Ä‘áº§u ra vÃ  má»™t hÃ m tÃ¬m kiáº¿m dá»¯ liá»‡u, sau Ä‘Ã³ tráº£ vá» má»™t Sá»‘ nguyÃªn . CÃ¡c Integer Ä‘áº¡i diá»‡n cho tá»· giÃ¡ há»‘i Ä‘oÃ¡i (vÃ­ dá»¥ 1,75) nhÃ¢n vá»›i má»™t triá»‡u. Äiá»u nÃ y trÃ¡nh nhá»¯ng phá»©c táº¡p cÃ³ thá»ƒ xáº£y ra khi sá»­ dá»¥ng sá»‘ thá»±c.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleValue #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue :: TxOut -&gt; (DatumHash -&gt; Maybe Datum) -&gt; Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue o f = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    dh      &lt;- txOutDatum o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Datum d &lt;- f dh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    PlutusTx.fromData d</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m nÃ y lÃ  má»™t vÃ­ dá»¥ vá» tÃ­nh toÃ¡n monadic trong monad. nÃ³ khÃ´ng pháº£i lÃ  <code>IO</code>  hoáº·c <code>Contract monad</code>. Äáº§u tiÃªn chung ta gá»i <code>txOutDatum</code>, NÃ³ khÃ´ng thÃ nh cÃ´ng náº¿u Ä‘Ã¢u ra khÃ´ng cÃ³ datum. Náº¿u nÃ³ thÃ nh cÃ´ng, chÃºng tÃ´i nháº­n Ä‘Æ°á»£c má»™t bÄƒm datum mÃ  chÃºng tÃ´i cÃ³ thá»ƒ tham chiáº¿u trong Ä‘Ã³ <code>dh</code>.  Tiáº¿p theo, chÃºng tÃ´i sá»­ dá»¥ng hÃ m  <code>f</code>  Ä‘Æ°á»£c cung cáº¥p lÃ m Ä‘á»‘i sá»‘ thá»© hai Ä‘á»ƒ cÃ³ thá»ƒ biáº¿n bÄƒm dá»¯ liá»‡u nÃ y thÃ nh má»™t dá»¯ liá»‡u. Äiá»u nÃ y cÅ©ng cÃ³ thá»ƒ tháº¥t báº¡i. Náº¿u nÃ³ thÃ nh cÃ´ng, chÃºng tÃ´i cÃ³ thá»ƒ tham kháº£o káº¿t quáº£ trong <code>d</code>. <code>Datum</code>  chá»‰ lÃ  má»™t trÃ¬nh bao bá»c kiá»ƒu má»›i xung quanh <code>Data</code>,vÃ¬ váº­y sau Ä‘Ã³ chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng <code>PlutusTx.fromData</code>  Ä‘á»ƒ cÃ³ thá»ƒ biáº¿n <code>d</code>  thÃ nh <code>Integer</code>.Má»™t láº§n ná»¯a, Ä‘iá»u nÃ y cÃ³ thá»ƒ khÃ´ng thÃ nh cÃ´ng, bá»Ÿi vÃ¬ ngay cáº£ khi dá»¯ liá»‡u á»Ÿ Ä‘Ã³, nÃ³ cÃ³ thá»ƒ khÃ´ng Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i thÃ nh giÃ¡ trá»‹ sá»‘ nguyÃªn.</p><p>ChÃºng ta sáº½ tháº¥y chÃºng ta sá»­ dá»¥ng hÃ m <code>oracleValue</code>  á»Ÿ Ä‘Ã¢y trong giÃ¢y lÃ¡t.</p><p>Chá»©c nÄƒng quan trá»ng nháº¥t lÃ   <code>mkOracleValidator</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE mkOracleValidator #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkOracleValidator :: Oracle -&gt; Integer -&gt; OracleRedeemer -&gt; ScriptContext -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkOracleValidator oracle x r ctx =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    traceIfFalse &quot;token missing from input&quot;  inputHasToken  &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    traceIfFalse &quot;token missing from output&quot; outputHasToken &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case r of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Update -&gt; traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  traceIfFalse &quot;invalid output datum&quot;       validOutputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Use    -&gt; traceIfFalse &quot;oracle value changed&quot;       (outputDatum == Just x)              &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  traceIfFalse &quot;fees not paid&quot;              feesPaid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info = scriptContextTxInfo ctx</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownInput = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; traceError &quot;oracle input missing&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just i  -&gt; txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inputHasToken = assetClassValueOf (txOutValue ownInput) (oracleAsset oracle) == 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownOutput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownOutput = case getContinuingOutputs ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _   -&gt; traceError &quot;expected exactly one oracle output&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputHasToken = assetClassValueOf (txOutValue ownOutput) (oracleAsset oracle) == 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputDatum :: Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputDatum = oracleValue ownOutput (`findDatum` info)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    validOutputDatum :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    validOutputDatum = isJust outputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    feesPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    feesPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        inVal  = txOutValue ownInput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outVal = txOutValue ownOutput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outVal `geq` (inVal &lt;&gt; Ada.lovelaceValueOf (oFee oracle))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>mkOracleValidator</code>  nháº­n 4 tham sá»‘: <code>Oracle</code>,
trong vÃ­ dá»¥ nÃ y <code>datum</code>  lÃ  <code>Integer</code>, <code>redeemer</code> lÃ 
<code>OracleRedeemer</code>  vÃ  cuá»‘i cÃ¹ng lÃ  <code>ScriptContext</code>.</p><p>CÃ³ hai trÆ°á»ng há»£p cho trÃ¬nh xÃ¡c thá»±c nÃ y - <code>use</code> vÃ  <code>update</code> - nhÆ°ng cÃ³ nhá»¯ng Ä‘iá»ƒm tÆ°Æ¡ng Ä‘á»“ng. Trong cáº£ hai trÆ°á»ng há»£p, chÃºng tÃ´i muá»‘n kiá»ƒm tra xem chÃºng tÃ´i cÃ³ Ä‘áº§u vÃ o chá»©a NFT vÃ  cÃ³ Ä‘áº§u ra chá»©a NFT khÃ´ng.</p><p>VÃ¬ cáº£ hai viá»‡c kiá»ƒm tra nÃ y Ä‘á»u cáº§n Ä‘Æ°á»£c thá»±c hiá»‡n báº¥t ká»ƒ trÆ°á»ng há»£p sá»­ dá»¥ng nÃ o, nÃªn chÃºng Ä‘Æ°á»£c thá»±c hiá»‡n trÆ°á»›c.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;token missing from input&quot;  inputHasToken  &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;token missing from output&quot; outputHasToken &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i xem xÃ©t trÆ°á»ng há»£p sá»­ dá»¥ng mÃ  chÃºng tÃ´i Ä‘ang xá»­ lÃ½.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case r of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Update -&gt; traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              traceIfFalse &quot;invalid output datum&quot;       validOutputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Use    -&gt; traceIfFalse &quot;oracle value changed&quot;       (outputDatum == Just x)              &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              traceIfFalse &quot;fees not paid&quot;              feesPaid    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>TrÆ°á»›c khi xem xÃ©t hÃ m <code>inputHasToken</code>, cÃ³ má»™t chá»©c nÄƒng trá»£ giÃºp khÃ¡c cáº§n xem xÃ©t</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownInput = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing -&gt; traceError &quot;oracle input missing&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Just i  -&gt; txInInfoResolved i</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>ownInput</code>  tráº£ vá» <code>TxOut</code>  MÃ  nÃ³ Ä‘ang cÃ³ gáº¯ng tiÃªu thá»¥, trong trÆ°á»ng há»£p nÃ y lÃ  oracle output. TrÆ°á»ng há»£p <code>Nothing</code>  cÃ³ thá»ƒ sáº©y ra náº¿u ra náº¿u chÃºng ta Ä‘ang á»Ÿ trong má»™t context khÃ¡c, cháº³ng háº¡n nhÆ° context Ä‘Ãºc, vÃ¬ váº­y tÃ¬nh huá»‘ng nÃ y sáº½ khÃ´ng xáº£y ra cho chÃºng ta. HÃ m <code>findOwnInput</code> Ä‘Æ°á»£c cung cáº¥p bá»Ÿi Plutus vÃ  sáº½ nháº­n context, sau Ä‘Ã³ tÃ¬m cÃ¡c Ä‘áº§u vÃ o liÃªn quan. HÃ m <code>txInInfoResolved</code>  nháº­n <code>TxOut</code>  tá»« <code>TxInInfo</code>.</p><p>HÃ m <code>inputHashToken</code>  kiá»ƒm tra token hiá»‡n táº¡i. NÃ³ sá»­ dá»¥ng hÃ m <code>assetClassValueOf</code>  Ä‘á»ƒ tÃ¬m kiáº¿m NFT trong pháº£n há»“i <code>ownInput</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">inputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">inputHasToken = assetClassValueOf (txOutValue ownInput) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m trá»£ giÃºp tiáº¿p theo, <code>ownOutput</code> kiá»ƒm tra xem chÃºng cÃ³ chÃ­nh xÃ¡c má»™t Ä‘áº§u ra hay khÃ´ng vÃ  tráº£ láº¡i Ä‘áº§u ra Ä‘Ã³ cho chÃºng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownOutput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownOutput = case getContinuingOutputs ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _   -&gt; traceError &quot;expected exactly one oracle output&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m trá»£ giÃºp <code>outputHasToken</code>  giá»‘ng nhÆ° hÃ m <code>inputHashToken</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">outputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">outputHasToken = assetClassValueOf (txOutValue ownOutput) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u Ä‘Ã³ bao gá»“m mÃ£ cho cÃ¡c trÆ°á»ng há»£p phá»• biáº¿n. BÃ¢y giá», hÃ£y xem mÃ£ cá»¥ thá»ƒ cho trÆ°á»ng há»£p <code>update</code>.</p><p>CÃ³ hai Ä‘iá»u kiá»‡n Ä‘á»ƒ kiá»ƒm tra. Äáº§u tiÃªn lÃ  nhÃ  Ä‘iá»u hÃ nh Ä‘Ã£ thá»±c sá»± kÃ½ káº¿t giao dá»‹ch. Äiá»u nÃ y ráº¥t Ä‘Æ¡n giáº£n nÃªn chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n nÃ³ on-chain mÃ  khÃ´ng cáº§n hÃ m trá»£ giÃºp.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u tiáº¿p theo cáº§n kiá»ƒm tra lÃ  dá»¯ liá»‡u Ä‘áº§u ra. ChÃºng tÃ´i biáº¿t ráº±ng giÃ¡ trá»‹ cÃ³ thá»ƒ thay Ä‘á»•i, nhÆ°ng chÃºng tÃ´i cáº§n kiá»ƒm tra xem Ã­t nháº¥t nÃ³ cÃ³ pháº£i lÃ  kiá»ƒu Ä‘Ãºng hay khÃ´ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;invalid output datum&quot; validOutputDatum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  Ä‘á»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i Ä‘Ã£ tham chiáº¿u Ä‘áº¿n má»™t hÃ m trá»£ giÃºp má»›i <code>validOutputDatum</code>, chÃ­nh nÃ³ sá»­ dá»¥ng má»™t hÃ m trá»£ giÃºp <code>outputDatum</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">outputDatum :: Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">outputDatum = oracleValue ownOutput (`findDatum` info)    </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">validOutputDatum :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">validOutputDatum = isJust outputDatum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="chÃº-Ã½"></a>ChÃº Ã½<a class="hash-link" href="#chÃº-Ã½" title="Direct link to heading">#</a></h2><p>Náº¿u báº¡n tra cá»©u <code>findDatum</code>  trong REPL, Báº¡n sáº½ tháº¥y cÃ³ má»™t loáº¡i nÃ y <code>DatumHash -&gt; TxInfo -&gt; Maybe Datum</code>. VÃ¬ chÃºng ta Ä‘ang sá»­ dá»¥ng infix á»Ÿ Ä‘Ã¢y, ChÃºng ta cÃ³ thá»ƒ chuyá»ƒn vÃ o <code>info</code>  dÆ°á»›i dáº¡ng tham sá»‘ duy nháº¥t, vÃ  Ä‘iá»u nÃ y sáº½ dáº«n Ä‘áº¿n toÃ n bá»™ biá»ƒu thá»©c cÃ³ kiá»ƒu <code>DatumHash -&gt; Maybe Datum</code>, lÃ  kiá»ƒu mÃ  chÃºng ta cáº§n chuyá»ƒn vÃ o<code>oracleValue</code>.</p><p>Äiá»u nÃ y hoáº¡t Ä‘á»™ng báº±ng cÃ¡ch cá»‘ gáº¯ng láº¥y giÃ¡ trá»‹ dá»¯ liá»‡u tá»« bÄƒm dá»¯ liá»‡u vÃ  sau Ä‘Ã³ cá»‘ gáº¯ng táº¡o giÃ¡ trá»‹ oracle tá»« nÃ³. Náº¿u thÃ nh cÃ´ng, nÃ³ sáº½ tráº£ vá» <code>Just Integer</code>, ngÆ°á»£c láº¡i nÃ³ sáº½ tráº£ vá» <code>Nothing</code>, vÃ¬ váº­y hÃ m <code>validOutputDatum</code>  chá»‰ cáº§n kiá»ƒm tra xem giÃ¡ trá»‹ tráº£ vá» cÃ³ pháº£i <code>Nothing</code>,hay lÃ  <code>Just</code>.</p><p>LÆ°u Ã½ ráº±ng chÃºng tÃ´i khÃ´ng kiá»ƒm tra báº¥t ká»³ Ä‘iá»u gÃ¬ vá» giÃ¡ trá»‹ cá»§a <code>Integer</code>. GiÃ¡ trá»‹ nÃ y tháº­m chÃ­ cÃ³ thá»ƒ giá»¯ nguyÃªn nhÆ° giÃ¡ trá»‹ Ä‘áº§u vÃ o, náº¿u giao dá»‹ch Ä‘Æ°á»£c sá»­ dá»¥ng chá»‰ Ä‘á»ƒ thu phÃ­ Ä‘Ã£ tÃ­ch lÅ©y tá»« viá»‡c sá»­ dá»¥ng oracle.</p><p>TrÆ°á»ng há»£p thá»© hai cho <code>mkOracleValidator</code>  lÃ  trÆ°á»ng há»£p <code>use</code>. TrÆ°á»ng há»£p nÃ y ai cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c nhÆ°ng háº¡n cháº¿ hÆ¡n ráº¥t nhiá»u.</p><p>Äáº§u tiÃªn, chÃºng tÃ´i khÃ´ng cho phÃ©p giÃ¡ trá»‹ thay Ä‘á»•i. VÃ¬ váº­y, Ä‘Ã¢y lÃ  Ä‘iá»u kiá»‡n Ä‘áº§u tiÃªn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;oracle value changed&quot; (outputDatum == Just x)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i Ä‘Ã£ viáº¿t hÃ m trá»£ giÃºp <code>outputDatum</code>. Thay vÃ¬ chá»‰ kiá»ƒm tra xem nÃ³ cÃ³ pháº£i lÃ  <code>Integer</code> hay khÃ´ng , á»Ÿ Ä‘Ã¢y chÃºng ta cÅ©ng kiá»ƒm tra xem giÃ¡ trá»‹ Ä‘áº§u ra cá»§a nÃ³ cÃ³ giá»‘ng vá»›i giÃ¡ trá»‹ Ä‘áº§u vÃ o hay khÃ´ng.</p><p>VÃ  cuá»‘i cÃ¹ng, chÃºng ta pháº£i kiá»ƒm tra xem cÃ¡c khoáº£n phÃ­ Ä‘Ã£ Ä‘Æ°á»£c thanh toÃ¡n hay chÆ°a. VÃ  Ä‘á»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i sá»­ dá»¥ng má»™t chá»©c nÄƒng trá»£ giÃºp má»›i Ä‘Æ°á»£c gá»i lÃ  <code>feesPaid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">feesPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">feesPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inVal  = txOutValue ownInput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outVal = txOutValue ownOutput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outVal `geq` (inVal &lt;&gt; Ada.lovelaceValueOf (oFee oracle))    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>feesPaid</code> kiá»ƒm tra giÃ¡ trá»‹ Ä‘áº§u ra Ã­t nháº¥t báº±ng giÃ¡ trá»‹ Ä‘áº§u vÃ o cá»™ng vá»›i phÃ­ báº¯t buá»™c. ChÃºng tÃ´i láº¡i sá»­ dá»¥ng toÃ¡n tá»­  <code>&lt;&gt;</code> Ä‘á»ƒ cá»™ng thÃªm fee vÃ o giÃ¡ trá»‹ Ä‘áº§u vÃ o. ChÃºng tÃ´i cÃ³ thá»ƒ Ä‘Ã£ sá»­ dá»¥ng báº±ng (eq) thay vÃ¬ lá»›n hÆ¡n hoáº·c báº±ng (geq). Viá»‡c sá»­ dá»¥ng <code>geq</code>  ho phÃ©p ngÆ°á»i dÃ¹ng oracle Ä‘Æ°a cho nhÃ  cung cáº¥p oracle má»™t máº¹o, náº¿u há» muá»‘n dÃ¹ng.</p><p>VÃ¬ váº­y, Ä‘Ã¢y vá» cÆ¡ báº£n lÃ  logic cá»‘t lÃµi cá»§a oracle nhÆ° Ä‘Æ°á»£c thá»ƒ hiá»‡n trong sÆ¡ Ä‘á»“ sau.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><p>BÃ¢y giá» chÃºng ta cÃ³ boilerplate cá»§a chÃºng ta. Äáº·c biá»‡t lÆ°u Ã½ ráº±ng chÃºng tÃ´i sá»­ dá»¥ng máº«u mÃ  chÃºng tÃ´i cáº§n cho trÃ¬nh xÃ¡c thá»±c Ä‘Æ°á»£c tham sá»‘ hÃ³a.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ScriptType Oracling where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Oracling = Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Oracling = OracleRedeemer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInst :: Oracle -&gt; Scripts.ScriptInstance Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInst oracle = Scripts.validator @Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ($$(PlutusTx.compile [|| mkOracleValidator ||]) `PlutusTx.applyCode` PlutusTx.liftCode oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @Integer @OracleRedeemer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValidator :: Oracle -&gt; Validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValidator = Scripts.validatorScript . oracleInst</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAddress :: Oracle -&gt; Ledger.Address</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAddress = scriptAddress . oracleValidator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  Ä‘iá»u nÃ y káº¿t thÃºc pháº§n on-chain cá»§a mÃ£ oracle.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="off-chain"></a>Off-chain<a class="hash-link" href="#off-chain" title="Direct link to heading">#</a></h3><p>ChÃºng tÃ´i cÅ©ng táº¡o má»™t sá»‘ mÃ£ ngoÃ i chuá»—i, cá»¥ thá»ƒ lÃ  Ä‘á»ƒ báº¯t Ä‘áº§u tiÃªn tri vÃ  cáº­p nháº­t nÃ³. Tuy nhiÃªn, chÃºng tÃ´i khÃ´ng viáº¿t mÃ£ off-chain cho useoracle. ÄÃ³ khÃ´ng pháº£i lÃ  trÃ¡ch nhiá»‡m cá»§a tÃ¡c giáº£ cá»§a há»£p Ä‘á»“ng nÃ y. ÄÃ³ sáº½ lÃ  trÃ¡ch nhiá»‡m cá»§a ngÆ°á»i muá»‘n sá»­ dá»¥ng oracle - há» sáº½ viáº¿t mÃ£ Ä‘á»ƒ táº¡o giao dá»‹ch vá»›i ngÆ°á»i Ä‘á»•i use. ÄÃ¢y lÃ  láº§n Ä‘áº§u tiÃªn chÃºng tÃ´i tháº¥y trÆ°á»ng há»£p chÃºng tÃ´i cÃ³ má»™t sá»‘ mÃ£ trong chuá»—i khÃ´ng Ä‘Æ°á»£c ghÃ©p ná»‘i vá»›i má»™t sá»‘ mÃ£ ngoÃ i chuá»—i.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="starting-the-oracle"></a>Starting the Oracle<a class="hash-link" href="#starting-the-oracle" title="Direct link to heading">#</a></h4><p>Äá»ƒ báº¯t Ä‘áº§u oracle, chÃºng ta cáº§n má»™t sá»‘ tham sá»‘.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data OracleParams = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { opFees   :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opSymbol :: !CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opToken  :: !TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    } deriving (Show, Generic, FromJSON, ToJSON)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p> <code>opFees</code>  tham sá»‘ Ä‘áº¡i diá»‡n cho sá»‘ phÃ­ lovelace Ä‘Ã³ sáº½ Ä‘Æ°á»£c tÃ­nh vÃ o sá»­ dá»¥ng oracle.</p><p>Tham sá»‘ <code>opSymbol</code>  vÃ  <code>opToken</code>  Ä‘áº¡i diá»‡n cho token
mÃ  chÃºng tÃ´i Ä‘ang cung cáº¥p tá»· giÃ¡ há»‘i Ä‘oÃ¡i Ada, trong trÆ°á»ng há»£p nÃ y lÃ  token USD.</p><p>Äáº§u tiÃªn, chÃºng tÃ´i táº¡o má»™t hÃ m <code>startOracle</code>, cÃ³ trÃ¡ch nhiá»‡m táº¡o ra NFT sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh UTxO oracle. CÃ¡c hÃ m<code>startOracle</code>  nÃ y sáº½ khÃ´ng cung cáº¥p má»™t giÃ¡ trá»‹ ban Ä‘áº§u cho oracle, Ä‘iá»u nÃ y sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi cÃ¡c hÃ m <code>updateOracle</code> . LÃ½ do cho Ä‘iá»u nÃ y lÃ , náº¿u chÃºng tÃ´i cung cáº¥p má»™t giÃ¡ trá»‹ ban Ä‘áº§u, nÃ³ cÃ³ thá»ƒ bá»‹ lá»—i thá»i vÃ o thá»i Ä‘iá»ƒm NFT Ä‘Æ°á»£c Ä‘Ãºc.</p><p>ChÃºng tÃ´i cÃ³ thá»ƒ Ä‘Ã£ sá»­ dá»¥ng cÃ¹ng má»™t mÃ£ Ä‘á»ƒ Ä‘Ãºc NFT nhÆ° chÃºng tÃ´i Ä‘Ã£ sá»­ dá»¥ng trong bÃ i giáº£ng 5. Äiá»u nÃ y sáº½ hoáº¡t Ä‘á»™ng hoÃ n toÃ n tá»‘t.</p><p>Tuy nhiÃªn, Ä‘Ã¢y lÃ  má»™t mÃ´-Ä‘un tiá»n tá»‡ Ä‘Æ°á»£c cung cáº¥p trong <code>plutus-use-cases</code> cÃ¡i mÃ  cung cáº¥p hÃ m <code>forgeContract</code>  cho phÃ©p táº¡o NFT</p><p>ÄÃ¢y lÃ  hÃ m <code>forgeContract</code>  hiá»‡n thá»‹ trong REPL.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; :t Plutus.Contracts.Currency.forgeContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contracts.Currency.forgeContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  :: (row-types-1.0.1.0:Data.Row.Internal.AllUniqueLabels</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Plutus.Contract.Schema.Input s),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      row-types-1.0.1.0:Data.Row.Internal.AllUniqueLabels</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Plutus.Contract.Schema.Output s),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      Plutus.Contracts.Currency.AsCurrencyError e,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Input s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx-confirmation&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.Contract.Effects.AwaitTxConfirmed.TxConfirmed,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Input s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.Contract.Effects.WriteTx.WriteTxResponse,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Output s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Ledger.Constraints.OffChain.UnbalancedTx,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Output s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx-confirmation&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.V1.Ledger.TxId.TxId) =&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     Plutus.V1.Ledger.Crypto.PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     -&gt; [(Plutus.V1.Ledger.Value.TokenName, Integer)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     -&gt; Plutus.Contract.Types.Contract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          w s e Plutus.Contracts.Currency.OneShotCurrency</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Pháº§n quan trá»ng báº¯t Ä‘áº§u vá» phÃ­a cuá»‘i, nÆ¡i mÃ  tham sá»‘ Ä‘áº§u tiÃªn - cá»§a kiá»ƒu <code>PubKeyHash</code>  - Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a. ÄÃ¢y lÃ  bÄƒm cá»§a khÃ³a cÃ´ng khai cá»§a ngÆ°á»i nháº­n NFT.</p><p>HÃ m <code>forgeContract</code>  ung cáº¥p chá»©c nÄƒng tá»•ng quÃ¡t hÆ¡n há»£p Ä‘á»“ng NFT trÆ°á»›c cá»§a chÃºng tÃ´i. NÃ³ cho phÃ©p táº¡o nhiá»u NFT trong má»™t láº§n. NÃ³ sáº½ táº¡o ra má»™t kÃ½ hiá»‡u tiá»n tá»‡ chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng má»™t, tÆ°Æ¡ng tá»± nhÆ° NFT cá»§a chÃºng tÃ´i tá»« láº§n trÆ°á»›c, vÃ¬ váº­y chá»‰ cÃ³ thá»ƒ cÃ³ má»™t giao dá»‹ch Ä‘Ãºc tiá»n. NhÆ°ng Ä‘á»‘i vá»›i má»™t biá»ƒu tÆ°á»£ng tiá»n tá»‡, báº¡n cÃ³ thá»ƒ Ä‘Ãºc nhiá»u mÃ£ thÃ´ng bÃ¡o khÃ¡c nhau trong cÃ¹ng má»™t giao dá»‹ch, vá»›i nhiá»u tÃªn mÃ£ thÃ´ng bÃ¡o khÃ¡c nhau vÃ  vá»›i sá»‘ lÆ°á»£ng khÃ¡c nhau. Tham sá»‘ thá»© hai cho phÃ©p chÃºng tÃ´i xÃ¡c Ä‘á»‹nh cÃ¡c tÃªn vÃ  sá»‘ lÆ°á»£ng mÃ£ thÃ´ng bÃ¡o nÃ y.</p><p>VÃ  nÃ³ cho chÃºng ta má»™t <code>Contract</code>  nÃ³ tráº£ vá» má»™t gia trá»‹ kiá»ƒu <code>OneShotCurrency</code>. Loáº¡i nÃ y dÃ nh riÃªng cho tiá»n tá»‡ vÃ  nÃ³ khÃ´ng thá»±c sá»± quan trá»ng Ä‘á»‘i vá»›i chÃºng tÃ´i. Táº¥t cáº£ nhá»¯ng gÃ¬ quan trá»ng Ä‘á»‘i vá»›i chÃºng tÃ´i lÃ  chÃºng tÃ´i cÃ³ thá»ƒ láº¥y láº¡i biá»ƒu tÆ°á»£ng tiá»n tá»‡ tá»« nÃ³.</p><p>CÃ³ má»™t váº¥n Ä‘á» nhá». Äiá»u nÃ y khÃ´ng tÆ°Æ¡ng thÃ­ch vá»›i nhá»¯ng gÃ¬ chÃºng tÃ´i muá»‘n. ChÃºng tÃ´i muá»‘n cÃ¡c loáº¡i nÃ y</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Contract w s Text Oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Má»™t kiá»ƒu ngÆ°á»i viáº¿t tÃ¹y Ã½ (vÃ¬ chÃºng ta khÃ´ng sá»­ dá»¥ng nÃ³), má»™t lÆ°á»£c Ä‘á»“ tÃ¹y Ã½ (miá»…n lÃ  chÃºng ta cÃ³ <code>BlockChainActions</code> sáºµn), <code>Text</code> thÃ´ng bÃ¡o lá»—i vÃ  kiá»ƒu tráº£ vá» <code>Oracle</code>.</p><p>Váº¥n Ä‘á» lÃ  giÃ¡ trá»‹ <code>Contract</code> tráº£ vá» <code>forgeContract</code> khÃ´ng cho phÃ©p <code>Text</code> thÃ´ng bÃ¡o lá»—i. Báº¡n cÃ³ thá»ƒ tháº¥y Ä‘iá»u nÃ y trong Ä‘áº§u ra chi tiáº¿t tá»« REPL - cÃ³ má»™t rÃ ng buá»™c Ä‘á»‘i vá»›i tham sá»‘ <code>e</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contracts.Currency.AsCurrencyError e,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tháº­t khÃ´ng may lÃ  <code>Text</code> khÃ´ng thá»±c hiá»‡n <code>AsCurrencyError</code>.</p><p>May máº¯n thay, cÃ³ má»™t hÃ m cÃ³ thá»ƒ trá»£ giÃºp</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contract.mapError</span></div><div class="token-line" style="color:#393A34"><span class="token plain">:: (e -&gt; e&#x27;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   -&gt; Plutus.Contract.Types.Contract w s e a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   -&gt; Plutus.Contract.Types.Contract w s e&#x27; a</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vá»›i má»™t <code>Contract</code>, nÃ³ cho phÃ©p chÃºng tÃ´i táº¡o má»›i má»™t <code>Contract</code>  vá»›i má»™t loáº¡i thÃ´ng bÃ¡o lá»—i má»›i.Äiá»u Ä‘Ã³ Ä‘Æ°á»£c cung cáº¥p, chÃºng tÃ´i cung cáº¥p má»™t hÃ m chuyá»ƒn Ä‘á»•i tá»« loáº¡i lá»—i Ä‘áº§u tiÃªn sang loáº¡i lá»—i thá»© hai.</p><p>VÃ¬ váº­y, chÃºng ta hÃ£y nhÃ¬n vÃ o hÃ m <code>startOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">startOracle :: forall w s. HasBlockchainActions s =&gt; OracleParams -&gt; Contract w s Text Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">startOracle op = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    osc &lt;- mapError (pack . show) (forgeContract pkh [(oracleTokenName, 1)] :: Contract w s CurrencyError OneShotCurrency)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let cs     = Currency.currencySymbol osc</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            { oSymbol   = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oOperator = pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oFee      = opFees op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oAsset    = AssetClass (opSymbol op, opToken op)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;started oracle &quot; ++ show oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>á» Ä‘Ã¢y chÃºng ta tháº¥y hÃ m chuyá»ƒn Ä‘á»•i lá»—i Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng  <code>pack . show</code>.
HÃ m <code>show</code>  chuyá»ƒn Ä‘á»•i lá»—i cho má»™t <code>String</code>  vÃ  hÃ m <code>pack</code>
chuyá»ƒn Ä‘á»• má»™t <code>String</code>  tá»›i má»™t kiá»ƒu <code>Data.Text</code>.</p><p>Táº¡i thá»i Ä‘iá»ƒm nÃ y <code>osc</code>  giá»¯  <code>OneShotCurrency</code>, VÃ  chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m <code>currencySymbol</code>  Ä‘á»ƒ láº¥y kÃ½ hiá»‡u tiá»n tá»‡ nhÆ°<code>cs</code>.</p><p>HÃ m <code>currencySymbol</code>  cÃ³ kiá»ƒu:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">currencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      :: OneShotCurrency -&gt; Plutus.V1.Ledger.Value.CurrencySymbol</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng phÃ¹ há»£p</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let cs = Currency.currencySymbol osc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» chÃºng tÃ´i Ä‘Ã£ Ä‘Ãºc NFT cá»§a mÃ¬nh vÃ  nÃ³ cÃ³ kÃ½ hiá»‡u tiá»n tá»‡ <code>cs</code>. Ã  bÃ¢y giá» chÃºng ta cÃ³ thá»ƒ xÃ¢y dá»±ng giÃ¡ trá»‹ tham sá»‘ <code>Oracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { oSymbol   = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oOperator = pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oFee      = opFees op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oAsset    = AssetClass (opSymbol op, opToken op)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>lÃ½ do lÃ  <code>opSymbol</code>  vÃ  <code>opToken</code> Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a riÃªng trong kiá»ƒu <code>OracleParams</code>.  <code>op</code>  há»‰ lÃ  Ä‘iá»u nÃ y lÃ m cho viá»‡c nÃ y trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n khi chÃºng ta sá»­ dá»¥ng playground.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="updating-the-oracle"></a>Updating the Oracle<a class="hash-link" href="#updating-the-oracle" title="Direct link to heading">#</a></h4><p>HÃ m <code>updateOracle</code>  lÃ  phá»©c táº¡p hÆ¡n.</p><p>Chá»©c nÄƒng nÃ y pháº£i xá»­ lÃ½ hai trÆ°á»ng há»£p. Cá»¥ thá»ƒ lÃ  trÆ°á»ng há»£p chÃºng tÃ´i cÃ³ má»™t giÃ¡ trá»‹ mÃ  chÃºng tÃ´i muá»‘n cáº­p nháº­t vÃ  trÆ°á»ng há»£p 2 chÃºng tÃ´i má»›i báº¯t Ä‘áº§u táº¡o oracle vÃ  chÃºng tÃ´i muá»‘n táº¡o má»™t giÃ¡ trá»‹ láº§n Ä‘áº§u tiÃªn.</p><p>NÃ³ láº¥y cÃ¡c tham sá»‘ oracle and <code>Integer</code> giÃ¡ trá»‹ mÃ  chÃºng tÃ´i muá»‘n cÃ³ oracle giá»¯.</p><p>Äáº§u tiÃªn, chÃºng tÃ´i táº¡o má»™t chá»©c nÄƒng trá»£ giÃºp <code>findOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">findOracle :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text (Maybe (TxOutRef, TxOutTx, Integer))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">findOracle oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- Map.filter f &lt;$&gt; utxoAt (oracleAddress oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return $ case Map.toList utxos of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [(oref, o)] -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            x &lt;- oracleValue (txOutTxOut o) $ \dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return (oref, o, x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _           -&gt; Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: TxOutTx -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f o = assetClassValueOf (txOutValue $ txOutTxOut o) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Muchj Ä‘Ã­ch cá»§a <code>findOracle</code>  lÃ  Ä‘á»ƒ tra cá»©u UTxO oracle hiá»‡n cÃ³. Äiá»u nÃ y cÃ³ thá»ƒ khÃ´ng thÃ nh cÃ´ng vÃ¬ cÃ³ thá»ƒ khÃ´ng cÃ³ tiÃªn tri á»Ÿ Ä‘Ã³. Äiá»u nÃ y sáº½ xáº£y ra náº¿u chÃºng ta má»›i báº¯t Ä‘áº§u oracles vÃ  chÆ°a táº¡o UTxO vá»›i giÃ¡ trá»‹ oracle. Tuy nhiÃªn, náº¿u chÃºng tÃ´i tÃ¬m tháº¥y nÃ³, chÃºng tÃ´i tráº£ vá» má»™t bá»™ ba chá»©a mÃ£ nháº­n dáº¡ng UTxO (TxOutRef), chÃ­nh UTxO, chá»©a táº¥t cáº£ dá»¯ liá»‡u (TxOutTx) vÃ  giÃ¡ trá»‹ oracle (tá»· giÃ¡ há»‘i Ä‘oÃ¡i hiá»‡n táº¡i do oracle náº¯m giá»¯). CÃ¡c <code>Integer</code> chá»©a giÃ¡ trá»‹ oracle Ä‘Æ°á»£c mÃ£ hÃ³a cÅ©ng trong giÃ¡ trá»‹ TxOutTx, nhÆ°ng chÃºng tÃ´i thÃªm nÃ³ vÃ o ba Ä‘á»ƒ lÃ m cho nÃ³ dá»… dÃ ng hÆ¡n Ä‘á»ƒ lÃ m viá»‡c vá»›i.</p><p>Äiá»u Ä‘áº§u tiÃªn chÃºng tÃ´i lÃ m lÃ  láº¥y táº¥t cáº£ cÃ¡c UTxO á»Ÿ Ä‘á»‹a chá»‰ nÃ y. NhÆ°ng chá»‰ má»™t trong sá»‘ nÃ y sáº½ lÃ  thá»© mÃ  chÃºng tÃ´i Ä‘ang tÃ¬m kiáº¿m - cÃ¡i cÃ³ chá»©a NFT.</p><p>ChÃºng tÃ´i thá»±c hiá»‡n Ä‘iá»u nÃ y báº±ng cÃ¡ch sá»­ dá»¥ng hÃ m <code>Map.filter</code>  nháº­n má»™t hÃ m lÃ m tham sá»‘, trong trÆ°á»ng há»£p nÃ y, tráº£ vá» True cho UTxO nÆ¡i NFT hiá»‡n diá»‡n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">utxos &lt;- Map.filter f &lt;$&gt; utxoAt (oracleAddress oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  f :: TxOutTx -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  f o = assetClassValueOf (txOutValue $ txOutTxOut o) (oracleAsset oracle) == 1    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta sáº½ káº¿t thÃºc vá»›i má»™t map <code>utxos</code> trá»‘ng hoáº·c chá»©a má»™t má»¥c. BÃ¢y giá», chÃºng ta phÃ¢n biá»‡t giá»¯a hai trÆ°á»ng há»£p nÃ y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">return $ case Map.toList utxos of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [(oref, o)] -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- oracleValue (txOutTxOut o) $ \dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (oref, o, x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _           -&gt; Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i chuyá»ƒn Ä‘á»•i báº£n Ä‘á»“ thÃ nh danh sÃ¡ch cÃ¡c bá»™ giÃ¡ trá»‹ Ä‘áº¡i diá»‡n cho cÃ¡c cáº·p giÃ¡ trá»‹ quan trá»ng cá»§a id giao dá»‹ch vÃ  chÃ­nh cÃ¡c giao dá»‹ch.</p><p>Äá»‘i vá»›i trÆ°á»ng há»£p khÃ´ng cÃ³ pháº§n tá»­, chÃºng tÃ´i sá»­ dá»¥ng trÆ°á»ng há»£p _ Ä‘á»ƒ Ä‘áº¡i diá»‡n cho táº¥t cáº£ cÃ¡c trÆ°á»ng há»£p khÃ¡c. ÄÃ¢y chá»‰ cÃ³ thá»ƒ lÃ  danh sÃ¡ch trá»‘ng, nhÆ°ng trÃ¬nh biÃªn dá»‹ch khÃ´ng biáº¿t Ä‘iá»u Ä‘Ã³.</p><p>Tuy nhiÃªn, náº¿u chÃºng tÃ´i Ä‘Ã£ tÃ¬m tháº¥y UTxO, thÃ¬ vÃ¬ chÃºng tÃ´i Ä‘Ã£ cÃ³ id vÃ  giao dá»‹ch cá»§a nÃ³, chÃºng tÃ´i chá»‰ cáº§n tÃ¬m <code>Integer</code> giÃ¡ trá»‹ cá»§a nÃ³ . Pháº§n nÃ y váº«n cÃ³ thá»ƒ sai. Máº·c dÃ¹ chÃºng tÃ´i Ä‘Ã£ tÃ¬m tháº¥y Ä‘Ãºng UTxO, nhÆ°ng cÃ³ thá»ƒ cÃ³ má»™t sá»‘ dá»¯ liá»‡u bá»‹ há»ng trong Ä‘Ã³ vÃ¬ báº¥t ká»³ lÃ½ do gÃ¬.</p><p>ChÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>oracleValue</code> mÃ  chÃºng tÃ´i cÅ©ng Ä‘Ã£ sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c thá»±c. HÃ m nÃ y nháº­n má»™t tham sá»‘ <code>TxOut</code> theo sau lÃ  má»™t tham sá»‘ thá»© hai lÃ  má»™t hÃ m, Ä‘Æ°á»£c cung cáº¥p má»™t hÃ m bÄƒm dá»¯ liá»‡u sáº½ tráº£ vá» giÃ¡ trá»‹ dá»¯ liá»‡u Ä‘Æ°á»£c liÃªn káº¿t.</p><p>Trong mÃ£ off-chain, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng tham sá»‘ hÃ m sau</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">\dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ÄÃ¢y <code>txData</code>  lÃ  má»™t trÆ°á»ng cá»§a giao dá»‹ch vÃ  nÃ³ lÃ  má»™t map tá»« hÃ m bÄƒm datum. ChÃºng tÃ´i nháº­n Ä‘Æ°á»£c giao dá»‹ch tá»« <code>txOutTxTx o</code>.</p><p>Náº¿u táº¥t cáº£ Ä‘iá»u nÃ y thÃ nh cÃ´ng, khi nÃ o sáº½ tráº£ vá» bá»™ ba <code>(oref, o, x)</code>,trong Ä‘Ã³ <code>x</code> lÃ  <code>Integer</code>  giÃ¡ trá»‹ cá»§a oracle.</p><p>BÃ¢y giá» chÃºng ta Ä‘Ã£ viáº¿t hÃ m <code>findOracle</code>. hÃºng ta cÃ³ thá»ƒ nhÃ¬n vÃ o hÃ m <code>updateOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Integer -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle oracle x = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let c = Constraints.mustPayToTheScript x $ assetClassValue (oracleAsset oracle) 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraints (oracleInst oracle) c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;set initial oracle value to &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (oref, o,  _) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            let lookups = Constraints.unspentOutputs (Map.singleton oref o)     &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.scriptInstanceLookups (oracleInst oracle) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.otherScript (oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx      = c &lt;&gt; Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Update)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraintsWith @Oracling lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;updated oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>sau Ä‘Ã³ nhÃ¬n hÃ m <code>findOracle</code>  hÃ m trá»£ giÃºp, vÃ¬ chÃºng ta sáº½ cáº§n rÃ ng buá»™c nÃ y hai láº§n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let c = Constraints.mustPayToTheScript x $ assetClassValue (oracleAsset oracle) 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau khi tÃ¬m kiáº¿m tiÃªn tri, cÃ³ ráº¥t nhiá»u kháº£ nÄƒng xáº£y ra - chÃºng tÃ´i Ä‘Ã£ tÃ¬m tháº¥y nÃ³ hoáº·c chÃºng tÃ´i Ä‘Ã£ khÃ´ng.</p><p>Náº¿u chÃºng tÃ´i khÃ´ng tÃ¬m tháº¥y nÃ³, thÃ¬ chÃºng tÃ´i Ä‘Ã£ báº¯t Ä‘áº§u tiÃªn tri nhÆ°ng chÃºng tÃ´i chÆ°a cung cáº¥p giÃ¡ trá»‹ ban Ä‘áº§u. ÄÃ¢y lÃ  trÆ°á»ng há»£p Ä‘áº§u tiÃªn. VÃ  trong trÆ°á»ng há»£p nÃ y, táº¥t cáº£ nhá»¯ng gÃ¬ chÃºng ta pháº£i lÃ m lÃ  gá»­i má»™t giao dá»‹ch táº¡o ra giÃ¡ trá»‹ Ä‘áº§u tiÃªn cho oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraints (oracleInst oracle) c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;set initial oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ÄÃ¢y lÃ  cÃ¡ch sá»­ dá»¥ng Ä‘áº§u tiÃªn cá»§a hÃ m trá»£ giÃºp <code>c</code> . NÃ³ cung cáº¥p rÃ ng buá»™c <code>mustPayToTheScript</code>  Ä‘áº£m báº£o ráº±ng giao dá»‹ch sáº½ cÃ³ Ä‘áº§u ra tráº£ cho má»™t Ä‘á»‹a chá»‰ táº­p lá»‡nh. LÃ  cÃ¡c Ä‘á»‘i sá»‘, nÃ³ láº¥y datum <code>x</code>  vÃ  NFT. Táº­p lá»‡nh mÃ  nÃ³ pháº£i tráº£ tiá»n luÃ´n lÃ  táº­p lá»‡nh náº±m trong tiÃªu Ä‘iá»ƒm - á»Ÿ Ä‘Ã¢y nÃ³ lÃ  tham sá»‘ Ä‘áº§u tiÃªn Ä‘áº¿n <code>submitTxConstraints</code>  - <code>(oracleInst oracle)</code>.</p><p>Sau Ä‘Ã³ chÃºng tÃ´i chá» xÃ¡c nháº­n vÃ  viáº¿t thÃ´ng bÃ¡o nháº­t kÃ½. VÃ  Ä‘Ã¢y lÃ  táº¥t cáº£ nhá»¯ng gÃ¬ chÃºng ta cáº§n lÃ m cho trÆ°á»ng há»£p nÃ y.</p><p>Trong trÆ°á»ng há»£p khÃ¡c, khi chÃºng tÃ´i Ä‘Ã£ cÃ³ má»™t giÃ¡ trá»‹, chÃºng tÃ´i cáº§n tham chiáº¿u Ä‘áº¿n cÃ¡c pháº§n UTxO, nhÆ°ng chÃºng tÃ´i khÃ´ng quan tÃ¢m Ä‘áº¿n dá»¯ liá»‡u hiá»‡n táº¡i, vÃ¬ chÃºng tÃ´i váº«n sáº½ cáº­p nháº­t nÃ³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Just (oref, o,  _) -&gt; do</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» nÃ³ trá»Ÿ nÃªn phá»©c táº¡p hÆ¡n má»™t chÃºt, bá»Ÿi vÃ¬ bÃ¢y giá» chÃºng ta cáº§n hai Ä‘iá»u kiá»‡n.</p><p>RÃ ng buá»™c Ä‘áº§u tiÃªn cÅ©ng giá»‘ng nhÆ° trong trÆ°á»ng há»£p khÃ¡c - rÃ ng buá»™c Ä‘Æ°á»£c tham chiáº¿u bá»Ÿi hÃ m trá»£ giÃºp <code>c</code>. NhÆ°ng bÃ¢y giá» cÃ³ má»™t háº¡n cháº¿ bá»• sung lÃ  chÃºng ta cÅ©ng pháº£i sá»­ dá»¥ng UTxO hiá»‡n cÃ³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">tx = c &lt;&gt; Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Update)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>mustSpendScriptOutput</code>  cÆ¡ báº£n lÃ  trÃ¡i ngÆ°á»£c vá»›i <code>mustPayToTheScript</code>. ItNÃ³ táº¡o ra má»™t Ä‘áº§u vÃ o cho Ä‘á»‹a chá»‰ táº­p lá»‡nh nÃ y. VÃ¬ cÃ¡c tham sá»‘, nÃ³ cÃ³ tham chiáº¿u Ä‘áº¿n UTxO mÃ  chÃºng ta muá»‘n sá»­ dá»¥ng, vÃ  nÃ³ cáº§n má»™t <code>Redeemer</code>. Trong trÆ°á»ng há»£p <code>Redeemer</code>  lÃ  <code>Update</code>  nÃ³ Ä‘Æ°á»£c chuyá»ƒn Ä‘á»•i thÃ nh kiá»ƒu <code>Data</code>  trong Plutus.</p><p>Äá»ƒ Ä‘iá»u nÃ y hoáº¡t Ä‘á»™ng, chÃºng tÃ´i cáº§n cung cáº¥p má»™t sá»‘ tra cá»©u.</p><p>Nháº±m má»¥c Ä‘Ã­ch tÃ¬m Ä‘áº§u ra <code>oref</code>  mÃ  nÃ³ muá»‘n chi tiÃªu, chÃºng ta pháº£i sá»­ dá»¥ng <code>unspentOutputs</code>  tra cá»©u vÃ  trong trÆ°á»ng há»£p nÃ y, chÃºng ta chá»‰ cung cáº¥p tra cá»©u báº±ng má»™t UTxO.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.unspentOutputs (Map.singleton oref o)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i pháº£i cung cáº¥p cÃ¡c phiÃªn báº£n script. ChÃºng ta cáº§n lÃ m Ä‘iá»u nÃ y hai láº§n, má»™t láº§n cho phÃ­a Ä‘áº§u vÃ o vÃ  má»™t láº§n cho phÃ­a Ä‘áº§u ra. Äá»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i cung cáº¥p phiÃªn báº£n oracle vÃ  trÃ¬nh xÃ¡c thá»±c oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.scriptInstanceLookups (oracleInst oracle) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.otherScript (oracleValidator oracle)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i khÃ´ng cáº§n cung cáº¥p <code>scriptInstanceLookups</code>  tra cá»©u trong trÆ°á»ng há»£p Ä‘áº§u tiÃªn, vÃ¬ chÃºng tÃ´i cÃ³ thá»ƒ chuyá»ƒn <code>oracleInst oracle</code>  Ä‘áº¿n hÃ m <code>submitTxConstraints</code>. Tuy nhiÃªn, vá»›i hÃ m <code>submitTxConstraintsWith</code> thÃ¬ chÃºng ta khÃ´ng cÃ³ tÃ¹y chá»n Ä‘Ã³.</p><p>Khi gá»­i giao dá»‹ch, chÃºng ta cáº§n thÃºc Ä‘áº©y trÃ¬nh biÃªn dá»‹ch má»™t chÃºt Ä‘á»ƒ cho nÃ³ biáº¿t script mÃ  chÃºng ta Ä‘ang nÃ³i Ä‘áº¿n - Ä‘á»ƒ nÃ³ biáº¿t, cháº³ng háº¡n nhÆ° The Script á»Ÿ trong <code>mustPayToTheScript</code>.  Äá»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i tham kháº£o loáº¡i <code>Oracling</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraintsWith @Oracling lookups tx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hy vá»ng ráº±ng bÃ¢y giá» chÃºng ta cÃ³ má»™t giao dá»‹ch há»£p lá»‡ Ä‘Æ°á»£c gá»­i Ä‘i, vÃ  sau Ä‘Ã³ chÃºng ta Ä‘á»£i nÃ³ Ä‘Æ°á»£c xÃ¡c nháº­n vÃ  viáº¿t má»™t sá»‘ thÃ´ng tin ghi nháº­t kÃ½.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;updated oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y nhá»› ráº±ng, chÃºng ta Ä‘Ã£ nÃ³i vá» viá»‡c thu phÃ­ trÆ°á»›c Ä‘Ã³. Äiá»u nÃ y sáº½ tá»± Ä‘á»™ng xáº£y ra. HÃ m <code>submitTxConstraintsWith</code> sáº½ gá»­i phÃ­ Ä‘áº¿n vÃ­ cá»§a chÃ­nh chÃºng ta. NÃ³ lÃ m Ä‘Æ°á»£c Ä‘iá»u nÃ y bá»Ÿi vÃ¬ cÃ³ sá»± máº¥t cÃ¢n báº±ng giá»¯a giÃ¡ trá»‹ gáº¯n vá»›i Ä‘áº§u vÃ o, bao gá»“m phÃ­ vÃ  NFT, vÃ  giÃ¡ trá»‹ mÃ  chÃºng tÃ´i Ä‘Ã£ nÃ³i pháº£i Ä‘Æ°á»£c tráº£ cho táº­p lá»‡nh, Ä‘Ã³ chá»‰ lÃ  NFT.</p><p>QuÃ¡ trÃ¬nh nÃ y cÅ©ng sáº½ tá»± Ä‘á»™ng táº¡o thÃªm má»™t Ä‘áº§u vÃ o tá»« Ä‘áº§u vÃ o cá»§a chÃ­nh chÃºng ta Ä‘á»ƒ tráº£ phÃ­ giao dá»‹ch cho viá»‡c thá»±c hiá»‡n giao dá»‹ch.</p><p>Cuá»‘i cÃ¹ng, chÃºng tÃ´i cung cáº¥p má»™t chá»©c nÄƒng káº¿t há»£p hai hoáº¡t Ä‘á»™ng nÃ y <code>startOracle</code> vÃ  <code>updateOracle</code> thÃ nh má»™t há»£p Ä‘á»“ng. Äiá»u nÃ y sáº½ lÃ m cho nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng trong sÃ¢n chÆ¡i vÃ  <code>EmulatorTrace</code> monad, cÅ©ng nhÆ° trong PAB.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type OracleSchema = BlockchainActions .\/ Endpoint &quot;update&quot; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">runOracle :: OracleParams -&gt; Contract (Last Oracle) OracleSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">runOracle op = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- startOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tell $ Last $ Just oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: Oracle -&gt; Contract (Last Oracle) OracleSchema Text a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- endpoint @&quot;update&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        updateOracle oracle x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>TrÆ°á»›c tiÃªn hÃ m <code>runOracle</code>  khá»Ÿi Ä‘á»™ng oracle. sau Ä‘Ã³, vÃ¬ nhá»¯ng lÃ½ do sáº½ trá»Ÿ nÃªn rÃµ rÃ ng sau nÃ y, chÃºng tÃ´i sá»­ dá»¥ng <code>tell</code>  Ä‘á»ƒ viáº¿t tham sá»‘ cho oracle. ChÃºng ta cáº§n cÃ³ kháº£ nÄƒng giao tiáº¿p giÃ¡ trá»‹ tham sá»‘ cá»§a oracle vá»›i tháº¿ giá»›i bÃªn ngoÃ i, Ä‘á»ƒ má»i ngÆ°á»i cÃ³ thá»ƒ sá»­ dá»¥ng oracle. ChÃºng tÃ´i sáº½ khÃ´ng biáº¿t cho Ä‘áº¿n khi cháº¡y kÃ½ hiá»‡u tiá»n tá»‡ sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng cho NFT, vÃ¬ váº­y chÃºng tÃ´i chÆ°a biáº¿t giÃ¡ trá»‹ cá»§a tham sá»‘ oracle.</p><p>HÃ£y nhá»› ráº±ng <code>tell</code>  mong Ä‘á»£i loáº¡i <code>Monoid</code>. VÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  má»™t danh sÃ¡ch cÃ¡c chuá»—i Ä‘Æ°á»£c ná»‘i vá»›i má»™t danh sÃ¡ch táº¥t cáº£ cÃ¡c thÃ´ng bÃ¡o nháº­t kÃ½.</p><p>NhÆ°ng nÃ³ khÃ´ng pháº£i lÃ  danh sÃ¡ch. Trong <code>Data.Monoid</code> ChÃºng tÃ´i cÃ³  <code>Last</code> Monoid.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Data.Monoid (Last (..))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; :i Last</span></div><div class="token-line" style="color:#393A34"><span class="token plain">type Last :: ` -&gt; `</span></div><div class="token-line" style="color:#393A34"><span class="token plain">newtype Last a = Last {getLast :: Maybe a}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Applicative Last -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Eq a =&gt; Eq (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Functor Last -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Monad Last -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Monoid (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Ord a =&gt; Ord (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Semigroup (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Show a =&gt; Show (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Read a =&gt; Read (Last a) -- Defined in â€˜Data.Monoidâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Traversable Last -- Defined in â€˜Data.Traversableâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Foldable Last -- Defined in â€˜Data.Foldableâ€™</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta tháº¥y ráº±ng nÃ³ chá»‰ lÃ  má»™t cÃ¡i  <code>newtype</code>  bao bá»c xung quanh <code>Maybe</code>.Váº¥n Ä‘á» lÃ  cung cáº¥p má»™t vÃ­ dá»¥ cá»¥ thá»ƒ <code>Monoid</code>. TÃ tÆ°á»Ÿng, nhÆ° tÃªn cho tháº¥y, Ä‘Ã³ lÃ  má»™t hoáº¡t Ä‘á»™ng Ä‘Æ¡n nguyÃªn luÃ´n ghi nhá»› giÃ¡ trá»‹ Just cuá»‘i cÃ¹ng.
VÃ­ dá»¥:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; Last (Just &#x27;x&#x27;) &lt;&gt; Last (Just &#x27;y&#x27;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Last {getLast = Just &#x27;y&#x27;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tuy nhiÃªn, náº¿u cÃ¡i thá»© hai  <code>Last</code> lÃ  khÃ´ng cÃ³ gÃ¬, nÃ³ sáº½ tráº£ vá» cÃ¡i Ä‘áº§u tiÃªn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; Last (Just &#x27;x&#x27;) &lt;&gt; Last Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Last {getLast = Just &#x27;x&#x27;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u cáº£ hai Ä‘á»u <code>Nothing</code>, nÃ³ sáº½ lÃ  <code>Nothing</code>.</p><p><code>Last</code>  ráº¥t há»¯u Ã­ch vÃ¬ nÃ³ cho phÃ©p chÃºng ta giá»¯ nguyÃªn tráº¡ng thÃ¡i hiá»‡n táº¡i. GiÃ¡ trá»‹ cá»§a nháº­t kÃ½ vá» cÆ¡ báº£n sáº½ lÃ  giÃ¡ trá»‹ cuá»‘i cÃ¹ng <code>Just</code> mÃ  chÃºng tÃ´i Ä‘Ã£ nÃ³i.</p><p>Trong há»£p Ä‘á»“ng nÃ y, chÃºng tÃ´i sáº½ chá»‰ lÃ m Ä‘iá»u Ä‘Ã³ má»™t láº§n. Ban Ä‘áº§u nÃ³ sáº½ nhÆ° váº­y <code>Last Nothing</code>. Sau Ä‘Ã³, chÃºng tÃ´i Ä‘Ãºc NFT, vÃ  sau Ä‘Ã³, khi chÃºng tÃ´i nháº­n Ä‘Æ°á»£c giÃ¡ trá»‹ oracle trong <code>runOracle</code>, vÃ  sau Ä‘Ã³ <code>tell</code> nÃ³ luÃ´n lÃ  giÃ¡ trá»‹ Ä‘Ã³. Náº¿u cÃ¡c há»£p Ä‘á»“ng khÃ¡c tá»« bÃªn ngoÃ i truy váº¥n tráº¡ng thÃ¡i, chÃºng sáº½ luÃ´n nháº­n Ä‘Æ°á»£c <code>Just oracle</code>, vÃ¬ váº­y chÃºng sáº½ cÃ³ thá»ƒ khÃ¡m phÃ¡ giÃ¡ trá»‹ cá»§a oracle.</p><p>VÃ¬ váº­y, tiáº¿p theo trong <code>runOracle</code>, hÃºng tÃ´i gá»i hÃ m trá»£ giÃºp <code>go</code>. Äiá»u nÃ y lÃ  cháº·n endpoint update. Ngay sau khi ai Ä‘Ã³ cung cáº¥p má»™t <code>Integer</code> nhÆ° lÃ  má»™t giÃ¡ trá»‹ má»›i, nÃ³ sáº½ gá»i hÃ m  <code>updateOracle</code> vá»›i má»™t giÃ¡ trá»‹ má»›i, sau Ä‘Ã³ láº·p láº¡i Ä‘á»ƒ cho phÃ©p ngÆ°á»i khÃ¡c cáº­p nháº­t oracle..</p><p>TÃ³m láº¡i, <code>runOracle</code> khá»Ÿi Ä‘á»™ng <code>oracle</code>, <code>tell</code> lÃ  <code>oracle</code>, sau Ä‘Ã³ láº·p láº¡i Ä‘á»ƒ cho phÃ©p ngÆ°á»i khÃ¡c cáº­p nháº­t oracle.</p><p>VÃ  Ä‘iá»u Ä‘Ã³ káº¿t thÃºc mÃ£ cho chÃ­nh nhÃ  tiÃªn tri. Nhá»¯ng gÃ¬ hiá»‡n cÃ²n thiáº¿u lÃ  má»™t vÃ­ dá»¥, má»™t há»£p Ä‘á»“ng thá»±c sá»± sá»­ dá»¥ng oracle - má»™t há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i. VÃ  cÅ©ng sá»­ dá»¥ng Plutus Application Backend Ä‘á»ƒ cháº¡y mÃ£ nÃ y trong tháº¿ giá»›i thá»±c hoáº·c trong trÆ°á»ng há»£p cá»§a chÃºng tÃ´i lÃ  trong má»™t chuá»—i khá»‘i mÃ´ phá»ng.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="xÃ¡c-thá»±c-hoÃ¡n-Ä‘á»•iswap-validation"></a>XÃ¡c thá»±c hoÃ¡n Ä‘á»•i(Swap Validation)<a class="hash-link" href="#xÃ¡c-thá»±c-hoÃ¡n-Ä‘á»•iswap-validation" title="Direct link to heading">#</a></h2><p>Há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i máº«u cá»§a chÃºng tÃ´i cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¬m tháº¥y trong:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.swap</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Má»¥c Ä‘Ã­ch cá»§a há»£p Ä‘á»“ng nÃ y lÃ  Ä‘á»ƒ ai Ä‘Ã³ cÃ³ thá»ƒ kÃ½ gá»­i ADA vÃ  Ä‘á»•i nÃ³ láº¥y mÃ£ thÃ´ng bÃ¡o, trong trÆ°á»ng há»£p nÃ y lÃ  token mÃ  chÃºng tÃ´i sá»­ dá»¥ng sáº½ gá»i lÃ  USDT lÃ  token USD.</p><p>Ã tÆ°á»Ÿng lÃ  giÃ¡, sá»‘ lÆ°á»£ng USDT sáº½ Ä‘Æ°á»£c yÃªu cáº§u thanh toÃ¡n cho ADA, sáº½ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi giÃ¡ trá»‹ cá»§a oracle. HÃ£y nhá»› ráº±ng chÃºng tÃ´i Ä‘ang sá»­ dá»¥ng má»™t <code>Integer</code> Ä‘á»ƒ pháº£n Ã¡nh tá»· giÃ¡ há»‘i Ä‘oÃ¡i, vá»›i giÃ¡ trá»‹ má»™t triá»‡u tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i má»™t USDT.</p><p>ChÃºng ta sáº½ báº¯t Ä‘áº§u vá»›i má»™t hÃ m trá»£ giÃºp Ä‘Æ°á»£c gá»i lÃ  <code>price</code>, vá»›i má»™t sá»‘ lovelace vÃ  tá»· giÃ¡ há»‘i Ä‘oÃ¡i, sáº½ tráº£ vá» giÃ¡ USDT.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">price :: Integer -&gt; Integer -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">price lovelace exchangeRate = (lovelace ` exchangeRate) `divide` 1000000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiáº¿p theo lÃ  hÃ m trá»£ giÆ°ps <code>lovelaces</code>,  káº¿t há»£p vá»›i cÃ¡c hÃ m tá»« thÆ° viá»‡n Plutus Ä‘á»ƒ trÃ­ch xuáº¥t má»™t sá»‘ lovelace tá»« má»™t kiá»ƒu <code>Value</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">lovelaces :: Value -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">lovelaces = Ada.getLovelace . Ada.fromValue    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» chÃºng ta sáº½ viáº¿t <code>mkSwapValidator</code>. ÄÃ¢y lÃ  má»™t trÃ¬nh xÃ¡c thá»±c Ä‘Æ°á»£c tham sá»‘ hÃ³a vá»›i hai tham sá»‘.</p><p>Tham sá»‘ Ä‘áº§u tiÃªn lÃ  oracle mÃ  chÃºng ta Ä‘ang sá»­ dá»¥ng. Äá»ƒ sá»­ dá»¥ng Ä‘iá»u nÃ y, chÃºng tÃ´i nháº­p mÃ´-Ä‘un oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">import Week06.Oracle.core</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tham sá»‘ thá»© hai lÃ  Ä‘á»‹a chá»‰ cá»§a oracle. ThÃ´ng thÆ°á»ng, vá»›i oracle , chÃºng ta sáº½ cÃ³ thá»ƒ tÃ­nh toÃ¡n Ä‘á»‹a chá»‰ tá»« nÃ³. Trong mÃ´-Ä‘un cá»‘t lÃµi, chÃºng tÃ´i Ä‘Ã£ tháº¥y má»™t hÃ m <code>oracleAddress</code> thá»±c hiá»‡n Ä‘iá»u nÃ y cho chÃºng tÃ´i. NhÆ°ng Ä‘Ã¢y lÃ  má»™t chá»©c nÄƒng mÃ  chÃºng tÃ´i khÃ´ng thá»ƒ sá»­ dá»¥ng trong trÃ¬nh xÃ¡c thá»±c, vÃ¬ nÃ³ khÃ´ng thá»ƒ Ä‘Æ°á»£c biÃªn dá»‹ch sang táº­p lá»‡nh Plutus. VÃ¬ váº­y, á»Ÿ Ä‘Ã¢y, chÃºng tÃ´i Ä‘Æ°a Ä‘á»‹a chá»‰ má»™t cÃ¡ch rÃµ rÃ ng cho trÃ¬nh xÃ¡c thá»±c.</p><p>Äá»‘i vá»›i dá»¯ liá»‡u, chÃºng tÃ´i sá»­ dá»¥ng mÃ£ bÄƒm khÃ³a cÃ´ng khai cá»§a ngÆ°á»i bÃ¡n. ChÃºng tÃ´i khÃ´ng sá»­ dá»¥ng cÃ´ng cá»¥ Ä‘á»•i quÃ , vÃ¬ váº­y chÃºng tÃ´i cung cáº¥p cho nÃ³ má»™t loáº¡i <code>Unit</code>.</p><p>ChÃºng tÃ´i nhá»› láº¡i tá»« sÆ¡ Ä‘á»“, giao dá»‹ch hoÃ¡n Ä‘á»•i pháº£i cÃ³ ba Ä‘áº§u vÃ o vÃ  ba Ä‘áº§u ra.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><hr><p>  Inputs                              Outputs</p><hr><p> Oracle, Äá»ƒ kiá»ƒm tra Oracle hiá»‡n táº¡i, cÃ¡i mÃ  chÃºng ta khÃ´ng cáº§n xem xÃ©t tá»· giÃ¡ há»‘i Ä‘oÃ¡i trong xÃ¡c nháº­n hoÃ¡n Ä‘á»•i</p><p>UTxO hoÃ¡n Ä‘á»•i giá»¯ cÃ¡c token lovelace cá»§a ngÆ°á»i bÃ¡n                            </p><p>  The source of the buyer\&#x27;s funds    The lovelace for the buyer</p><hr><p>HoÃ¡n Ä‘á»•i Ä‘áº§u vÃ o Ä‘áº§u ra giao dá»‹ch:</p><p>LÆ°u Ã½ ráº±ng chÃºng ta khÃ´ng cáº§n pháº£i lo láº¯ng vá» oracle nhÆ° má»™t Ä‘áº§u ra. TrÃ¬nh xÃ¡c thá»±c oracle sáº½ Ä‘áº£m báº£o ráº±ng giÃ¡ trá»‹ khÃ´ng bá»‹ thay Ä‘á»•i vÃ  cÃ¡c khoáº£n phÃ­ Ä‘Æ°á»£c thÃªm vÃ o.</p><p>ChÃºng tÃ´i cÅ©ng muá»‘n há»— trá»£ trÆ°á»ng há»£p sá»­ dá»¥ng thá»© hai, trÆ°á»ng há»£p ngÆ°á»i bÃ¡n cÃ³ thá»ƒ láº¥y token ADA trong trÆ°á»ng há»£p há» khÃ´ng muá»‘n thá»±c hiá»‡n hoÃ¡n Ä‘á»•i ná»¯a. Náº¿u chÃºng tÃ´i khÃ´ng há»— trá»£ trÆ°á»ng há»£p nÃ y, ADA cÃ³ thá»ƒ bá»‹ khÃ³a á»Ÿ Ä‘Ã³ mÃ£i mÃ£i, náº¿u khÃ´ng ai quyáº¿t Ä‘á»‹nh thá»±c hiá»‡n hoÃ¡n Ä‘á»•i.</p><p>TrÆ°á»ng há»£p thá»© hai nÃ y lÃ  Ä‘iá»u kiá»‡n chÃºng tÃ´i kiá»ƒm tra trong trÃ¬nh xÃ¡c thá»±c. Náº¿u ngÆ°á»i bÃ¡n tá»± mÃ¬nh kÃ½ vÃ o giao dá»‹ch, thÃ¬ khÃ´ng cÃ³ báº¥t ká»³ rÃ ng buá»™c nÃ o ná»¯a - chÃºng tÃ´i khÃ´ng cáº§n kiá»ƒm tra oracle hay báº¥t cá»© thá»© gÃ¬ khÃ¡c - ngÆ°á»i bÃ¡n chá»‰ cÃ³ thá»ƒ láº¥y láº¡i lovelace cá»§a há».</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mkSwapValidator :: Oracle -&gt; Address -&gt; PubKeyHash -&gt; () -&gt; ScriptContext -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkSwapValidator oracle addr pkh () ctx =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    txSignedBy info pkh ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...            </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>TrÆ°á»ng há»£p thÃº vá»‹ hÆ¡n lÃ  trÆ°á»ng há»£p thá»© hai, nÆ¡i chÃºng tÃ´i kiá»ƒm tra hai Ä‘iá»u kiá»‡n.</p><p>Äáº§u tiÃªn, pháº£i cÃ³ hai Ä‘áº§u vÃ o - oracle vÃ  UTxO hoÃ¡n Ä‘á»•i. Táº¥t cáº£ cÃ¡c Ä‘áº§u vÃ o bá»• sung (tiá»n cá»§a ngÆ°á»i mua) pháº£i lÃ  Ä‘áº§u vÃ o khÃ³a cÃ´ng khai. Äiá»u nÃ y lÃ  do chÃºng tÃ´i khÃ´ng muá»‘n lo láº¯ng vá» viá»‡c can thiá»‡p vÃ o cÃ¡c há»£p Ä‘á»“ng thÃ´ng minh khÃ¡c.</p><p>Thá»© hai, chÃºng tÃ´i muá»‘n kiá»ƒm tra xem ngÆ°á»i bÃ¡n cÃ³ Ä‘Æ°á»£c thanh toÃ¡n hay khÃ´ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">(traceIfFalse &quot;expected exactly two script inputs&quot; hasTwoScriptInputs &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> traceIfFalse &quot;price not paid&quot;                     sellerPaid)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá», chÃºng ta cÃ³ cÃ¡c Ä‘á»‹nh nghÄ©a vá» hÃ m trá»£ giÃºp cá»§a chÃºng ta.</p><p>Äáº§u tiÃªn:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">info = scriptContextTxInfo ctx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng ta pháº£i dÃ¹ng <code>oracleInput</code>  Ä‘á»ƒ láº¥y UTxO tá»« oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInput =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ins = [ o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          | i &lt;- txInfoInputs info</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          , let o = txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          , txOutAddress o == addr</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          ]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case ins of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _   -&gt; traceError &quot;expected exactly one oracle input&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i thá»±c hiá»‡n Ä‘iá»u nÃ y báº±ng cÃ¡ch láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c Ä‘áº§u vÃ o. Äá»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i sá»­ dá»¥ng kháº£ nÄƒng hiá»ƒu danh sÃ¡ch, cho phÃ©p chÃºng tÃ´i láº¥y tá»« cÃ¡c danh sÃ¡ch khÃ¡c báº±ng bá»™ lá»c. Trong trÆ°á»ng há»£p nÃ y, chÃºng tÃ´i láº¥y tá»« danh sÃ¡ch tá»« <code>txInfoInputs info</code>, Ä‘Ã³ lÃ  danh sÃ¡ch cá»§a <code>TxInfo</code>. ChÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>txInInfoResolved</code>  Ä‘á»ƒ xem má»—i pháº§n tá»­ kiá»ƒu <code>TxOut</code>, sau Ä‘Ã³ chÃºng tÃ´i so sÃ¡nh vá»›i tham sá»‘ <code>addr</code>. Danh sÃ¡ch káº¿t quáº£ sáº½ trá»‘ng hoáº·c sáº½ cÃ³ danh sÃ¡ch <code>TxOut</code> phÃ¹ há»£p vá»›i UTxO oracle.</p><p>Sau Ä‘Ã³, chÃºng tÃ´i kiá»ƒm tra xem cÃ³ chÃ­nh xÃ¡c má»™t pháº§n tá»­ trong danh sÃ¡ch káº¿t quáº£ hay khÃ´ng, vÃ  náº¿u cÃ³, chÃºng tÃ´i tráº£ vá» nÃ³. ChÃºng tÃ´i khÃ´ng tráº£ láº¡i danh sÃ¡ch, chá»‰ tráº£ láº¡i <code>TxOut</code>.</p><p>Äiá»u nÃ y hiá»‡n Ä‘Ã£ cho chÃºng ta káº¿t quáº£ Ä‘áº§u ra ká»³ diá»‡u mÃ  chÃºng ta Ä‘ang sá»­ dá»¥ng lÃ m Ä‘áº§u vÃ o.</p><p>BÃ¢y giá», chÃºng tÃ´i muá»‘n kiá»ƒm tra tá»· giÃ¡ há»‘i Ä‘oÃ¡i thá»±c táº¿. Äá»‘i vá»›i Ä‘iá»u Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>oracleValue</code>   mÃ  chÃºng tÃ´i Ä‘Ã£ xÃ¡c Ä‘á»‹nh trong mÃ´-Ä‘un cá»‘t lÃµi. á» Ä‘Ã¢y má»™t láº§n ná»¯a, nÃ³ cÃ³ thá»ƒ thÃ nh cÃ´ng, hoáº·c nÃ³ cÃ³ thá»ƒ tháº¥t báº¡i. Náº¿u nÃ³ thÃ nh cÃ´ng, chÃºng tÃ´i tráº£ vá» giÃ¡ trá»‹.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue&#x27; = case oracleValue oracleInput (`findDatum` info) of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing -&gt; traceError &quot;oracle value not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Just x  -&gt; x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta khÃ´ng cáº§n kiá»ƒm tra xem oracle cÃ³ chá»©a NFT hay khÃ´ng. Do cÃ¡ch thá»©c hoáº¡t Ä‘á»™ng cá»§a xÃ¡c thá»±c Ä‘á»‘i vá»›i oracle, chÃºng ta biáº¿t ráº±ng nÃ³ hiá»‡n diá»‡n..</p><p>BÃ¢y giá», chÃºng ta hÃ£y xem xÃ©t hÃ m trá»£ giÃºp <code>hasTwoScriptInputs</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">hasTwoScriptInputs :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hasTwoScriptInputs =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    xs = filter (isJust . toValidatorHash . txOutAddress . txInInfoResolved) $ txInfoInputs info</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    length xs == 2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äáº§u tiÃªn, chÃºng tÃ´i lá»c, sá»­ dá»¥ng hÃ m tá»•ng há»£p</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">(isJust . toValidatorHash . txOutAddress . txInInfoResolved)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äá»c tá»« pháº£i sang trÃ¡i, chÃºng ta nháº­n Ä‘Æ°á»£c UTxO tá»« Ä‘áº§u vÃ o, sau Ä‘Ã³ chÃºng ta nháº­n Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cho UTxO nÃ y, vÃ  chÃºng ta nháº­n Ä‘Æ°á»£c mÃ£ bÄƒm cá»§a trÃ¬nh xÃ¡c thá»±c cho Ä‘á»‹a chá»‰ Ä‘Ã³. Cuá»‘i cÃ¹ng, chÃºng ta kiá»ƒm tra xem nÃ³ cÃ³ pháº£i lÃ  Ä‘áº§u ra táº­p lá»‡nh hay khÃ´ng, báº±ng cÃ¡ch xem nÃ³ cÃ³ pháº£i lÃ  <code>Just</code>. Náº¿u nÃ³ lÃ   <code>Nothing</code>, thÃ¬ Ä‘iá»u nÃ y sáº½ cho tháº¥y ráº±ng nÃ³ lÃ  má»™t khÃ³a cÃ´ng khai, khÃ´ng pháº£i lÃ  má»™t Ä‘á»‹a chá»‰ táº­p lá»‡nh.</p><p>Sau Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng hÃ m tá»•ng há»£p nÃ y nhÆ° má»™t bá»™ lá»c dá»±a trÃªn danh sÃ¡ch cÃ¡c <code>TxInInfos</code>. VÃ  sau Ä‘Ã³ chÃºng tÃ´i kiá»ƒm tra Ä‘á»™ dÃ i cá»§a danh sÃ¡ch káº¿t quáº£ lÃ  chÃ­nh xÃ¡c hai.</p><p>Quay trá»Ÿ láº¡i cÃ¡c Ä‘iá»u kiá»‡n xÃ¡c thá»±c cá»§a chÃºng ta, bÃ¢y giá» chÃºng ta pháº£i lÃ m vá»›i viá»‡c kiá»ƒm tra xem ngÆ°á»i bÃ¡n cÃ³ Ä‘Æ°á»£c thanh toÃ¡n hay khÃ´ng. VÃ¬ váº­y, hÃ£y viáº¿t hÃ m <code>sellerPaid</code> mÃ  chÃºng ta Ä‘Ã£ tham chiáº¿u.</p><p>Äá»‘i vá»›i Ä‘iá»u nÃ y, chÃºng tÃ´i sáº½ sá»­ dá»¥ng má»™t hÃ m trá»£ giÃºp khÃ¡c Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giÃ¡ yÃªu cáº§u.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">minPrice :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">minPrice =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    lovelaceIn = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; traceError &quot;own input not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just i  -&gt; lovelaces $ txOutValue $ txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    price lovelaceIn oracleValue&#x27;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>TrÆ°á»›c tiÃªn, chÃºng tÃ´i kiá»ƒm tra xem chÃºng tÃ´i cÃ³ má»™t Ä‘áº§u vÃ o hay khÃ´ng, vÃ  náº¿u cÃ³, chÃºng tÃ´i trÃ­ch xuáº¥t sá»‘ lÆ°á»£ng khoáº£ng cÃ¡ch vÃ  gÃ¡n sá»‘ Ä‘Ã³ cho <code>lovelaceIn</code>. Sau Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>price</code> Ä‘á»ƒ xÃ¡c Ä‘á»‹nh giÃ¡ báº±ng token USDT.</p><p>BÃ¢y giá», chÃºng ta cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a hÃ m <code>sellerPaid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">sellerPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sellerPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid =  assetClassValueOf (valuePaidTo info pkh) (oAsset oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid &gt;= minPrice</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>valuePaidTo</code>  nÃ y lÃ  tá»« cÃ¡c thÆ° viá»‡n Plutus. ÄÃ£ cho <code>info</code> vÃ  má»™t bÄƒm khÃ³a cÃ´ng khai, nÃ³ sáº½ cá»™ng táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ cá»§a táº¥t cáº£ cÃ¡c Ä‘áº§u ra khÃ³a cÃ´ng khai Ä‘i Ä‘áº¿n Ä‘á»‹a chá»‰ nÃ y. Sau Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng <code>assetClassValueOf</code> Ä‘á»ƒ kiá»ƒm tra thÃ nh pháº§n cá»§a giÃ¡ trá»‹ cÃ³ trong mÃ£ thÃ´ng bÃ¡o USD vÃ  kiá»ƒm tra xem chÃºng tÃ´i cÃ³ Ã­t nháº¥t bao nhiÃªu tÃ¹y theo yÃªu cáº§u cá»§a chÃºng tÃ´i.</p><p>ÄÃ³ lÃ  chá»©c nÄƒng cuá»‘i cá»§a pháº§n chÃ­nh trong mÃ£ trÃ¬nh xÃ¡c thá»±c hoÃ¡n Ä‘á»•i. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ScriptType Swapping where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Swapping = PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Swapping = ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapInst :: Oracle -&gt; Scripts.ScriptInstance Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapInst oracle = Scripts.validator @Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ($$(PlutusTx.compile [|| mkSwapValidator ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        `PlutusTx.applyCode` PlutusTx.liftCode oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        `PlutusTx.applyCode` PlutusTx.liftCode (oracleAddress oracle))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @PubKeyHash @()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapValidator :: Oracle -&gt; Validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapValidator = Scripts.validatorScript . swapInst</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapAddress :: Oracle -&gt; Ledger.Address</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapAddress = scriptAddress . swapValidator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>LÆ°u Ã½ ráº±ng trong hÃ m <code>swapInst</code>, nÆ¡i chÃºng ta sá»­ dá»¥ng hÃ m bÄƒm máº«u Ä‘á»ƒ táº¡o trÃ¬nh xÃ¡c thá»±c Plutus tá»« hÃ m <code>mkSwapValidator</code>, chÃºng tÃ´i khÃ´ng cáº§n chuyá»ƒn Ä‘á»‹a chá»‰ oracle lÃ m tham sá»‘. Äiá»u nÃ y lÃ  do chÃºng tÃ´i sáº½ tÃ­nh toÃ¡n Ä‘iá»u nÃ y bÃªn trong hÃ m. HÃ£y nhá»› ráº±ng chÃºng ta khÃ´ng thá»ƒ sá»­ dá»¥ng hÃ m <code>oracleAddress</code>  bÃªn trong trÃ¬nh xÃ¡c thá»±c Plutus.</p><p>BÃ¢y giá» Ä‘á»ƒ xÃ¡c Ä‘á»‹nh má»™t sá»‘ há»£p Ä‘á»“ng.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="chÃ o-hÃ ng-offerswap"></a>ChÃ o hÃ ng (offerSwap)<a class="hash-link" href="#chÃ o-hÃ ng-offerswap" title="Direct link to heading">#</a></h3><p>Äáº§u tiÃªn <code>offerSwap</code>. Äiá»u nÃ y dÃ nh cho ngÆ°á»i bÃ¡n muá»‘n Ä‘Æ°a ra má»™t sá»‘ lÆ°á»£ng nháº¥t Ä‘á»‹nh Ä‘á»ƒ trao Ä‘á»•i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">offerSwap :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Integer -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">offerSwap oracle amt = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let tx = Constraints.mustPayToTheScript pkh $ Ada.lovelaceValueOf amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ledgerTx &lt;- submitTxConstraints (swapInst oracle) tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;offered &quot; ++ show amt ++ &quot; lovelace for swap&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="findswaps"></a>findSwaps<a class="hash-link" href="#findswaps" title="Direct link to heading">#</a></h3><p>Tiáº¿p theo, má»™t hÃ m trá»£ giÃºp sáº½ tÃ¬m táº¥t cáº£ cÃ¡c hoÃ¡n Ä‘á»•i thá»a mÃ£n má»™t vá»‹ tháº¿ nháº¥t Ä‘á»‹nh. NÃ³ cáº§n má»™t oracle cá»™ng vá»›i má»™t vá»‹ tháº¿ dá»±a trÃªn hÃ m bÄƒm khÃ³a cÃ´ng khai vÃ  tráº£ vá» danh sÃ¡ch bá»™ ba UTxO thá»a mÃ£n vá»‹ tháº¿.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">findSwaps :: HasBlockchainActions s =&gt; Oracle -&gt; (PubKeyHash -&gt; Bool) -&gt; Contract w s Text [(TxOutRef, TxOutTx, PubKeyHash)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">findSwaps oracle p = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- utxoAt $ swapAddress oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return $ mapMaybe g $ Map.toList utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: TxOutTx -&gt; Maybe PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f o = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        dh        &lt;- txOutDatumHash $ txOutTxOut o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Datum d) &lt;- Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        PlutusTx.fromData d</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    g :: (TxOutRef, TxOutTx) -&gt; Maybe (TxOutRef, TxOutTx, PubKeyHash)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    g (oref, o) = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        pkh &lt;- f o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        guard $ p pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (oref, o, pkh)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äáº§u tiÃªn, chÃºng tÃ´i nháº­n Ä‘Æ°á»£c danh sÃ¡ch táº¥t cáº£ cÃ¡c UTxO á»Ÿ Ä‘á»‹a chá»‰ há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i. Sau Ä‘Ã³ chÃºng tÃ´i Ã¡p dá»¥ng <code>mapMaybe</code>  dÃ nh cho danh sÃ¡ch nÃ y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mapMaybe :: (a -&gt; Maybe b) -&gt; [a] -&gt; [b]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m nÃ y sáº½ Ã¡p dá»¥ng hÃ m <code>(a -&gt; Maybe b)</code>  cho tá»«ng pháº§n tá»­ trong danh sÃ¡ch <code>a</code> vÃ  táº¡o danh sÃ¡ch <code>Maybe b</code>, cÃ³ thá»ƒ chá»©a há»—n há»£p cá»§a <code>Just</code> vÃ  <code>Nothing</code>. sau Ä‘Ã³ nÃ³ bá» <code>Nothing</code>vÃ  chá»‰ Ä‘á»ƒ láº¡i giÃ¡ trá»‹<code>Just</code>.</p><p>Äá»ƒ lÃ m rÃµ Ä‘iá»u nÃ y, hÃ£y tÆ°á»Ÿng tÆ°á»£ng chÃºng ta cÃ³ má»™t hÃ m tráº£ vá» nhÆ° <code>Just</code>  cho sá»‘ cháºµn vÃ  má»™t <code>Nothing</code>  cho sá»‘ láº».</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">f (n :: Int) = if even n then Just (div n 2) else Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng thÃ´ng sá»‘ nÃ y lÃ m tham sá»‘ Ä‘áº§u tiÃªn Ä‘á»ƒ láº­p <code>mapMaybe</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Data.Maybe</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Maybe Week06.Oracle.Core&gt; mapMaybe f [2, 4, 10, 11, 13, 100]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[1,2,5,50]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chung ta sá»­ dá»¥ng <code>mapMaybe</code>  vÃ  hÃ m <code>g</code> Ä‘á»ƒ lá»c danh sÃ¡ch cÃ¡c UTxO.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">g :: (TxOutRef, TxOutTx) -&gt; Maybe (TxOutRef, TxOutTx, PubKeyHash)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">g (oref, o) = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- f o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    guard $ p pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return (oref, o, pkh)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m nÃ y nháº­n má»™t cáº·p giÃ¡ trá»‹ khÃ³a Ä‘áº¡i diá»‡n cho UTxO vÃ  tráº£ vá» má»™t bá»™ ba <code>Maybe</code> chá»©a cÃ¡c má»¥c tá»« cáº·p cÃ¹ng vá»›i <code>PubKeyHash</code>.</p><p>HÃ m <code>g</code>  bÃªn trong monad <code>Maybe</code>  vÃ  sá»­ dá»¥ng hÃ m <code>f</code>,
cÅ©ng náº±m bÃªn trong monad <code>Maybe</code>. HÃ m <code>f</code> láº¥y mÃ£ bÄƒm khÃ³a cÃ´ng khai tá»« UTxO, náº¿u nÃ³ tá»“n táº¡i. Sau Ä‘Ã³, hÃ m  <code>g</code>  sá»­ dá»¥ng hÃ m<code>guard</code>  cÃ¹ng vá»›i thuá»™c tÃ­nh <code>p</code>  tmÃ  chÃºng ta chuyá»ƒn vÃ o lÃ m   Ä‘á»‘i sá»‘.</p><p>HÃ m <code>guard</code>  lÃ  hÃ m cÃ³ sáºµn trong monads, vÃ  monad <code>Maybe</code><br>
cÅ©ng váº­y. NÃ³ nháº­n má»™t boolean lÃ m tham sá»‘, vÃ  náº¿u boolean lÃ  false, thÃ¬ quÃ¡ trÃ¬nh tÃ­nh toÃ¡n sáº½ khÃ´ng thÃ nh cÃ´ng. Trong trÆ°á»ng há»£p nÃ y, false cÃ³ nghÄ©a lÃ  quay trá»Ÿ láº¡i <code>Nothing</code>. náº¿u lÃ  true, Náº¿u nÃ³ lÃ  sá»± tháº­t, nÃ³ chá»‰ tiáº¿p tá»¥c. Trong trÆ°á»ng há»£p nÃ y, Ä‘iá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  tráº£ vá»  bá»™ ba <code>Just</code> chá»©a hÃ m bÄƒm khÃ³a cÃ´ng khai. </p><p>ChÃºng ta sáº½ xem cÃ¡ch chÃºng ta sá»­ dá»¥ng hÃ m <code>findSwaps</code>  má»™t lÃ¡t ná»¯a.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="láº¥y-láº¡i-hoÃ¡n-Ä‘á»•i-retrieveswaps"></a>láº¥y láº¡i HoÃ¡n Ä‘á»•i (retrieveSwaps)<a class="hash-link" href="#láº¥y-láº¡i-hoÃ¡n-Ä‘á»•i-retrieveswaps" title="Direct link to heading">#</a></h3><p>Contract <code>retrieveSwaps</code>  lÃ  dÃ nh cho ngÆ°á»i bÃ¡n náº¿u há» muá»‘n thay Ä‘á»•i suy nghÄ© cá»§a há» vÃ  nháº­n Ä‘Æ°á»£c Ada trá»Ÿ láº¡i cá»§a há».</p><p>ÄÃ¢y lÃ  nÆ¡i chÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>findSwaps</code>. ChÃºng ta sá»­ dá»¥ng nÃ³ vá»›i<code>(== pkh)</code> nhÆ° lÃ  má»™t thuá»™c tÃ­nh, cÃ³ nghÄ©a lÃ  chÃºng tÃ´i muá»‘n chá»‰ nhá»¯ng UTxO á»Ÿ Ä‘á»‹a chá»‰ hoÃ¡n Ä‘á»•i thuá»™c vá» nhÃ  Ä‘iá»u hÃ nh.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">retrieveSwaps :: HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">retrieveSwaps oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    xs &lt;- findSwaps oracle (== pkh)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case xs of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [] -&gt; logInfo @String &quot;no swaps found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _  -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            let lookups = Constraints.unspentOutputs (Map.fromList [(oref, o) | (oref, o, _) &lt;- xs]) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.otherScript (swapValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx      = mconcat [Constraints.mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | (oref, _, _) &lt;- xs]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;retrieved &quot; ++ show (length xs) ++ &quot; swap(s)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u khÃ´ng cÃ³, thÃ¬ khÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ lÃ m. Náº¿u cÃ³ má»™t sá»‘, chÃºng tÃ´i xÃ¢y dá»±ng má»™t giao dá»‹ch truy xuáº¥t táº¥t cáº£ chÃºng.</p><p>Äá»ƒ lÃ m Ä‘iá»u Ä‘Ã³, chÃºng tÃ´i táº¡o má»™t danh sÃ¡ch cÃ¡c rÃ ng buá»™c <code>mustSpendScriptOutput</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">tx = mconcat [Constraints.mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | (oref, _, _) &lt;- xs]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p> TrÃ´ng cÃ³ váº» Ä‘Ã¡ng sá»£, nhÆ°ng nÃ³ chá»‰ lÃ  trÃ­ch xuáº¥t má»™t danh sÃ¡ch cÃ¡c <code>oref</code> tá»« danh sÃ¡ch <code>xs</code>  vÃ  sá»­ dá»¥ng nÃ³ Ä‘á»ƒ xÃ¢y dá»±ng má»™t rÃ ng buá»™c cho tá»«ng ngÆ°á»i trong sá»‘ há», sá»­ dá»¥ng <code>Unit</code>  nhÆ° lÃ  kiá»ƒu <code>Redeemer</code>. HÃ m <code>mconcat</code> Ã¡p dá»¥ng  <code>Semigroup</code> toÃ¡n tá»­ <code>&lt;&gt;</code> trong toÃ n bá»™ danh sÃ¡ch Ä‘á»ƒ káº¿t há»£p chÃºng.</p><p>Khi tra cá»©u, chÃºng tÃ´i pháº£i cung cáº¥p táº¥t cáº£ cÃ¡c UTxO vÃ  trÃ¬nh xÃ¡c thá»±c hoÃ¡n Ä‘á»•i.</p><p>ChÃºng tÃ´i cÃ³ danh sÃ¡ch cÃ¡c UTxO trong <code>xs</code> vÃ  chÃºng tÃ´i biáº¿n danh sÃ¡ch nÃ y thÃ nh danh sÃ¡ch cÃ¡c cáº·p vÃ  sau Ä‘Ã³ chÃºng tÃ´i sá»­ dá»¥ng <code>Map.fromList</code> Ä‘á»ƒ biáº¿n cÃ¡c cáº·p Ä‘Ã³ thÃ nh má»™t báº£n Ä‘á»“ (map), sau Ä‘Ã³ chÃºng tÃ´i Ã¡p dá»¥ng rÃ ng buá»™c <code>unspentOutputs</code> .</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="useswaps"></a>useSwaps<a class="hash-link" href="#useswaps" title="Direct link to heading">#</a></h3><p>VÃ  bÃ¢y giá» lÃ  má»™t trong nhá»¯ng thÃº vá»‹ nháº¥t <code>useSwaps</code>. ÄÃ¢y lÃ  nÆ¡i chÃºng tÃ´i thá»±c sá»± sá»­ dá»¥ng oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">useSwap :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">useSwap oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    funds &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let amt = assetClassValueOf funds $ oAsset oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;available assets: &quot; ++ show amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing           -&gt; logInfo @String &quot;oracle not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (oref, o, x) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;found oracle, exchange rate &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            pkh   &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            swaps &lt;- findSwaps oracle (/= pkh)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            case find (f amt x) swaps of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Nothing                -&gt; logInfo @String &quot;no suitable swap found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Just (oref&#x27;, o&#x27;, pkh&#x27;) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    let v       = txOutValue (txOutTxOut o) &lt;&gt; lovelaceValueOf (oFee oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        p       = assetClassValue (oAsset oracle) $ price (lovelaces $ txOutValue $ txOutTxOut o&#x27;) x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        lookups = Constraints.otherScript (swapValidator oracle)                     &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.otherScript (oracleValidator oracle)                   &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.unspentOutputs (Map.fromList [(oref, o), (oref&#x27;, o&#x27;)])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        tx      = Constraints.mustSpendScriptOutput oref  (Redeemer $ PlutusTx.toData Use) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustSpendScriptOutput oref&#x27; (Redeemer $ PlutusTx.toData ())  &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustPayToOtherScript</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    (validatorHash $ oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    (Datum $ PlutusTx.toData x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    v                                                                      &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustPayToPubKey pkh&#x27; p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    logInfo @String $ &quot;made swap with price &quot; ++ show (Value.flattenValue p)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice :: Integer -&gt; TxOutTx -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice x o = price (lovelaces $ txOutValue $ txOutTxOut o) x</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: Integer -&gt; Integer -&gt; (TxOutRef, TxOutTx, PubKeyHash) -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f amt x (_, o, _) = getPrice x o &lt;= amt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äáº§u tiÃªn, chÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>ownFunds</code>. Äiá»u nÃ y Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong má»™t mÃ´-Ä‘un riÃªng biá»‡t mÃ  chÃºng ta sáº½ Ä‘i sÃ¢u vÃ o trong má»™t chÃºt. Táº¥t cáº£ nhá»¯ng gÃ¬ nÃ³ lÃ m lÃ  thÃªm táº¥t cáº£ tiá»n vÃ o vÃ­ cá»§a chÃ­nh chÃºng ta vÃ  tráº£ vá» <code>Value</code>. Sau Ä‘Ã³, chÃºng tÃ´i tÃ¬m hiá»ƒu chÃºng tÃ´i cÃ³ bao nhiÃªu USD Token.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">funds &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">let amt = assetClassValueOf funds $ oAsset oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;available assets: &quot; ++ show amt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>findOracle</code>  Ä‘Æ°á»£c Ä‘á»‹nh nghia trong mÃ´ Ä‘un Oracle.Core tá»« trÆ°á»›c. Báº¡n sáº½ nhá»› láº¡i ráº±ng nÃ³ tÃ¬m tháº¥y oracle UTxO cÃ³ chá»©a giÃ¡ trá»‹ oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">m &lt;- findOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u chÃºng tÃ´i khÃ´ng tÃ¬m tháº¥y lá»i tiÃªn tri, chÃºng tÃ´i sáº½ chá»‰ ghi láº¡i má»™t thÃ´ng bÃ¡o vá» hiá»‡u á»©ng Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing           -&gt; logInfo @String &quot;oracle not found&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u chÃºng tÃ´i tÃ¬m tháº¥y nÃ³, chÃºng tÃ´i sáº½ ghi láº¡i má»™t thÃ´ng bÃ¡o vá»›i tá»· giÃ¡ há»‘i Ä‘oÃ¡i hiá»‡n táº¡i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Just (oref, o, x) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;found oracle, exchange rate &quot; ++ show x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiáº¿p theo, chÃºng tÃ´i kiá»ƒm tra khÃ³a cÃ´ng khai cá»§a riÃªng mÃ¬nh vÃ  kiá»ƒm tra táº¥t cáº£ cÃ¡c giao dá»‹ch hoÃ¡n Ä‘á»•i cÃ³ sáºµn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">pkh   &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swaps &lt;- findSwaps oracle (/= pkh)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng má»™t hÃ m <code>find</code>  Ä‘Ã³ lÃ  tá»« Haskell prelude,Trong module <code>Data.List</code>. HÃ m <code>find</code>  vá»›i Ä‘á»‘i sá»‘ lÃ  má»™t thuá»™c tÃ­nh lÃ  má»™t danh sÃ¡ch <code>Maybe</code>  tráº£ vá» má»™t pháº§n tá»­ phÃ¹ há»£p vá»›i thuá»™c tÃ­nh Ä‘Ã³.</p><p>HÃ m Ä‘Æ°á»£c sá»­ dá»¥ng trong vá»‹ tá»« Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  hÃ m trá»£ giÃºp <code>f</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice :: Integer -&gt; TxOutTx -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice x o = price (lovelaces $ txOutValue $ txOutTxOut o) x    </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: Integer -&gt; Integer -&gt; (TxOutRef, TxOutTx, PubKeyHash) -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f amt x (_, o, _) = getPrice x o &lt;= amt    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i cung cáº¥p cho nÃ³ má»™t sá»‘ tiá»n, tá»· giÃ¡ há»‘i Ä‘oÃ¡i hiá»‡n táº¡i vÃ  má»™t bá»™ ba UTxO. HÃ m xÃ¡c Ä‘á»‹nh xem cÃ³ hoÃ¡n Ä‘á»•i nÃ o ráº» hÆ¡n hoáº·c báº±ng tham sá»‘ sá»‘ tiá»n hay khÃ´ng.</p><p>BÃ¢y giá», chÃºng tÃ´i Ä‘Ã£ tÃ¬m kiáº¿m má»™t giao dá»‹ch hoÃ¡n Ä‘á»•i mÃ  chÃºng tÃ´i cÃ³ thá»ƒ chi tráº£. Náº¿u chÃºng tÃ´i khÃ´ng tÃ¬m tháº¥y má»™t, chÃºng tÃ´i sáº½ ghi láº¡i má»™t thÃ´ng bÃ¡o nÃ³i nhÆ° váº­y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case find (f amt x) swaps of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing                -&gt; logInfo @String &quot;no suitable swap found&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u chÃºng tÃ´i tÃ¬m tháº¥y má»™t cÃ¡i, chÃºng tÃ´i chá»‰ láº¥y cÃ¡i Ä‘áº§u tiÃªn. Táº¥t nhiÃªn, Ä‘iá»u nÃ y khÃ´ng thá»±c táº¿ láº¯m. Trong má»™t vÃ­ dá»¥ thá»±c táº¿, chÃºng tÃ´i cÃ³ thá»ƒ sáº½ chá»‰ Ä‘á»‹nh sá»‘ tiá»n chÃ­nh xÃ¡c mÃ  chÃºng tÃ´i muá»‘n hoÃ¡n Ä‘á»•i. á» Ä‘Ã¢y, chÃºng tÃ´i chá»‰ giá»¯ nÃ³ Ä‘Æ¡n giáº£n vÃ¬ chÃºng tÃ´i táº­p trung vÃ o má»¥c tiÃªu máº¥u chá»‘t hÆ¡n lÃ  hoÃ¡n Ä‘á»•i.</p><p>VÃ¬ váº­y, bÃ¢y giá» chÃºng ta xÃ¢y dá»±ng má»™t giao dá»‹ch.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let v = txOutValue (txOutTxOut o) &lt;&gt; lovelaceValueOf (oFee oracle)                </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ÄÃ¢y lÃ  Ä‘áº§u ra cho tiÃªn tri. NÃ³ cÅ©ng giá»‘ng nhÆ° Ä‘áº§u vÃ o, bao gá»“m báº¥t ká»³ khoáº£n phÃ­ nÃ o Ä‘Ã£ tÃ­ch lÅ©y á»Ÿ Ä‘Ã³, cá»™ng vá»›i khoáº£n phÃ­ trong tÃ¬nh yÃªu mÃ  chÃºng ta cáº§n pháº£i tráº£.</p><p>Sau Ä‘Ã³, chÃºng tÃ´i táº¡o má»™t <code>Value</code> mÃ£ thÃ´ng bÃ¡o USD  Ä‘áº¡i diá»‡n mÃ  chÃºng tÃ´i cáº§n thanh toÃ¡n. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">p = assetClassValue (oAsset oracle) $ price (lovelaces $ txOutValue $ txOutTxOut o&#x27;) x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá», chÃºng ta hÃ£y xem xÃ©t cÃ¡c rÃ ng buá»™c.</p><p>RÃ ng buá»™c Ä‘áº§u tiÃªn lÃ  chÃºng ta pháº£i sá»­ dá»¥ng oracle lÃ m Ä‘áº§u vÃ o. VÃ  á»Ÿ Ä‘Ã¢y chÃºng ta tháº¥y láº§n Ä‘áº§u tiÃªn sá»­ dá»¥ng <code>Redeemer</code>. ChÃºng tÃ´i chÆ°a bao giá» sá»­ dá»¥ng <code>Redeemer</code> nÃ y trong chÃ­nh lÃµi oracle, vÃ¬ nhÃ  cung cáº¥p oracle chá»‰ chá»‹u trÃ¡ch nhiá»‡m cáº­p nháº­t cÃ¡c giÃ¡ trá»‹ sá»­ dá»¥ng <code>Redeemer</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Use)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>RÃ ng buá»™c thá»© hai lÃ  sá»­ dá»¥ng Ä‘áº§u vÃ o hoÃ¡n Ä‘á»•i, chá»‰ sá»­ dá»¥ng má»™t trÃ¬nh <code>Unit</code> cho Redeeemer.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustSpendScriptOutput oref&#x27; (Redeemer $ PlutusTx.toData ())</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>RÃ ng buá»™c thá»© ba lÃ  tráº£ tiá»n oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustPayToOtherScript</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    (validatorHash $ oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    (Datum $ PlutusTx.toData x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>á» Ä‘Ã¢y chÃºng tÃ´i sá»­ dá»¥ng <code>mustPayToOtherScript</code>, chá»‰ Ä‘á»‹nh táº­p lá»‡nh oracle, vÃ¬ bÃ¢y giá» chÃºng ta cÃ³ hai táº­p lá»‡nh Ä‘ang hoáº¡t Ä‘á»™ng - táº­p lá»‡nh oracle vÃ  táº­p lá»‡nh hoÃ¡n Ä‘á»•i. NhÆ° <code>Datum</code>  chÃºng tÃ´i sá»­ dá»¥ng datum tá»“n táº¡i - wchÃºng tÃ´i khÃ´ng Ä‘Æ°á»£c thay Ä‘á»•i nÃ³ - vÃ 
nhÆ° lÃ  <code>Value</code>  chÃºng tÃ´i sá»­ dá»¥ng giÃ¡ trá»‹ <code>v</code>  mÃ  chÃºng tÃ´i Ä‘Ã£ tÃ­nh toÃ¡n trÆ°á»›c Ä‘Ã³.</p><p>RÃ ng buá»™c cuá»‘i cÃ¹ng lÃ  chÃºng tÃ´i pháº£i tráº£ tiá»n cho ngÆ°á»i bÃ¡n  - vÃ  khoáº£n thanh toÃ¡n lÃ  giÃ¡ trá»‹ <code>p</code> mÃ  chÃºng tÃ´i Ä‘Ã£ tÃ­nh toÃ¡n trÆ°á»›c Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustPayToPubKey pkh&#x27; p</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äá»ƒ tra cá»©u, chÃºng tÃ´i pháº£i cung cáº¥p trÃ¬nh xÃ¡c thá»±c cá»§a há»£p Ä‘á»“ng oracle vÃ  hoÃ¡n Ä‘á»•i, Ä‘á»“ng thá»i chÃºng tÃ´i pháº£i cung cáº¥p hai UTxO mÃ  chÃºng tÃ´i muá»‘n sá»­ dá»¥ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">lookups = Constraints.otherScript (swapValidator oracle)               &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Constraints.otherScript (oracleValidator oracle)                   &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Constraints.unspentOutputs (Map.fromList [(oref, o), (oref&#x27;, o&#x27;)])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá», thÃ´ng thÆ°á»ng - chÃºng tÃ´i gá»­i nÃ³, chá» xÃ¡c nháº­n, sau Ä‘Ã³ ghi láº¡i má»™t tin nháº¯n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;made swap with price &quot; ++ show (Value.flattenValue p)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="gÃ³i-há»£p-Ä‘á»“ng-contract-bundle"></a>GÃ³i há»£p Ä‘á»“ng (Contract bundle)<a class="hash-link" href="#gÃ³i-há»£p-Ä‘á»“ng-contract-bundle" title="Direct link to heading">#</a></h3><p>Äiá»u Ä‘Ã³ xÃ¡c Ä‘á»‹nh cÃ¡c há»£p Ä‘á»“ng thÃ´. BÃ¢y giá», chÃºng tÃ´i cung cáº¥p má»™t gÃ³i chá»©a táº¥t cáº£ chÃºng.</p><p>Äáº§u tiÃªn, chÃºng tÃ´i Ä‘á»‹nh nghÄ©a, nhÆ° má»i khi, má»™t <code>SwapSchema</code>, xÃ¡c Ä‘á»‹nh cÃ¡c endpoints.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type SwapSchema =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    BlockchainActions</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;offer&quot;    Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;retrieve&quot; ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;use&quot;      ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;funds&quot;    ()    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiáº¿p theo, chÃºng ta tháº¥y toÃ¡n tá»­ <code>select</code>. Viá»‡c sá»­ dá»¥ng toÃ¡n tá»­ nÃ y sáº½ khiáº¿n mÃ£ cá»§a chÃºng tÃ´i Ä‘á»£i cho Ä‘áº¿n khi má»™t trong cÃ¡c Ä‘iá»ƒm cuá»‘i Ä‘Æ°á»£c chá»n, rá»“i thá»±c thi mÃ£ Ä‘Æ°á»£c liÃªn káº¿t.</p><p>CÃ¡c hÃ m <code>swap</code>  Ä‘á»‡ quy gá»i chÃ­nh nÃ³, cung cáº¥p má»™t láº§n ná»¯a vÃ  má»™t láº§n ná»¯a lá»±a chá»n cÃ¹ng má»™t endpoints.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">swap :: Oracle -&gt; Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap oracle = (offer `select` retrieve `select` use `select` funds) &gt;&gt; swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        offer :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        offer = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            amt &lt;- endpoint @&quot;offer&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            offerSwap oracle amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        retrieve :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        retrieve = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;retrieve&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            retrieveSwaps oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        use :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        use = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;use&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            useSwap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        funds :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        funds = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;funds&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            v &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            tell $ Last $ Just v</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        h :: Contract (Last Value) SwapSchema Text () -&gt; Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        h = handleError logError    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>MÃ£ cho bá»‘n endpoint lÃ  trÃ¬nh bao bá»c cho mÃ£ chÃºng ta Ä‘Ã£ viáº¿t.</p><p>VÃ­ dá»¥ <code>offer</code>, wchÃºng tÃ´i cháº·n cho Ä‘áº¿n khi chÃºng tÃ´i Ä‘Æ°á»£c cung cáº¥p <code>amt</code> vÃ  sau Ä‘Ã³ gá»i contract <code>offerSwap</code>  .</p><p>Äá»‘i vá»›i endpoints <code>retrieve</code>  vÃ   <code>use</code>  ,chÃºng khÃ´ng cáº§n tham sá»‘.</p><p>cuá»‘i cÃ¹ng lÃ  endpoint <code>funds</code>, nÃ³ thÃ¬ khÃ¡c má»™t chÃºt. hÃ m <code>ownFunds</code>xuáº¥t phÃ¡t tá»« mÃ´-Ä‘un <code>Funds</code> , chÃºng ta Ä‘Ã£ Ä‘á» cáº­p trÆ°á»›c Ä‘Ã³, Chung ta tháº¥y, nÃ³ chá»©a má»™t giÃ¡ trá»‹ <code>Value</code> mÃ  nÃ³ sá»Ÿ há»©u. sau Ä‘Ã³ chÃºng ta <code>tell</code> giÃ¡ trá»‹ nÃ y  nhÆ° má»™t cÃ¡ch bÃ¡o cÃ¡o vá»›i tháº¿ giá»›i bÃªn ngoÃ i ráº±ng chÃºng tÃ´i cÃ³ bao nhiÃªu.</p><p>Trong hmá»—i Ä‘iá»ƒm cuá»‘i lÃ  má»™t trÃ¬nh xá»­ lÃ½ lá»— <code>h</code>. Má»—i Ä‘iá»ƒm cuá»‘i Ä‘Æ°á»£c bao bá»c bÃªn trong trÃ¬nh xá»­ lÃ½ lá»—i, trÃ¬nh nÃ y chá»‰ ghi láº¡i lá»—i, nhÆ°ng khÃ´ng táº¡m dá»«ng thá»±c thi.</p><p>VÃ  Ä‘iá»u Ä‘Ã³ káº¿t thÃºc vÃ­ dá»¥ hoÃ¡n Ä‘á»•i.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="funds-module"></a>Funds Module<a class="hash-link" href="#funds-module" title="Direct link to heading">#</a></h2><p>BÃ¢y giá» chÃºng ta hÃ£y nhanh chÃ³ng xem xÃ©t mÃ´-Ä‘un <code>Funds</code>. ÄÃ³ lÃ  má»™t mÃ´-Ä‘un ngáº¯n cung cáº¥p hai há»£p Ä‘á»“ng.</p><p>CÃ¡c hÃ m <code>ownFunds</code>  Ä‘Æ°á»£c giao nhiá»‡m vá»¥ tá»•ng há»£p táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ trong cÃ¡c UTxOs cá»§a chÃºng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds :: HasBlockchainActions s =&gt; Contract w s Text Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pk    &lt;- ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- utxoAt $ pubKeyAddress pk</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let v = mconcat $ Map.elems $ txOutValue . txOutTxOut &lt;$&gt; utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;own funds: &quot; ++ show (Value.flattenValue v)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return v</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NÃ³ thá»±c hiá»‡n Ä‘iá»u nÃ y báº±ng cÃ¡ch tra cá»©u khÃ³a cÃ´ng khai cá»§a chÃºng, sau Ä‘Ã³ nháº­n táº¥t cáº£ cÃ¡c UTxO táº¡i Ä‘á»‹a chá»‰ khÃ³a cÃ´ng khai Ä‘Ã³. Sau Ä‘Ã³ <code>utxos</code> lÃ  má»™t báº£n Ä‘á»“ tá»« cÃ¡c tham chiáº¿u UTxO Ä‘áº¿n cÃ¡c UTxO.</p><p>nhÆ° <code>map</code>  thá»±c hiá»‡n <code>Functor</code>  hÃºng tÃ´i cÃ³ thá»ƒ Ã¡nh xáº¡ trÃªn báº£n Ä‘á»“ Ä‘á»ƒ thay Ä‘á»•i cÃ¡c yáº¿u tá»‘ thÃ nh má»™t cÃ¡i gÃ¬ Ä‘Ã³ khÃ¡c. Trong trÆ°á»ng há»£p nÃ y, chÃºng tÃ´i thay Ä‘á»•i chÃºng thÃ nh giÃ¡ trá»‹ báº±ng cÃ¡ch Ã¡p dá»¥ng hÃ m tá»•ng há»£p <code>txOutValue</code>  . <code>txOutTxOut</code>.</p><p>CÃ¡c hÃ m <code>Map.elems</code>  bá» qua cÃ¡c phÃ­m vÃ  chá»‰ cho chÃºng ta cÃ¡c giÃ¡ trá»‹. VÃ , nhÆ° chÃºng ta Ä‘Ã£ tháº¥y trÆ°á»›c Ä‘Ã¢y <code>mconcat</code>khi Ä‘Æ°á»£c cung cáº¥p má»™t kiá»ƒu <code>Semigroup</code>  or <code>Monoid</code>sáº½ káº¿t há»£p danh sÃ¡ch cÃ¡c giÃ¡ trá»‹ thÃ nh má»™t giÃ¡ trá»‹.</p><p>VÃ¬ váº­y,  <code>v</code>  khÃ´ng pháº£i lÃ  tá»•ng cá»§a táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ cá»§a táº¥t cáº£ cÃ¡c UTxO mÃ  chÃºng ta sá»Ÿ há»¯u.
HÃ m <code>ownFunds</code>  cá»§a chÃºng tÃ´i lÃ  má»™t há»£p Ä‘á»“ng cÃ³ kiá»ƒu tráº£ vá» giÃ¡ trá»‹ <code>v</code>.</p><p>HÃ m <code>ownFunds&#x27;</code> lÃ  má»™t biáº¿n thá»ƒ, thay vÃ¬ tráº£ vá» giÃ¡ trá»‹, nÃ³ sáº½ vÄ©nh viá»…n lÃ  tell. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds&#x27; :: Contract (Last Value) BlockchainActions Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds&#x27; = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    handleError logError $ ownFunds &gt;&gt;= tell . Last . Just</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Contract.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownFunds&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u nÃ y gá»i hÃ m <code>ownFunds</code>  thá»±c hiá»‡n liÃªn káº¿t Ä‘Æ¡n nguyÃªn vá»›i hÃ m tá»•ng há»£p <code>tell . Last . Just</code>  wÃ y cho biáº¿t giÃ¡ trá»‹, sau Ä‘Ã³ nÃ³ Ä‘á»£i má»™t vá»‹ trÃ­ vÃ  sau Ä‘Ã³ gá»i chÃ­nh nÃ³. VÃ¬ váº­y, má»—i khá»‘i, nÃ³ ghi giÃ¡ trá»‹ vÃ o nháº­t kÃ½.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="testing"></a>Testing<a class="hash-link" href="#testing" title="Direct link to heading">#</a></h2><p>BÃ¢y giá» chÃºng tÃ´i sáº½ viáº¿t mÃ£, sá»­ dá»¥ng  <code>EmulatorTrace</code>  monad, kiá»ƒm tra cÃ¡c há»£p Ä‘á»“ng chÃºng tÃ´i Ä‘Ã£ viáº¿t.</p><p>MÃ£ nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¬m tháº¥y trong mÃ´-Ä‘un sau:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.Test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äáº§u tiÃªn, chÃºng ta cáº§n xÃ¡c Ä‘á»‹nh má»™t mÃ£ thÃ´ng bÃ¡o mÃ  chÃºng ta cÃ³ thá»ƒ kiá»ƒm tra. <code>assetSymbol</code> lÃ  má»™t hÃ m bÄƒm tÃ¹y Ã½, dÃ¹ng Ä‘Æ°á»£c cho cÃ¡c má»¥c Ä‘Ã­ch thá»­ nghiá»‡m.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">assetSymbol :: CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetSymbol = &quot;ff&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetToken :: TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetToken = &quot;USDT&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Láº§n nÃ y chÃºng ta sáº½ sá»­ dá»¥ng phiÃªn báº£n má»“i cá»§a <code>runEmulatorTraceIO</code>, láº¥y thÃªm hai Ä‘á»‘i sá»‘ vÃ  cung cáº¥p nhiá»u chi tiáº¿t hÆ¡n cho mÃ´i trÆ°á»ng giáº£ láº­p.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">test :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">test = runEmulatorTraceIO&#x27; def emCfg myTrace</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    emCfg :: EmulatorConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    emCfg = EmulatorConfig $ Left $ Map.fromList [(Wallet i, v) | i &lt;- [1 .. 10]]</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v :: Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v = Ada.lovelaceValueOf                    100_000_000 &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Value.singleton assetSymbol assetToken 100_000_000    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äá»‘i sá»‘ Ä‘áº§u tiÃªn Ä‘á»ƒ <code>runEmulatorTraceIO&#x27;</code>  xÃ¡c Ä‘á»‹nh cÃ¡ch hiá»ƒn thá»‹ cÃ¡c thÃ´ng bÃ¡o nháº­t kÃ½ khÃ¡c nhau. Báº±ng cÃ¡ch sá»­ dá»¥ng  <code>def</code>, chÃºng tÃ´i Ä‘Ã£ chá»n máº·c Ä‘á»‹nh, giá»‘ng nhÆ° trong phiÃªn báº£n khÃ´ng cÃ³ báº£n quyá»n.</p><p>LÃ½ do chÃºng tÃ´i Ä‘ang sá»­ dá»¥ng phiÃªn báº£n má»“i lÃ  chÃºng tÃ´i muá»‘n Ä‘á»‹nh cáº¥u hÃ¬nh phÃ¢n phá»‘i ban Ä‘áº§u vÃ  chÃºng tÃ´i cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘iá»u Ä‘Ã³ vá»›i Ä‘á»‘i sá»‘ thá»© hai, mÃ  á»Ÿ Ä‘Ã¢y chÃºng tÃ´i Ä‘Ã£ gáº¯n nhÃ£n <code>emCfg</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">emCfg :: EmulatorConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">emCfg = EmulatorConfig $ Left $ Map.fromList [(Wallet i, v) | i &lt;- [1 .. 10]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i sá»­ dá»¥ng Ä‘iá»u nÃ y vá»›i hÃ m trá»£ giÃºp <code>v</code>  Ä‘á»ƒ cung cáº¥p cho má»i ngÆ°á»i 100 triá»‡u lovelace (100 Ada) and 100 triá»‡u USD Tokens Ä‘á»ƒ báº¯t Ä‘áº§u.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">v :: Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">v = Ada.lovelaceValueOf                    100_000_000 &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Value.singleton assetSymbol assetToken 100_000_000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i xÃ¡c Ä‘á»‹nh má»™t há»£p Ä‘á»“ng trá»£ giÃºp  <code>checkOracle</code>, nÃ³ sáº½ liÃªn tá»¥c kiá»ƒm tra giÃ¡ trá»‹ oracle vÃ  ghi láº¡i nÃ³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">checkOracle :: Oracle -&gt; Contract () BlockchainActions Text a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">checkOracle oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing        -&gt; return ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (_, _, x) -&gt; Contract.logInfo $ &quot;Oracle value: &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Contract.waitNSlots 1 &gt;&gt; checkOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  bÃ¢y giá» chÃºng ta cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh dáº¥u váº¿t cá»§a mÃ¬nh.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">myTrace :: EmulatorTrace ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">myTrace = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let op = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                { opFees = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , opSymbol = assetSymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , opToken  = assetToken</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h1 &lt;- activateContractWallet (Wallet 1) $ runOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- getOracle h1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 2) $ checkOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_500_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 1) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 3) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 4) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 5) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h3 &lt;- activateContractWallet (Wallet 3) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h4 &lt;- activateContractWallet (Wallet 4) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h5 &lt;- activateContractWallet (Wallet 5) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;offer&quot; h3 10_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;offer&quot; h4 20_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_700_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_800_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;retrieve&quot; h3 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;retrieve&quot; h4 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getOracle :: ContractHandle (Last Oracle) OracleSchema Text -&gt; EmulatorTrace Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getOracle h = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        l &lt;- observableState h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        case l of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Last Nothing       -&gt; Emulator.waitNSlots 1 &gt;&gt; getOracle h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Last (Just oracle) -&gt; Extras.logInfo (show oracle) &gt;&gt; return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ÄÃ¢y lÃ  táº¥t cáº£ nhá»¯ng thá»© mÃ  chÃºng ta Ä‘Ã£ tháº¥y. ChÃºng tÃ´i xÃ¡c Ä‘á»‹nh cÃ¡c tham sá»‘ oracle cá»§a mÃ¬nh, Ä‘áº·t má»©c phÃ­ oracle á»Ÿ má»©c 1 triá»‡u lovelace vÃ  loáº¡i tÃ i sáº£n tÃ¹y Ã½ cá»§a chÃºng tÃ´i Ä‘Ã£ xÃ¡c Ä‘á»‹nh trÆ°á»›c Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let op = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { opFees = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opSymbol = assetSymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opToken  = assetToken</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i báº¯t Ä‘áº§u má»™t oracle vÃ  chá» má»™t slot.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">h1 &lt;- activateContractWallet (Wallet 1) $ runOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracle &lt;- getOracle h1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i Ä‘Ã£ náº¯m báº¯t Ä‘Æ°á»£c má»™t xá»­ lÃ½ Ä‘á»‘i vá»›i oracle báº±ng cÃ¡ch sá»­ dá»¥ng chá»©c nÄƒng trá»£ giÃºp Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong má»‡nh Ä‘á» <code>where</code> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getOracle :: ContractHandle (Last Oracle) OracleSchema Text -&gt; EmulatorTrace Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getOracle h = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    l &lt;- observableState h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case l of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Last Nothing       -&gt; Emulator.waitNSlots 1 &gt;&gt; getOracle h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Last (Just oracle) -&gt; Extras.logInfo (show oracle) &gt;&gt; return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cáº§n Ä‘iá»u nÃ y vÃ¬ há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i Ä‘Æ°á»£c tham sá»‘ hÃ³a vá»›i giÃ¡ trá»‹ oracle. VÃ  Ä‘Ã¢y lÃ  lÃ½ do táº¡i sao chÃºng tÃ´i sá»­ dá»¥ng <code>tell</code>  trong hÃ m <code>runOracle</code>.</p><p>ChÃºng tÃ´i sá»­ dá»¥ng hÃ m <code>observableState</code>  Ä‘á»ƒ náº¯m giá»¯ thÃ´ng tin nÃ y. Náº¿u nÃ³ khÃ´ng tá»“n táº¡i, chÃºng tÃ´i Ä‘á»£i má»™t vá»‹ trÃ­ vÃ  thá»­ láº¡i. Náº¿u khÃ´ng, chÃºng tÃ´i ghi láº¡i nÃ³ cho má»¥c Ä‘Ã­ch gá»¡ lá»—i vÃ  tráº£ láº¡i nÃ³.</p><p>Tiáº¿p theo, chÃºng tÃ´i sá»­ dá»¥ng Wallet 2 Ä‘á»ƒ thá»±c thi hÃ m <code>checkOracle</code>  mÃ  chÃºng tÃ´i Ä‘Ã£ tháº¥y trÆ°á»›c Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 2) $ checkOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i khá»Ÿi táº¡o oracle vá»›i tá»· giÃ¡ há»‘i Ä‘oÃ¡i lÃ  1,5 Ada vÃ  Ä‘á»£i 3 slots.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;update&quot; h1 1_500_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» chÃºng ta gá»i hÃ m <code>ownFunds&#x27;</code>  trÃªn vÃ­ 1, 3, 4 vÃ  5 Ä‘á»ƒ kiá»ƒm tra sá»‘ dÆ° ban Ä‘áº§u.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 1) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 3) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 4) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 5) ownFunds&#x27;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i báº¯t Ä‘áº§u há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i trÃªn VÃ­ 3, 4 vÃ  5.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">h3 &lt;- activateContractWallet (Wallet 3) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">h4 &lt;- activateContractWallet (Wallet 4) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">h5 &lt;- activateContractWallet (Wallet 5) $ swap oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i thá»­ má»™t sá»‘ ká»‹ch báº£n. Äáº§u tiÃªn, VÃ­ 3 vÃ  4 láº§n lÆ°á»£t cung cáº¥p 10 vÃ  20 Ada Ä‘á»ƒ hoÃ¡n Ä‘á»•i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;offer&quot; h3 10_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;offer&quot; h4 20_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  bÃ¢y giá» VÃ­ 5 sá»­ dá»¥ng hoÃ¡n Ä‘á»•i. NÃ³ sáº½ chá»n má»™t trong hai. KhÃ´ng rÃµ cÃ¡i nÃ o, cÃ¡i nÃ o tÃ¬m trÆ°á»›c. HÃ£y nhá»› ráº±ng chÃºng tÃ´i chá»‰ viáº¿t mÃ£ Ä‘á»ƒ tÃ¬m vá»‹ trÃ­ Ä‘áº§u tiÃªn cÃ³ giÃ¡ cáº£ pháº£i chÄƒng. Sau Ä‘Ã³, nÃ³ sáº½ tráº£ USD Token cho nÃ³. Sá»‘ tiá»n Ä‘Æ°á»£c tráº£ sáº½ phá»¥ thuá»™c vÃ o giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá», Wallet 1 cáº­p nháº­t giÃ¡ trá»‹ oracle lÃªn 1,7. Äiá»u nÃ y cÅ©ng dáº«n Ä‘áº¿n phÃ­ tÃ­ch lÅ©y (1 Ada) Ä‘Æ°á»£c tráº£ cho VÃ­ 1.</p><blockquote><p>callEndpoint @\&quot;update\&quot; h1 1_700_000 void \$ Emulator.waitNSlots 3</p></blockquote><p>Sau Ä‘Ã³, Wallet 5 thá»­ láº¡i, láº¥y pháº§n hoÃ¡n Ä‘á»•i cÃ²n láº¡i, nhÆ°ng hiá»‡n Ä‘ang tráº£ má»™t giÃ¡ USD Token khÃ¡c.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, chÃºng tÃ´i Ä‘áº·t giÃ¡ trá»‹ oracle thÃ nh 1,8.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;update&quot; h1 1_800_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u nÃ y sáº½ cho phÃ©p Wallet 1 thu phÃ­. GiÃ¡ trá»‹ oracle thá»±c sá»± khÃ´ng cáº§n pháº£i thay Ä‘á»•i Ä‘á»ƒ Ä‘iá»u nÃ y xáº£y ra.</p><p>VÃ­ 3 vÃ  4 hiá»‡n Ä‘Æ°a ra <code>retrieve</code> yÃªu cáº§u láº¥y láº¡i báº¥t ká»³ khoáº£n tiá»n nÃ o chÆ°a Ä‘Æ°á»£c mua. Äiá»u nÃ y sáº½ dáº«n Ä‘áº¿n viá»‡c khÃ´ng cÃ³ tiá»n Ä‘Æ°á»£c tráº£ láº¡i vÃ¬ táº¥t cáº£ cÃ¡c khoáº£n hoÃ¡n Ä‘á»•i Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;retrieve&quot; h3 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;retrieve&quot; h4 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  Ä‘Ã¢y lÃ  toÃ n bá»™ code. VÃ¬ váº­y, hÃ£y cháº¡y nÃ³ trong REPL.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-in-the-repl"></a>Test in the REPL<a class="hash-link" href="#test-in-the-repl" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Week06.Oracle.Test</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Test Week06.Oracle.Core&gt; test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sáº½ cÃ³ ráº¥t nhiá»u Ä‘áº§u ra.</p><p>HÃ£y xem xÃ©t má»™t sá»‘ pháº§n chÃ­nh. Äáº§u tiÃªn, slot 3, nÆ¡i táº¡o ra oracle. á» Ä‘Ã¢y chÃºng tÃ´i nháº­n Ä‘Æ°á»£c giÃ¡ trá»‹ <code>oSymbol</code>  mÃ  chÃºng tÃ´i cÃ³ thá»ƒ sá»­ dá»¥ng cho má»i thá»© khÃ¡c.</p><p>ChÃºng tÃ´i cÅ©ng tháº¥y trong vá»‹ trÃ­ sá»‘ 3 <code>getOracle</code> Ä‘Æ°á»£c báº¯t Ä‘áº§u sáº½ ghi láº¡i giÃ¡ trá»‹ cá»§a oracle, Ä‘á»ƒ biáº¿t thÃ´ng tin cá»§a chÃºng tÃ´i, má»i vá»‹ trÃ­ ká»ƒ tá»« bÃ¢y giá».</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: ```  CONTRACT LOG: &quot;started oracle Oracle {oSymbol = 6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (ff,\&quot;USDT\&quot;)}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Sending contract state to Thread 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: ```  USER LOG: Oracle {oSymbol = 6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (ff,&quot;USDT&quot;)}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000001 {Contract instance for wallet 2}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;update&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1500000.0)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: W1: TxSubmit: 93fab1c0845a5b96863a50d248fa2de68bd6702185e3de92ae0c58b869569909</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: TxnValidate 93fab1c0845a5b96863a50d248fa2de68bd6702185e3de92ae0c58b869569909</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ , vá»‹ trÃ­ thá»© 4, chÃºng ta tháº¥y giÃ¡ trá»‹ Ä‘áº§u tiÃªn <code>getOracle</code> tÃ¬m tháº¥y lÃ  1.500.000.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00004: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00004: ```  CONTRACT LOG: &quot;set initial oracle value to 1500000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vá»‹ trÃ­ 6 lÃ  káº¿t quáº£ cá»§a táº¥t cáº£ cÃ¡c láº§n gá»i <code>activateContractWallet</code>. ChÃºng khÃ´ng nháº¥t thiáº¿t pháº£i xuáº¥t hiá»‡n theo thá»© tá»± nhÆ° trong mÃ£. LÆ°u Ã½ ráº±ng VÃ­ 1 cÃ³ Ã­t Ada hÆ¡n má»™t chÃºt so vá»›i cÃ¡c vÃ­ khÃ¡c. Äiá»u nÃ y lÃ  do VÃ­ 1 startOracle vÃ  cáº§n pháº£i tráº£ phÃ­ giao dá»‹ch cho viá»‡c Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000002 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000003 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000004 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000005 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000006 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000007 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000008 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000006 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;offer&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1.0e7)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: W3: TxSubmit: 8274315b83fb8b4d721146a75772cf39be3f96730557bd6021235864f0f37bc6</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000007 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;offer&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 2.0e7)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: W4: TxSubmit: 221f86cc1d6087a5967793aaf9eb078d8ec0677b2d6aca586f985f6f2c57a100</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: TxnValidate 221f86cc1d6087a5967793aaf9eb078d8ec0677b2d6aca586f985f6f2c57a100</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: TxnValidate 8274315b83fb8b4d721146a75772cf39be3f96730557bd6021235864f0f37bc6</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Slot 7, cÃ¡c Æ°u Ä‘Ã£i cá»§a 10 Ada vÃ  20 Ada Ä‘Æ°á»£c thá»±c hiá»‡n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;offered 10000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,89999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;offered 20000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,79999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong vá»‹ trÃ­ 9, cÃ¡i Ä‘áº§u tiÃªn <code>use</code> Ä‘Æ°á»£c yÃªu cáº§u.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.Slot"><div tabindex="0" class="prism-code language-{.Slot codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Receive endpoint call: Object (fromList [(\&quot;tag\&quot;,String \&quot;use\&quot;),(\&quot;value\&quot;,Object (fromList [(\&quot;unEndpointValue\&quot;,Array [])]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;own funds: [(,\\\&quot;\\\&quot;,100000000),(ff,\\\&quot;USDT\\\&quot;,100000000)]\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;available assets: 100000000\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;found oracle, exchange rate 1500000\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: W5: TxSubmit: 35d38def28dd6f5d016bee056e227501b97b2bb3ed2192e364242f01319e5e56</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: TxnValidate 35d38def28dd6f5d016bee056e227501b97b2bb3ed2192e364242f01319e5e56}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  á»Ÿ vá»‹ trÃ­ sá»‘ 10, chÃºng ta tháº¥y sá»± hoÃ¡n Ä‘á»•i xáº£y ra.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,89999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,79999990),(ff,\&quot;USDT\&quot;,130000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;made swap with price [(ff,\&quot;USDT\&quot;,30000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,118999990),(ff,\&quot;USDT\&quot;,70000000)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The oracle nháº­n vÃ  cáº­p nháº­t yÃªu cáº§u trong slot 12.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;update&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1700000.0)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: W1: TxSubmit: ff7e1fbfb51897b100dcfdf551ad9a03886432af0a9fa92ff8dd986a0f7c90fe</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: TxnValidate ff7e1fbfb51897b100dcfdf551ad9a03886432af0a9fa92ff8dd986a0f7c90fe</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  chÃºng tÃ´i tháº¥y nÃ³ xáº£y ra á»Ÿ vá»‹ trÃ­ sá»‘ 13.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00013: ```  CONTRACT LOG: &quot;updated oracle value to 1700000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><div tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Thá»©  nhÃ¬ `use`  yÃªu cáº§u Ä‘áº¿n slot 15.</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">``` {.}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: 00000000-0000-4000-8000-000000000008 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;use&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Array [])]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,118999990),(ff,\&quot;USDT\&quot;,70000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;available assets: 70000000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;found oracle, exchange rate 1700000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: W5: TxSubmit: 84bec9a9044eee9c5b40029dca5bbc8346214504e5adb4745bbe6e5d7d96078e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: TxnValidate 84bec9a9044eee9c5b40029dca5bbc8346214504e5adb4745bbe6e5d7d96078e</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  sá»± hoÃ¡n Ä‘á»•i xáº£y ra á»Ÿ vá»‹ trÃ­ 16.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00016: ```  CONTRACT LOG: &quot;made swap with price [(ff,\&quot;USDT\&quot;,17000000)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  á»Ÿ dÆ°á»›i cÃ¹ng, chÃºng tÃ´i tháº¥y sá»‘ dÆ° cuá»‘i cÃ¹ng.</p><p>VÃ­ 2 váº«n cÃ³ táº¥t cáº£ tiá»n cá»§a nÃ³. Táº¥t cáº£ nhá»¯ng gÃ¬ VÃ­ 2 Ä‘Ã£ lÃ m lÃ  kiá»ƒm tra báº±ng Oracle, khÃ´ng tá»‘n báº¥t ká»³ chi phÃ­ nÃ o, vÃ¬ nÃ³ hoÃ n toÃ n lÃ  má»™t váº¥n Ä‘á» off-chain.</p><p>VÃ­ 1 Ä‘Ã£ tráº£ má»™t sá»‘ phÃ­ giao dá»‹ch nhÆ°ng káº¿t thÃºc vá»›i sá»‘ tiá»n cao hÆ¡n khoáº£ng 2 Ada so vá»›i ban Ä‘áº§u. Äiá»u nÃ y lÃ  do nÃ³ Ä‘Ã£ thu 2 Ada phÃ­ sá»­ dá»¥ng oracle.</p><p>VÃ­ 3 vÃ  4 Ä‘á»u Ä‘Æ°a ra Ä‘á» nghá»‹ vÃ  sá»‘ dÆ° cá»§a chÃºng pháº£n Ã¡nh tá»· giÃ¡ há»‘i Ä‘oÃ¡i mÃ  táº¡i Ä‘Ã³ cÃ¡c Ä‘á» nghá»‹ cá»§a chÃºng Ä‘Ã£ Ä‘Æ°á»£c cháº¥p nháº­n.</p><p>VÃ­ 5 lÃ  ngÆ°á»i cháº¥p nháº­n cÃ¡c Ä‘á» nghá»‹ vÃ  Ada bá»• sung cÅ©ng váº­y, nhÆ°ng sá»‘ dÆ° MÃ£ thÃ´ng bÃ¡o USD bá»‹ giáº£m. LÆ°u Ã½ ráº±ng VÃ­ 5 cÅ©ng Ä‘Ã£ bá»‹ kháº¥u trá»« má»™t sá»‘ khoáº£n phÃ­ tá»« sá»‘ dÆ° Ada cá»§a nÃ³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Final balances</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 1: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 101999950</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 2: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 3: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 117000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 89999990</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 4: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 130000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 79999990</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 5: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 127999980</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 53000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 6: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 7: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 8: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 9: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 10: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  cuá»‘i cÃ¹ng, cÅ©ng nhÆ° cÃ¡c vÃ­, chÃºng ta tháº¥y ráº±ng oracle váº«n tiáº¿p tá»¥c, vÃ  váº«n sá»Ÿ há»¯u NFT. LÆ°u Ã½ ráº±ng, trong nháº­t kÃ½ nÃ y, chÃºng tÃ´i khÃ´ng tháº¥y giÃ¡ trá»‹ datum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Script cc6a43073dce46eebc7b309223904c7a8033ffab7d9b239cf013342d4c69a5d6: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, &quot;&quot;}: 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="plutus-application-backend-pab"></a>Plutus Application Backend (PAB)<a class="hash-link" href="#plutus-application-backend-pab" title="Direct link to heading">#</a></h2><p>NgoÃ i Ã½ tÆ°á»Ÿng vá» cÃ¡ch triá»ƒn khai má»™t oracle trong Plutus, khÃ´ng cÃ³ gÃ¬ chÃºng tÃ´i Ä‘Ã£ lÃ m trong bÃ i giáº£ng nÃ y cho Ä‘áº¿n nay lÃ  má»›i, ngoáº¡i trá»« má»™t vÃ i hÃ m thÆ° viá»‡n vÃ  ká»¹ thuáº­t Haskell. Vá» nguyÃªn táº¯c, chÃºng ta Ä‘Ã£ quen thuá»™c vá»›i cÃ¡ch trÃ¬nh xÃ¡c thá»±c Ä‘Æ°á»£c viáº¿t cho mÃ£ off-chain vÃ  cÃ¡ch há»£p Ä‘á»“ng Ä‘Æ°á»£c viáº¿t cho mÃ£ on-chain cÅ©ng nhÆ° cÃ¡ch chÃºng ta cÃ³ thá»ƒ kiá»ƒm tra mÃ£ cá»§a mÃ¬nh vá»›i <code>EmulatorTrace</code>  monad.</p><p>NhÆ°ng bÃ¢y giá» chÃºng ta sáº½ nÃ³i vá» má»™t thá»© má»›i - Plutus Application Backend (PAB), cho phÃ©p chÃºng ta láº¥y táº¥t cáº£ nhá»¯ng thá»© chÃºng ta Ä‘Ã£ lÃ m vÃ  biáº¿n nÃ³ thÃ nh má»™t tá»‡p thá»±c thi cháº¡y cÃ¡c há»£p Ä‘á»“ng.</p><p>Náº¿u testnet hoáº·c mainnet cÃ³ sáºµn vá»›i sá»± há»— trá»£ cá»§a Plutus, chÃºng tÃ´i cÃ³ thá»ƒ triá»ƒn khai má»™t á»©ng dá»¥ng nhÆ° váº­y, nhÆ°ng hiá»‡n táº¡i chÃºng tÃ´i sáº½ cáº§n hÃ i lÃ²ng vá»›i má»™t blockchain mÃ´ phá»ng. Tuy nhiÃªn, quÃ¡ trÃ¬nh biáº¿n mÃ£ thÃ nh má»™t dApp thá»±c táº¿ giá»‘ng nhÆ° trÃªn má»™t blockchain thá»±c.</p><p>ChÃºng ta cáº§n thÃªm má»™t mÃ´-Ä‘un nhá» ná»¯a, vá» cÆ¡ báº£n chá»‰ lÃ  má»™t Ä‘á»‹nh nghÄ©a kiá»ƒu. NÃ³ ráº¥t nhá», chÃºng tÃ´i cÃ³ thá»ƒ bao gá»“m toÃ n bá»™ ná»™i dung tá»‡p á»Ÿ Ä‘Ã¢y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# LANGUAGE DeriveAnyClass     #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{-# LANGUAGE DeriveGeneric      #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.PAB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ( OracleContracts (..)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ) where</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Data.Aeson                (FromJSON, ToJSON)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Data.Text.Prettyprint.Doc (Pretty (..), viaShow)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           GHC.Generics              (Generic)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import qualified Week06.Oracle.Core        as Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data OracleContracts = Init | Oracle CurrencySymbol | Swap Oracle.Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deriving (Eq, Ord, Show, Generic, FromJSON, ToJSON)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Pretty OracleContracts where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pretty = viaShow</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ã tÆ°á»Ÿng lÃ  nÃ³ sá»­a Ä‘á»•i cÃ¡c phiÃªn báº£n há»£p Ä‘á»“ng mÃ  chÃºng tÃ´i muá»‘n cháº¡y. ChÃºng tÃ´i cÃ³ nhiá»u há»£p Ä‘á»“ng khÃ¡c nhau vÃ  chÃºng tÃ´i muá»‘n cÃ³ má»™t kiá»ƒu dá»¯ liá»‡u trong Ä‘Ã³ má»—i giÃ¡ trá»‹ cá»§a kiá»ƒu dá»¯ liá»‡u tÆ°Æ¡ng á»©ng vá»›i má»™t liÃªn há»‡ mÃ  cuá»‘i cÃ¹ng chÃºng tÃ´i muá»‘n cháº¡y.</p><p>PhÆ°Æ¡ng thá»©c khá»Ÿi táº¡o <code>Init</code>  sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thiáº¿t láº­p má»™t mÃ´i trÆ°á»ng nÆ¡i cÃ³ sáºµn MÃ£ thÃ´ng bÃ¡o USD vÃ  nÆ¡i cÃ¡c vÃ­ cÃ³ nguá»“n cung cáº¥p ban Ä‘áº§u cá»§a chÃºng.</p><p>HÃ m <code>Oracle</code> táº¡o tÆ°Æ¡ng á»©ng vá»›i <code>runOracle</code> há»£p Ä‘á»“ng sáº½ báº¯t Ä‘áº§u <code>oracle</code> vÃ  cung cáº¥p endpoint <code>update</code> , vÃ  tham sá»‘ <code>CurrencySymbol</code>  sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng cho MÃ£ thÃ´ng bÃ¡o USD.</p><p>Cuá»‘i cÃ¹ng, cÃ¡c Swap, tham sá»‘ hÃ³a báº±ng cÃ¡ch <code>Oracle</code> sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cháº¡y cÃ¡c há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i, cung cáº¥p thiáº¿t bá»‹ Ä‘áº§u cuá»‘i khÃ¡c nhau nhÆ° <code>offer</code> , <code>retrieve</code>, <code>use</code> vÃ  <code>funds</code>.</p><p>ChÃºng ta cáº§n Ä‘á»‹nh nghÄ©a <code>OracleContracts</code>  trong má»™t mÃ´-Ä‘un riÃªng biá»‡t vÃ¬ chÃºng ta sáº½ sá»­ dá»¥ng nÃ³ cáº£ tá»« PAB vÃ  cáº£ tá»« giao diá»‡n ngÆ°á»i dÃ¹ng.</p><p>ChÃºng ta sáº½ xem xÃ©t tá»‡p Cabal.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">plutus-pioneer-program-week06.cabal</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong Ä‘Ã³, chÃºng tÃ´i cÃ³ cÃ¡c Ä‘á»‹nh nghÄ©a cho cÃ¡c tá»‡p thá»±c thi khÃ¡c nhau.</p><p>Táº­p tin <code>oracle-pab</code>  thá»±c thi sáº½ thiáº¿t láº­p má»™t vÃ­ mÃ´ phá»ng, khá»Ÿi táº¡o táº¥t cáº£ cÃ¡c há»£p Ä‘á»“ng vÃ  thiáº¿t láº­p má»™t mÃ¡y chá»§ web cho phÃ©p tháº¿ giá»›i bÃªn ngoÃ i tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c há»£p Ä‘á»“ng nÃ y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable oracle-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: oracle-pab.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall -threaded</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       aeson</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , freer-extras</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , freer-simple</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-contract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pioneer-program-week06</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-use-cases</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tá»‡p <code>oracle-clientt</code> thá»±c thi sáº½ Ä‘Æ°á»£c cháº¡y bá»Ÿi nhÃ  cung cáº¥p oracle, do Ä‘Ã³, tá»‡p sáº½ tÆ°Æ¡ng tÃ¡c vá»›i há»£p Ä‘á»“ng <code>runOracle</code> . NÃ³ cÅ©ng sáº½ láº¥y tá»· giÃ¡ há»‘i Ä‘oÃ¡i tá»« internet vÃ  Ä‘Æ°a chÃºng vÃ o há»‡ thá»‘ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable oracle-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: oracle-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , bytestring</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , regex-tdfa ^&gt;= 1.3.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , req ^&gt;= 3.9.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, tá»‡p cÃ³ <code>swap-client</code>  thá»±c thi sáº½ Ä‘Æ°á»£c cháº¡y bá»Ÿi cÃ¡c khÃ¡ch hÃ ng muá»‘n sá»­ dá»¥ng há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable swap-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: swap-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       aeson</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pioneer-program-week06</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , req ^&gt;= 3.9.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta sáº½ láº§n lÆ°á»£t xem xÃ©t tá»«ng Ä‘iá»u nÃ y.</p><p>Báº¡n cÃ³ thá»ƒ tÃ¬m tháº¥y mÃ£ cho tá»«ng á»©ng dá»¥ng nÃ y trong thÆ° má»¥c <code>app</code> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">app/oracle-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app/oracle-pab.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app/swap-client.hs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-pab"></a>Oracle PAB<a class="hash-link" href="#oracle-pab" title="Direct link to heading">#</a></h3><p>Äáº§u tiÃªn, má»™t sá»‘ báº£ng soáº¡n sáºµn Ä‘á»ƒ káº¿t ná»‘i kiá»ƒu dá»¯ liá»‡u mÃ  chÃºng ta vá»«a xÃ¡c Ä‘á»‹nh - cÃ¡c trÆ°á»ng há»£p há»£p Ä‘á»“ng Ä‘Æ°á»£c sá»­a Ä‘á»•i - vá»›i cÃ¡c lÆ°á»£c Ä‘á»“ vÃ  há»£p Ä‘á»“ng mÃ  chÃºng ta Ä‘Ã£ xÃ¡c Ä‘á»‹nh trÆ°á»›c Ä‘Ã³.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">handleOracleContracts ::</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ( Member (Error PABError) effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Member (LogMsg (PABMultiAgentMsg (Builtin OracleContracts))) effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    =&gt; ContractEffect (Builtin OracleContracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ~&gt; Eff effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">handleOracleContracts = handleBuiltin getSchema getContract where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getSchema = \case</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Init     -&gt; endpointsToSchemas @Empty</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Oracle _ -&gt; endpointsToSchemas @(Oracle.OracleSchema .\\ BlockchainActions)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Swap _   -&gt; endpointsToSchemas @(Oracle.SwapSchema   .\\ BlockchainActions)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getContract = \case</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Init        -&gt; SomeBuiltin   initContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Oracle cs   -&gt; SomeBuiltin $ Oracle.runOracle $ oracleParams cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Swap oracle -&gt; SomeBuiltin $ Oracle.swap oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>Init</code>  sáº½ khÃ´ng cÃ³ báº¥t ká»³ schema nÃ o ,vÃ¬ váº­y nÃ³ chá»‰ cÃ³ <code>BlockChainActions</code>.
<code>Oracle</code>  sá»­ dá»¥ng <code>OracleSchema</code>  vÃ  <code>Swap</code> sá»­ dá»¥ng <code>SwapSchema</code>. KhÃ´ng cÃ³ gÃ¬ ngáº¡c nhiÃªn á»Ÿ Ä‘Ã³.</p><p><code>Init</code>  sáº½ cháº¡y <code>initContract</code>, mÃ  chÃºng ta sáº½ tháº¥y trong giÃ¢y lÃ¡t.</p><p><code>Oracle</code>  sáº½ cháº¡y há»£p Ä‘á»“ng <code>runOracle</code> vá»›i <code>oracleParams</code> kÃ½ hiá»‡u tiá»n tá»‡ cá»§a USD Token vÃ  vÃ­ dá»¥ Ä‘á»‹nh nghÄ©a oracleparams.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleParams :: CurrencySymbol -&gt; Oracle.OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleParams cs = Oracle.OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { Oracle.opFees   = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Oracle.opSymbol = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Oracle.opToken  = usdt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>vÃ  cuá»‘i cÃ¹ng <code>Swap</code>  sáº½ cháº¡y há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i vá»›i má»™t giÃ¡ trá»‹ oracle.</p><p>ÄÃ¢y lÃ  má»™t sá»‘ báº£n copy/paste boilerplate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">handlers :: SimulatorEffectHandlers (Builtin OracleContracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">handlers =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Simulator.mkSimulatorHandlers @(Builtin OracleContracts) []</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $ interpret handleOracleContracts        </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  Ä‘Ã¢y lÃ  hÃ m <code>initContract</code>  mÃ  chÃºng tÃ´i Ä‘Ã£ Ä‘á» cáº­p ngay trÆ°á»›c Ä‘Ã¢y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">initContract :: Contract (Last CurrencySymbol) BlockchainActions Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">initContract = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownPK &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cur   &lt;-</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mapError (pack . show)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Currency.forgeContract ownPK [(usdt, fromIntegral (length wallets) ` amount)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        :: Contract (Last CurrencySymbol) BlockchainActions Currency.CurrencyError Currency.OneShotCurrency)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let cs = Currency.currencySymbol cur</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        v  = Value.singleton cs usdt amount</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    forM_ wallets $ \w -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        let pkh = pubKeyHash $ walletPubKey w</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (pkh /= ownPK) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            tx &lt;- submitTx $ mustPayToPubKey pkh v</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tell $ Last $ Just cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    amount :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    amount = 100_000_000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>initContract</code>  Ä‘Ãºc Tokens USD  phÃ¢n phá»‘i chÃºng Ä‘áº¿n cÃ¡c vÃ­, sau Ä‘Ã³ nÃ³ telllÃ  biá»ƒu tÆ°á»£ng tiá»n tá»‡ cho Token USD .</p><p>VÃ­ Ä‘Æ°á»£c mÃ£ hÃ³a cá»©ng trÆ°á»›c Ä‘Ã³ trong mÃ£. Sá»‘ lÆ°á»£ng vÃ­ vÃ  sá»‘ token Ä‘Æ°á»£c trao cho chÃºng lÃ  hoÃ n toÃ n tÃ¹y Ã½.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">wallets :: [Wallet]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">wallets = [Wallet i | i &lt;- [1 .. 5]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» chÃºng ta cÃ³ thá»ƒ nhÃ¬n vÃ o mÃ£ PAB thá»±c táº¿.</p><p>Láº§n Ä‘áº§u tiÃªn, chÃºng ta tháº¥y má»™t hÃ m <code>main</code>  lÃ  Ä‘iá»ƒm nháº­p cá»§a tá»‡p thá»±c thi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = void $ Simulator.runSimulationWith handlers $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Simulator.logString @(Builtin OracleContracts) &quot;Starting Oracle PAB webserver. Press enter to exit.&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    shutdown &lt;- PAB.Server.startServerDebug</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cidInit &lt;- Simulator.activateContract (Wallet 1) Init</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cs      &lt;- waitForLast cidInit</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _       &lt;- Simulator.waitUntilFinished cidInit</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cidOracle &lt;- Simulator.activateContract (Wallet 1) $ Oracle cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ writeFile &quot;oracle.cid&quot; $ show $ unContractInstanceId cidOracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- waitForLast cidOracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    forM_ wallets $ \w -&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (w /= Wallet 1) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            cid &lt;- Simulator.activateContract w $ Swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            liftIO $ writeFile (&#x27;W&#x27; : show (getWallet w) ++ &quot;.cid&quot;) $ show $ unContractInstanceId cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ liftIO getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    shutdown</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>CÃ¡c hÃ m <code>main</code>  sá»­ dá»¥ng monad khÃ¡c  mÃ  chÃºng ta chÆ°a tá»«ng tháº¥y trÆ°á»›c Ä‘Ã¢y vÃ  lÃ  Ä‘áº·c trÆ°ng cho PAB  - CÃ¡c <code>Simulator</code>  monad.</p><p>CÃ¡i <code>Simulator</code>  monad lÃ  ráº¥t giá»‘ng vá»›i <code>EmulatorTrace</code>  monad. Vá» nguyÃªn táº¯c nÃ³ cÃ³ cÃ¡c kháº£ nÄƒng nhÆ° nhau. Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u cÃ¡c há»£p Ä‘á»“ng trÃªn vÃ­, báº¡n cÃ³ thá»ƒ kiá»ƒm tra tráº¡ng thÃ¡i báº±ng cÃ¡ch sá»­ dá»¥ng nháº­t kÃ½, báº¡n cÃ³ thá»ƒ gá»i cÃ¡c endpoint, v.v.</p><p>CÃ³ má»™t chÃºt Ä‘Ã¡ng tiáº¿c lÃ  cÃ³ hai monads cho Ä‘iá»u nÃ y vÃ¬ chÃºng ráº¥t giá»‘ng nhau. NhÃ³m Plutus cÃ³ káº¿ hoáº¡ch sáº¯p xáº¿p chÃºng vÃ  cÃ³ thá»ƒ biáº¿n chÃºng thÃ nh má»™t. VÃ¬ váº­y, nÃ³ cÃ³ thá»ƒ khÃ´ng Ä‘Ã¡ng Ä‘á»ƒ tÃ¬m hiá»ƒu nhá»¯ng Ä‘iá»u phá»©c táº¡p cá»§a <code>Simulator</code> monad vÃ¬ nÃ³ cÃ³ thá»ƒ sáº½ sá»›m thay Ä‘á»•i.</p><p>TÆ°Æ¡ng tá»± nhÆ° <code>runEmulatorTraceIO</code>,ChÃºng ta cÃ³ <code>runSimulationWith</code>Ä‘á»ƒ pass qua <code>handlers</code>  boilerplate.</p><p>Tuy nhiÃªn má»™t sá»± khÃ¡c biá»‡t <code>EmulatorTrace</code> monad:
<code>EmulatorTrace</code>  monad lÃ  mÃ£ thuáº§n tÃºy - khÃ´ng cÃ³ tÃ¡c dá»¥ng phá»¥ trong tháº¿ giá»›i thá»±c, khÃ´ng liÃªn quan Ä‘áº¿n IO. Äáº·c biá»‡t cÃ³ má»™t trÃ¬nh thÃ´ng dá»‹ch thuáº§n tÃºy <code>runEmulatorTrace</code> lÃ  má»™t hÃ m Haskell thuáº§n tÃºy khÃ´ng cÃ³ tÃ¡c dá»¥ng phá»¥.</p><p><code>Simulator</code> khÃ¡c - báº¡n cÃ³ thá»ƒ lÃ m IO. CÃ¡ch nÃ³ hoáº¡t Ä‘á»™ng lÃ  Ä‘ang sá»­ dá»¥ng <code>MonadIO</code>, trong Ä‘Ã³ cÃ³ má»™t phÆ°Æ¡ng thá»©c <code>liftIO</code>, thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng <code>IO</code>  vÃ  <code>lifts</code>  nÃ³ trá»Ÿ thÃ nh monad Ä‘á» cáº­p . VÃ¬ váº­y, náº¿u báº¡n cÃ³ má»™t sá»‘ hÃ nh Ä‘á»™ng IO tÃ¹y Ã½ mÃ  báº¡n cÃ³ thá»ƒ thá»±c hiá»‡n trong Haskell, thÃ¬ báº±ng cÃ¡ch Ã¡p dá»¥ng <code>liftIO</code> cho nÃ³, báº¡n cÃ³ thá»ƒ chuyá»ƒn nÃ³ vÃ o <code>Simulator</code>  monad.</p><p>NgoÃ i ra, náº¿u báº¡n nheo máº¯t, nÃ³ trÃ´ng ráº¥t giá»‘ng vá»›i má»™t <code>EmulatorTrace</code>.</p><p>Äiá»u Ä‘áº§u tiÃªn chÃºng tÃ´i lÃ m lÃ  sá»­ dá»¥ng <code>logString</code>  á»ƒ ghi láº¡i ráº±ng chÃºng tÃ´i Ä‘ang khá»Ÿi Ä‘á»™ng mÃ¡y chá»§ PAB. Sau Ä‘Ã³, chÃºng tÃ´i gá»i hÃ m <code>startServerDebug</code>, Ã  giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m Ä‘Ã³ Ä‘Æ°á»£c liÃªn káº¿t vá»›i  <code>shutdown</code>  Ã³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng sau nÃ y Ä‘á»ƒ táº¯t mÃ¡y chá»§.</p><p>BÃ¢y giá» chÃºng tÃ´i sá»­ dá»¥ng má»™t cÃ¡i gÃ¬ Ä‘Ã³ Ä‘Æ°á»£c gá»i <code>activateContract</code>  lÃ  tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i <code>activateContractWallet</code>  tá»« <code>EmulatorTrace</code>  monad.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cidInit &lt;- Simulator.activateContract (Wallet 1) Init</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NÃ³ cáº§n má»™t vÃ­ mÃ  chÃºng ta muá»‘n báº¯t Ä‘áº§u phiÃªn báº£n Ä‘Ã³ vÃ  sau Ä‘Ã³ lÃ  má»™t giÃ¡ trá»‹ cá»§a loáº¡i há»£p Ä‘á»“ng Ä‘Ã£ Ä‘Æ°á»£c sá»­a Ä‘á»•i. HÃ£y nhá»› ráº±ng chÃºng ta Ä‘Ã£ liÃªn káº¿t táº¡o hÃ m <code>Init</code>
vá»›i hÃ m <code>initContract</code> .</p><p>BÃ¢y giá» chÃºng ta cáº§n kÃ½ hiá»‡u tiá»n tá»‡. ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch chÃºng tÃ´i láº¥y thÃ´ng tin ra khá»i há»£p Ä‘á»“ng báº±ng cÃ¡ch sá»­ dá»¥ng <code>tell</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cs &lt;- waitForLast cidInit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>cidInit</code>  sá»­ dá»¥ng má»™t hÃ m tá»« monad <code>Simulator</code> Ä‘Æ°á»£c gá»i lÃ 
<code>waitForState</code>, hÃ m nÃ y nháº­n má»™t há»£p Ä‘á»“ng vÃ  má»™t vá»‹ tá»«. Vá»‹ tá»« nháº­n má»™t biá»ƒu thá»©c JSON vÃ  tráº£ vá»  <code>Maybe a</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">waitForLast :: FromJSON a =&gt; ContractInstanceId -&gt; Simulator.Simulation t a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">waitForLast cid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    flip Simulator.waitForState cid $ \json -&gt; case fromJSON json of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Success (Last (Just x)) -&gt; Just x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _                       -&gt; Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ã tÆ°á»Ÿng lÃ  nÃ³ sáº½ Ä‘á»c tráº¡ng thÃ¡i cá»§a há»£p Ä‘á»“ng mÃ  chÃºng tÃ´i Ä‘Ã£ viáº¿t báº±ng cÃ¡ch sá»­ dá»¥ng <code>tell</code>. Äiá»u nÃ y Ä‘Æ°á»£c tuáº§n tá»± hÃ³a dÆ°á»›i dáº¡ng giÃ¡ trá»‹ JSON vÃ  nÃ³ Ã¡p dá»¥ng giÃ¡ trá»‹ JSON nÃ y cho vá»‹ tá»« (predicate) Ä‘Æ°á»£c cung cáº¥p. Náº¿u káº¿t quáº£ lÃ  <code>Nothing</code>, nÃ³ chá»‰ cáº§n Ä‘á»£i cho Ä‘áº¿n khi tráº¡ng thÃ¡i thay Ä‘á»•i má»™t láº§n ná»¯a. NhÆ°ng, náº¿u Ä‘Ãºng nhÆ° váº­y <code>Just x</code> nÃ³ sáº½ tráº£ vá» <code>x</code>.</p><p>CÃ³ thá»ƒ cÃ³ hai cÃ¡ch <code>Nothing</code> - phÃ¢n tÃ­ch cÃº phÃ¡p JSON cÃ³ thá»ƒ khÃ´ng thÃ nh cÃ´ng hoáº·c chÃºng ta cÃ³ thá»ƒ nháº­n Ä‘Æ°á»£c <code>Last Nothing</code>. VÃ¬ váº­y, káº¿t quáº£ cuá»‘i cÃ¹ng lÃ  hÃ m Ä‘á»£i cho Ä‘áº¿n khi tráº¡ng thÃ¡i cá»§a há»£p Ä‘á»“ng cho biáº¿t má»™t giÃ¡ trá»‹ <code>Just</code>.</p><p>Táº¡i thá»i Ä‘iá»ƒm nÃ y, chÃºng tÃ´i cÃ³ kÃ½ hiá»‡u tiá»n tá»‡ bá»‹ rÃ ng buá»™c <code>cs</code>. VÃ  sau Ä‘Ã³ chÃºng tÃ´i chá» Ä‘á»£i cho Ä‘áº¿n khi <code>initContract</code> káº¿t thÃºc.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">_ &lt;- Simulator.waitUntilFinished cidInit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÆ°á»›c tiáº¿p theo lÃ  báº¯t Ä‘áº§u oracle trÃªn VÃ­ 1, sá»­ dá»¥ng giÃ¡ trá»‹ <code>cs</code>  mÃ  chÃºng tÃ´i Ä‘Ã£ thu Ä‘Æ°á»£c gáº§n Ä‘Ã¢y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cidOracle &lt;- Simulator.activateContract (Wallet 1) $ Oracle cs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i há»£p Ä‘á»“ng oracle tá»« tháº¿ giá»›i bÃªn ngoÃ i, vÃ­ dá»¥ nhÆ° tá»« giao diá»‡n web, chÃºng ta cáº§n báº¯t tay vÃ o xá»­ lÃ½ <code>cidOracle</code> .</p><p>VÃ¬ váº­y, nhá»¯ng gÃ¬ chÃºng tÃ´i lÃ m lÃ  ghi Ä‘iá»u nÃ y vÃ o má»™t tá»‡p cÃ³ tÃªn <code>oracle.cid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">liftIO $ writeFile &quot;oracle.cid&quot; $ show $ unContractInstanceId cidOracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u nÃ y chá»‰ lÃ  nhanh chÃ³ng vÃ  khÃ´ng tá»‘t Ä‘á»ƒ trÃ¬nh diá»…n. Trong mÃ£ sáº£n xuáº¥t, báº¡n sáº½ sá»­ dá»¥ng má»™t cÆ¡ cháº¿ an toÃ n hÆ¡n.</p><p>BÃ¢y giá» chÃºng tÃ´i sá»­ dá»¥ng <code>waitForLast</code> má»™t láº§n ná»¯a Ä‘á»ƒ nháº­n giÃ¡ trá»‹ oracle, mÃ  chÃºng tÃ´i Ä‘Ã£ cung cáº¥p tá»« há»£p Ä‘á»“ng <code>runOracle</code>  thÃ´ng qua <code>tell</code>. ChÃºng ta cáº§n Ä‘iá»u nÃ y vÃ¬ há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i Ä‘Æ°á»£c tham sá»‘ hÃ³a bá»Ÿi giÃ¡ trá»‹ nÃ y.</p><p>á» giai Ä‘oáº¡n nÃ y, NFT Ä‘Æ°á»£c Ä‘Ãºc vÃ  chÃºng ta biáº¿t giÃ¡ trá»‹ oracle lÃ  gÃ¬.</p><p>Tiáº¿p theo, chÃºng tÃ´i láº·p qua táº¥t cáº£ cÃ¡c vÃ­, ngoáº¡i trá»« vÃ­ 1 cháº¡y oracle vÃ  chÃºng tÃ´i kÃ­ch hoáº¡t há»£p Ä‘á»“ng hoÃ¡n Ä‘á»•i trÃªn má»—i vÃ­. á» Ä‘Ã¢y chÃºng tÃ´i sá»­ dá»¥ng má»™t phÆ°Æ¡ng phÃ¡p ghi tá»‡p tÆ°Æ¡ng tá»± Ä‘á»ƒ náº¯m giá»¯ cÃ¡c quy trÃ¬nh xá»­ lÃ½ há»£p Ä‘á»“ng</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">forM_ wallets $ \w -&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    when (w /= Wallet 1) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        cid &lt;- Simulator.activateContract w $ Swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        liftIO $ writeFile (&#x27;W&#x27; : show (getWallet w) ++ &quot;.cid&quot;) $ show $ unContractInstanceId cid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá» chÃºng tÃ´i chá»‰ cháº·n cho Ä‘áº¿n khi ngÆ°á»i dÃ¹ng nháº¥n enter, sau Ä‘Ã³ chÃºng tÃ´i táº¯t mÃ¡y chá»§.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ liftIO getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">shutdown</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>KhÃ´ng thá»±c sá»± cáº§n thiáº¿t pháº£i lÃ m táº¥t cáº£ nhá»¯ng Ä‘iá»u nÃ y, vÃ¬ báº¡n cÅ©ng cÃ³ thá»ƒ báº¯t Ä‘áº§u vÃ  dá»«ng cÃ¡c phiÃªn báº£n há»£p Ä‘á»“ng tá»« giao diá»‡n web. á» Ä‘Ã¢y, chÃºng tÃ´i dá»… dÃ ng thá»±c hiá»‡n Ä‘iá»u Ä‘Ã³ hÆ¡n theo cÃ¡ch cÃ³ ká»‹ch báº£n cho báº£n demo, nhÆ°ng vá» nguyÃªn táº¯c, báº¡n chá»‰ cÃ³ thá»ƒ khá»Ÿi Ä‘á»™ng trÃ¬nh mÃ´ phá»ng vÃ  sau Ä‘Ã³ Ä‘á»£i cho Ä‘áº¿n khi báº¡n táº¯t mÃ¡y.</p><p>Náº¿u báº¡n tÃ² mÃ² vá» API do PAB cung cáº¥p, báº¡n cÃ³ thá»ƒ kiá»ƒm tra Ä‘iá»u Ä‘Ã³ trong gÃ³i <code>plutus-pab</code> , trong mÃ´-Ä‘un <code>Plutus.PAB.Webserver.API</code>. NhÆ°ng cÃ¡i mÃ  chÃºng tÃ´i Ä‘ang sá»­ dá»¥ng á»Ÿ Ä‘Ã¢y lÃ :</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-- | PAB client API for contracts of type @t@. Examples of @t@ are</span></div><div class="token-line" style="color:#393A34"><span class="token plain">--   ` Contract executables that reside in the user&#x27;s file system</span></div><div class="token-line" style="color:#393A34"><span class="token plain">--   ` &quot;Builtin&quot; contracts that run in the same process as the PAB (ie. the PAB is compiled &amp; distributed with these contracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">type NewAPI t walletId -- see note [WalletID type in wallet API]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    = &quot;api&quot; :&gt; &quot;new&quot; :&gt; &quot;contract&quot; :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (&quot;activate&quot; :&gt; ReqBody &#x27;[ JSON] (ContractActivationArgs t) :&gt; Post &#x27;[JSON] ContractInstanceId -- start a new instance</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instance&quot; :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (Capture &quot;contract-instance-id&quot; Text :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        ( &quot;status&quot; :&gt; Get &#x27;[JSON] (ContractInstanceClientState t) -- Current status of contract instance</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        :&lt;|&gt; &quot;endpoint&quot; :&gt; Capture &quot;endpoint-name&quot; String :&gt; ReqBody &#x27;[JSON] JSON.Value :&gt; Post &#x27;[JSON] () -- Call an endpoint. Make</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        :&lt;|&gt; &quot;stop&quot; :&gt; Put &#x27;[JSON] () -- Terminate the instance.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instances&quot; :&gt; &quot;wallet&quot; :&gt; Capture &quot;wallet-id&quot; walletId :&gt; Get &#x27;[JSON] [ContractInstanceClientState t]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instances&quot; :&gt; Get &#x27;[ JSON] [ContractInstanceClientState t] -- list of all active contract instances</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;definitions&quot; :&gt; Get &#x27;[JSON] [ContractSignatureResponse t] -- list of available contracts</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äiá»u nÃ y lÃ m cho viá»‡c sá»­ dá»¥ng thÆ° viá»‡n Haskell phá»• biáº¿n <code>Servant</code> Ä‘á»ƒ viáº¿t cÃ¡c á»©ng dá»¥ng web an toÃ n, nhÆ°ng nÃ³ sáº½ cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c Ã­t nhiá»u mÃ  khÃ´ng cáº§n biáº¿t vá» thÆ° viá»‡n <code>Servant</code> . VÃ­ dá»¥: báº¡n cÃ³ thá»ƒ tháº¥y endpoint <code>/api/new/contract/activate</code> Ä‘Æ°á»£c khai bÃ¡o mÃ  báº¡n cÃ³ thá»ƒ dÃ¹ng <code>ContractActivationArgs</code> lÃ m pháº§n thÃ¢n cá»§a nÃ³ vÃ  tráº£ vá» má»™t <code>ContractInstanceId</code>.</p><p>NgoÃ i ra cÃ²n cÃ³ má»™t API á»• cáº¯m web, nhÆ°ng chÃºng tÃ´i Ä‘Ã£ khÃ´ng sá»­ dá»¥ng nÃ³ trong vÃ­ dá»¥ nÃ y.</p><p>VÃ¬ váº­y, hÃ£y thá»­ tá»‡p thá»±c thi cá»§a chÃºng tÃ´i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-pab</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng tÃ´i nháº­n Ä‘Æ°á»£c Ä‘áº§u ra nháº­t kÃ½ tÆ°Æ¡ng tá»± nhÆ° nhá»¯ng gÃ¬ chÃºng tÃ´i tháº¥y vá»›i <code> EmulatorTrace</code> , nhÆ°ng Ä‘Ã¢y bÃ¢y giá» lÃ  má»™t mÃ¡y chá»§ trá»±c tiáº¿p.</p><p>Äáº§u ra bÃªn dÆ°á»›i Ä‘Æ°á»£c giáº£m bá»›t Ä‘á»ƒ trÃ¡nh Ä‘áº§y Ä‘á»§ chi tiáº¿t.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 0: TxnValidate af5e6d25b5ecb26185289a03d50786b7ac4425b21849143ed7e18bcd70dc4db8</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Starting Oracle PAB webserver. Press enter to exit.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Starting PAB backend server on port: 8080</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance dda39c83-5a0f-484f-b49a-9943b1ff5526 on W1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     Tx:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                       Tx da767478580878690990b3a22387be9c5b27fabed2c0ca7b9991eb682a6781f8:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         {inputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         outputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                           - Value (Map [(,Map [(&quot;&quot;,1)])]) addressed to</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                             addressed to ScriptCredential: e9827f1a9e43109d1c8d4555913734b8c48a467a31061b312959f270850fc8a0 (no staking credential)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         forge: Value (Map [])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         fee: Value (Map [(,Map [(&quot;&quot;,10)])])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         mps:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         validity range: Interval {ivFrom = LowerBound NegInf True, ivTo = UpperBound PosInf True}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         data:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                           &lt;&gt;}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     Requires signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1: TxnValidate b7d6ba18d02898aa5d0814a306e4a05cf153c199aabb175ef9b00328105ab98f</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 2: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 6: TxnValidate d690122263521c37f308a0d5ae858aa4807cb1e493c2a3374bf65b934c74782a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance deceaa52-f117-46bc-b0f1-eb1f2f529b5a on W1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 7: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 7: TxnValidate a679948d128735ec1f380e9f733d7f4a5e54c81f39c73a656d61b077111840e1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 8: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 8: TxnValidate f0125e685edd6de2d09f9547f53b18d1bad11bd7fad570a057ba74737ab3053e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] deceaa52-f117-46bc-b0f1-eb1f2f529b5a: &quot;started oracle Oracle {oSymbol = b8a1d67cd94acf75d7e00f27015ec5e31242adad0967eee473f49c5d1d686169, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;)}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 5bac6e67-f956-45ef-b386-f1d045cf5e37 on W2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 2c3a2794-2592-4c2b-9a7d-9c810cedf886 on W3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 6f8d611d-a3f6-4794-9048-8ea3201e3c56 on W4</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 387d9651-6024-48c1-a72d-5b3c6d3a6b53 on W5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ­ dá»¥, chÃºng ta cÃ³ thá»ƒ tháº¥y nÆ¡i chÃºng ta cÃ³ thá»ƒ tÃ¬m tháº¥y ID phiÃªn báº£n cá»§a cÃ¡c há»£p Ä‘á»“ng náº¿u chÃºng ta muá»‘n tÆ°Æ¡ng tÃ¡c vá»›i chÃºng thÃ´ng qua API.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance deceaa52-f117-46bc-b0f1-eb1f2f529b5a on W1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u bÃ¢y giá» chÃºng ta dá»«ng mÃ¡y chá»§ vÃ  tÃ¬m trong thÆ° má»¥c, chÃºng ta sáº½ tháº¥y cÃ¡c tá»‡p mÃ  chÃºng ta Ä‘Ã£ lÆ°u trá»¯ cÃ¡c ID phiÃªn báº£n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[nix-shell:~/git/ada/pioneer-fork/code/week06]$ ls</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app            dist-newstyle  LICENSE     plutus-pioneer-program-week06.cabal  W2.cid  W4.cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">cabal.project  hie.yaml       oracle.cid  src                                  W3.cid  W5.cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[nix-shell:~/git/ada/pioneer-fork/code/week06]$ cat W5.cid </span></div><div class="token-line" style="color:#393A34"><span class="token plain">387d9651-6024-48c1-a72d-5b3c6d3a6b53</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vá»›i thÃ´ng tin nÃ y - thu Ä‘Æ°á»£c tá»« nháº­t kÃ½ mÃ¡y chá»§ web hoáº·c tá»« cÃ¡c tá»‡p chÃºng tÃ´i Ä‘Ã£ táº¡o, chÃºng tÃ´i cÃ³ thá»ƒ sá»­ dá»¥ng báº¥t ká»³ cÃ´ng cá»¥ HTTP nÃ o nhÆ° Curl hoáº·c Postman Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c há»£p Ä‘á»“ng khi mÃ¡y chá»§ web Ä‘ang cháº¡y. Theo máº·c Ä‘á»‹nh, nÃ³ cháº¡y trÃªn cá»•ng 8080. ChÃºng tÃ´i cÅ©ng cÃ³ thá»ƒ viáº¿t mÃ£ báº±ng báº¥t ká»³ ngÃ´n ngá»¯ láº­p trÃ¬nh nÃ o mÃ  chÃºng tÃ´i muá»‘n Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i mÃ¡y chá»§ web báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c endpoints HTTP.</p><p>BÃ¢y giá» chÃºng ta sáº½ xem xÃ©t ngáº¯n gá»n vá» <code>oracle-client</code> vÃ  <code>swap-client</code>. ChÃºng tÃ´i sáº½ khÃ´ng Ä‘i vÃ o quÃ¡ nhiá»u chi tiáº¿t vÃ¬ chÃºng tÃ´i khÃ´ng quÃ¡ quan tÃ¢m Ä‘áº¿n cÃ¡ch viáº¿t giao diá»‡n ngÆ°á»i dÃ¹ng á»Ÿ Ä‘Ã¢y.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-client"></a>Oracle Client<a class="hash-link" href="#oracle-client" title="Direct link to heading">#</a></h3><p>ChÃºng tÃ´i sá»­ dá»¥ng thÆ° viá»‡n Haskell <code>Req</code>  á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i mÃ¡y chá»§ web.</p><p>Äáº§u tiÃªn chÃºng tÃ´i Ä‘á»c tá»‡p <code>oracle.cid</code>  Ä‘á»ƒ láº¥y ID phiÃªn báº£n oracle. Sau Ä‘Ã³, chÃºng ta cÃ³ má»™t hÃ m Ä‘á»‡ quy <code>go</code>.</p><p>HÃ m <code>go</code> tra cá»©u tá»· giÃ¡ há»‘i Ä‘oÃ¡i hiá»‡n táº¡i trÃªn CoinMarketCap, kiá»ƒm tra xem Ä‘iá»u Ä‘Ã³ Ä‘Ã£ thay Ä‘á»•i hay chÆ°a, vÃ  náº¿u cÃ³ thay Ä‘á»•i, nÃ³ sáº½ gá»i hÃ m <code>updateOracle</code> nÃ y gá»i lÃ  <code>endpoint updateOracle</code> trÃªn há»£p Ä‘á»“ng cá»§a chÃºng tÃ´i. VÃ , cho dÃ¹ thay Ä‘á»•i cÃ³ Ä‘Æ°á»£c phÃ¡t hiá»‡n hay khÃ´ng, nÃ³ sáº½ Ä‘á»£i trong nÄƒm giÃ¢y (tÃ¹y Ã½), rá»“i láº¡i tiáº¿p tá»¥c.</p><p>Thá»i gian trÃ¬ hoÃ£n sáº½ phá»¥ thuá»™c vÃ o nhá»¯ng Ä‘iá»u nhÆ° giá»›i háº¡n tá»· lá»‡ do CoinMarketCap Ã¡p Ä‘áº·t. TrÃªn thá»±c táº¿, vÃ¬ cÃ¡c khá»‘i trÃªn Cardano chá»‰ xuáº¥t hiá»‡n hai mÆ°Æ¡i giÃ¢y má»™t láº§n, nÃªn nÄƒm giÃ¢y cÃ³ láº½ lÃ  quÃ¡ ngáº¯n.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    uuid &lt;- read &lt;$&gt; readFile &quot;oracle.cid&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    putStrLn $ &quot;oracle contract instance id: &quot; ++ show uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: UUID -&gt; Maybe Integer -&gt; IO a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid m = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- getExchangeRate</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        let y = Just x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (m /= y) $</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            updateOracle uuid x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        threadDelay 5_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go uuid y</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>BÃ¢y giá», hÃ m <code>updateOracle</code>  chuáº©n bá»‹ má»™t yÃªu cáº§u POST báº±ng cÃ¡ch sá»­ dá»¥ng ID phiÃªn báº£n oracle vÃ  má»™t pháº§n thÃ¢n JSON chá»©a tá»· giÃ¡ há»‘i Ä‘oÃ¡i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle :: UUID -&gt; Integer -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle uuid x = runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        POST</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;endpoint&quot; /: &quot;update&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (ReqBodyJson x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Proxy :: Proxy (JsonResponse ()))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ putStrLn $ if responseStatusCode v == 200</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        then &quot;updated oracle to &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else &quot;error updating oracle&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vad Ä‘Ã¢y lÃ  hÃ m <code>getExchangeRate</code> cÃ¡i mÃ  nhanh chÃ³ng vÃ  hiá»‡u quáº£ Ä‘á»ƒ nháº­n tá»· giÃ¡ há»‘i Ä‘oÃ¡i tá»« CoinMarketCap. Há» cung cáº¥p má»™t API thÃ­ch há»£p, nhÆ°ng á»Ÿ Ä‘Ã¢y chÃºng tÃ´i chá»‰ thá»±c hiá»‡n má»™t sá»‘ thao tÃ¡c quÃ©t mÃ n hÃ¬nh tá»« trang web vÃ  sá»­ dá»¥ng <code>regex</code> Ä‘á»ƒ trÃ­ch xuáº¥t giÃ¡ trá»‹ mÃ  chÃºng tÃ´i quan tÃ¢m. Táº¥t nhiÃªn, Ä‘iá»u nÃ y ráº¥t má»ng manh vÃ  khÃ´ng bao giá» cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m mÃ£ sáº£n xuáº¥t.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getExchangeRate :: IO Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getExchangeRate = runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        GET</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (https &quot;coinmarketcap.com&quot; /: &quot;currencies&quot; /: &quot;cardano&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        NoReqBody</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        bsResponse</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mempty</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let priceRegex      = &quot;priceValue___11gHJ\&quot;&gt;\\$([\\.0-9]`)&quot; :: ByteString</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (_, _, _, [bs]) = responseBody v =~ priceRegex :: (ByteString, ByteString, ByteString, [ByteString])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        d               = read $ unpack bs :: Double</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x               = round $ 1_000_000 ` d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ putStrLn $ &quot;queried exchange rate: &quot; ++ show d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y Ä‘á»ƒ chÃºng tÃ´i cháº¡y nÃ³.</p><p>TrÆ°á»›c tiÃªn, chÃºng ta cáº§n Ä‘áº£m báº£o ráº±ng PAB Ä‘ang cháº¡y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-pab </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³, trong má»™t thiáº¿t bá»‹ Ä‘áº§u cuá»‘i khÃ¡c (terminal)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.54</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updated oracle to 1540000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.54</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cÃ³ thá»ƒ tháº¥y tá»· giÃ¡ há»‘i Ä‘oÃ¡i mÃ  nÃ³ thu Ä‘Æ°á»£c tá»« CoinMarketCap vÃ  yÃªu cáº§u cáº­p nháº­t oracle.</p><p>VÃ  náº¿u chÃºng ta Ä‘á»£i Ä‘á»§ lÃ¢u, chÃºng ta sáº½ tháº¥y</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.55</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updated oracle to 1550000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.55</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  chÃºng tÃ´i tháº¥y ráº±ng chÃºng tÃ´i Ä‘ang di chuyá»ƒn.</p><p>Náº¿u báº¡n chuyá»ƒn trá»Ÿ láº¡i PAB, báº¡n cÅ©ng sáº½ tháº¥y cÃ¡c thÃ´ng bÃ¡o nháº­t kÃ½ bá»• sung.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 16: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Tx:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Tx c5b384f75f93ebc8f1e6b514237aa70d0d982e9b035eececa27af0b3e72568e4:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        {inputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        - Value (Map [(b8a1d67cd94acf75d7e00f27015ec5e31242adad0967eee473f49c5d1d686169,Map [(&quot;&quot;,1)])]) addressed to</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            addressed to ScriptCredential: 04a718132f7ca493a011c40926e191a76bd84cbf8e7c14b6c99bbea8b8bc0bba (no staking credential)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        forge: Value (Map [])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        fee: Value (Map [(,Map [(&quot;&quot;,10)])])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mps:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        validity range: Interval {ivFrom = LowerBound NegInf True, ivTo = UpperBound PosInf True}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        data:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        1540000}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Requires signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 16: TxnValidate 40c5dbb5e7c8de390a6943d8f0a84d218cf86dd81af1fd7cfc62612e6b616c2c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 5d9d778e-55f9-45ab-89a6-2ba9aa18045e: &quot;set initial oracle value to 1540000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="swap-client"></a>Swap Client<a class="hash-link" href="#swap-client" title="Direct link to heading">#</a></h3><p>The swap client ráº¥t Ä‘Æ¡n giáº£n.</p><p>á» Ä‘Ã¢y, chÃºng tÃ´i chá»‰ Ä‘Æ°a ra má»™t giao diá»‡n báº£ng Ä‘iá»u khiá»ƒn Ä‘Æ¡n giáº£n, vÃ¬ váº­y chÃºng tÃ´i khÃ´ng báº­n tÃ¢m Ä‘áº¿n Ä‘á»“ há»a hoáº·c giao diá»‡n ngÆ°á»i dÃ¹ng web.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [i :: Int] &lt;- map read &lt;$&gt; getArgs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    uuid       &lt;- read &lt;$&gt; readFile (&#x27;W&#x27; : show i ++ &quot;.cid&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    hSetBuffering stdout NoBuffering</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    putStrLn $ &quot;swap contract instance id for Wallet &quot; ++ show i ++ &quot;: &quot; ++ show uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: UUID -&gt; IO a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        cmd &lt;- readCommand</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        case cmd of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Offer amt -&gt; offer uuid amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Retrieve  -&gt; retrieve uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Use       -&gt; use uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Funds     -&gt; getFunds uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    readCommand :: IO Command</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    readCommand = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        putStr &quot;enter command (Offer amt, Retrieve, Use or Funds): &quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        s &lt;- getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        maybe readCommand return $ readMaybe s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ã tÆ°á»Ÿng lÃ  láº¥y má»™t lá»‡nh tá»« báº£ng Ä‘iá»u khiá»ƒn vÃ  gá»i endpoint thÃ­ch há»£p. .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case cmd of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Offer amt -&gt; offer uuid amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Retrieve  -&gt; retrieve uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Use       -&gt; use uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Funds     -&gt; getFunds uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Viá»‡c gá»i endpoint sá»­ dá»¥ng cÃ¹ng má»™t phÆ°Æ¡ng thá»©c cho má»—i endpoint, táº¡o ra má»™t cuá»™c gá»i HTTP giá»‘ng nhÆ° cÃ¡ch mÃ  chÃºng tÃ´i Ä‘Ã£ lÃ m cho á»©ng dá»¥ng  Oracle Client.</p><p>CÃ¡c hÃ m <code>getFunds</code> hÆ¡i phá»©c táº¡p hÆ¡n so vá»›i ba hÃ m kia vÃ¬ nÃ³ cáº§n Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c thÃ´ng tin tá»« mÃ¡y chá»§. Äá»‘i vá»›i Ä‘iá»u nÃ y, nÃ³ cáº§n pháº£i thá»±c hiá»‡n hai yÃªu cáº§u. YÃªu cáº§u thá»© hai lÃ  Ä‘á»c tráº¡ng thÃ¡i <code>told</code> cá»§a láº§n gá»i Ä‘áº§u tiÃªn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getFunds :: UUID -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getFunds uuid = handle h $ runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        POST</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;endpoint&quot; /: &quot;funds&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (ReqBodyJson ())</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Proxy :: Proxy (JsonResponse ()))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    if responseStatusCode v /= 200</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        then liftIO $ putStrLn &quot;error getting funds&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            w &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                GET</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;status&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                NoReqBody</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (Proxy :: Proxy (JsonResponse (ContractInstanceClientState OracleContracts)))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            liftIO $ putStrLn $ case fromJSON $ observableState $ cicCurrentState $ responseBody w of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Success (Last (Just f)) -&gt; &quot;funds: &quot; ++ show (flattenValue f)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                _                       -&gt; &quot;error decoding state&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h :: HttpException -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h _ = threadDelay 1_000_000 &gt;&gt; getFunds uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y cháº¡y á»©ng dá»¥ng Swap client. ChÃºng tÃ´i sáº½ Ä‘á»ƒ mÃ¡y chá»§ web vÃ  á»©ng dá»¥ng oracle client Ä‘ang cháº¡y.</p><p>Khi sá»­ dá»¥ng cabal, chÃºng ta truyá»n cÃ¡c tham sá»‘ nhÆ° sau <code>--</code>. Äá»‘i vá»›i á»©ng dá»¥ng oracle client, chÃºng tÃ´i chuyá»ƒn sá»‘ vÃ­ vÃ o lÃ m tham sá»‘.</p><p>ChÃºng tÃ´i sáº½ khá»Ÿi cháº¡y á»©ng dá»¥ng Swap client cho vÃ­ 2 vÃ  3, má»—i vÃ­ trong má»™t cá»­a sá»• riÃªng biá»‡t vÃ  truy váº¥n sá»‘ tiá»n tÆ°Æ¡ng á»©ng cá»§a chÃºng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run swap-client -- 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap contract instance id for Wallet 2: ab65f248-450d-4988-ab2a-651ad5697596</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run swap-client -- 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap contract instance id for Wallet 3: 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ­ 2 hiá»‡n cung cáº¥p 10 Ada dÆ°á»›i dáº¡ng hoÃ¡n Ä‘á»•i vÃ  chÃºng tÃ´i kiá»ƒm tra tiá»n vÃ  chÃºng tÃ´i tháº¥y ráº±ng sá»‘ dÆ° Ada Ä‘Ã£ giáº£m xuá»‘ng (báº±ng 10 Ada cá»™ng vá»›i phÃ­ giao dá»‹ch), nhÆ°ng sá»‘ dÆ° MÃ£ thÃ´ng bÃ¡o USD váº«n giá»¯ nguyÃªn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Offer 10000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">offered swap of 10000000 lovelace</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,89999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong khi cÃ¡c lá»‡nh nÃ y Ä‘ang cháº¡y, báº¡n cÅ©ng cÃ³ thá»ƒ tháº¥y cÃ¡c lá»‡nh gá»i Ä‘ang Ä‘Æ°á»£c thá»±c hiá»‡n trong Ä‘áº§u ra PAB.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">INFO] Slot 1662: TxnValidate 17f640f03e4dc7d0a4c246129454aa19daa8d9d674bfebeeee486d6143c6648e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] ab65f248-450d-4988-ab2a-651ad5697596: &quot;offered 10000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] ab65f248-450d-4988-ab2a-651ad5697596: &quot;own funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,100000000),(,\&quot;\&quot;,89999990)]&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, Wallet 3 is going to take up the offer of the swap.
BÃ¢y giá», Wallet 3 sáº½ nháº­n offer cá»§a hoÃ¡n Ä‘á»•i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Use</span></div><div class="token-line" style="color:#393A34"><span class="token plain">used swap</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sáº½ máº¥t má»™t chÃºt thá»i gian Ä‘á»ƒ cáº­p nháº­t tiá»n, vÃ¬ váº­y hÃ£y thá»­ láº¡i lá»‡nh <code>Funds</code> </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,84400000),(,&quot;&quot;,108999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>CÃ¡i Ä‘Ã³ tá»‘t hÆ¡n. VÃ  chÃºng ta cÃ³ thá»ƒ tháº¥y ráº±ng vÃ­ 3 Ä‘Ã£ nháº­n Ä‘Æ°á»£c 10 Ada, trá»« Ä‘i phÃ­ oracle cá»§a 1 Ada vÃ  trá»« Ä‘i phÃ­ giao dá»‹ch.</p><p>Trong Ä‘áº§u ra PAB, chÃºng tÃ´i tháº¥y má»™t cÃ¡i gÃ¬ Ä‘Ã³ nhÆ°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1868: TxnValidate 00afd25af063d58b4f290e43057f4738483098f26ff0134bc14c9d54b9b94090</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2: &quot;made swap with price [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,15600000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2: &quot;own funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,84400000),(,\&quot;\&quot;,108999990)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y xem xÃ©t quá»¹ cá»§a vÃ­ 2.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,115600000),(,&quot;&quot;,89999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  chÃºng tÃ´i tháº¥y ráº±ng vÃ­ 2 Ä‘Ã£ máº¥t má»™t sá»‘ Ada, nhÆ°ng Ä‘Ã£ thu Ä‘Æ°á»£c má»™t sá»‘ Token USD. Viá»‡c hoÃ¡n Ä‘á»•i Ä‘Ã£ hoÃ n táº¥t, sá»­ dá»¥ng tá»· giÃ¡ há»‘i Ä‘oÃ¡i Ä‘ang diá»…n ra, ngay bÃ¢y giá», Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ°a vÃ o blockchain giáº£ thÃ´ng qua oracle.</p><p>VÃ¬ váº­y, bÃ¢y giá» chÃºng ta Ä‘Ã£ tháº¥y má»™t vÃ­ dá»¥ end-to-end cá»§a Plutus dApp. NÃ³ cÃ³ giao diá»‡n ngÆ°á»i dÃ¹ng, nÃ³ nÃ³i chuyá»‡n vá»›i tháº¿ giá»›i bÃªn ngoÃ i, truy cáº­p internet, láº¥y thÃ´ng tin vÃ  tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c há»£p Ä‘á»“ng thÃ´ng minh cá»§a Plutus. CÃ¡c há»£p Ä‘á»“ng thÃ´ng minh gá»­i cÃ¡c giao dá»‹ch tá»›i blockchain nÆ¡i logic xÃ¡c thá»±c báº¯t Ä‘áº§u vÃ  Ä‘áº£m báº£o ráº±ng má»i thá»© tuÃ¢n theo cÃ¡c quy táº¯c kinh doanh.</p><p>Trong vÃ­ dá»¥ nÃ y, vÃ¬ chÃºng ta khÃ´ng cÃ³ blockchain thá»±c Ä‘á»ƒ chÆ¡i cÃ¹ng, nÃªn táº¥t cáº£ cÃ¡c vÃ­ Ä‘á»u sá»­ dá»¥ng cÃ¹ng má»™t mÃ¡y chá»§ PAB, táº¥t nhiÃªn, trong cuá»™c sá»‘ng thá»±c sáº½ lÃ  ngá»› ngáº©n. RÃµ rÃ ng, cÃ¡c vÃ­ khÃ¡c nhau sáº½ cÃ³ cÃ¡c phiÃªn báº£n PAB cháº¡y khÃ¡c nhau.</p><p>NhÆ°ng, ngoÃ i Ä‘iá»u Ä‘Ã³ ra, nÃ³ gáº§n nhÆ° chÃ­nh xÃ¡c lÃ  end-to-end, cÃ¡ch má»™t há»‡ thá»‘ng nhÆ° váº­y sáº½ hoáº¡t Ä‘á»™ng.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/cardano2vn/cardanovn-portal/edit/main/docs/dr-lars-lession/week6.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tá»•ng-quat" class="table-of-contents__link">Tá»•ng quat</a><ul><li><a href="#báº£n-tÃ³m-táº¯t" class="table-of-contents__link">Báº£n tÃ³m táº¯t</a></li></ul></li><li><a href="#oracle-core" class="table-of-contents__link">Oracle Core</a><ul><li><a href="#on-chain" class="table-of-contents__link">On-chain</a></li></ul></li><li><a href="#chÃº-Ã½" class="table-of-contents__link">ChÃº Ã½</a><ul><li><a href="#off-chain" class="table-of-contents__link">Off-chain</a></li></ul></li><li><a href="#xÃ¡c-thá»±c-hoÃ¡n-Ä‘á»•iswap-validation" class="table-of-contents__link">XÃ¡c thá»±c hoÃ¡n Ä‘á»•i(Swap Validation)</a><ul><li><a href="#chÃ o-hÃ ng-offerswap" class="table-of-contents__link">ChÃ o hÃ ng (offerSwap)</a></li><li><a href="#findswaps" class="table-of-contents__link">findSwaps</a></li><li><a href="#láº¥y-láº¡i-hoÃ¡n-Ä‘á»•i-retrieveswaps" class="table-of-contents__link">láº¥y láº¡i HoÃ¡n Ä‘á»•i (retrieveSwaps)</a></li><li><a href="#useswaps" class="table-of-contents__link">useSwaps</a></li><li><a href="#gÃ³i-há»£p-Ä‘á»“ng-contract-bundle" class="table-of-contents__link">GÃ³i há»£p Ä‘á»“ng (Contract bundle)</a></li></ul></li><li><a href="#funds-module" class="table-of-contents__link">Funds Module</a></li><li><a href="#testing" class="table-of-contents__link">Testing</a><ul><li><a href="#test-in-the-repl" class="table-of-contents__link">Test in the REPL</a></li></ul></li><li><a href="#plutus-application-backend-pab" class="table-of-contents__link">Plutus Application Backend (PAB)</a><ul><li><a href="#oracle-pab" class="table-of-contents__link">Oracle PAB</a></li><li><a href="#oracle-client" class="table-of-contents__link">Oracle Client</a></li><li><a href="#swap-client" class="table-of-contents__link">Swap Client</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">TÃ i liá»‡u</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a></li></ul></div><div class="col footer__col"><div class="footer__title">Cá»™ng Ä‘á»“ng</div><ul class="footer__items"><li class="footer__item"><a href="https://t.me/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCJTdAQPGJntJet5v-nk9ebA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about-us">About Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">The content of this site is referenced and copied from the <a href="https://developers.cardano.org/" target="_blank" rel="noopener noreferrer">Cardano Developer</a>, 2021</div></div></div></footer></div>
<script src="/assets/js/runtime~main.af40557b.js"></script>
<script src="/assets/js/main.97b62b7d.js"></script>
</body>
</html>