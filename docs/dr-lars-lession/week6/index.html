<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Cardano2vn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Cardano2vn Blog Atom Feed"><title data-react-helmet="true">Week 06 - Oracles | Cardano2vn</title><meta data-react-helmet="true" property="og:url" content="https://cardano2vn.io/docs/dr-lars-lession/week6"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Week 06 - Oracles | Cardano2vn"><meta data-react-helmet="true" name="description" content="Ghi chú"><meta data-react-helmet="true" property="og:description" content="Ghi chú"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo/2.png"><link data-react-helmet="true" rel="canonical" href="https://cardano2vn.io/docs/dr-lars-lession/week6"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week6" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week6" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8b54419c.css">
<link rel="preload" href="/assets/js/runtime~main.af40557b.js" as="script">
<link rel="preload" href="/assets/js/main.97b62b7d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a><a class="navbar__item navbar__link" href="/docs/getting-started/overview">Bắt đầu</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started/overview">Bắt đầu</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><main class="docMainContainer_r8cw docMainContainerEnhanced_SOUu"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">Week 06 - Oracles</h1></header><div class="markdown"><p>Ghi chú</p><p>Đây là phiên bản viết của <a href="https://www.youtube.com/watch?v=X9fOkkpj-aU" target="_blank" rel="noopener noreferrer">Bài giảng số 6</a>.</p><p>Trong bài giảng này, chúng ta học về oracles và sử dụng PAB (Plutus Application Backend).</p><p>Những ghi chú này sử dụng Plutus cam kết: 476409eaee94141e2fe076a7821fc2fcdec5dfcb</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="tổng-quat"></a>Tổng quat<a class="hash-link" href="#tổng-quat" title="Direct link to heading">#</a></h2><p>Trong bài giảng này, chúng ta sẽ xem xét một nghiên cứu điển hình, để xem làm thế nào những gì chúng ta đã học được cho đến nay có thể được biến thành một ứng dụng thực tế. Một bộ sưu tập các tệp thực thi thậm chí đi kèm với một giao diện người dùng nhỏ.</p><p>Nó sẽ là một dApp thực sự, ngoài việc chúng ta chưa có sẵn một blockchain thực sự. Điều này sẽ chạy trên một chuỗi khối mô phỏng - một chuỗi mô hình.</p><p>Ví dụ chúng ta sẽ sử dụng cho việc này là triển khai một tiên tri rất đơn giản.</p><p>Ghi chú</p><p>Trong thế giới blockchain, tiên tri là một cách để đưa thông tin thế giới thực vào blockchain, để làm cho nó có thể sử dụng được trong các hợp đồng thông minh.</p><p>Có rất nhiều ví dụ về các trường hợp sử dụng cho oracles. Chúng ta có thể nghĩ đến các nguồn dữ liệu bên ngoài như dữ liệu thời tiết, kết quả bầu cử, dữ liệu trao đổi chứng khoán hoặc sự ngẫu nhiên. Ví dụ, bạn có thể có một hợp đồng cá cược phụ thuộc vào kết quả của một trò chơi thể thao cụ thể.</p><p>Có nhiều cách khác nhau để thực hiện các câu chuyện thần thoại, với mức độ phức tạp khác nhau.</p><p>Chúng tôi sẽ sử dụng một cách tiếp cận rất đơn giản, nơi chúng tôi có một nhà cung cấp dữ liệu đáng tin cậy. Và, để làm ví dụ về dữ liệu, chúng tôi sẽ sử dụng tỷ giá hối đoái ADA / USD.</p><p>Có rất nhiều vấn đề với cách tiếp cận này, vì chúng ta phải tin tưởng vào nguồn dữ liệu. Có nhiều cách để giảm thiểu rủi ro nguồn dữ liệu không đáng tin cậy hoặc không đáng tin cậy. Ví dụ: chúng tôi có thể yêu cầu nhà cung cấp đưa ra một số tài sản thế chấp bị mất nếu dữ liệu không được cung cấp hoặc không chính xác. Hoặc, bạn có thể kết hợp nhiều câu thần chú thành một và chỉ chấp nhận kết quả nếu tất cả chúng đều đồng ý hoặc lấy giá trị trung bình hoặc giá trị trung bình của các nguồn khác nhau. Bạn cũng có thể nghĩ ra các cơ chế phức tạp hơn.</p><p>Như chúng ta đã biết, đối với bất kỳ điều gì xảy ra trên blockchain, phải có UTxO, vì vậy điều hiển nhiên cần làm là biểu thị nguồn cấp dữ liệu dưới dạng UTxO. UTxO nằm ở địa chỉ tập lệnh của oracle và trường dữ liệu của nó mang giá trị hiện tại của dữ liệu oracle.</p><p><img src="/assets/images/week06__00000-84dc8472c851f9d498e50158a6db82a3.png"></p><p>Và đây là nơi chúng tôi tìm ra vấn đề đầu tiên của mình. Như chúng ta đã lưu ý trước đây, xác thực chỉ xảy ra khi bạn muốn sử dụng thứ gì đó từ địa chỉ tập lệnh, chứ không phải khi bạn tạo đầu ra tại địa chỉ tập lệnh. Điều này có nghĩa là chúng tôi không thể ngăn cản bất kỳ ai tạo ra kết quả đầu ra tùy ý tại địa chỉ tập lệnh.</p><p><img src="/assets/images/week06__00001-ed7cda335f088c7048ac7c74b7c077a6.png"></p><p>Bằng cách nào đó, chúng ta cần phân biệt đầu ra oracle thực sự với các đầu ra khác có thể ở cùng một địa chỉ tập lệnh. Và cách chúng tôi làm điều này là đặt một NFT trên đầu ra. Vì một NFT chỉ có thể tồn tại một lần nên chỉ có thể có một UTxO tại địa chỉ tập lệnh chứa NFT.</p><p><img src="/assets/images/week06__00002-44ef75fbc3b1e1a1a3e3419b14783066.png"></p><p>Làm thế nào một lời tiên tri như vậy có thể được sử dụng?</p><p>Ở đây chúng ta đến với một cái gì đó mà chúng ta chưa từng thấy trước đây. Trong tất cả các hợp đồng và trình xác thực viết mã của chúng tôi, chúng tôi luôn biết trước toàn bộ API. Trong trường hợp của một nhà tiên tri, điều này là khác nhau. Tại thời điểm mà một tiên tri được tạo ra, bạn không biết mọi người có thể muốn sử dụng nó như thế nào. Nó phải giống như một API mở, có thể hoạt động với các hợp đồng thông minh chưa được thiết kế.</p><p>Ví dụ về trường hợp sử dụng có thể sử dụng oracle cụ thể này, chúng ta hãy xem xét một hợp đồng hoán đổi trong đó, tại địa chỉ hoán đổi, ai đó có thể gửi ADA và sau đó người khác có thể lấy những ADA đó để đổi lấy USD.</p><p><img src="/assets/images/week06__00003-0b5bb3782b21d4bd0fca5389ea01645c.png"></p><p>Tất nhiên, chúng ta không có USD trực tiếp trên blockchain, nhưng chúng ta có thể tưởng tượng rằng chúng được đại diện bởi một số mã thông báo gốc.</p><p>Trong ví dụ này, vì giá trị của oracle là 1,75, thì nếu ai đó cung cấp 100 ADA, giá cho điều đó sẽ là 175 USD.</p><p>Ngoài ra, chúng tôi cần một động lực để tiên tri cung cấp dữ liệu, bởi vì ngoài các chi phí khác để cung cấp dữ liệu, thì ở mức tối thiểu họ sẽ phải trả phí để tạo UTxO.</p><p>Vì vậy, giả sử rằng nhà cung cấp oracle xác định một khoản phí 1 ADA phải trả mỗi khi oracle được sử dụng.</p><p>Trong ví dụ này, điều đó có nghĩa là người muốn ADA sẽ phải trả 175 USD cho người bán ADA và 1 ADA cho nhà tiên tri.</p><p>Giao dịch sẽ như thế nào?</p><p><img src="/assets/images/week06__00004-789b3973cd4c08a6f70363671d8f7219.png"></p><p>Trước hết, logic xác thực hoán đổi sẽ cần quyền truy cập vào giá trị oracle hiện tại, có nghĩa là UTxO oracle phải là đầu vào cho giao dịch.</p><p>Sau đó, chúng ta có logic xác thực tiên tri. Trong trường hợp này, chúng tôi muốn sử dụng tiên tri. Vì vậy, giả sử chúng ta có một công cụ đổi quà được gọi là sử dụng . Bây giờ, trình xác thực tiên tri phải kiểm tra một số thứ.</p><ol><li>NFT có trong đầu vào được tiêu thụ không?</li><li>Có đầu ra từ giao dịch tại cùng một địa chỉ có chứa cùng một NFT không?</li><li>IGiá trị trong UTxO đầu ra có giống với giá trị đầu vào không?</li><li>Phí có phải không?</li></ol><p>Bây giờ chúng ta có thể hoàn thành giao dịch.</p><p>Chúng tôi sử dụng hai đầu vào bổ sung - phí do người mua trả và 100 ADA do người bán đặt cọc. Sau đó, chúng tôi có hai đầu ra bổ sung - 175 USD cho người bán và 100 ADA cho người mua. Và đối với những đầu vào và đầu ra mới này, người xác nhận hoán đổi có trách nhiệm đảm bảo rằng nó chính xác. Trong khi đó, trình xác nhận tiên tri chỉ quan tâm đến việc đảm bảo rằng mọi thứ liên quan đến tiên tri là chính xác.</p><p><img src="/assets/images/week06__00005-a367da3cdd4e2bd0cdb39e22365539c5.png"></p><p>Chỉ cần nhấn mạnh, hợp đồng hoán đổi này chỉ là một ví dụ. Nhà tiên tri phải có khả năng làm việc với nhiều hợp đồng thông minh khác nhau muốn sử dụng dữ liệu của nó.</p><p>Nếu đây là tất cả, thì chúng ta sẽ không cần một lời tiên tri. Nếu giá trị đã được cố định, để nó luôn là 1,75 thì chúng tôi có thể chỉ cần mã hóa giá trị này vào hợp đồng của mình. Vì vậy, giá trị phải có thể thay đổi. Ít nhất, trong một ví dụ chẳng hạn như ví dụ này, nơi chúng ta có một tỷ giá hối đoái, tất nhiên, có thể thay đổi theo thời gian. Có thể có các ví dụ khác như kết quả của một trận đấu thể thao, trong đó nó là một sự kiện kỳ ​​lạ trong lịch sử, nhưng trong trường hợp này, điều quan trọng là nó có thể thay đổi.</p><p>Điều này có nghĩa là trình xác thực oracle, ngoài việc sử dụng Redeemer, phải có khả năng hỗ trợ một hoạt động khác mà nhà cung cấp oracle thực sự có thể thay đổi dữ liệu.</p><p>Vì vậy, giả sử giá trị thay đổi từ 1,75 thành 1,77.</p><p>Chúng tôi biết rằng trên blockchain UTxO (E), không có gì thay đổi, vì vậy bạn không thể thay đổi dữ liệu của UTxO hiện có. Tất cả những gì bạn có thể làm là sử dụng UTxO và sản xuất UTxO mới.</p><p>Chúng tôi sẽ có một giao dịch sử dụng Redeemer bản cập nhật . Logic xác nhận hơi khác. Nó giống như trước đây ở chỗ NFT cần phải có mặt trong đầu vào oracle đã tiêu thụ, và cũng cần có mặt trong đầu ra mới. Ngoài ra, giao dịch phải được ký bởi nhà cung cấp oracle. Và, chúng tôi có thể sử dụng giao dịch cập nhật này như một cơ hội để nhà cung cấp oracle thu phí.</p><p>Chúng tôi nhấn mạnh rằng NFT có trong đầu ra, nhưng chúng tôi không nói gì về các giá trị khác. Tất cả các khoản phí do các giao dịch khác sử dụng dữ liệu oracle này có thể được thu trong quá trình cập nhật giao dịch.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="bản-tóm-tắt"></a>Bản tóm tắt<a class="hash-link" href="#bản-tóm-tắt" title="Direct link to heading">#</a></h3><p>Tóm lại, chúng tôi đại diện cho tiên tri bởi một UTxO và xác định UTxO chính xác bằng một NFT. Giá trị oracle là dữ liệu của UTxO. Chúng tôi hỗ trợ hai hoạt động.</p><p>Một là sử dụng sử dụng tiên tri trong một số giao dịch tùy ý. Các sử dụng validator sẽ đảm bảo rằng các đầu vào oracle tiêu thụ mang NFT, rằng có một đầu ra mà lại mang NFT, không làm thay đổi dữ kiện, và mang phí bổ sung.</p><p>Thao tác thứ hai là cập nhật chỉ có thể được thực hiện bởi nhà cung cấp oracle. Đối với một giao dịch cập nhật , đầu vào oracle lại phải mang NFT, phải có đầu ra oracle cũng mang NFT. Không có hạn chế nào nữa. Số liệu có thể thay đổi và phí tích lũy có thể được lấy ra.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-core"></a>Oracle Core<a class="hash-link" href="#oracle-core" title="Direct link to heading">#</a></h2><p>Bây giờ chúng ta biết nó hoạt động như thế nào, hãy xem một số đoạn mã.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="on-chain"></a>On-chain<a class="hash-link" href="#on-chain" title="Direct link to heading">#</a></h3><p>Đầu tiên, hãy xem mã Plutus tự thực thi oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.Core</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The oracle sẽ là một hợp đồng được tham số hóa và nó sẽ phụ thuộc vào bốn trường.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { oSymbol   :: !CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oOperator :: !PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oFee      :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oAsset    :: !AssetClass</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    } deriving (Show, Generic, FromJSON, ToJSON, Prelude.Eq, Prelude.Ord)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><ul><li><code>oSymbol</code>  là biểu tượng tiền tệ của NFT được sử dụng để xác định giao dịch. Chúng tôi không cần tên mã thông báo vì chúng tôi sẽ chỉ sử dụng chuỗi trống làm tên mã thông báo.</li><li><code>oOperator</code>  là chủ sở hữu của oracle - hàm băm của chủ sở hữu khóa công khai có thể thực hiện cập nhật</li><li><code>oFee</code>  là khoản phí trong tình yêu phải trả mỗi khi sử dụng oracle</li><li><code>oAsset</code>  đại diện cho loại tài sản mà chúng tôi muốn trao đổi tỷ giá so với Ada, trong trường hợp của chúng tôi sẽ là một số loại mã thông báo USD</li></ul><p>Redeemer sẽ hỗ trợ hai hoạt động.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data OracleRedeemer = Update | Use</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deriving Show</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">PlutusTx.unstableMakeIsData &#x27;&#x27;OracleRedeemer</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta cần xác định lớp tài sản NFT. Như đã đề cập, chúng ta sẽ sử dụng chuỗi trống cho tên mã thông báo.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleTokenName #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleTokenName :: TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleTokenName = TokenName emptyByteString</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Các <code>oracleAsset</code> sẽ được sử dụng để xác định các NFT - đây không phải là <code>oAsset</code> định nghĩa ở trên.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleAsset #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAsset :: Oracle -&gt; AssetClass</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAsset oracle = AssetClass (oSymbol oracle, oracleTokenName)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi tạo một hàm trợ giúp nhỏ gọi là <code>oracleValue</code> . Điều này nhận một giao dịch đầu ra và một hàm tìm kiếm dữ liệu, sau đó trả về một Số nguyên . Các Integer đại diện cho tỷ giá hối đoái (ví dụ 1,75) nhân với một triệu. Điều này tránh những phức tạp có thể xảy ra khi sử dụng số thực.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE oracleValue #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue :: TxOut -&gt; (DatumHash -&gt; Maybe Datum) -&gt; Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue o f = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    dh      &lt;- txOutDatum o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Datum d &lt;- f dh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    PlutusTx.fromData d</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm này là một ví dụ về tính toán monadic trong monad. nó không phải là <code>IO</code>  hoặc <code>Contract monad</code>. Đầu tiên chung ta gọi <code>txOutDatum</code>, Nó không thành công nếu đâu ra không có datum. Nếu nó thành công, chúng tôi nhận được một băm datum mà chúng tôi có thể tham chiếu trong đó <code>dh</code>.  Tiếp theo, chúng tôi sử dụng hàm  <code>f</code>  được cung cấp làm đối số thứ hai để có thể biến băm dữ liệu này thành một dữ liệu. Điều này cũng có thể thất bại. Nếu nó thành công, chúng tôi có thể tham khảo kết quả trong <code>d</code>. <code>Datum</code>  chỉ là một trình bao bọc kiểu mới xung quanh <code>Data</code>,vì vậy sau đó chúng ta có thể sử dụng <code>PlutusTx.fromData</code>  để có thể biến <code>d</code>  thành <code>Integer</code>.Một lần nữa, điều này có thể không thành công, bởi vì ngay cả khi dữ liệu ở đó, nó có thể không được chuyển đổi thành giá trị số nguyên.</p><p>Chúng ta sẽ thấy chúng ta sử dụng hàm <code>oracleValue</code>  ở đây trong giây lát.</p><p>Chức năng quan trọng nhất là  <code>mkOracleValidator</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE mkOracleValidator #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkOracleValidator :: Oracle -&gt; Integer -&gt; OracleRedeemer -&gt; ScriptContext -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkOracleValidator oracle x r ctx =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    traceIfFalse &quot;token missing from input&quot;  inputHasToken  &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    traceIfFalse &quot;token missing from output&quot; outputHasToken &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case r of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Update -&gt; traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  traceIfFalse &quot;invalid output datum&quot;       validOutputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Use    -&gt; traceIfFalse &quot;oracle value changed&quot;       (outputDatum == Just x)              &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  traceIfFalse &quot;fees not paid&quot;              feesPaid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info = scriptContextTxInfo ctx</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownInput = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; traceError &quot;oracle input missing&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just i  -&gt; txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inputHasToken = assetClassValueOf (txOutValue ownInput) (oracleAsset oracle) == 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownOutput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownOutput = case getContinuingOutputs ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _   -&gt; traceError &quot;expected exactly one oracle output&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputHasToken = assetClassValueOf (txOutValue ownOutput) (oracleAsset oracle) == 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputDatum :: Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outputDatum = oracleValue ownOutput (`findDatum` info)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    validOutputDatum :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    validOutputDatum = isJust outputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    feesPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    feesPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        inVal  = txOutValue ownInput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outVal = txOutValue ownOutput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outVal `geq` (inVal &lt;&gt; Ada.lovelaceValueOf (oFee oracle))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>mkOracleValidator</code>  nhận 4 tham số: <code>Oracle</code>,
trong ví dụ này <code>datum</code>  là <code>Integer</code>, <code>redeemer</code> là
<code>OracleRedeemer</code>  và cuối cùng là <code>ScriptContext</code>.</p><p>Có hai trường hợp cho trình xác thực này - <code>use</code> và <code>update</code> - nhưng có những điểm tương đồng. Trong cả hai trường hợp, chúng tôi muốn kiểm tra xem chúng tôi có đầu vào chứa NFT và có đầu ra chứa NFT không.</p><p>Vì cả hai việc kiểm tra này đều cần được thực hiện bất kể trường hợp sử dụng nào, nên chúng được thực hiện trước.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;token missing from input&quot;  inputHasToken  &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;token missing from output&quot; outputHasToken &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi xem xét trường hợp sử dụng mà chúng tôi đang xử lý.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case r of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Update -&gt; traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              traceIfFalse &quot;invalid output datum&quot;       validOutputDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Use    -&gt; traceIfFalse &quot;oracle value changed&quot;       (outputDatum == Just x)              &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">              traceIfFalse &quot;fees not paid&quot;              feesPaid    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trước khi xem xét hàm <code>inputHasToken</code>, có một chức năng trợ giúp khác cần xem xét</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownInput = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing -&gt; traceError &quot;oracle input missing&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Just i  -&gt; txInInfoResolved i</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>ownInput</code>  trả về <code>TxOut</code>  Mà nó đang có gắng tiêu thụ, trong trường hợp này là oracle output. Trường hợp <code>Nothing</code>  có thể sẩy ra nếu ra nếu chúng ta đang ở trong một context khác, chẳng hạn như context đúc, vì vậy tình huống này sẽ không xảy ra cho chúng ta. Hàm <code>findOwnInput</code> được cung cấp bởi Plutus và sẽ nhận context, sau đó tìm các đầu vào liên quan. Hàm <code>txInInfoResolved</code>  nhận <code>TxOut</code>  từ <code>TxInInfo</code>.</p><p>Hàm <code>inputHashToken</code>  kiểm tra token hiện tại. Nó sử dụng hàm <code>assetClassValueOf</code>  để tìm kiếm NFT trong phản hồi <code>ownInput</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">inputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">inputHasToken = assetClassValueOf (txOutValue ownInput) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm trợ giúp tiếp theo, <code>ownOutput</code> kiểm tra xem chúng có chính xác một đầu ra hay không và trả lại đầu ra đó cho chúng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownOutput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownOutput = case getContinuingOutputs ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _   -&gt; traceError &quot;expected exactly one oracle output&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta có thể sử dụng hàm trợ giúp <code>outputHasToken</code>  giống như hàm <code>inputHashToken</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">outputHasToken :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">outputHasToken = assetClassValueOf (txOutValue ownOutput) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều đó bao gồm mã cho các trường hợp phổ biến. Bây giờ, hãy xem mã cụ thể cho trường hợp <code>update</code>.</p><p>Có hai điều kiện để kiểm tra. Đầu tiên là nhà điều hành đã thực sự ký kết giao dịch. Điều này rất đơn giản nên chúng ta có thể thực hiện nó on-chain mà không cần hàm trợ giúp.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;operator signature missing&quot; (txSignedBy info $ oOperator oracle)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều tiếp theo cần kiểm tra là dữ liệu đầu ra. Chúng tôi biết rằng giá trị có thể thay đổi, nhưng chúng tôi cần kiểm tra xem ít nhất nó có phải là kiểu đúng hay không.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;invalid output datum&quot; validOutputDatum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và đối với điều này, chúng tôi đã tham chiếu đến một hàm trợ giúp mới <code>validOutputDatum</code>, chính nó sử dụng một hàm trợ giúp <code>outputDatum</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">outputDatum :: Maybe Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">outputDatum = oracleValue ownOutput (`findDatum` info)    </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">validOutputDatum :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">validOutputDatum = isJust outputDatum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="chú-ý"></a>Chú ý<a class="hash-link" href="#chú-ý" title="Direct link to heading">#</a></h2><p>Nếu bạn tra cứu <code>findDatum</code>  trong REPL, Bạn sẽ thấy có một loại này <code>DatumHash -&gt; TxInfo -&gt; Maybe Datum</code>. Vì chúng ta đang sử dụng infix ở đây, Chúng ta có thể chuyển vào <code>info</code>  dưới dạng tham số duy nhất, và điều này sẽ dẫn đến toàn bộ biểu thức có kiểu <code>DatumHash -&gt; Maybe Datum</code>, là kiểu mà chúng ta cần chuyển vào<code>oracleValue</code>.</p><p>Điều này hoạt động bằng cách cố gắng lấy giá trị dữ liệu từ băm dữ liệu và sau đó cố gắng tạo giá trị oracle từ nó. Nếu thành công, nó sẽ trả về <code>Just Integer</code>, ngược lại nó sẽ trả về <code>Nothing</code>, vì vậy hàm <code>validOutputDatum</code>  chỉ cần kiểm tra xem giá trị trả về có phải <code>Nothing</code>,hay là <code>Just</code>.</p><p>Lưu ý rằng chúng tôi không kiểm tra bất kỳ điều gì về giá trị của <code>Integer</code>. Giá trị này thậm chí có thể giữ nguyên như giá trị đầu vào, nếu giao dịch được sử dụng chỉ để thu phí đã tích lũy từ việc sử dụng oracle.</p><p>Trường hợp thứ hai cho <code>mkOracleValidator</code>  là trường hợp <code>use</code>. Trường hợp này ai cũng có thể sử dụng được nhưng hạn chế hơn rất nhiều.</p><p>Đầu tiên, chúng tôi không cho phép giá trị thay đổi. Vì vậy, đây là điều kiện đầu tiên.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">traceIfFalse &quot;oracle value changed&quot; (outputDatum == Just x)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi đã viết hàm trợ giúp <code>outputDatum</code>. Thay vì chỉ kiểm tra xem nó có phải là <code>Integer</code> hay không , ở đây chúng ta cũng kiểm tra xem giá trị đầu ra của nó có giống với giá trị đầu vào hay không.</p><p>Và cuối cùng, chúng ta phải kiểm tra xem các khoản phí đã được thanh toán hay chưa. Và đối với điều này, chúng tôi sử dụng một chức năng trợ giúp mới được gọi là <code>feesPaid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">feesPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">feesPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    inVal  = txOutValue ownInput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outVal = txOutValue ownOutput</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    outVal `geq` (inVal &lt;&gt; Ada.lovelaceValueOf (oFee oracle))    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>feesPaid</code> kiểm tra giá trị đầu ra ít nhất bằng giá trị đầu vào cộng với phí bắt buộc. Chúng tôi lại sử dụng toán tử  <code>&lt;&gt;</code> để cộng thêm fee vào giá trị đầu vào. Chúng tôi có thể đã sử dụng bằng (eq) thay vì lớn hơn hoặc bằng (geq). Việc sử dụng <code>geq</code>  ho phép người dùng oracle đưa cho nhà cung cấp oracle một mẹo, nếu họ muốn dùng.</p><p>Vì vậy, đây về cơ bản là logic cốt lõi của oracle như được thể hiện trong sơ đồ sau.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><p>Bây giờ chúng ta có boilerplate của chúng ta. Đặc biệt lưu ý rằng chúng tôi sử dụng mẫu mà chúng tôi cần cho trình xác thực được tham số hóa.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ScriptType Oracling where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Oracling = Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Oracling = OracleRedeemer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInst :: Oracle -&gt; Scripts.ScriptInstance Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInst oracle = Scripts.validator @Oracling</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ($$(PlutusTx.compile [|| mkOracleValidator ||]) `PlutusTx.applyCode` PlutusTx.liftCode oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @Integer @OracleRedeemer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValidator :: Oracle -&gt; Validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleValidator = Scripts.validatorScript . oracleInst</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAddress :: Oracle -&gt; Ledger.Address</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleAddress = scriptAddress . oracleValidator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và điều này kết thúc phần on-chain của mã oracle.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="off-chain"></a>Off-chain<a class="hash-link" href="#off-chain" title="Direct link to heading">#</a></h3><p>Chúng tôi cũng tạo một số mã ngoài chuỗi, cụ thể là để bắt đầu tiên tri và cập nhật nó. Tuy nhiên, chúng tôi không viết mã off-chain cho useoracle. Đó không phải là trách nhiệm của tác giả của hợp đồng này. Đó sẽ là trách nhiệm của người muốn sử dụng oracle - họ sẽ viết mã để tạo giao dịch với người đổi use. Đây là lần đầu tiên chúng tôi thấy trường hợp chúng tôi có một số mã trong chuỗi không được ghép nối với một số mã ngoài chuỗi.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="starting-the-oracle"></a>Starting the Oracle<a class="hash-link" href="#starting-the-oracle" title="Direct link to heading">#</a></h4><p>Để bắt đầu oracle, chúng ta cần một số tham số.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data OracleParams = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { opFees   :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opSymbol :: !CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opToken  :: !TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    } deriving (Show, Generic, FromJSON, ToJSON)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p> <code>opFees</code>  tham số đại diện cho số phí lovelace đó sẽ được tính vào sử dụng oracle.</p><p>Tham số <code>opSymbol</code>  và <code>opToken</code>  đại diện cho token
mà chúng tôi đang cung cấp tỷ giá hối đoái Ada, trong trường hợp này là token USD.</p><p>Đầu tiên, chúng tôi tạo một hàm <code>startOracle</code>, có trách nhiệm tạo ra NFT sẽ được sử dụng để xác định UTxO oracle. Các hàm<code>startOracle</code>  này sẽ không cung cấp một giá trị ban đầu cho oracle, điều này sẽ được xử lý bởi các hàm <code>updateOracle</code> . Lý do cho điều này là, nếu chúng tôi cung cấp một giá trị ban đầu, nó có thể bị lỗi thời vào thời điểm NFT được đúc.</p><p>Chúng tôi có thể đã sử dụng cùng một mã để đúc NFT như chúng tôi đã sử dụng trong bài giảng 5. Điều này sẽ hoạt động hoàn toàn tốt.</p><p>Tuy nhiên, đây là một mô-đun tiền tệ được cung cấp trong <code>plutus-use-cases</code> cái mà cung cấp hàm <code>forgeContract</code>  cho phép tạo NFT</p><p>Đây là hàm <code>forgeContract</code>  hiện thị trong REPL.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; :t Plutus.Contracts.Currency.forgeContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contracts.Currency.forgeContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  :: (row-types-1.0.1.0:Data.Row.Internal.AllUniqueLabels</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Plutus.Contract.Schema.Input s),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      row-types-1.0.1.0:Data.Row.Internal.AllUniqueLabels</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Plutus.Contract.Schema.Output s),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      Plutus.Contracts.Currency.AsCurrencyError e,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Input s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx-confirmation&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.Contract.Effects.AwaitTxConfirmed.TxConfirmed,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Input s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.Contract.Effects.WriteTx.WriteTxResponse,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Output s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Ledger.Constraints.OffChain.UnbalancedTx,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      (Plutus.Contract.Schema.Output s</span></div><div class="token-line" style="color:#393A34"><span class="token plain">       row-types-1.0.1.0:Data.Row.Internal..! &quot;tx-confirmation&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ~ Plutus.V1.Ledger.TxId.TxId) =&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     Plutus.V1.Ledger.Crypto.PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     -&gt; [(Plutus.V1.Ledger.Value.TokenName, Integer)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     -&gt; Plutus.Contract.Types.Contract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          w s e Plutus.Contracts.Currency.OneShotCurrency</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Phần quan trọng bắt đầu về phía cuối, nơi mà tham số đầu tiên - của kiểu <code>PubKeyHash</code>  - được định nghĩa. Đây là băm của khóa công khai của người nhận NFT.</p><p>Hàm <code>forgeContract</code>  ung cấp chức năng tổng quát hơn hợp đồng NFT trước của chúng tôi. Nó cho phép tạo nhiều NFT trong một lần. Nó sẽ tạo ra một ký hiệu tiền tệ chỉ có thể được sử dụng một, tương tự như NFT của chúng tôi từ lần trước, vì vậy chỉ có thể có một giao dịch đúc tiền. Nhưng đối với một biểu tượng tiền tệ, bạn có thể đúc nhiều mã thông báo khác nhau trong cùng một giao dịch, với nhiều tên mã thông báo khác nhau và với số lượng khác nhau. Tham số thứ hai cho phép chúng tôi xác định các tên và số lượng mã thông báo này.</p><p>Và nó cho chúng ta một <code>Contract</code>  nó trả về một gia trị kiểu <code>OneShotCurrency</code>. Loại này dành riêng cho tiền tệ và nó không thực sự quan trọng đối với chúng tôi. Tất cả những gì quan trọng đối với chúng tôi là chúng tôi có thể lấy lại biểu tượng tiền tệ từ nó.</p><p>Có một vấn đề nhỏ. Điều này không tương thích với những gì chúng tôi muốn. Chúng tôi muốn các loại này</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Contract w s Text Oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Một kiểu người viết tùy ý (vì chúng ta không sử dụng nó), một lược đồ tùy ý (miễn là chúng ta có <code>BlockChainActions</code> sẵn), <code>Text</code> thông báo lỗi và kiểu trả về <code>Oracle</code>.</p><p>Vấn đề là giá trị <code>Contract</code> trả về <code>forgeContract</code> không cho phép <code>Text</code> thông báo lỗi. Bạn có thể thấy điều này trong đầu ra chi tiết từ REPL - có một ràng buộc đối với tham số <code>e</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contracts.Currency.AsCurrencyError e,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Thật không may là <code>Text</code> không thực hiện <code>AsCurrencyError</code>.</p><p>May mắn thay, có một hàm có thể trợ giúp</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Plutus.Contract.mapError</span></div><div class="token-line" style="color:#393A34"><span class="token plain">:: (e -&gt; e&#x27;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   -&gt; Plutus.Contract.Types.Contract w s e a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   -&gt; Plutus.Contract.Types.Contract w s e&#x27; a</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Với một <code>Contract</code>, nó cho phép chúng tôi tạo mới một <code>Contract</code>  với một loại thông báo lỗi mới.Điều đó được cung cấp, chúng tôi cung cấp một hàm chuyển đổi từ loại lỗi đầu tiên sang loại lỗi thứ hai.</p><p>Vì vậy, chúng ta hãy nhìn vào hàm <code>startOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">startOracle :: forall w s. HasBlockchainActions s =&gt; OracleParams -&gt; Contract w s Text Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">startOracle op = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    osc &lt;- mapError (pack . show) (forgeContract pkh [(oracleTokenName, 1)] :: Contract w s CurrencyError OneShotCurrency)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let cs     = Currency.currencySymbol osc</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            { oSymbol   = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oOperator = pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oFee      = opFees op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            , oAsset    = AssetClass (opSymbol op, opToken op)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;started oracle &quot; ++ show oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ở đây chúng ta thấy hàm chuyển đổi lỗi được cung cấp dưới dạng  <code>pack . show</code>.
Hàm <code>show</code>  chuyển đổi lỗi cho một <code>String</code>  và hàm <code>pack</code>
chuyển đổ một <code>String</code>  tới một kiểu <code>Data.Text</code>.</p><p>Tại thời điểm này <code>osc</code>  giữ  <code>OneShotCurrency</code>, Và chúng ta có thể sử dụng hàm <code>currencySymbol</code>  để lấy ký hiệu tiền tệ như<code>cs</code>.</p><p>Hàm <code>currencySymbol</code>  có kiểu:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">currencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      :: OneShotCurrency -&gt; Plutus.V1.Ledger.Value.CurrencySymbol</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>và được sử dụng phù hợp</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let cs = Currency.currencySymbol osc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ chúng tôi đã đúc NFT của mình và nó có ký hiệu tiền tệ <code>cs</code>. à bây giờ chúng ta có thể xây dựng giá trị tham số <code>Oracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracle = Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { oSymbol   = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oOperator = pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oFee      = opFees op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , oAsset    = AssetClass (opSymbol op, opToken op)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>lý do là <code>opSymbol</code>  và <code>opToken</code> được định nghĩa riêng trong kiểu <code>OracleParams</code>.  <code>op</code>  hỉ là điều này làm cho việc này trở nên dễ dàng hơn khi chúng ta sử dụng playground.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="updating-the-oracle"></a>Updating the Oracle<a class="hash-link" href="#updating-the-oracle" title="Direct link to heading">#</a></h4><p>Hàm <code>updateOracle</code>  là phức tạp hơn.</p><p>Chức năng này phải xử lý hai trường hợp. Cụ thể là trường hợp chúng tôi có một giá trị mà chúng tôi muốn cập nhật và trường hợp 2 chúng tôi mới bắt đầu tạo oracle và chúng tôi muốn tạo một giá trị lần đầu tiên.</p><p>Nó lấy các tham số oracle and <code>Integer</code> giá trị mà chúng tôi muốn có oracle giữ.</p><p>Đầu tiên, chúng tôi tạo một chức năng trợ giúp <code>findOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">findOracle :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text (Maybe (TxOutRef, TxOutTx, Integer))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">findOracle oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- Map.filter f &lt;$&gt; utxoAt (oracleAddress oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return $ case Map.toList utxos of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [(oref, o)] -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            x &lt;- oracleValue (txOutTxOut o) $ \dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return (oref, o, x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _           -&gt; Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: TxOutTx -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f o = assetClassValueOf (txOutValue $ txOutTxOut o) (oracleAsset oracle) == 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Muchj đích của <code>findOracle</code>  là để tra cứu UTxO oracle hiện có. Điều này có thể không thành công vì có thể không có tiên tri ở đó. Điều này sẽ xảy ra nếu chúng ta mới bắt đầu oracles và chưa tạo UTxO với giá trị oracle. Tuy nhiên, nếu chúng tôi tìm thấy nó, chúng tôi trả về một bộ ba chứa mã nhận dạng UTxO (TxOutRef), chính UTxO, chứa tất cả dữ liệu (TxOutTx) và giá trị oracle (tỷ giá hối đoái hiện tại do oracle nắm giữ). Các <code>Integer</code> chứa giá trị oracle được mã hóa cũng trong giá trị TxOutTx, nhưng chúng tôi thêm nó vào ba để làm cho nó dễ dàng hơn để làm việc với.</p><p>Điều đầu tiên chúng tôi làm là lấy tất cả các UTxO ở địa chỉ này. Nhưng chỉ một trong số này sẽ là thứ mà chúng tôi đang tìm kiếm - cái có chứa NFT.</p><p>Chúng tôi thực hiện điều này bằng cách sử dụng hàm <code>Map.filter</code>  nhận một hàm làm tham số, trong trường hợp này, trả về True cho UTxO nơi NFT hiện diện.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">utxos &lt;- Map.filter f &lt;$&gt; utxoAt (oracleAddress oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  f :: TxOutTx -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  f o = assetClassValueOf (txOutValue $ txOutTxOut o) (oracleAsset oracle) == 1    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta sẽ kết thúc với một map <code>utxos</code> trống hoặc chứa một mục. Bây giờ, chúng ta phân biệt giữa hai trường hợp này.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">return $ case Map.toList utxos of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [(oref, o)] -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- oracleValue (txOutTxOut o) $ \dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (oref, o, x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _           -&gt; Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi chuyển đổi bản đồ thành danh sách các bộ giá trị đại diện cho các cặp giá trị quan trọng của id giao dịch và chính các giao dịch.</p><p>Đối với trường hợp không có phần tử, chúng tôi sử dụng trường hợp _ để đại diện cho tất cả các trường hợp khác. Đây chỉ có thể là danh sách trống, nhưng trình biên dịch không biết điều đó.</p><p>Tuy nhiên, nếu chúng tôi đã tìm thấy UTxO, thì vì chúng tôi đã có id và giao dịch của nó, chúng tôi chỉ cần tìm <code>Integer</code> giá trị của nó . Phần này vẫn có thể sai. Mặc dù chúng tôi đã tìm thấy đúng UTxO, nhưng có thể có một số dữ liệu bị hỏng trong đó vì bất kỳ lý do gì.</p><p>Chúng tôi sử dụng hàm <code>oracleValue</code> mà chúng tôi cũng đã sử dụng để xác thực. Hàm này nhận một tham số <code>TxOut</code> theo sau là một tham số thứ hai là một hàm, được cung cấp một hàm băm dữ liệu sẽ trả về giá trị dữ liệu được liên kết.</p><p>Trong mã off-chain, chúng ta có thể sử dụng tham số hàm sau</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">\dh -&gt; Map.lookup dh $ txData $ txOutTxTx o</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đây <code>txData</code>  là một trường của giao dịch và nó là một map từ hàm băm datum. Chúng tôi nhận được giao dịch từ <code>txOutTxTx o</code>.</p><p>Nếu tất cả điều này thành công, khi nào sẽ trả về bộ ba <code>(oref, o, x)</code>,trong đó <code>x</code> là <code>Integer</code>  giá trị của oracle.</p><p>Bây giờ chúng ta đã viết hàm <code>findOracle</code>. húng ta có thể nhìn vào hàm <code>updateOracle</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Integer -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle oracle x = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let c = Constraints.mustPayToTheScript x $ assetClassValue (oracleAsset oracle) 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraints (oracleInst oracle) c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;set initial oracle value to &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (oref, o,  _) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            let lookups = Constraints.unspentOutputs (Map.singleton oref o)     &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.scriptInstanceLookups (oracleInst oracle) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.otherScript (oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx      = c &lt;&gt; Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Update)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraintsWith @Oracling lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;updated oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>sau đó nhìn hàm <code>findOracle</code>  hàm trợ giúp, vì chúng ta sẽ cần ràng buộc này hai lần.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let c = Constraints.mustPayToTheScript x $ assetClassValue (oracleAsset oracle) 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau khi tìm kiếm tiên tri, có rất nhiều khả năng xảy ra - chúng tôi đã tìm thấy nó hoặc chúng tôi đã không.</p><p>Nếu chúng tôi không tìm thấy nó, thì chúng tôi đã bắt đầu tiên tri nhưng chúng tôi chưa cung cấp giá trị ban đầu. Đây là trường hợp đầu tiên. Và trong trường hợp này, tất cả những gì chúng ta phải làm là gửi một giao dịch tạo ra giá trị đầu tiên cho oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraints (oracleInst oracle) c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;set initial oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đây là cách sử dụng đầu tiên của hàm trợ giúp <code>c</code> . Nó cung cấp ràng buộc <code>mustPayToTheScript</code>  đảm bảo rằng giao dịch sẽ có đầu ra trả cho một địa chỉ tập lệnh. Là các đối số, nó lấy datum <code>x</code>  và NFT. Tập lệnh mà nó phải trả tiền luôn là tập lệnh nằm trong tiêu điểm - ở đây nó là tham số đầu tiên đến <code>submitTxConstraints</code>  - <code>(oracleInst oracle)</code>.</p><p>Sau đó chúng tôi chờ xác nhận và viết thông báo nhật ký. Và đây là tất cả những gì chúng ta cần làm cho trường hợp này.</p><p>Trong trường hợp khác, khi chúng tôi đã có một giá trị, chúng tôi cần tham chiếu đến các phần UTxO, nhưng chúng tôi không quan tâm đến dữ liệu hiện tại, vì chúng tôi vẫn sẽ cập nhật nó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Just (oref, o,  _) -&gt; do</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ nó trở nên phức tạp hơn một chút, bởi vì bây giờ chúng ta cần hai điều kiện.</p><p>Ràng buộc đầu tiên cũng giống như trong trường hợp khác - ràng buộc được tham chiếu bởi hàm trợ giúp <code>c</code>. Nhưng bây giờ có một hạn chế bổ sung là chúng ta cũng phải sử dụng UTxO hiện có.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">tx = c &lt;&gt; Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Update)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>mustSpendScriptOutput</code>  cơ bản là trái ngược với <code>mustPayToTheScript</code>. ItNó tạo ra một đầu vào cho địa chỉ tập lệnh này. Vì các tham số, nó có tham chiếu đến UTxO mà chúng ta muốn sử dụng, và nó cần một <code>Redeemer</code>. Trong trường hợp <code>Redeemer</code>  là <code>Update</code>  nó được chuyển đổi thành kiểu <code>Data</code>  trong Plutus.</p><p>Để điều này hoạt động, chúng tôi cần cung cấp một số tra cứu.</p><p>Nhằm mục đích tìm đầu ra <code>oref</code>  mà nó muốn chi tiêu, chúng ta phải sử dụng <code>unspentOutputs</code>  tra cứu và trong trường hợp này, chúng ta chỉ cung cấp tra cứu bằng một UTxO.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.unspentOutputs (Map.singleton oref o)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi phải cung cấp các phiên bản script. Chúng ta cần làm điều này hai lần, một lần cho phía đầu vào và một lần cho phía đầu ra. Đối với điều này, chúng tôi cung cấp phiên bản oracle và trình xác thực oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.scriptInstanceLookups (oracleInst oracle) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.otherScript (oracleValidator oracle)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi không cần cung cấp <code>scriptInstanceLookups</code>  tra cứu trong trường hợp đầu tiên, vì chúng tôi có thể chuyển <code>oracleInst oracle</code>  đến hàm <code>submitTxConstraints</code>. Tuy nhiên, với hàm <code>submitTxConstraintsWith</code> thì chúng ta không có tùy chọn đó.</p><p>Khi gửi giao dịch, chúng ta cần thúc đẩy trình biên dịch một chút để cho nó biết script mà chúng ta đang nói đến - để nó biết, chẳng hạn như The Script ở trong <code>mustPayToTheScript</code>.  Đối với điều này, chúng tôi tham khảo loại <code>Oracling</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraintsWith @Oracling lookups tx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hy vọng rằng bây giờ chúng ta có một giao dịch hợp lệ được gửi đi, và sau đó chúng ta đợi nó được xác nhận và viết một số thông tin ghi nhật ký.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;updated oracle value to &quot; ++ show x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hãy nhớ rằng, chúng ta đã nói về việc thu phí trước đó. Điều này sẽ tự động xảy ra. Hàm <code>submitTxConstraintsWith</code> sẽ gửi phí đến ví của chính chúng ta. Nó làm được điều này bởi vì có sự mất cân bằng giữa giá trị gắn với đầu vào, bao gồm phí và NFT, và giá trị mà chúng tôi đã nói phải được trả cho tập lệnh, đó chỉ là NFT.</p><p>Quá trình này cũng sẽ tự động tạo thêm một đầu vào từ đầu vào của chính chúng ta để trả phí giao dịch cho việc thực hiện giao dịch.</p><p>Cuối cùng, chúng tôi cung cấp một chức năng kết hợp hai hoạt động này <code>startOracle</code> và <code>updateOracle</code> thành một hợp đồng. Điều này sẽ làm cho nó có thể được sử dụng trong sân chơi và <code>EmulatorTrace</code> monad, cũng như trong PAB.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type OracleSchema = BlockchainActions .\/ Endpoint &quot;update&quot; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">runOracle :: OracleParams -&gt; Contract (Last Oracle) OracleSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">runOracle op = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- startOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tell $ Last $ Just oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: Oracle -&gt; Contract (Last Oracle) OracleSchema Text a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- endpoint @&quot;update&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        updateOracle oracle x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trước tiên hàm <code>runOracle</code>  khởi động oracle. sau đó, vì những lý do sẽ trở nên rõ ràng sau này, chúng tôi sử dụng <code>tell</code>  để viết tham số cho oracle. Chúng ta cần có khả năng giao tiếp giá trị tham số của oracle với thế giới bên ngoài, để mọi người có thể sử dụng oracle. Chúng tôi sẽ không biết cho đến khi chạy ký hiệu tiền tệ sẽ được sử dụng cho NFT, vì vậy chúng tôi chưa biết giá trị của tham số oracle.</p><p>Hãy nhớ rằng <code>tell</code>  mong đợi loại <code>Monoid</code>. Ví dụ điển hình là một danh sách các chuỗi được nối với một danh sách tất cả các thông báo nhật ký.</p><p>Nhưng nó không phải là danh sách. Trong <code>Data.Monoid</code> Chúng tôi có  <code>Last</code> Monoid.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Data.Monoid (Last (..))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; :i Last</span></div><div class="token-line" style="color:#393A34"><span class="token plain">type Last :: ` -&gt; `</span></div><div class="token-line" style="color:#393A34"><span class="token plain">newtype Last a = Last {getLast :: Maybe a}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Applicative Last -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Eq a =&gt; Eq (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Functor Last -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Monad Last -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Monoid (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Ord a =&gt; Ord (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Semigroup (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Show a =&gt; Show (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Read a =&gt; Read (Last a) -- Defined in ‘Data.Monoid’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Traversable Last -- Defined in ‘Data.Traversable’</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Foldable Last -- Defined in ‘Data.Foldable’</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta thấy rằng nó chỉ là một cái  <code>newtype</code>  bao bọc xung quanh <code>Maybe</code>.Vấn đề là cung cấp một ví dụ cụ thể <code>Monoid</code>. TÝ tưởng, như tên cho thấy, đó là một hoạt động đơn nguyên luôn ghi nhớ giá trị Just cuối cùng.
Ví dụ:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; Last (Just &#x27;x&#x27;) &lt;&gt; Last (Just &#x27;y&#x27;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Last {getLast = Just &#x27;y&#x27;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tuy nhiên, nếu cái thứ hai  <code>Last</code> là không có gì, nó sẽ trả về cái đầu tiên.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Monoid Week06.Oracle.Core&gt; Last (Just &#x27;x&#x27;) &lt;&gt; Last Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Last {getLast = Just &#x27;x&#x27;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu cả hai đều <code>Nothing</code>, nó sẽ là <code>Nothing</code>.</p><p><code>Last</code>  rất hữu ích vì nó cho phép chúng ta giữ nguyên trạng thái hiện tại. Giá trị của nhật ký về cơ bản sẽ là giá trị cuối cùng <code>Just</code> mà chúng tôi đã nói.</p><p>Trong hợp đồng này, chúng tôi sẽ chỉ làm điều đó một lần. Ban đầu nó sẽ như vậy <code>Last Nothing</code>. Sau đó, chúng tôi đúc NFT, và sau đó, khi chúng tôi nhận được giá trị oracle trong <code>runOracle</code>, và sau đó <code>tell</code> nó luôn là giá trị đó. Nếu các hợp đồng khác từ bên ngoài truy vấn trạng thái, chúng sẽ luôn nhận được <code>Just oracle</code>, vì vậy chúng sẽ có thể khám phá giá trị của oracle.</p><p>Vì vậy, tiếp theo trong <code>runOracle</code>, húng tôi gọi hàm trợ giúp <code>go</code>. Điều này là chặn endpoint update. Ngay sau khi ai đó cung cấp một <code>Integer</code> như là một giá trị mới, nó sẽ gọi hàm  <code>updateOracle</code> với một giá trị mới, sau đó lặp lại để cho phép người khác cập nhật oracle..</p><p>Tóm lại, <code>runOracle</code> khởi động <code>oracle</code>, <code>tell</code> là <code>oracle</code>, sau đó lặp lại để cho phép người khác cập nhật oracle.</p><p>Và điều đó kết thúc mã cho chính nhà tiên tri. Những gì hiện còn thiếu là một ví dụ, một hợp đồng thực sự sử dụng oracle - một hợp đồng hoán đổi. Và cũng sử dụng Plutus Application Backend để chạy mã này trong thế giới thực hoặc trong trường hợp của chúng tôi là trong một chuỗi khối mô phỏng.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="xác-thực-hoán-đổiswap-validation"></a>Xác thực hoán đổi(Swap Validation)<a class="hash-link" href="#xác-thực-hoán-đổiswap-validation" title="Direct link to heading">#</a></h2><p>Hợp đồng hoán đổi mẫu của chúng tôi có thể được tìm thấy trong:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.swap</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Mục đích của hợp đồng này là để ai đó có thể ký gửi ADA và đổi nó lấy mã thông báo, trong trường hợp này là token mà chúng tôi sử dụng sẽ gọi là USDT là token USD.</p><p>Ý tưởng là giá, số lượng USDT sẽ được yêu cầu thanh toán cho ADA, sẽ được xác định bởi giá trị của oracle. Hãy nhớ rằng chúng tôi đang sử dụng một <code>Integer</code> để phản ánh tỷ giá hối đoái, với giá trị một triệu tương đương với một USDT.</p><p>Chúng ta sẽ bắt đầu với một hàm trợ giúp được gọi là <code>price</code>, với một số lovelace và tỷ giá hối đoái, sẽ trả về giá USDT.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">price :: Integer -&gt; Integer -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">price lovelace exchangeRate = (lovelace ` exchangeRate) `divide` 1000000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiếp theo là hàm trợ giưps <code>lovelaces</code>,  kết hợp với các hàm từ thư viện Plutus để trích xuất một số lovelace từ một kiểu <code>Value</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">lovelaces :: Value -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">lovelaces = Ada.getLovelace . Ada.fromValue    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ chúng ta sẽ viết <code>mkSwapValidator</code>. Đây là một trình xác thực được tham số hóa với hai tham số.</p><p>Tham số đầu tiên là oracle mà chúng ta đang sử dụng. Để sử dụng điều này, chúng tôi nhập mô-đun oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">import Week06.Oracle.core</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tham số thứ hai là địa chỉ của oracle. Thông thường, với oracle , chúng ta sẽ có thể tính toán địa chỉ từ nó. Trong mô-đun cốt lõi, chúng tôi đã thấy một hàm <code>oracleAddress</code> thực hiện điều này cho chúng tôi. Nhưng đây là một chức năng mà chúng tôi không thể sử dụng trong trình xác thực, vì nó không thể được biên dịch sang tập lệnh Plutus. Vì vậy, ở đây, chúng tôi đưa địa chỉ một cách rõ ràng cho trình xác thực.</p><p>Đối với dữ liệu, chúng tôi sử dụng mã băm khóa công khai của người bán. Chúng tôi không sử dụng công cụ đổi quà, vì vậy chúng tôi cung cấp cho nó một loại <code>Unit</code>.</p><p>Chúng tôi nhớ lại từ sơ đồ, giao dịch hoán đổi phải có ba đầu vào và ba đầu ra.</p><p><img src="/assets/images/week06__00006-1cf322f6040cefba7bb0781f3f259ff3.png"></p><hr><p>  Inputs                              Outputs</p><hr><p> Oracle, Để kiểm tra Oracle hiện tại, cái mà chúng ta không cần xem xét tỷ giá hối đoái trong xác nhận hoán đổi</p><p>UTxO hoán đổi giữ các token lovelace của người bán                            </p><p>  The source of the buyer\&#x27;s funds    The lovelace for the buyer</p><hr><p>Hoán đổi đầu vào đầu ra giao dịch:</p><p>Lưu ý rằng chúng ta không cần phải lo lắng về oracle như một đầu ra. Trình xác thực oracle sẽ đảm bảo rằng giá trị không bị thay đổi và các khoản phí được thêm vào.</p><p>Chúng tôi cũng muốn hỗ trợ trường hợp sử dụng thứ hai, trường hợp người bán có thể lấy token ADA trong trường hợp họ không muốn thực hiện hoán đổi nữa. Nếu chúng tôi không hỗ trợ trường hợp này, ADA có thể bị khóa ở đó mãi mãi, nếu không ai quyết định thực hiện hoán đổi.</p><p>Trường hợp thứ hai này là điều kiện chúng tôi kiểm tra trong trình xác thực. Nếu người bán tự mình ký vào giao dịch, thì không có bất kỳ ràng buộc nào nữa - chúng tôi không cần kiểm tra oracle hay bất cứ thứ gì khác - người bán chỉ có thể lấy lại lovelace của họ.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mkSwapValidator :: Oracle -&gt; Address -&gt; PubKeyHash -&gt; () -&gt; ScriptContext -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkSwapValidator oracle addr pkh () ctx =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    txSignedBy info pkh ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...            </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trường hợp thú vị hơn là trường hợp thứ hai, nơi chúng tôi kiểm tra hai điều kiện.</p><p>Đầu tiên, phải có hai đầu vào - oracle và UTxO hoán đổi. Tất cả các đầu vào bổ sung (tiền của người mua) phải là đầu vào khóa công khai. Điều này là do chúng tôi không muốn lo lắng về việc can thiệp vào các hợp đồng thông minh khác.</p><p>Thứ hai, chúng tôi muốn kiểm tra xem người bán có được thanh toán hay không.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">(traceIfFalse &quot;expected exactly two script inputs&quot; hasTwoScriptInputs &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> traceIfFalse &quot;price not paid&quot;                     sellerPaid)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ, chúng ta có các định nghĩa về hàm trợ giúp của chúng ta.</p><p>Đầu tiên:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">info = scriptContextTxInfo ctx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng ta phải dùng <code>oracleInput</code>  để lấy UTxO từ oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleInput :: TxOut</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleInput =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ins = [ o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          | i &lt;- txInfoInputs info</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          , let o = txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          , txOutAddress o == addr</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          ]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case ins of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [o] -&gt; o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _   -&gt; traceError &quot;expected exactly one oracle input&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi thực hiện điều này bằng cách lấy danh sách tất cả các đầu vào. Đối với điều này, chúng tôi sử dụng khả năng hiểu danh sách, cho phép chúng tôi lấy từ các danh sách khác bằng bộ lọc. Trong trường hợp này, chúng tôi lấy từ danh sách từ <code>txInfoInputs info</code>, đó là danh sách của <code>TxInfo</code>. Chúng tôi sử dụng hàm <code>txInInfoResolved</code>  để xem mỗi phần tử kiểu <code>TxOut</code>, sau đó chúng tôi so sánh với tham số <code>addr</code>. Danh sách kết quả sẽ trống hoặc sẽ có danh sách <code>TxOut</code> phù hợp với UTxO oracle.</p><p>Sau đó, chúng tôi kiểm tra xem có chính xác một phần tử trong danh sách kết quả hay không, và nếu có, chúng tôi trả về nó. Chúng tôi không trả lại danh sách, chỉ trả lại <code>TxOut</code>.</p><p>Điều này hiện đã cho chúng ta kết quả đầu ra kỳ diệu mà chúng ta đang sử dụng làm đầu vào.</p><p>Bây giờ, chúng tôi muốn kiểm tra tỷ giá hối đoái thực tế. Đối với điều đó, chúng tôi sử dụng hàm <code>oracleValue</code>   mà chúng tôi đã xác định trong mô-đun cốt lõi. Ở đây một lần nữa, nó có thể thành công, hoặc nó có thể thất bại. Nếu nó thành công, chúng tôi trả về giá trị.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleValue&#x27; = case oracleValue oracleInput (`findDatum` info) of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing -&gt; traceError &quot;oracle value not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Just x  -&gt; x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta không cần kiểm tra xem oracle có chứa NFT hay không. Do cách thức hoạt động của xác thực đối với oracle, chúng ta biết rằng nó hiện diện..</p><p>Bây giờ, chúng ta hãy xem xét hàm trợ giúp <code>hasTwoScriptInputs</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">hasTwoScriptInputs :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hasTwoScriptInputs =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    xs = filter (isJust . toValidatorHash . txOutAddress . txInInfoResolved) $ txInfoInputs info</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    length xs == 2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đầu tiên, chúng tôi lọc, sử dụng hàm tổng hợp</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">(isJust . toValidatorHash . txOutAddress . txInInfoResolved)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đọc từ phải sang trái, chúng ta nhận được UTxO từ đầu vào, sau đó chúng ta nhận được địa chỉ cho UTxO này, và chúng ta nhận được mã băm của trình xác thực cho địa chỉ đó. Cuối cùng, chúng ta kiểm tra xem nó có phải là đầu ra tập lệnh hay không, bằng cách xem nó có phải là <code>Just</code>. Nếu nó là  <code>Nothing</code>, thì điều này sẽ cho thấy rằng nó là một khóa công khai, không phải là một địa chỉ tập lệnh.</p><p>Sau đó, chúng tôi sử dụng hàm tổng hợp này như một bộ lọc dựa trên danh sách các <code>TxInInfos</code>. Và sau đó chúng tôi kiểm tra độ dài của danh sách kết quả là chính xác hai.</p><p>Quay trở lại các điều kiện xác thực của chúng ta, bây giờ chúng ta phải làm với việc kiểm tra xem người bán có được thanh toán hay không. Vì vậy, hãy viết hàm <code>sellerPaid</code> mà chúng ta đã tham chiếu.</p><p>Đối với điều này, chúng tôi sẽ sử dụng một hàm trợ giúp khác để xác định giá yêu cầu.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">minPrice :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">minPrice =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    lovelaceIn = case findOwnInput ctx of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; traceError &quot;own input not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just i  -&gt; lovelaces $ txOutValue $ txInInfoResolved i</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    price lovelaceIn oracleValue&#x27;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trước tiên, chúng tôi kiểm tra xem chúng tôi có một đầu vào hay không, và nếu có, chúng tôi trích xuất số lượng khoảng cách và gán số đó cho <code>lovelaceIn</code>. Sau đó, chúng tôi sử dụng hàm <code>price</code> để xác định giá bằng token USDT.</p><p>Bây giờ, chúng ta có thể định nghĩa hàm <code>sellerPaid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">sellerPaid :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">sellerPaid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  let</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid =  assetClassValueOf (valuePaidTo info pkh) (oAsset oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  in</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pricePaid &gt;= minPrice</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>valuePaidTo</code>  này là từ các thư viện Plutus. Đã cho <code>info</code> và một băm khóa công khai, nó sẽ cộng tất cả các giá trị của tất cả các đầu ra khóa công khai đi đến địa chỉ này. Sau đó, chúng tôi sử dụng <code>assetClassValueOf</code> để kiểm tra thành phần của giá trị có trong mã thông báo USD và kiểm tra xem chúng tôi có ít nhất bao nhiêu tùy theo yêu cầu của chúng tôi.</p><p>Đó là chức năng cuối của phần chính trong mã trình xác thực hoán đổi. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ScriptType Swapping where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Swapping = PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Swapping = ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapInst :: Oracle -&gt; Scripts.ScriptInstance Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapInst oracle = Scripts.validator @Swapping</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ($$(PlutusTx.compile [|| mkSwapValidator ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        `PlutusTx.applyCode` PlutusTx.liftCode oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        `PlutusTx.applyCode` PlutusTx.liftCode (oracleAddress oracle))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @PubKeyHash @()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapValidator :: Oracle -&gt; Validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapValidator = Scripts.validatorScript . swapInst</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapAddress :: Oracle -&gt; Ledger.Address</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swapAddress = scriptAddress . swapValidator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Lưu ý rằng trong hàm <code>swapInst</code>, nơi chúng ta sử dụng hàm băm mẫu để tạo trình xác thực Plutus từ hàm <code>mkSwapValidator</code>, chúng tôi không cần chuyển địa chỉ oracle làm tham số. Điều này là do chúng tôi sẽ tính toán điều này bên trong hàm. Hãy nhớ rằng chúng ta không thể sử dụng hàm <code>oracleAddress</code>  bên trong trình xác thực Plutus.</p><p>Bây giờ để xác định một số hợp đồng.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="chào-hàng-offerswap"></a>Chào hàng (offerSwap)<a class="hash-link" href="#chào-hàng-offerswap" title="Direct link to heading">#</a></h3><p>Đầu tiên <code>offerSwap</code>. Điều này dành cho người bán muốn đưa ra một số lượng nhất định để trao đổi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">offerSwap :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Integer -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">offerSwap oracle amt = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let tx = Constraints.mustPayToTheScript pkh $ Ada.lovelaceValueOf amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ledgerTx &lt;- submitTxConstraints (swapInst oracle) tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;offered &quot; ++ show amt ++ &quot; lovelace for swap&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="findswaps"></a>findSwaps<a class="hash-link" href="#findswaps" title="Direct link to heading">#</a></h3><p>Tiếp theo, một hàm trợ giúp sẽ tìm tất cả các hoán đổi thỏa mãn một vị thế nhất định. Nó cần một oracle cộng với một vị thế dựa trên hàm băm khóa công khai và trả về danh sách bộ ba UTxO thỏa mãn vị thế.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">findSwaps :: HasBlockchainActions s =&gt; Oracle -&gt; (PubKeyHash -&gt; Bool) -&gt; Contract w s Text [(TxOutRef, TxOutTx, PubKeyHash)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">findSwaps oracle p = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- utxoAt $ swapAddress oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return $ mapMaybe g $ Map.toList utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: TxOutTx -&gt; Maybe PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f o = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        dh        &lt;- txOutDatumHash $ txOutTxOut o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Datum d) &lt;- Map.lookup dh $ txData $ txOutTxTx o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        PlutusTx.fromData d</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    g :: (TxOutRef, TxOutTx) -&gt; Maybe (TxOutRef, TxOutTx, PubKeyHash)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    g (oref, o) = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        pkh &lt;- f o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        guard $ p pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (oref, o, pkh)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đầu tiên, chúng tôi nhận được danh sách tất cả các UTxO ở địa chỉ hợp đồng hoán đổi. Sau đó chúng tôi áp dụng <code>mapMaybe</code>  dành cho danh sách này.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mapMaybe :: (a -&gt; Maybe b) -&gt; [a] -&gt; [b]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm này sẽ áp dụng hàm <code>(a -&gt; Maybe b)</code>  cho từng phần tử trong danh sách <code>a</code> và tạo danh sách <code>Maybe b</code>, có thể chứa hỗn hợp của <code>Just</code> và <code>Nothing</code>. sau đó nó bỏ <code>Nothing</code>và chỉ để lại giá trị<code>Just</code>.</p><p>Để làm rõ điều này, hãy tưởng tượng chúng ta có một hàm trả về như <code>Just</code>  cho số chẵn và một <code>Nothing</code>  cho số lẻ.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">f (n :: Int) = if even n then Just (div n 2) else Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta có thể sử dụng thông số này làm tham số đầu tiên để lập <code>mapMaybe</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Data.Maybe</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Data.Maybe Week06.Oracle.Core&gt; mapMaybe f [2, 4, 10, 11, 13, 100]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[1,2,5,50]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chung ta sử dụng <code>mapMaybe</code>  và hàm <code>g</code> để lọc danh sách các UTxO.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">g :: (TxOutRef, TxOutTx) -&gt; Maybe (TxOutRef, TxOutTx, PubKeyHash)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">g (oref, o) = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- f o</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    guard $ p pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return (oref, o, pkh)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm này nhận một cặp giá trị khóa đại diện cho UTxO và trả về một bộ ba <code>Maybe</code> chứa các mục từ cặp cùng với <code>PubKeyHash</code>.</p><p>Hàm <code>g</code>  bên trong monad <code>Maybe</code>  và sử dụng hàm <code>f</code>,
cũng nằm bên trong monad <code>Maybe</code>. Hàm <code>f</code> lấy mã băm khóa công khai từ UTxO, nếu nó tồn tại. Sau đó, hàm  <code>g</code>  sử dụng hàm<code>guard</code>  cùng với thuộc tính <code>p</code>  tmà chúng ta chuyển vào làm   đối số.</p><p>Hàm <code>guard</code>  là hàm có sẵn trong monads, và monad <code>Maybe</code><br>
cũng vậy. Nó nhận một boolean làm tham số, và nếu boolean là false, thì quá trình tính toán sẽ không thành công. Trong trường hợp này, false có nghĩa là quay trở lại <code>Nothing</code>. nếu là true, Nếu nó là sự thật, nó chỉ tiếp tục. Trong trường hợp này, điều đó có nghĩa là trả về  bộ ba <code>Just</code> chứa hàm băm khóa công khai. </p><p>Chúng ta sẽ xem cách chúng ta sử dụng hàm <code>findSwaps</code>  một lát nữa.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="lấy-lại-hoán-đổi-retrieveswaps"></a>lấy lại Hoán đổi (retrieveSwaps)<a class="hash-link" href="#lấy-lại-hoán-đổi-retrieveswaps" title="Direct link to heading">#</a></h3><p>Contract <code>retrieveSwaps</code>  là dành cho người bán nếu họ muốn thay đổi suy nghĩ của họ và nhận được Ada trở lại của họ.</p><p>Đây là nơi chúng tôi sử dụng hàm <code>findSwaps</code>. Chúng ta sử dụng nó với<code>(== pkh)</code> như là một thuộc tính, có nghĩa là chúng tôi muốn chỉ những UTxO ở địa chỉ hoán đổi thuộc về nhà điều hành.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">retrieveSwaps :: HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">retrieveSwaps oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    xs &lt;- findSwaps oracle (== pkh)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case xs of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        [] -&gt; logInfo @String &quot;no swaps found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _  -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            let lookups = Constraints.unspentOutputs (Map.fromList [(oref, o) | (oref, o, _) &lt;- xs]) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.otherScript (swapValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx      = mconcat [Constraints.mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | (oref, _, _) &lt;- xs]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;retrieved &quot; ++ show (length xs) ++ &quot; swap(s)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu không có, thì không có gì để làm. Nếu có một số, chúng tôi xây dựng một giao dịch truy xuất tất cả chúng.</p><p>Để làm điều đó, chúng tôi tạo một danh sách các ràng buộc <code>mustSpendScriptOutput</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">tx = mconcat [Constraints.mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | (oref, _, _) &lt;- xs]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p> Trông có vẻ đáng sợ, nhưng nó chỉ là trích xuất một danh sách các <code>oref</code> từ danh sách <code>xs</code>  và sử dụng nó để xây dựng một ràng buộc cho từng người trong số họ, sử dụng <code>Unit</code>  như là kiểu <code>Redeemer</code>. Hàm <code>mconcat</code> áp dụng  <code>Semigroup</code> toán tử <code>&lt;&gt;</code> trong toàn bộ danh sách để kết hợp chúng.</p><p>Khi tra cứu, chúng tôi phải cung cấp tất cả các UTxO và trình xác thực hoán đổi.</p><p>Chúng tôi có danh sách các UTxO trong <code>xs</code> và chúng tôi biến danh sách này thành danh sách các cặp và sau đó chúng tôi sử dụng <code>Map.fromList</code> để biến các cặp đó thành một bản đồ (map), sau đó chúng tôi áp dụng ràng buộc <code>unspentOutputs</code> .</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="useswaps"></a>useSwaps<a class="hash-link" href="#useswaps" title="Direct link to heading">#</a></h3><p>Và bây giờ là một trong những thú vị nhất <code>useSwaps</code>. Đây là nơi chúng tôi thực sự sử dụng oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">useSwap :: forall w s. HasBlockchainActions s =&gt; Oracle -&gt; Contract w s Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">useSwap oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    funds &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let amt = assetClassValueOf funds $ oAsset oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;available assets: &quot; ++ show amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing           -&gt; logInfo @String &quot;oracle not found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (oref, o, x) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;found oracle, exchange rate &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            pkh   &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            swaps &lt;- findSwaps oracle (/= pkh)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            case find (f amt x) swaps of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Nothing                -&gt; logInfo @String &quot;no suitable swap found&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Just (oref&#x27;, o&#x27;, pkh&#x27;) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    let v       = txOutValue (txOutTxOut o) &lt;&gt; lovelaceValueOf (oFee oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        p       = assetClassValue (oAsset oracle) $ price (lovelaces $ txOutValue $ txOutTxOut o&#x27;) x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        lookups = Constraints.otherScript (swapValidator oracle)                     &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.otherScript (oracleValidator oracle)                   &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.unspentOutputs (Map.fromList [(oref, o), (oref&#x27;, o&#x27;)])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        tx      = Constraints.mustSpendScriptOutput oref  (Redeemer $ PlutusTx.toData Use) &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustSpendScriptOutput oref&#x27; (Redeemer $ PlutusTx.toData ())  &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustPayToOtherScript</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    (validatorHash $ oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    (Datum $ PlutusTx.toData x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    v                                                                      &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                  Constraints.mustPayToPubKey pkh&#x27; p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    logInfo @String $ &quot;made swap with price &quot; ++ show (Value.flattenValue p)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice :: Integer -&gt; TxOutTx -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice x o = price (lovelaces $ txOutValue $ txOutTxOut o) x</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: Integer -&gt; Integer -&gt; (TxOutRef, TxOutTx, PubKeyHash) -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f amt x (_, o, _) = getPrice x o &lt;= amt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đầu tiên, chúng tôi sử dụng hàm <code>ownFunds</code>. Điều này được định nghĩa trong một mô-đun riêng biệt mà chúng ta sẽ đi sâu vào trong một chút. Tất cả những gì nó làm là thêm tất cả tiền vào ví của chính chúng ta và trả về <code>Value</code>. Sau đó, chúng tôi tìm hiểu chúng tôi có bao nhiêu USD Token.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">funds &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">let amt = assetClassValueOf funds $ oAsset oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;available assets: &quot; ++ show amt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>findOracle</code>  được định nghia trong mô đun Oracle.Core từ trước. Bạn sẽ nhớ lại rằng nó tìm thấy oracle UTxO có chứa giá trị oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">m &lt;- findOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu chúng tôi không tìm thấy lời tiên tri, chúng tôi sẽ chỉ ghi lại một thông báo về hiệu ứng đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing           -&gt; logInfo @String &quot;oracle not found&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu chúng tôi tìm thấy nó, chúng tôi sẽ ghi lại một thông báo với tỷ giá hối đoái hiện tại.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Just (oref, o, x) -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;found oracle, exchange rate &quot; ++ show x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiếp theo, chúng tôi kiểm tra khóa công khai của riêng mình và kiểm tra tất cả các giao dịch hoán đổi có sẵn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">pkh   &lt;- pubKeyHash &lt;$&gt; Contract.ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swaps &lt;- findSwaps oracle (/= pkh)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi sử dụng một hàm <code>find</code>  đó là từ Haskell prelude,Trong module <code>Data.List</code>. Hàm <code>find</code>  với đối số là một thuộc tính là một danh sách <code>Maybe</code>  trả về một phần tử phù hợp với thuộc tính đó.</p><p>Hàm được sử dụng trong vị từ được định nghĩa là hàm trợ giúp <code>f</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice :: Integer -&gt; TxOutTx -&gt; Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getPrice x o = price (lovelaces $ txOutValue $ txOutTxOut o) x    </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f :: Integer -&gt; Integer -&gt; (TxOutRef, TxOutTx, PubKeyHash) -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    f amt x (_, o, _) = getPrice x o &lt;= amt    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi cung cấp cho nó một số tiền, tỷ giá hối đoái hiện tại và một bộ ba UTxO. Hàm xác định xem có hoán đổi nào rẻ hơn hoặc bằng tham số số tiền hay không.</p><p>Bây giờ, chúng tôi đã tìm kiếm một giao dịch hoán đổi mà chúng tôi có thể chi trả. Nếu chúng tôi không tìm thấy một, chúng tôi sẽ ghi lại một thông báo nói như vậy.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case find (f amt x) swaps of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Nothing                -&gt; logInfo @String &quot;no suitable swap found&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu chúng tôi tìm thấy một cái, chúng tôi chỉ lấy cái đầu tiên. Tất nhiên, điều này không thực tế lắm. Trong một ví dụ thực tế, chúng tôi có thể sẽ chỉ định số tiền chính xác mà chúng tôi muốn hoán đổi. Ở đây, chúng tôi chỉ giữ nó đơn giản vì chúng tôi tập trung vào mục tiêu mấu chốt hơn là hoán đổi.</p><p>Vì vậy, bây giờ chúng ta xây dựng một giao dịch.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let v = txOutValue (txOutTxOut o) &lt;&gt; lovelaceValueOf (oFee oracle)                </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đây là đầu ra cho tiên tri. Nó cũng giống như đầu vào, bao gồm bất kỳ khoản phí nào đã tích lũy ở đó, cộng với khoản phí trong tình yêu mà chúng ta cần phải trả.</p><p>Sau đó, chúng tôi tạo một <code>Value</code> mã thông báo USD  đại diện mà chúng tôi cần thanh toán. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">p = assetClassValue (oAsset oracle) $ price (lovelaces $ txOutValue $ txOutTxOut o&#x27;) x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ, chúng ta hãy xem xét các ràng buộc.</p><p>Ràng buộc đầu tiên là chúng ta phải sử dụng oracle làm đầu vào. Và ở đây chúng ta thấy lần đầu tiên sử dụng <code>Redeemer</code>. Chúng tôi chưa bao giờ sử dụng <code>Redeemer</code> này trong chính lõi oracle, vì nhà cung cấp oracle chỉ chịu trách nhiệm cập nhật các giá trị sử dụng <code>Redeemer</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustSpendScriptOutput oref (Redeemer $ PlutusTx.toData Use)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ràng buộc thứ hai là sử dụng đầu vào hoán đổi, chỉ sử dụng một trình <code>Unit</code> cho Redeeemer.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustSpendScriptOutput oref&#x27; (Redeemer $ PlutusTx.toData ())</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ràng buộc thứ ba là trả tiền oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustPayToOtherScript</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    (validatorHash $ oracleValidator oracle)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    (Datum $ PlutusTx.toData x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ở đây chúng tôi sử dụng <code>mustPayToOtherScript</code>, chỉ định tập lệnh oracle, vì bây giờ chúng ta có hai tập lệnh đang hoạt động - tập lệnh oracle và tập lệnh hoán đổi. Như <code>Datum</code>  chúng tôi sử dụng datum tồn tại - wchúng tôi không được thay đổi nó - và
như là <code>Value</code>  chúng tôi sử dụng giá trị <code>v</code>  mà chúng tôi đã tính toán trước đó.</p><p>Ràng buộc cuối cùng là chúng tôi phải trả tiền cho người bán  - và khoản thanh toán là giá trị <code>p</code> mà chúng tôi đã tính toán trước đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Constraints.mustPayToPubKey pkh&#x27; p</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Để tra cứu, chúng tôi phải cung cấp trình xác thực của hợp đồng oracle và hoán đổi, đồng thời chúng tôi phải cung cấp hai UTxO mà chúng tôi muốn sử dụng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">lookups = Constraints.otherScript (swapValidator oracle)               &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Constraints.otherScript (oracleValidator oracle)                   &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Constraints.unspentOutputs (Map.fromList [(oref, o), (oref&#x27;, o&#x27;)])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ, thông thường - chúng tôi gửi nó, chờ xác nhận, sau đó ghi lại một tin nhắn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ledgerTx &lt;- submitTxConstraintsWith @Swapping lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">logInfo @String $ &quot;made swap with price &quot; ++ show (Value.flattenValue p)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="gói-hợp-đồng-contract-bundle"></a>Gói hợp đồng (Contract bundle)<a class="hash-link" href="#gói-hợp-đồng-contract-bundle" title="Direct link to heading">#</a></h3><p>Điều đó xác định các hợp đồng thô. Bây giờ, chúng tôi cung cấp một gói chứa tất cả chúng.</p><p>Đầu tiên, chúng tôi định nghĩa, như mọi khi, một <code>SwapSchema</code>, xác định các endpoints.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type SwapSchema =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    BlockchainActions</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;offer&quot;    Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;retrieve&quot; ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;use&quot;      ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        .\/ Endpoint &quot;funds&quot;    ()    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tiếp theo, chúng ta thấy toán tử <code>select</code>. Việc sử dụng toán tử này sẽ khiến mã của chúng tôi đợi cho đến khi một trong các điểm cuối được chọn, rồi thực thi mã được liên kết.</p><p>Các hàm <code>swap</code>  đệ quy gọi chính nó, cung cấp một lần nữa và một lần nữa lựa chọn cùng một endpoints.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">swap :: Oracle -&gt; Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap oracle = (offer `select` retrieve `select` use `select` funds) &gt;&gt; swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        offer :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        offer = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            amt &lt;- endpoint @&quot;offer&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            offerSwap oracle amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        retrieve :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        retrieve = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;retrieve&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            retrieveSwaps oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        use :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        use = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;use&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            useSwap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        funds :: Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        funds = h $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            endpoint @&quot;funds&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            v &lt;- ownFunds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            tell $ Last $ Just v</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        h :: Contract (Last Value) SwapSchema Text () -&gt; Contract (Last Value) SwapSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        h = handleError logError    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Mã cho bốn endpoint là trình bao bọc cho mã chúng ta đã viết.</p><p>Ví dụ <code>offer</code>, wchúng tôi chặn cho đến khi chúng tôi được cung cấp <code>amt</code> và sau đó gọi contract <code>offerSwap</code>  .</p><p>Đối với endpoints <code>retrieve</code>  và  <code>use</code>  ,chúng không cần tham số.</p><p>cuối cùng là endpoint <code>funds</code>, nó thì khác một chút. hàm <code>ownFunds</code>xuất phát từ mô-đun <code>Funds</code> , chúng ta đã đề cập trước đó, Chung ta thấy, nó chứa một giá trị <code>Value</code> mà nó sở hứu. sau đó chúng ta <code>tell</code> giá trị này  như một cách báo cáo với thế giới bên ngoài rằng chúng tôi có bao nhiêu.</p><p>Trong hmỗi điểm cuối là một trình xử lý lỗ <code>h</code>. Mỗi điểm cuối được bao bọc bên trong trình xử lý lỗi, trình này chỉ ghi lại lỗi, nhưng không tạm dừng thực thi.</p><p>Và điều đó kết thúc ví dụ hoán đổi.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="funds-module"></a>Funds Module<a class="hash-link" href="#funds-module" title="Direct link to heading">#</a></h2><p>Bây giờ chúng ta hãy nhanh chóng xem xét mô-đun <code>Funds</code>. Đó là một mô-đun ngắn cung cấp hai hợp đồng.</p><p>Các hàm <code>ownFunds</code>  được giao nhiệm vụ tổng hợp tất cả các giá trị trong các UTxOs của chúng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds :: HasBlockchainActions s =&gt; Contract w s Text Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pk    &lt;- ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- utxoAt $ pubKeyAddress pk</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let v = mconcat $ Map.elems $ txOutValue . txOutTxOut &lt;$&gt; utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ &quot;own funds: &quot; ++ show (Value.flattenValue v)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return v</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nó thực hiện điều này bằng cách tra cứu khóa công khai của chúng, sau đó nhận tất cả các UTxO tại địa chỉ khóa công khai đó. Sau đó <code>utxos</code> là một bản đồ từ các tham chiếu UTxO đến các UTxO.</p><p>như <code>map</code>  thực hiện <code>Functor</code>  húng tôi có thể ánh xạ trên bản đồ để thay đổi các yếu tố thành một cái gì đó khác. Trong trường hợp này, chúng tôi thay đổi chúng thành giá trị bằng cách áp dụng hàm tổng hợp <code>txOutValue</code>  . <code>txOutTxOut</code>.</p><p>Các hàm <code>Map.elems</code>  bỏ qua các phím và chỉ cho chúng ta các giá trị. Và, như chúng ta đã thấy trước đây <code>mconcat</code>khi được cung cấp một kiểu <code>Semigroup</code>  or <code>Monoid</code>sẽ kết hợp danh sách các giá trị thành một giá trị.</p><p>Vì vậy,  <code>v</code>  không phải là tổng của tất cả các giá trị của tất cả các UTxO mà chúng ta sở hữu.
Hàm <code>ownFunds</code>  của chúng tôi là một hợp đồng có kiểu trả về giá trị <code>v</code>.</p><p>Hàm <code>ownFunds&#x27;</code> là một biến thể, thay vì trả về giá trị, nó sẽ vĩnh viễn là tell. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds&#x27; :: Contract (Last Value) BlockchainActions Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ownFunds&#x27; = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    handleError logError $ ownFunds &gt;&gt;= tell . Last . Just</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Contract.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownFunds&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều này gọi hàm <code>ownFunds</code>  thực hiện liên kết đơn nguyên với hàm tổng hợp <code>tell . Last . Just</code>  wày cho biết giá trị, sau đó nó đợi một vị trí và sau đó gọi chính nó. Vì vậy, mỗi khối, nó ghi giá trị vào nhật ký.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="testing"></a>Testing<a class="hash-link" href="#testing" title="Direct link to heading">#</a></h2><p>Bây giờ chúng tôi sẽ viết mã, sử dụng  <code>EmulatorTrace</code>  monad, kiểm tra các hợp đồng chúng tôi đã viết.</p><p>Mã này có thể được tìm thấy trong mô-đun sau:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.Test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đầu tiên, chúng ta cần xác định một mã thông báo mà chúng ta có thể kiểm tra. <code>assetSymbol</code> là một hàm băm tùy ý, dùng được cho các mục đích thử nghiệm.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">assetSymbol :: CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetSymbol = &quot;ff&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetToken :: TokenName</span></div><div class="token-line" style="color:#393A34"><span class="token plain">assetToken = &quot;USDT&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Lần này chúng ta sẽ sử dụng phiên bản mồi của <code>runEmulatorTraceIO</code>, lấy thêm hai đối số và cung cấp nhiều chi tiết hơn cho môi trường giả lập.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">test :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">test = runEmulatorTraceIO&#x27; def emCfg myTrace</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    emCfg :: EmulatorConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    emCfg = EmulatorConfig $ Left $ Map.fromList [(Wallet i, v) | i &lt;- [1 .. 10]]</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v :: Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v = Ada.lovelaceValueOf                    100_000_000 &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Value.singleton assetSymbol assetToken 100_000_000    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đối số đầu tiên để <code>runEmulatorTraceIO&#x27;</code>  xác định cách hiển thị các thông báo nhật ký khác nhau. Bằng cách sử dụng  <code>def</code>, chúng tôi đã chọn mặc định, giống như trong phiên bản không có bản quyền.</p><p>Lý do chúng tôi đang sử dụng phiên bản mồi là chúng tôi muốn định cấu hình phân phối ban đầu và chúng tôi có thể thực hiện điều đó với đối số thứ hai, mà ở đây chúng tôi đã gắn nhãn <code>emCfg</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">emCfg :: EmulatorConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">emCfg = EmulatorConfig $ Left $ Map.fromList [(Wallet i, v) | i &lt;- [1 .. 10]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi sử dụng điều này với hàm trợ giúp <code>v</code>  để cung cấp cho mọi người 100 triệu lovelace (100 Ada) and 100 triệu USD Tokens để bắt đầu.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">v :: Value</span></div><div class="token-line" style="color:#393A34"><span class="token plain">v = Ada.lovelaceValueOf                    100_000_000 &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Value.singleton assetSymbol assetToken 100_000_000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi xác định một hợp đồng trợ giúp  <code>checkOracle</code>, nó sẽ liên tục kiểm tra giá trị oracle và ghi lại nó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">checkOracle :: Oracle -&gt; Contract () BlockchainActions Text a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">checkOracle oracle = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    m &lt;- findOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case m of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing        -&gt; return ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just (_, _, x) -&gt; Contract.logInfo $ &quot;Oracle value: &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Contract.waitNSlots 1 &gt;&gt; checkOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và bây giờ chúng ta có thể xác định dấu vết của mình.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">myTrace :: EmulatorTrace ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">myTrace = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let op = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                { opFees = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , opSymbol = assetSymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , opToken  = assetToken</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h1 &lt;- activateContractWallet (Wallet 1) $ runOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- getOracle h1</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 2) $ checkOracle oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_500_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 1) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 3) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 4) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ activateContractWallet (Wallet 5) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h3 &lt;- activateContractWallet (Wallet 3) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h4 &lt;- activateContractWallet (Wallet 4) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h5 &lt;- activateContractWallet (Wallet 5) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;offer&quot; h3 10_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;offer&quot; h4 20_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_700_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;update&quot; h1 1_800_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;retrieve&quot; h3 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    callEndpoint @&quot;retrieve&quot; h4 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ Emulator.waitNSlots 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getOracle :: ContractHandle (Last Oracle) OracleSchema Text -&gt; EmulatorTrace Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getOracle h = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        l &lt;- observableState h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        case l of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Last Nothing       -&gt; Emulator.waitNSlots 1 &gt;&gt; getOracle h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Last (Just oracle) -&gt; Extras.logInfo (show oracle) &gt;&gt; return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Đây là tất cả những thứ mà chúng ta đã thấy. Chúng tôi xác định các tham số oracle của mình, đặt mức phí oracle ở mức 1 triệu lovelace và loại tài sản tùy ý của chúng tôi đã xác định trước đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">let op = OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { opFees = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opSymbol = assetSymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , opToken  = assetToken</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi bắt đầu một oracle và chờ một slot.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">h1 &lt;- activateContractWallet (Wallet 1) $ runOracle op</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracle &lt;- getOracle h1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi đã nắm bắt được một xử lý đối với oracle bằng cách sử dụng chức năng trợ giúp được định nghĩa trong mệnh đề <code>where</code> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getOracle :: ContractHandle (Last Oracle) OracleSchema Text -&gt; EmulatorTrace Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getOracle h = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    l &lt;- observableState h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    case l of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Last Nothing       -&gt; Emulator.waitNSlots 1 &gt;&gt; getOracle h</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Last (Just oracle) -&gt; Extras.logInfo (show oracle) &gt;&gt; return oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta cần điều này vì hợp đồng hoán đổi được tham số hóa với giá trị oracle. Và đây là lý do tại sao chúng tôi sử dụng <code>tell</code>  trong hàm <code>runOracle</code>.</p><p>Chúng tôi sử dụng hàm <code>observableState</code>  để nắm giữ thông tin này. Nếu nó không tồn tại, chúng tôi đợi một vị trí và thử lại. Nếu không, chúng tôi ghi lại nó cho mục đích gỡ lỗi và trả lại nó.</p><p>Tiếp theo, chúng tôi sử dụng Wallet 2 để thực thi hàm <code>checkOracle</code>  mà chúng tôi đã thấy trước đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 2) $ checkOracle oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi khởi tạo oracle với tỷ giá hối đoái là 1,5 Ada và đợi 3 slots.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;update&quot; h1 1_500_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ chúng ta gọi hàm <code>ownFunds&#x27;</code>  trên ví 1, 3, 4 và 5 để kiểm tra số dư ban đầu.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 1) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 3) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 4) ownFunds&#x27;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ activateContractWallet (Wallet 5) ownFunds&#x27;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi bắt đầu hợp đồng hoán đổi trên Ví 3, 4 và 5.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">h3 &lt;- activateContractWallet (Wallet 3) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">h4 &lt;- activateContractWallet (Wallet 4) $ swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">h5 &lt;- activateContractWallet (Wallet 5) $ swap oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi thử một số kịch bản. Đầu tiên, Ví 3 và 4 lần lượt cung cấp 10 và 20 Ada để hoán đổi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;offer&quot; h3 10_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;offer&quot; h4 20_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và bây giờ Ví 5 sử dụng hoán đổi. Nó sẽ chọn một trong hai. Không rõ cái nào, cái nào tìm trước. Hãy nhớ rằng chúng tôi chỉ viết mã để tìm vị trí đầu tiên có giá cả phải chăng. Sau đó, nó sẽ trả USD Token cho nó. Số tiền được trả sẽ phụ thuộc vào giá trị hiện tại của oracle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ, Wallet 1 cập nhật giá trị oracle lên 1,7. Điều này cũng dẫn đến phí tích lũy (1 Ada) được trả cho Ví 1.</p><blockquote><p>callEndpoint @\&quot;update\&quot; h1 1_700_000 void \$ Emulator.waitNSlots 3</p></blockquote><p>Sau đó, Wallet 5 thử lại, lấy phần hoán đổi còn lại, nhưng hiện đang trả một giá USD Token khác.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;use&quot; h5 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, chúng tôi đặt giá trị oracle thành 1,8.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;update&quot; h1 1_800_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều này sẽ cho phép Wallet 1 thu phí. Giá trị oracle thực sự không cần phải thay đổi để điều này xảy ra.</p><p>Ví 3 và 4 hiện đưa ra <code>retrieve</code> yêu cầu lấy lại bất kỳ khoản tiền nào chưa được mua. Điều này sẽ dẫn đến việc không có tiền được trả lại vì tất cả các khoản hoán đổi đã được sử dụng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;retrieve&quot; h3 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">callEndpoint @&quot;retrieve&quot; h4 ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">void $ Emulator.waitNSlots 3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và đây là toàn bộ code. Vì vậy, hãy chạy nó trong REPL.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-in-the-repl"></a>Test in the REPL<a class="hash-link" href="#test-in-the-repl" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Core&gt; import Week06.Oracle.Test</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week06.Oracle.Test Week06.Oracle.Core&gt; test</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sẽ có rất nhiều đầu ra.</p><p>Hãy xem xét một số phần chính. Đầu tiên, slot 3, nơi tạo ra oracle. Ở đây chúng tôi nhận được giá trị <code>oSymbol</code>  mà chúng tôi có thể sử dụng cho mọi thứ khác.</p><p>Chúng tôi cũng thấy trong vị trí số 3 <code>getOracle</code> được bắt đầu sẽ ghi lại giá trị của oracle, để biết thông tin của chúng tôi, mọi vị trí kể từ bây giờ.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: ```  CONTRACT LOG: &quot;started oracle Oracle {oSymbol = 6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (ff,\&quot;USDT\&quot;)}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Sending contract state to Thread 0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: ```  USER LOG: Oracle {oSymbol = 6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (ff,&quot;USDT&quot;)}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000001 {Contract instance for wallet 2}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;update&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1500000.0)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: W1: TxSubmit: 93fab1c0845a5b96863a50d248fa2de68bd6702185e3de92ae0c58b869569909</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00003: TxnValidate 93fab1c0845a5b96863a50d248fa2de68bd6702185e3de92ae0c58b869569909</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và, vị trí thứ 4, chúng ta thấy giá trị đầu tiên <code>getOracle</code> tìm thấy là 1.500.000.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00004: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00004: ```  CONTRACT LOG: &quot;set initial oracle value to 1500000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vị trí 6 là kết quả của tất cả các lần gọi <code>activateContractWallet</code>. Chúng không nhất thiết phải xuất hiện theo thứ tự như trong mã. Lưu ý rằng Ví 1 có ít Ada hơn một chút so với các ví khác. Điều này là do Ví 1 startOracle và cần phải trả phí giao dịch cho việc đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000002 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000003 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000004 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000005 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000006 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000007 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000008 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Contract instance started</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000006 {Contract instance for wallet 3}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;offer&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1.0e7)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: W3: TxSubmit: 8274315b83fb8b4d721146a75772cf39be3f96730557bd6021235864f0f37bc6</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: 00000000-0000-4000-8000-000000000007 {Contract instance for wallet 4}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;offer&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 2.0e7)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: W4: TxSubmit: 221f86cc1d6087a5967793aaf9eb078d8ec0677b2d6aca586f985f6f2c57a100</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: TxnValidate 221f86cc1d6087a5967793aaf9eb078d8ec0677b2d6aca586f985f6f2c57a100</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00006: TxnValidate 8274315b83fb8b4d721146a75772cf39be3f96730557bd6021235864f0f37bc6</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Slot 7, các ưu đãi của 10 Ada và 20 Ada được thực hiện.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;offered 10000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,89999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;offered 20000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,79999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,100000000),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00007: ```  CONTRACT LOG: &quot;Oracle value: 1500000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong vị trí 9, cái đầu tiên <code>use</code> được yêu cầu.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.Slot"><div tabindex="0" class="prism-code language-{.Slot codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Receive endpoint call: Object (fromList [(\&quot;tag\&quot;,String \&quot;use\&quot;),(\&quot;value\&quot;,Object (fromList [(\&quot;unEndpointValue\&quot;,Array [])]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;own funds: [(,\\\&quot;\\\&quot;,100000000),(ff,\\\&quot;USDT\\\&quot;,100000000)]\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;available assets: 100000000\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: ```  CONTRACT LOG: \&quot;found oracle, exchange rate 1500000\&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: W5: TxSubmit: 35d38def28dd6f5d016bee056e227501b97b2bb3ed2192e364242f01319e5e56</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00009: TxnValidate 35d38def28dd6f5d016bee056e227501b97b2bb3ed2192e364242f01319e5e56}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và ở vị trí số 10, chúng ta thấy sự hoán đổi xảy ra.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,99999970),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,89999990),(ff,\&quot;USDT\&quot;,100000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,79999990),(ff,\&quot;USDT\&quot;,130000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;made swap with price [(ff,\&quot;USDT\&quot;,30000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00010: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,118999990),(ff,\&quot;USDT\&quot;,70000000)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The oracle nhận và cập nhật yêu cầu trong slot 12.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;update&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Number 1700000.0)]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: W1: TxSubmit: ff7e1fbfb51897b100dcfdf551ad9a03886432af0a9fa92ff8dd986a0f7c90fe</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00012: TxnValidate ff7e1fbfb51897b100dcfdf551ad9a03886432af0a9fa92ff8dd986a0f7c90fe</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và chúng tôi thấy nó xảy ra ở vị trí số 13.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00013: ```  CONTRACT LOG: &quot;updated oracle value to 1700000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><div tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Thứ  nhì `use`  yêu cầu đến slot 15.</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">``` {.}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: 00000000-0000-4000-8000-000000000008 {Contract instance for wallet 5}:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;use&quot;),(&quot;value&quot;,Object (fromList [(&quot;unEndpointValue&quot;,Array [])]))])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;own funds: [(,\&quot;\&quot;,118999990),(ff,\&quot;USDT\&quot;,70000000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;available assets: 70000000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: ```  CONTRACT LOG: &quot;found oracle, exchange rate 1700000&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: W5: TxSubmit: 84bec9a9044eee9c5b40029dca5bbc8346214504e5adb4745bbe6e5d7d96078e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00015: TxnValidate 84bec9a9044eee9c5b40029dca5bbc8346214504e5adb4745bbe6e5d7d96078e</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và sự hoán đổi xảy ra ở vị trí 16.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Slot 00016: ```  CONTRACT LOG: &quot;made swap with price [(ff,\&quot;USDT\&quot;,17000000)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và ở dưới cùng, chúng tôi thấy số dư cuối cùng.</p><p>Ví 2 vẫn có tất cả tiền của nó. Tất cả những gì Ví 2 đã làm là kiểm tra bằng Oracle, không tốn bất kỳ chi phí nào, vì nó hoàn toàn là một vấn đề off-chain.</p><p>Ví 1 đã trả một số phí giao dịch nhưng kết thúc với số tiền cao hơn khoảng 2 Ada so với ban đầu. Điều này là do nó đã thu 2 Ada phí sử dụng oracle.</p><p>Ví 3 và 4 đều đưa ra đề nghị và số dư của chúng phản ánh tỷ giá hối đoái mà tại đó các đề nghị của chúng đã được chấp nhận.</p><p>Ví 5 là người chấp nhận các đề nghị và Ada bổ sung cũng vậy, nhưng số dư Mã thông báo USD bị giảm. Lưu ý rằng Ví 5 cũng đã bị khấu trừ một số khoản phí từ số dư Ada của nó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Final balances</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 1: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 101999950</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 2: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 3: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 117000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 89999990</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 4: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 130000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 79999990</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 5: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 127999980</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 53000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 6: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 7: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 8: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 9: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Wallet 10: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {, &quot;&quot;}: 100000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {ff, &quot;USDT&quot;}: 100000000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và cuối cùng, cũng như các ví, chúng ta thấy rằng oracle vẫn tiếp tục, và vẫn sở hữu NFT. Lưu ý rằng, trong nhật ký này, chúng tôi không thấy giá trị datum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Script cc6a43073dce46eebc7b309223904c7a8033ffab7d9b239cf013342d4c69a5d6: </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    {6122edd57c938cda24066f434da9aee55120b4eb362d4a1bd37547ef6e4a6cbb, &quot;&quot;}: 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="plutus-application-backend-pab"></a>Plutus Application Backend (PAB)<a class="hash-link" href="#plutus-application-backend-pab" title="Direct link to heading">#</a></h2><p>Ngoài ý tưởng về cách triển khai một oracle trong Plutus, không có gì chúng tôi đã làm trong bài giảng này cho đến nay là mới, ngoại trừ một vài hàm thư viện và kỹ thuật Haskell. Về nguyên tắc, chúng ta đã quen thuộc với cách trình xác thực được viết cho mã off-chain và cách hợp đồng được viết cho mã on-chain cũng như cách chúng ta có thể kiểm tra mã của mình với <code>EmulatorTrace</code>  monad.</p><p>Nhưng bây giờ chúng ta sẽ nói về một thứ mới - Plutus Application Backend (PAB), cho phép chúng ta lấy tất cả những thứ chúng ta đã làm và biến nó thành một tệp thực thi chạy các hợp đồng.</p><p>Nếu testnet hoặc mainnet có sẵn với sự hỗ trợ của Plutus, chúng tôi có thể triển khai một ứng dụng như vậy, nhưng hiện tại chúng tôi sẽ cần hài lòng với một blockchain mô phỏng. Tuy nhiên, quá trình biến mã thành một dApp thực tế giống như trên một blockchain thực.</p><p>Chúng ta cần thêm một mô-đun nhỏ nữa, về cơ bản chỉ là một định nghĩa kiểu. Nó rất nhỏ, chúng tôi có thể bao gồm toàn bộ nội dung tệp ở đây.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# LANGUAGE DeriveAnyClass     #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{-# LANGUAGE DeriveGeneric      #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">module Week06.Oracle.PAB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ( OracleContracts (..)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ) where</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Data.Aeson                (FromJSON, ToJSON)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Data.Text.Prettyprint.Doc (Pretty (..), viaShow)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           GHC.Generics              (Generic)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import           Ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">import qualified Week06.Oracle.Core        as Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data OracleContracts = Init | Oracle CurrencySymbol | Swap Oracle.Oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deriving (Eq, Ord, Show, Generic, FromJSON, ToJSON)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Pretty OracleContracts where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pretty = viaShow</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ý tưởng là nó sửa đổi các phiên bản hợp đồng mà chúng tôi muốn chạy. Chúng tôi có nhiều hợp đồng khác nhau và chúng tôi muốn có một kiểu dữ liệu trong đó mỗi giá trị của kiểu dữ liệu tương ứng với một liên hệ mà cuối cùng chúng tôi muốn chạy.</p><p>Phương thức khởi tạo <code>Init</code>  sẽ được sử dụng để thiết lập một môi trường nơi có sẵn Mã thông báo USD và nơi các ví có nguồn cung cấp ban đầu của chúng.</p><p>Hàm <code>Oracle</code> tạo tương ứng với <code>runOracle</code> hợp đồng sẽ bắt đầu <code>oracle</code> và cung cấp endpoint <code>update</code> , và tham số <code>CurrencySymbol</code>  sẽ được sử dụng cho Mã thông báo USD.</p><p>Cuối cùng, các Swap, tham số hóa bằng cách <code>Oracle</code> sẽ được sử dụng để chạy các hợp đồng hoán đổi, cung cấp thiết bị đầu cuối khác nhau như <code>offer</code> , <code>retrieve</code>, <code>use</code> và <code>funds</code>.</p><p>Chúng ta cần định nghĩa <code>OracleContracts</code>  trong một mô-đun riêng biệt vì chúng ta sẽ sử dụng nó cả từ PAB và cả từ giao diện người dùng.</p><p>Chúng ta sẽ xem xét tệp Cabal.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">plutus-pioneer-program-week06.cabal</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong đó, chúng tôi có các định nghĩa cho các tệp thực thi khác nhau.</p><p>Tập tin <code>oracle-pab</code>  thực thi sẽ thiết lập một ví mô phỏng, khởi tạo tất cả các hợp đồng và thiết lập một máy chủ web cho phép thế giới bên ngoài tương tác với các hợp đồng này.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable oracle-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: oracle-pab.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall -threaded</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       aeson</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , freer-extras</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , freer-simple</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-contract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pioneer-program-week06</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-use-cases</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Tệp <code>oracle-clientt</code> thực thi sẽ được chạy bởi nhà cung cấp oracle, do đó, tệp sẽ tương tác với hợp đồng <code>runOracle</code> . Nó cũng sẽ lấy tỷ giá hối đoái từ internet và đưa chúng vào hệ thống.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable oracle-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: oracle-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , bytestring</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , regex-tdfa ^&gt;= 1.3.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , req ^&gt;= 3.9.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, tệp có <code>swap-client</code>  thực thi sẽ được chạy bởi các khách hàng muốn sử dụng hợp đồng hoán đổi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">executable swap-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main-is: swap-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hs-source-dirs:      app</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ghc-options:         -Wall</span></div><div class="token-line" style="color:#393A34"><span class="token plain">build-depends:       aeson</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , base ^&gt;= 4.14.1.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , plutus-pioneer-program-week06</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , req ^&gt;= 3.9.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , text</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   , uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta sẽ lần lượt xem xét từng điều này.</p><p>Bạn có thể tìm thấy mã cho từng ứng dụng này trong thư mục <code>app</code> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">app/oracle-client.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app/oracle-pab.hs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app/swap-client.hs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-pab"></a>Oracle PAB<a class="hash-link" href="#oracle-pab" title="Direct link to heading">#</a></h3><p>Đầu tiên, một số bảng soạn sẵn để kết nối kiểu dữ liệu mà chúng ta vừa xác định - các trường hợp hợp đồng được sửa đổi - với các lược đồ và hợp đồng mà chúng ta đã xác định trước đó.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">handleOracleContracts ::</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ( Member (Error PABError) effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Member (LogMsg (PABMultiAgentMsg (Builtin OracleContracts))) effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    =&gt; ContractEffect (Builtin OracleContracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ~&gt; Eff effs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">handleOracleContracts = handleBuiltin getSchema getContract where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getSchema = \case</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Init     -&gt; endpointsToSchemas @Empty</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Oracle _ -&gt; endpointsToSchemas @(Oracle.OracleSchema .\\ BlockchainActions)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Swap _   -&gt; endpointsToSchemas @(Oracle.SwapSchema   .\\ BlockchainActions)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    getContract = \case</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Init        -&gt; SomeBuiltin   initContract</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Oracle cs   -&gt; SomeBuiltin $ Oracle.runOracle $ oracleParams cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Swap oracle -&gt; SomeBuiltin $ Oracle.swap oracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>Init</code>  sẽ không có bất kỳ schema nào ,vì vậy nó chỉ có <code>BlockChainActions</code>.
<code>Oracle</code>  sử dụng <code>OracleSchema</code>  và <code>Swap</code> sử dụng <code>SwapSchema</code>. Không có gì ngạc nhiên ở đó.</p><p><code>Init</code>  sẽ chạy <code>initContract</code>, mà chúng ta sẽ thấy trong giây lát.</p><p><code>Oracle</code>  sẽ chạy hợp đồng <code>runOracle</code> với <code>oracleParams</code> ký hiệu tiền tệ của USD Token và ví dụ định nghĩa oracleparams.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oracleParams :: CurrencySymbol -&gt; Oracle.OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">oracleParams cs = Oracle.OracleParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    { Oracle.opFees   = 1_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Oracle.opSymbol = cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    , Oracle.opToken  = usdt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>và cuối cùng <code>Swap</code>  sẽ chạy hợp đồng hoán đổi với một giá trị oracle.</p><p>Đây là một số bản copy/paste boilerplate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">handlers :: SimulatorEffectHandlers (Builtin OracleContracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">handlers =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Simulator.mkSimulatorHandlers @(Builtin OracleContracts) []</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $ interpret handleOracleContracts        </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và đây là hàm <code>initContract</code>  mà chúng tôi đã đề cập ngay trước đây.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">initContract :: Contract (Last CurrencySymbol) BlockchainActions Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">initContract = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ownPK &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cur   &lt;-</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mapError (pack . show)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Currency.forgeContract ownPK [(usdt, fromIntegral (length wallets) ` amount)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        :: Contract (Last CurrencySymbol) BlockchainActions Currency.CurrencyError Currency.OneShotCurrency)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let cs = Currency.currencySymbol cur</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        v  = Value.singleton cs usdt amount</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    forM_ wallets $ \w -&gt; do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        let pkh = pubKeyHash $ walletPubKey w</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (pkh /= ownPK) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            tx &lt;- submitTx $ mustPayToPubKey pkh v</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            awaitTxConfirmed $ txId tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tell $ Last $ Just cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    amount :: Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    amount = 100_000_000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>initContract</code>  đúc Tokens USD  phân phối chúng đến các ví, sau đó nó telllà biểu tượng tiền tệ cho Token USD .</p><p>Ví được mã hóa cứng trước đó trong mã. Số lượng ví và số token được trao cho chúng là hoàn toàn tùy ý.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">wallets :: [Wallet]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">wallets = [Wallet i | i &lt;- [1 .. 5]]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ chúng ta có thể nhìn vào mã PAB thực tế.</p><p>Lần đầu tiên, chúng ta thấy một hàm <code>main</code>  là điểm nhập của tệp thực thi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = void $ Simulator.runSimulationWith handlers $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Simulator.logString @(Builtin OracleContracts) &quot;Starting Oracle PAB webserver. Press enter to exit.&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    shutdown &lt;- PAB.Server.startServerDebug</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cidInit &lt;- Simulator.activateContract (Wallet 1) Init</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cs      &lt;- waitForLast cidInit</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _       &lt;- Simulator.waitUntilFinished cidInit</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    cidOracle &lt;- Simulator.activateContract (Wallet 1) $ Oracle cs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ writeFile &quot;oracle.cid&quot; $ show $ unContractInstanceId cidOracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    oracle &lt;- waitForLast cidOracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    forM_ wallets $ \w -&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (w /= Wallet 1) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            cid &lt;- Simulator.activateContract w $ Swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            liftIO $ writeFile (&#x27;W&#x27; : show (getWallet w) ++ &quot;.cid&quot;) $ show $ unContractInstanceId cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ liftIO getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    shutdown</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Các hàm <code>main</code>  sử dụng monad khác  mà chúng ta chưa từng thấy trước đây và là đặc trưng cho PAB  - Các <code>Simulator</code>  monad.</p><p>Cái <code>Simulator</code>  monad là rất giống với <code>EmulatorTrace</code>  monad. Về nguyên tắc nó có các khả năng như nhau. Bạn có thể bắt đầu các hợp đồng trên ví, bạn có thể kiểm tra trạng thái bằng cách sử dụng nhật ký, bạn có thể gọi các endpoint, v.v.</p><p>Có một chút đáng tiếc là có hai monads cho điều này vì chúng rất giống nhau. Nhóm Plutus có kế hoạch sắp xếp chúng và có thể biến chúng thành một. Vì vậy, nó có thể không đáng để tìm hiểu những điều phức tạp của <code>Simulator</code> monad vì nó có thể sẽ sớm thay đổi.</p><p>Tương tự như <code>runEmulatorTraceIO</code>,Chúng ta có <code>runSimulationWith</code>để pass qua <code>handlers</code>  boilerplate.</p><p>Tuy nhiên một sự khác biệt <code>EmulatorTrace</code> monad:
<code>EmulatorTrace</code>  monad là mã thuần túy - không có tác dụng phụ trong thế giới thực, không liên quan đến IO. Đặc biệt có một trình thông dịch thuần túy <code>runEmulatorTrace</code> là một hàm Haskell thuần túy không có tác dụng phụ.</p><p><code>Simulator</code> khác - bạn có thể làm IO. Cách nó hoạt động là đang sử dụng <code>MonadIO</code>, trong đó có một phương thức <code>liftIO</code>, thực hiện một hành động <code>IO</code>  và <code>lifts</code>  nó trở thành monad đề cập . Vì vậy, nếu bạn có một số hành động IO tùy ý mà bạn có thể thực hiện trong Haskell, thì bằng cách áp dụng <code>liftIO</code> cho nó, bạn có thể chuyển nó vào <code>Simulator</code>  monad.</p><p>Ngoài ra, nếu bạn nheo mắt, nó trông rất giống với một <code>EmulatorTrace</code>.</p><p>Điều đầu tiên chúng tôi làm là sử dụng <code>logString</code>  ể ghi lại rằng chúng tôi đang khởi động máy chủ PAB. Sau đó, chúng tôi gọi hàm <code>startServerDebug</code>, à giá trị trả về của hàm đó được liên kết với  <code>shutdown</code>  ó thể được sử dụng sau này để tắt máy chủ.</p><p>Bây giờ chúng tôi sử dụng một cái gì đó được gọi <code>activateContract</code>  là tương đương với <code>activateContractWallet</code>  từ <code>EmulatorTrace</code>  monad.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cidInit &lt;- Simulator.activateContract (Wallet 1) Init</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nó cần một ví mà chúng ta muốn bắt đầu phiên bản đó và sau đó là một giá trị của loại hợp đồng đã được sửa đổi. Hãy nhớ rằng chúng ta đã liên kết tạo hàm <code>Init</code>
với hàm <code>initContract</code> .</p><p>Bây giờ chúng ta cần ký hiệu tiền tệ. Đây là một ví dụ về cách chúng tôi lấy thông tin ra khỏi hợp đồng bằng cách sử dụng <code>tell</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cs &lt;- waitForLast cidInit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hàm <code>cidInit</code>  sử dụng một hàm từ monad <code>Simulator</code> được gọi là
<code>waitForState</code>, hàm này nhận một hợp đồng và một vị từ. Vị từ nhận một biểu thức JSON và trả về  <code>Maybe a</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">waitForLast :: FromJSON a =&gt; ContractInstanceId -&gt; Simulator.Simulation t a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">waitForLast cid =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    flip Simulator.waitForState cid $ \json -&gt; case fromJSON json of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Success (Last (Just x)) -&gt; Just x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        _                       -&gt; Nothing</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ý tưởng là nó sẽ đọc trạng thái của hợp đồng mà chúng tôi đã viết bằng cách sử dụng <code>tell</code>. Điều này được tuần tự hóa dưới dạng giá trị JSON và nó áp dụng giá trị JSON này cho vị từ (predicate) được cung cấp. Nếu kết quả là <code>Nothing</code>, nó chỉ cần đợi cho đến khi trạng thái thay đổi một lần nữa. Nhưng, nếu đúng như vậy <code>Just x</code> nó sẽ trả về <code>x</code>.</p><p>Có thể có hai cách <code>Nothing</code> - phân tích cú pháp JSON có thể không thành công hoặc chúng ta có thể nhận được <code>Last Nothing</code>. Vì vậy, kết quả cuối cùng là hàm đợi cho đến khi trạng thái của hợp đồng cho biết một giá trị <code>Just</code>.</p><p>Tại thời điểm này, chúng tôi có ký hiệu tiền tệ bị ràng buộc <code>cs</code>. Và sau đó chúng tôi chờ đợi cho đến khi <code>initContract</code> kết thúc.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">_ &lt;- Simulator.waitUntilFinished cidInit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bước tiếp theo là bắt đầu oracle trên Ví 1, sử dụng giá trị <code>cs</code>  mà chúng tôi đã thu được gần đây.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cidOracle &lt;- Simulator.activateContract (Wallet 1) $ Oracle cs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Để tương tác với hợp đồng oracle từ thế giới bên ngoài, ví dụ như từ giao diện web, chúng ta cần bắt tay vào xử lý <code>cidOracle</code> .</p><p>Vì vậy, những gì chúng tôi làm là ghi điều này vào một tệp có tên <code>oracle.cid</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">liftIO $ writeFile &quot;oracle.cid&quot; $ show $ unContractInstanceId cidOracle</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều này chỉ là nhanh chóng và không tốt để trình diễn. Trong mã sản xuất, bạn sẽ sử dụng một cơ chế an toàn hơn.</p><p>Bây giờ chúng tôi sử dụng <code>waitForLast</code> một lần nữa để nhận giá trị oracle, mà chúng tôi đã cung cấp từ hợp đồng <code>runOracle</code>  thông qua <code>tell</code>. Chúng ta cần điều này vì hợp đồng hoán đổi được tham số hóa bởi giá trị này.</p><p>Ở giai đoạn này, NFT được đúc và chúng ta biết giá trị oracle là gì.</p><p>Tiếp theo, chúng tôi lặp qua tất cả các ví, ngoại trừ ví 1 chạy oracle và chúng tôi kích hoạt hợp đồng hoán đổi trên mỗi ví. Ở đây chúng tôi sử dụng một phương pháp ghi tệp tương tự để nắm giữ các quy trình xử lý hợp đồng</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">forM_ wallets $ \w -&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    when (w /= Wallet 1) $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        cid &lt;- Simulator.activateContract w $ Swap oracle</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        liftIO $ writeFile (&#x27;W&#x27; : show (getWallet w) ++ &quot;.cid&quot;) $ show $ unContractInstanceId cid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ chúng tôi chỉ chặn cho đến khi người dùng nhấn enter, sau đó chúng tôi tắt máy chủ.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">void $ liftIO getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">shutdown</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Không thực sự cần thiết phải làm tất cả những điều này, vì bạn cũng có thể bắt đầu và dừng các phiên bản hợp đồng từ giao diện web. Ở đây, chúng tôi dễ dàng thực hiện điều đó hơn theo cách có kịch bản cho bản demo, nhưng về nguyên tắc, bạn chỉ có thể khởi động trình mô phỏng và sau đó đợi cho đến khi bạn tắt máy.</p><p>Nếu bạn tò mò về API do PAB cung cấp, bạn có thể kiểm tra điều đó trong gói <code>plutus-pab</code> , trong mô-đun <code>Plutus.PAB.Webserver.API</code>. Nhưng cái mà chúng tôi đang sử dụng ở đây là:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-- | PAB client API for contracts of type @t@. Examples of @t@ are</span></div><div class="token-line" style="color:#393A34"><span class="token plain">--   ` Contract executables that reside in the user&#x27;s file system</span></div><div class="token-line" style="color:#393A34"><span class="token plain">--   ` &quot;Builtin&quot; contracts that run in the same process as the PAB (ie. the PAB is compiled &amp; distributed with these contracts)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">type NewAPI t walletId -- see note [WalletID type in wallet API]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    = &quot;api&quot; :&gt; &quot;new&quot; :&gt; &quot;contract&quot; :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (&quot;activate&quot; :&gt; ReqBody &#x27;[ JSON] (ContractActivationArgs t) :&gt; Post &#x27;[JSON] ContractInstanceId -- start a new instance</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instance&quot; :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (Capture &quot;contract-instance-id&quot; Text :&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        ( &quot;status&quot; :&gt; Get &#x27;[JSON] (ContractInstanceClientState t) -- Current status of contract instance</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        :&lt;|&gt; &quot;endpoint&quot; :&gt; Capture &quot;endpoint-name&quot; String :&gt; ReqBody &#x27;[JSON] JSON.Value :&gt; Post &#x27;[JSON] () -- Call an endpoint. Make</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        :&lt;|&gt; &quot;stop&quot; :&gt; Put &#x27;[JSON] () -- Terminate the instance.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    )</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instances&quot; :&gt; &quot;wallet&quot; :&gt; Capture &quot;wallet-id&quot; walletId :&gt; Get &#x27;[JSON] [ContractInstanceClientState t]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;instances&quot; :&gt; Get &#x27;[ JSON] [ContractInstanceClientState t] -- list of all active contract instances</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            :&lt;|&gt; &quot;definitions&quot; :&gt; Get &#x27;[JSON] [ContractSignatureResponse t] -- list of available contracts</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Điều này làm cho việc sử dụng thư viện Haskell phổ biến <code>Servant</code> để viết các ứng dụng web an toàn, nhưng nó sẽ có thể đọc được ít nhiều mà không cần biết về thư viện <code>Servant</code> . Ví dụ: bạn có thể thấy endpoint <code>/api/new/contract/activate</code> được khai báo mà bạn có thể dùng <code>ContractActivationArgs</code> làm phần thân của nó và trả về một <code>ContractInstanceId</code>.</p><p>Ngoài ra còn có một API ổ cắm web, nhưng chúng tôi đã không sử dụng nó trong ví dụ này.</p><p>Vì vậy, hãy thử tệp thực thi của chúng tôi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-pab</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng tôi nhận được đầu ra nhật ký tương tự như những gì chúng tôi thấy với <code> EmulatorTrace</code> , nhưng đây bây giờ là một máy chủ trực tiếp.</p><p>Đầu ra bên dưới được giảm bớt để tránh đầy đủ chi tiết.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 0: TxnValidate af5e6d25b5ecb26185289a03d50786b7ac4425b21849143ed7e18bcd70dc4db8</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Starting Oracle PAB webserver. Press enter to exit.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Starting PAB backend server on port: 8080</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance dda39c83-5a0f-484f-b49a-9943b1ff5526 on W1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     Tx:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                       Tx da767478580878690990b3a22387be9c5b27fabed2c0ca7b9991eb682a6781f8:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         {inputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         outputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                           - Value (Map [(,Map [(&quot;&quot;,1)])]) addressed to</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                             addressed to ScriptCredential: e9827f1a9e43109d1c8d4555913734b8c48a467a31061b312959f270850fc8a0 (no staking credential)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         forge: Value (Map [])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         fee: Value (Map [(,Map [(&quot;&quot;,10)])])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         mps:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         validity range: Interval {ivFrom = LowerBound NegInf True, ivTo = UpperBound PosInf True}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         data:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                           &lt;&gt;}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     Requires signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1: TxnValidate b7d6ba18d02898aa5d0814a306e4a05cf153c199aabb175ef9b00328105ab98f</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 2: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 6: TxnValidate d690122263521c37f308a0d5ae858aa4807cb1e493c2a3374bf65b934c74782a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance deceaa52-f117-46bc-b0f1-eb1f2f529b5a on W1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 7: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 7: TxnValidate a679948d128735ec1f380e9f733d7f4a5e54c81f39c73a656d61b077111840e1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 8: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 8: TxnValidate f0125e685edd6de2d09f9547f53b18d1bad11bd7fad570a057ba74737ab3053e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] deceaa52-f117-46bc-b0f1-eb1f2f529b5a: &quot;started oracle Oracle {oSymbol = b8a1d67cd94acf75d7e00f27015ec5e31242adad0967eee473f49c5d1d686169, oOperator = 21fe31dfa154a261626bf854046fd2271b7bed4b6abe45aa58877ef47f9721b9, oFee = 1000000, oAsset = (9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;)}&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 5bac6e67-f956-45ef-b386-f1d045cf5e37 on W2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 2c3a2794-2592-4c2b-9a7d-9c810cedf886 on W3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 6f8d611d-a3f6-4794-9048-8ea3201e3c56 on W4</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance 387d9651-6024-48c1-a72d-5b3c6d3a6b53 on W5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ví dụ, chúng ta có thể thấy nơi chúng ta có thể tìm thấy ID phiên bản của các hợp đồng nếu chúng ta muốn tương tác với chúng thông qua API.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Activated instance deceaa52-f117-46bc-b0f1-eb1f2f529b5a on W1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Nếu bây giờ chúng ta dừng máy chủ và tìm trong thư mục, chúng ta sẽ thấy các tệp mà chúng ta đã lưu trữ các ID phiên bản.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[nix-shell:~/git/ada/pioneer-fork/code/week06]$ ls</span></div><div class="token-line" style="color:#393A34"><span class="token plain">app            dist-newstyle  LICENSE     plutus-pioneer-program-week06.cabal  W2.cid  W4.cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">cabal.project  hie.yaml       oracle.cid  src                                  W3.cid  W5.cid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[nix-shell:~/git/ada/pioneer-fork/code/week06]$ cat W5.cid </span></div><div class="token-line" style="color:#393A34"><span class="token plain">387d9651-6024-48c1-a72d-5b3c6d3a6b53</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Với thông tin này - thu được từ nhật ký máy chủ web hoặc từ các tệp chúng tôi đã tạo, chúng tôi có thể sử dụng bất kỳ công cụ HTTP nào như Curl hoặc Postman để tương tác với các hợp đồng khi máy chủ web đang chạy. Theo mặc định, nó chạy trên cổng 8080. Chúng tôi cũng có thể viết mã bằng bất kỳ ngôn ngữ lập trình nào mà chúng tôi muốn để tương tác với máy chủ web bằng cách sử dụng các endpoints HTTP.</p><p>Bây giờ chúng ta sẽ xem xét ngắn gọn về <code>oracle-client</code> và <code>swap-client</code>. Chúng tôi sẽ không đi vào quá nhiều chi tiết vì chúng tôi không quá quan tâm đến cách viết giao diện người dùng ở đây.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="oracle-client"></a>Oracle Client<a class="hash-link" href="#oracle-client" title="Direct link to heading">#</a></h3><p>Chúng tôi sử dụng thư viện Haskell <code>Req</code>  ể tương tác với máy chủ web.</p><p>Đầu tiên chúng tôi đọc tệp <code>oracle.cid</code>  để lấy ID phiên bản oracle. Sau đó, chúng ta có một hàm đệ quy <code>go</code>.</p><p>Hàm <code>go</code> tra cứu tỷ giá hối đoái hiện tại trên CoinMarketCap, kiểm tra xem điều đó đã thay đổi hay chưa, và nếu có thay đổi, nó sẽ gọi hàm <code>updateOracle</code> này gọi là <code>endpoint updateOracle</code> trên hợp đồng của chúng tôi. Và, cho dù thay đổi có được phát hiện hay không, nó sẽ đợi trong năm giây (tùy ý), rồi lại tiếp tục.</p><p>Thời gian trì hoãn sẽ phụ thuộc vào những điều như giới hạn tỷ lệ do CoinMarketCap áp đặt. Trên thực tế, vì các khối trên Cardano chỉ xuất hiện hai mươi giây một lần, nên năm giây có lẽ là quá ngắn.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    uuid &lt;- read &lt;$&gt; readFile &quot;oracle.cid&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    putStrLn $ &quot;oracle contract instance id: &quot; ++ show uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid Nothing</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: UUID -&gt; Maybe Integer -&gt; IO a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid m = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x &lt;- getExchangeRate</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        let y = Just x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        when (m /= y) $</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            updateOracle uuid x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        threadDelay 5_000_000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go uuid y</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Bây giờ, hàm <code>updateOracle</code>  chuẩn bị một yêu cầu POST bằng cách sử dụng ID phiên bản oracle và một phần thân JSON chứa tỷ giá hối đoái.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle :: UUID -&gt; Integer -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updateOracle uuid x = runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        POST</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;endpoint&quot; /: &quot;update&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (ReqBodyJson x)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Proxy :: Proxy (JsonResponse ()))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ putStrLn $ if responseStatusCode v == 200</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        then &quot;updated oracle to &quot; ++ show x</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else &quot;error updating oracle&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Vad đây là hàm <code>getExchangeRate</code> cái mà nhanh chóng và hiệu quả để nhận tỷ giá hối đoái từ CoinMarketCap. Họ cung cấp một API thích hợp, nhưng ở đây chúng tôi chỉ thực hiện một số thao tác quét màn hình từ trang web và sử dụng <code>regex</code> để trích xuất giá trị mà chúng tôi quan tâm. Tất nhiên, điều này rất mỏng manh và không bao giờ có thể được sử dụng làm mã sản xuất.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getExchangeRate :: IO Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getExchangeRate = runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        GET</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (https &quot;coinmarketcap.com&quot; /: &quot;currencies&quot; /: &quot;cardano&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        NoReqBody</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        bsResponse</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mempty</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let priceRegex      = &quot;priceValue___11gHJ\&quot;&gt;\\$([\\.0-9]`)&quot; :: ByteString</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (_, _, _, [bs]) = responseBody v =~ priceRegex :: (ByteString, ByteString, ByteString, [ByteString])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        d               = read $ unpack bs :: Double</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        x               = round $ 1_000_000 ` d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    liftIO $ putStrLn $ &quot;queried exchange rate: &quot; ++ show d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return x    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hãy để chúng tôi chạy nó.</p><p>Trước tiên, chúng ta cần đảm bảo rằng PAB đang chạy.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-pab </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau đó, trong một thiết bị đầu cuối khác (terminal)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run oracle-client</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.54</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updated oracle to 1540000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.54</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chúng ta có thể thấy tỷ giá hối đoái mà nó thu được từ CoinMarketCap và yêu cầu cập nhật oracle.</p><p>Và nếu chúng ta đợi đủ lâu, chúng ta sẽ thấy</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.55</span></div><div class="token-line" style="color:#393A34"><span class="token plain">updated oracle to 1550000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">queried exchange rate: 1.55</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và chúng tôi thấy rằng chúng tôi đang di chuyển.</p><p>Nếu bạn chuyển trở lại PAB, bạn cũng sẽ thấy các thông báo nhật ký bổ sung.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 16: W1: Balancing an unbalanced transaction:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Tx:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Tx c5b384f75f93ebc8f1e6b514237aa70d0d982e9b035eececa27af0b3e72568e4:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        {inputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        outputs:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        - Value (Map [(b8a1d67cd94acf75d7e00f27015ec5e31242adad0967eee473f49c5d1d686169,Map [(&quot;&quot;,1)])]) addressed to</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            addressed to ScriptCredential: 04a718132f7ca493a011c40926e191a76bd84cbf8e7c14b6c99bbea8b8bc0bba (no staking credential)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        forge: Value (Map [])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        fee: Value (Map [(,Map [(&quot;&quot;,10)])])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        mps:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        validity range: Interval {ivFrom = LowerBound NegInf True, ivTo = UpperBound PosInf True}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        data:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        1540000}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Requires signatures:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 16: TxnValidate 40c5dbb5e7c8de390a6943d8f0a84d218cf86dd81af1fd7cfc62612e6b616c2c</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 5d9d778e-55f9-45ab-89a6-2ba9aa18045e: &quot;set initial oracle value to 1540000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="swap-client"></a>Swap Client<a class="hash-link" href="#swap-client" title="Direct link to heading">#</a></h3><p>The swap client rất đơn giản.</p><p>Ở đây, chúng tôi chỉ đưa ra một giao diện bảng điều khiển đơn giản, vì vậy chúng tôi không bận tâm đến đồ họa hoặc giao diện người dùng web.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">main = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [i :: Int] &lt;- map read &lt;$&gt; getArgs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    uuid       &lt;- read &lt;$&gt; readFile (&#x27;W&#x27; : show i ++ &quot;.cid&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    hSetBuffering stdout NoBuffering</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    putStrLn $ &quot;swap contract instance id for Wallet &quot; ++ show i ++ &quot;: &quot; ++ show uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go :: UUID -&gt; IO a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    go uuid = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        cmd &lt;- readCommand</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        case cmd of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Offer amt -&gt; offer uuid amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Retrieve  -&gt; retrieve uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Use       -&gt; use uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Funds     -&gt; getFunds uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        go uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    readCommand :: IO Command</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    readCommand = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        putStr &quot;enter command (Offer amt, Retrieve, Use or Funds): &quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        s &lt;- getLine</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        maybe readCommand return $ readMaybe s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ý tưởng là lấy một lệnh từ bảng điều khiển và gọi endpoint thích hợp. .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">case cmd of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Offer amt -&gt; offer uuid amt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Retrieve  -&gt; retrieve uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Use       -&gt; use uuid</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    Funds     -&gt; getFunds uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Việc gọi endpoint sử dụng cùng một phương thức cho mỗi endpoint, tạo ra một cuộc gọi HTTP giống như cách mà chúng tôi đã làm cho ứng dụng  Oracle Client.</p><p>Các hàm <code>getFunds</code> hơi phức tạp hơn so với ba hàm kia vì nó cần để có được thông tin từ máy chủ. Đối với điều này, nó cần phải thực hiện hai yêu cầu. Yêu cầu thứ hai là đọc trạng thái <code>told</code> của lần gọi đầu tiên.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">getFunds :: UUID -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">getFunds uuid = handle h $ runReq defaultHttpConfig $ do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    v &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        POST</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;endpoint&quot; /: &quot;funds&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (ReqBodyJson ())</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (Proxy :: Proxy (JsonResponse ()))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    if responseStatusCode v /= 200</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        then liftIO $ putStrLn &quot;error getting funds&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            w &lt;- req</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                GET</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (http &quot;127.0.0.1&quot; /: &quot;api&quot;  /: &quot;new&quot; /: &quot;contract&quot; /: &quot;instance&quot; /: pack (show uuid) /: &quot;status&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                NoReqBody</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (Proxy :: Proxy (JsonResponse (ContractInstanceClientState OracleContracts)))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (port 8080)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            liftIO $ putStrLn $ case fromJSON $ observableState $ cicCurrentState $ responseBody w of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Success (Last (Just f)) -&gt; &quot;funds: &quot; ++ show (flattenValue f)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                _                       -&gt; &quot;error decoding state&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h :: HttpException -&gt; IO ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    h _ = threadDelay 1_000_000 &gt;&gt; getFunds uuid</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hãy chạy ứng dụng Swap client. Chúng tôi sẽ để máy chủ web và ứng dụng oracle client đang chạy.</p><p>Khi sử dụng cabal, chúng ta truyền các tham số như sau <code>--</code>. Đối với ứng dụng oracle client, chúng tôi chuyển số ví vào làm tham số.</p><p>Chúng tôi sẽ khởi chạy ứng dụng Swap client cho ví 2 và 3, mỗi ví trong một cửa sổ riêng biệt và truy vấn số tiền tương ứng của chúng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run swap-client -- 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap contract instance id for Wallet 2: ab65f248-450d-4988-ab2a-651ad5697596</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">cabal run swap-client -- 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">swap contract instance id for Wallet 3: 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Ví 2 hiện cung cấp 10 Ada dưới dạng hoán đổi và chúng tôi kiểm tra tiền và chúng tôi thấy rằng số dư Ada đã giảm xuống (bằng 10 Ada cộng với phí giao dịch), nhưng số dư Mã thông báo USD vẫn giữ nguyên.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Offer 10000000</span></div><div class="token-line" style="color:#393A34"><span class="token plain">offered swap of 10000000 lovelace</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,89999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Trong khi các lệnh này đang chạy, bạn cũng có thể thấy các lệnh gọi đang được thực hiện trong đầu ra PAB.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">INFO] Slot 1662: TxnValidate 17f640f03e4dc7d0a4c246129454aa19daa8d9d674bfebeeee486d6143c6648e</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] ab65f248-450d-4988-ab2a-651ad5697596: &quot;offered 10000000 lovelace for swap&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] ab65f248-450d-4988-ab2a-651ad5697596: &quot;own funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,100000000),(,\&quot;\&quot;,89999990)]&quot;    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, Wallet 3 is going to take up the offer of the swap.
Bây giờ, Wallet 3 sẽ nhận offer của hoán đổi.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Use</span></div><div class="token-line" style="color:#393A34"><span class="token plain">used swap</span></div><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,100000000),(,&quot;&quot;,100000000)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sẽ mất một chút thời gian để cập nhật tiền, vì vậy hãy thử lại lệnh <code>Funds</code> </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,84400000),(,&quot;&quot;,108999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Cái đó tốt hơn. Và chúng ta có thể thấy rằng ví 3 đã nhận được 10 Ada, trừ đi phí oracle của 1 Ada và trừ đi phí giao dịch.</p><p>Trong đầu ra PAB, chúng tôi thấy một cái gì đó như</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] Slot 1868: TxnValidate 00afd25af063d58b4f290e43057f4738483098f26ff0134bc14c9d54b9b94090</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2: &quot;made swap with price [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,15600000)]&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">[INFO] 2dc4f6f2-142e-40a2-a1b8-c431eb29a3a2: &quot;own funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,\&quot;USDT\&quot;,84400000),(,\&quot;\&quot;,108999990)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Hãy xem xét quỹ của ví 2.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">enter command (Offer amt, Retrieve, Use or Funds): Funds</span></div><div class="token-line" style="color:#393A34"><span class="token plain">funds: [(9a91216e55e5369b926acc07c70a11d9ae7fef454e43e3e5c0aa1733f48c798a,&quot;USDT&quot;,115600000),(,&quot;&quot;,89999990)]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Và chúng tôi thấy rằng ví 2 đã mất một số Ada, nhưng đã thu được một số Token USD. Việc hoán đổi đã hoàn tất, sử dụng tỷ giá hối đoái đang diễn ra, ngay bây giờ, đã được đưa vào blockchain giả thông qua oracle.</p><p>Vì vậy, bây giờ chúng ta đã thấy một ví dụ end-to-end của Plutus dApp. Nó có giao diện người dùng, nó nói chuyện với thế giới bên ngoài, truy cập internet, lấy thông tin và tương tác với các hợp đồng thông minh của Plutus. Các hợp đồng thông minh gửi các giao dịch tới blockchain nơi logic xác thực bắt đầu và đảm bảo rằng mọi thứ tuân theo các quy tắc kinh doanh.</p><p>Trong ví dụ này, vì chúng ta không có blockchain thực để chơi cùng, nên tất cả các ví đều sử dụng cùng một máy chủ PAB, tất nhiên, trong cuộc sống thực sẽ là ngớ ngẩn. Rõ ràng, các ví khác nhau sẽ có các phiên bản PAB chạy khác nhau.</p><p>Nhưng, ngoài điều đó ra, nó gần như chính xác là end-to-end, cách một hệ thống như vậy sẽ hoạt động.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/cardano2vn/cardanovn-portal/edit/main/docs/dr-lars-lession/week6.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tổng-quat" class="table-of-contents__link">Tổng quat</a><ul><li><a href="#bản-tóm-tắt" class="table-of-contents__link">Bản tóm tắt</a></li></ul></li><li><a href="#oracle-core" class="table-of-contents__link">Oracle Core</a><ul><li><a href="#on-chain" class="table-of-contents__link">On-chain</a></li></ul></li><li><a href="#chú-ý" class="table-of-contents__link">Chú ý</a><ul><li><a href="#off-chain" class="table-of-contents__link">Off-chain</a></li></ul></li><li><a href="#xác-thực-hoán-đổiswap-validation" class="table-of-contents__link">Xác thực hoán đổi(Swap Validation)</a><ul><li><a href="#chào-hàng-offerswap" class="table-of-contents__link">Chào hàng (offerSwap)</a></li><li><a href="#findswaps" class="table-of-contents__link">findSwaps</a></li><li><a href="#lấy-lại-hoán-đổi-retrieveswaps" class="table-of-contents__link">lấy lại Hoán đổi (retrieveSwaps)</a></li><li><a href="#useswaps" class="table-of-contents__link">useSwaps</a></li><li><a href="#gói-hợp-đồng-contract-bundle" class="table-of-contents__link">Gói hợp đồng (Contract bundle)</a></li></ul></li><li><a href="#funds-module" class="table-of-contents__link">Funds Module</a></li><li><a href="#testing" class="table-of-contents__link">Testing</a><ul><li><a href="#test-in-the-repl" class="table-of-contents__link">Test in the REPL</a></li></ul></li><li><a href="#plutus-application-backend-pab" class="table-of-contents__link">Plutus Application Backend (PAB)</a><ul><li><a href="#oracle-pab" class="table-of-contents__link">Oracle PAB</a></li><li><a href="#oracle-client" class="table-of-contents__link">Oracle Client</a></li><li><a href="#swap-client" class="table-of-contents__link">Swap Client</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Tài liệu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/overview">Bắt đầu</a></li></ul></div><div class="col footer__col"><div class="footer__title">Cộng đồng</div><ul class="footer__items"><li class="footer__item"><a href="https://t.me/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCJTdAQPGJntJet5v-nk9ebA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about-us">About Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">The content of this site is referenced and copied from the <a href="https://developers.cardano.org/" target="_blank" rel="noopener noreferrer">Cardano Developer</a>, 2021</div></div></div></footer></div>
<script src="/assets/js/runtime~main.af40557b.js"></script>
<script src="/assets/js/main.97b62b7d.js"></script>
</body>
</html>