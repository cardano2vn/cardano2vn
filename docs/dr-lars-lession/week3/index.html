<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Cardano2vn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Cardano2vn Blog Atom Feed"><title data-react-helmet="true">Week 03 - Script Context | Cardano2vn</title><meta data-react-helmet="true" property="og:url" content="https://cardano2vn.io/docs/dr-lars-lession/week3"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Week 03 - Script Context | Cardano2vn"><meta data-react-helmet="true" name="description" content="Note"><meta data-react-helmet="true" property="og:description" content="Note"><link data-react-helmet="true" rel="shortcut icon" href="/img/2.png"><link data-react-helmet="true" rel="canonical" href="https://cardano2vn.io/docs/dr-lars-lession/week3"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week3" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cardano2vn.io/docs/dr-lars-lession/week3" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8b54419c.css">
<link rel="preload" href="/assets/js/runtime~main.00983322.js" as="script">
<link rel="preload" href="/assets/js/main.349a1baa.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/2.png" alt="Cardano2vn Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Cardano2vn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><div class="docSidebarContainer_0YBq" role="complementary"><div class="sidebar_a3j0"><div class="menu menu--responsive thin-scrollbar menu_cyFh"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/overview">Tá»•ng quan</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Táº¡o Há»£p Ä‘á»“ng thÃ´ng minh</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/smart-contracts/overview">Tá»•ng quan</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/smart-contracts/marlowe">Marlowe</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/smart-contracts/plutus">Plutus</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">TÃ­ch há»£p vá»›i Cardano</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/creating-wallet-faucet">Tao Wallet Faucet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/multi-witness-transactions-cli">Multi witness transaction cli</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/listening-for-payments-cli">Listening for payment cli</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/listening-for-payments-wallet">Listening for payment wallets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/integrate-cardano/testnet-faucet">Testnet faucet</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Váº­n hÃ nh má»™t Stake Pool</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/operate-a-stake-pool/overview">Tá»•ng quan</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">KhoÃ¡ Ä‘Ã o táº¡o Plutus cá»§a Dr. Lars</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/dr-lars-lession/overview">Plutus Pioneer Program</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/dr-lars-lession/week1">Week 01 - English Auction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/dr-lars-lession/week2">Week 02 - Validation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/dr-lars-lession/week3">Week 03 - Script Context</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/dr-lars-lession/week4">Week 04 - Monads</a></li></ul></li></ul></div></div></div><main class="docMainContainer_r8cw"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">Week 03 - Script Context</h1></header><div class="markdown"><p>::: {.note}
::: {.title}
Note
:::</p><p>ÄÃ¢y lÃ  phiÃªn báº£n Ä‘Ã£ dá»‹ch cá»§a <a href="https://youtu.be/WG3uw-TkW2k" target="_blank" rel="noopener noreferrer">BÃ i giáº£ng sá»‘ 3 Dr. Lars</a>.</p><p>Trong bÃ i giáº£ng nÃ y, chÃºng ta tÃ¬m hiá»ƒu vá» context script (Ä‘á»‘i sá»‘ xÃ¡c thá»±c thá»© ba), thá»i gian xá»­ lÃ½ vÃ  cÃ¡c há»£p Ä‘á»“ng Ä‘Æ°á»£c tham sá»‘ hÃ³a.</p><p>Äoáº¡n mÃ£ trong bÃ i giáº£ng nÃ y sá»­ dá»¥ng Plutus commit lÃ  <code>81ba78edb1d634a13371397d8c8b19829345ce0d</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="trÆ°á»›c-khi-chÃºng-ta-báº¯t-Ä‘áº§u"></a>TrÆ°á»›c khi chÃºng ta báº¯t Ä‘áº§u<a class="hash-link" href="#trÆ°á»›c-khi-chÃºng-ta-báº¯t-Ä‘áº§u" title="Direct link to heading">#</a></h2><p>Ká»ƒ tá»« bÃ i giáº£ng cuá»‘i cÃ¹ng Ä‘Ã£ cÃ³ má»™t báº£n cáº­p nháº­t cho sÃ¢n chÆ¡i, cÃ³ trong báº£n cam káº¿t Plutus mÃ  chÃºng tÃ´i Ä‘ang sá»­ dá»¥ng cho bÃ i giáº£ng nÃ y (xem ghi chÃº á»Ÿ trÃªn).</p><p>ÄÃ£ xáº£y ra sá»± cá»‘ khi thá»i gian chá» Ä‘Æ°á»£c mÃ£ hÃ³a cá»©ng vÃ o sÃ¢n chÆ¡i quÃ¡ ngáº¯n. Äiá»u nÃ y sáº½ khiáº¿n mÃ´ phá»ng khÃ´ng thÃ nh cÃ´ng náº¿u chÃºng máº¥t nhiá»u thá»i gian hÆ¡n thá»i gian chá» mÃ£ cá»©ng.</p><p>BÃ¢y giá» cÃ³ má»™t tÃ¹y chá»n khi báº¡n khá»Ÿi Ä‘á»™ng MÃ¡y chá»§ sÃ¢n chÆ¡i Plutus cho phÃ©p báº¡n chá»‰ Ä‘á»‹nh thá»i gian chá». VÃ­ dá»¥ sau Ä‘áº·t thá»i gian chá» thÃ nh 120 giÃ¢y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.}"><div tabindex="0" class="prism-code language-{.} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">plutus-playground-server -i 120s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="tÃ³m-táº¯t-láº¡i"></a>TÃ³m táº¯t láº¡i<a class="hash-link" href="#tÃ³m-táº¯t-láº¡i" title="Direct link to heading">#</a></h2><p>Khi chÃºng tÃ´i Ä‘Ã£ giáº£i thÃ­ch (E) UTxO mÃ´ hÃ¬nh trong bÃ i giáº£ng Ä‘áº§u tiÃªn, chÃºng tÃ´i Ä‘á» cáº­p ráº±ng Ä‘á»ƒ má»Ÿ khÃ³a má»™t Ä‘á»‹a chá»‰ ká»‹ch báº£n, ká»‹ch báº£n gáº¯n liá»n vá»›i Ä‘á»‹a chá»‰ Ä‘Æ°á»£c cháº¡y, vÃ  ká»‹ch báº£n mÃ  Ä‘Æ°á»£c ba máº©u thÃ´ng tin -
<em>datum</em>,  <em>redeemer</em> vÃ  <em>context</em>.</p><p>Trong bÃ i giáº£ng thá»© hai, chÃºng ta Ä‘Ã£ xem cÃ¡c vÃ­ dá»¥ vá» Ä‘iá»u Ä‘Ã³ vÃ  chÃºng ta Ä‘Ã£ tháº¥y nÃ³ thá»±c sá»± hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o trong Haskell.</p><p>ChÃºng tÃ´i Ä‘Ã£ tháº¥y viá»‡c triá»ƒn khai cáº¥p tháº¥p, trong Ä‘Ã³ cáº£ ba Ä‘á»‘i sá»‘ Ä‘á»u Ä‘Æ°á»£c biá»ƒu thá»‹ báº±ng kiá»ƒu <code>Data</code>. ChÃºng tÃ´i cÅ©ng tháº¥y ráº±ng trong thá»±c táº¿ Ä‘iá»u nÃ y khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng.</p><p>Thay vÃ o Ä‘Ã³, chÃºng tÃ´i sá»­ dá»¥ng phiÃªn báº£n Ä‘Ã£ nháº­p, trong Ä‘Ã³ dá»¯ liá»‡u vÃ  cÃ´ng cá»¥ Ä‘á»•i cÃ³ thá»ƒ lÃ  kiá»ƒu tÃ¹y chá»‰nh (miá»…n lÃ  chÃºng triá»ƒn khai lá»›p kiá»ƒu <code>IsData</code>) vÃ  trong Ä‘Ã³ Ä‘á»‘i sá»‘ thá»© ba lÃ  kiá»ƒu <code>ScriptContext</code>.</p><p>Trong cÃ¡c vÃ­ dá»¥ mÃ  chÃºng tÃ´i Ä‘Ã£ tháº¥y cho Ä‘áº¿n nay, chÃºng tÃ´i Ä‘Ã£ xem xÃ©t dá»¯ liá»‡u vÃ  cÃ´ng cá»¥ Ä‘á»•i, nhÆ°ng chÃºng tÃ´i luÃ´n bá» qua ngá»¯ cáº£nh. NhÆ°ng bá»‘i cáº£nh, táº¥t nhiÃªn, ráº¥t quan trá»ng. VÃ¬ váº­y, trong bÃ i giáº£ng nÃ y, chÃºng ta sáº½ báº¯t Ä‘áº§u xem xÃ©t context.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="scriptcontext"></a>ScriptContext<a class="hash-link" href="#scriptcontext" title="Direct link to heading">#</a></h2><p><code>ScriptContext</code> Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong gÃ³i <code>plutus-ledger-api</code>, mÃ  lÃ  má»™t gÃ³i pháº§n má»m Ä‘Ã³, cho Ä‘áº¿n bÃ¢y giá», chÃºng tÃ´i Ä‘Ã£ khÃ´ng cáº§n thiáº¿t. NhÆ°ng bÃ¢y giá» chÃºng tÃ´i cáº§n nÃ³, vÃ  nÃ³ Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ°a vÃ o files <code>.cabal</code> cá»§a tuáº§n nÃ y . NÃ³ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong mÃ´-Ä‘un <code>Plutus.V1.Ledger.Contexts</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data ScriptContext = ScriptContext { </span></div><div class="token-line" style="color:#393A34"><span class="token plain">            scriptContextTxInfo :: TxInfo, </span></div><div class="token-line" style="color:#393A34"><span class="token plain">            scriptContextPurpose :: ScriptPurpose </span></div><div class="token-line" style="color:#393A34"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NÃ³ lÃ  má»™t loáº¡i báº£n ghi cÃ³ hai trÆ°á»ng.</p><p>TrÆ°á»ng thá»© hai thuá»™c loáº¡i <code>ScriptPurpose</code>, Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trong cÃ¹ng má»™t mÃ´-Ä‘un. NÃ³ xÃ¡c Ä‘á»‹nh má»¥c Ä‘Ã­ch mÃ  má»™t táº­p lá»‡nh Ä‘ang Ä‘Æ°á»£c cháº¡y.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data ScriptPurpose</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   = Minting CurrencySymbol</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   | Spending TxOutRef</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   | Rewarding StakingCredential</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   | Certifying DCert</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Äá»‘i vá»›i chÃºng tÃ´i, quan trá»ng nháº¥t lÃ  <code>Spending</code>. ÄÃ¢y lÃ  nhá»¯ng gÃ¬ chÃºng ta Ä‘Ã£ nÃ³i cho Ä‘áº¿n nay trong context cá»§a mÃ´ hÃ¬nh (E) UTxO. ÄÃ¢y lÃ  khi má»™t táº­p lá»‡nh Ä‘Æ°á»£c cháº¡y Ä‘á»ƒ xÃ¡c thá»±c Ä‘áº§u vÃ o chi tiÃªu cho má»™t giao dá»‹ch.</p><p>CÃ¡c <code>Minting</code> dÃ¹ng khi báº¡n muá»‘n Ä‘á»‹nh nghÄ©a má»™t token gá»‘c. Má»¥c Ä‘Ã­ch cá»§a nÃ³ lÃ  chÃºng tÃ´i mÃ´ táº£ trong nhá»¯ng trÆ°á»ng há»£p nÃ o token gá»‘c cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Ãºc hoáº·c Ä‘á»‘t.</p><p>NgoÃ i ra cÃ²n cÃ³ hai má»¥c Ä‘Ã­ch hoÃ n toÃ n má»›i -<code>Rewarding</code>-  liÃªn quan Ä‘áº¿n Ä‘áº·t cÆ°á»£c vÃ  <em><code>Certifying</code></em>  liÃªn quan Ä‘áº¿n á»§y quyá»n cá»• pháº§n.</p><p>TrÆ°á»ng thÃº vá»‹ nháº¥t, trÆ°á»ng chá»©a ngá»¯ cáº£nh thá»±c táº¿ <code>scriptContextTxInfo</code> lÃ  trÆ°á»ng thuá»™c loáº¡i <code>TxInfo</code>, cÅ©ng Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trong cÃ¹ng má»™t mÃ´-Ä‘un.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data TxInfo = TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   { txInfoInputs      :: [TxInInfo] -- ^ Transaction inputs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoOutputs     :: [TxOut] -- ^ Transaction outputs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoFee         :: Value -- ^ The fee paid by this transaction.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoForge       :: Value -- ^ The &#x27;Value&#x27; forged by this transaction.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoDCert       :: [DCert] -- ^ Digests of certificates included in this transaction</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoWdrl        :: [(StakingCredential, Integer)] -- ^ Withdrawals</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoValidRange  :: SlotRange -- ^ The valid range for the transaction.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoSignatories :: [PubKeyHash] -- ^ Signatures provided with the transaction, attested that they all signed the tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoData        :: [(DatumHash, Datum)]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , txInfoId          :: TxId</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   -- ^ Hash of the pending transaction (excluding witnesses)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   } deriving (Generic)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NÃ³ mÃ´ táº£ giao dá»‹ch chi tiÃªu. Trong mÃ´ hÃ¬nh (E) UTxO, bá»‘i cáº£nh xÃ¡c thá»±c lÃ  giao dá»‹ch chi tiÃªu vÃ  cÃ¡c Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra cá»§a nÃ³. Bá»‘i cáº£nh nÃ y Ä‘Æ°á»£c thá»ƒ hiá»‡n trong <code>TxInfo</code>.</p><p>CÃ³ má»™t sá»‘ trÆ°á»ng lÃ  toÃ n cáº§u cho toÃ n bá»™ giao dá»‹ch vÃ  cá»¥ thá»ƒ lÃ  chÃºng tÃ´i cÃ³ danh sÃ¡ch táº¥t cáº£ cÃ¡c Ä‘áº§u vÃ o <code>txInfoInputs</code> vÃ  danh sÃ¡ch táº¥t cáº£ cÃ¡c Ä‘áº§u ra <code>txInfoOutputs</code>. Má»—i ngÆ°á»i trong sá»‘ há» cÃ³ nhiá»u lÄ©nh vá»±c khÃ¡c nhau Ä‘á»ƒ Ä‘i sÃ¢u vÃ o tá»«ng Ä‘áº§u vÃ o hoáº·c Ä‘áº§u ra riÃªng láº».</p><p>ChÃºng tÃ´i cÅ©ng tháº¥y cÃ¡c trÆ°á»ng vá» phÃ­ <code>txFee</code>, giÃ¡ trá»‹ giáº£ máº¡o <code>txInfoForge</code>, Ä‘Æ°á»£c sá»­ dá»¥ng khi Ä‘Ãºc hoáº·c Ä‘á»‘t cÃ¡c token gá»‘c.</p><p>Sau Ä‘Ã³, chÃºng tÃ´i cÃ³ má»™t danh sÃ¡ch cÃ¡c chá»©ng chá»‰ á»§y quyá»n trong <code>txInfoDCert</code> vÃ  má»™t trÆ°á»ng <code>txInfoWdrl</code> Ä‘á»ƒ náº¯m giá»¯ thÃ´ng tin vá» viá»‡c rÃºt tiá»n Ä‘áº·t cÆ°á»£c.</p><p>TrÆ°á»ng <code>txInfoValidRange</code> mÃ  chÃºng ta sáº½ xem xÃ©t chi tiáº¿t hÆ¡n trong giÃ¢y lÃ¡t, xÃ¡c Ä‘á»‹nh pháº¡m vi vá»‹ trÃ­ mÃ  giao dá»‹ch nÃ y há»£p lá»‡.</p><p><code>txInfoSignatories</code> lÃ  danh sÃ¡ch cÃ¡c khÃ³a cÃ´ng khai Ä‘Ã£ kÃ½ káº¿t giao dá»‹ch nÃ y.</p><p>CÃ¡c giao dá»‹ch sá»­ dá»¥ng Ä‘áº§u ra táº­p lá»‡nh cáº§n pháº£i bao gá»“m dá»¯ liá»‡u cá»§a Ä‘áº§u ra táº­p lá»‡nh. CÃ¡c <code>txInfoData</code> lÄ©nh vá»±c lÃ  má»™t danh sÃ¡ch liÃªn káº¿t datums vá»›i bÄƒm tÆ°Æ¡ng á»©ng cá»§a há». Náº¿u cÃ³ má»™t Ä‘áº§u ra giao dá»‹ch tá»›i má»™t Ä‘á»‹a chá»‰ táº­p lá»‡nh mang má»™t sá»‘ dá»¯ liá»‡u nÃ o Ä‘Ã³, báº¡n khÃ´ng cáº§n pháº£i bao gá»“m dá»¯ liá»‡u Ä‘Ã³, báº¡n chá»‰ cÃ³ thá»ƒ bao gá»“m bÄƒm dá»¯ liá»‡u. Tuy nhiÃªn, cÃ¡c táº­p lá»‡nh sá»­ dá»¥ng má»™t Ä‘áº§u ra cáº§n pháº£i bao gá»“m dá»¯ liá»‡u, trong trÆ°á»ng há»£p Ä‘Ã³, nÃ³ sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o danh sÃ¡ch <code>txInfoData</code> .</p><p>Cuá»‘i cÃ¹ng, trÆ°á»ng <code>txInfoId</code> lÃ  ID cá»§a giao dá»‹ch nÃ y.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="txinfovalidrange"></a>txInfoValidRange<a class="hash-link" href="#txinfovalidrange" title="Direct link to heading">#</a></h3><p>Máº·c dÃ¹ cÃ³ ráº¥t nhiá»u thÃ´ng tin chá»©a trong kiá»ƒu <code>txInfo</code>, nhÆ°ng Ä‘á»‘i vá»›i vÃ­ dá»¥ Ä‘áº§u tiÃªn cá»§a chÃºng tÃ´i vá» cÃ¡ch sá»­ dá»¥ng Ä‘á»‘i sá»‘ thá»© ba Ä‘á»ƒ xÃ¡c thá»±c, chÃºng tÃ´i sáº½ táº­p trung vÃ o trÆ°á»ng <code>txInfoValidRange</code> nÃ y.</p><p>Äiá»u nÃ y Ä‘Æ°a chÃºng ta Ä‘áº¿n má»™t tÃ¬nh huá»‘ng khÃ³ xá»­ thÃº vá»‹. ChÃºng tÃ´i Ä‘Ã£ nháº¥n máº¡nh nhiá»u láº§n ráº±ng lá»£i tháº¿ lá»›n mÃ  Cardano cÃ³ so vá»›i má»™t thá»© nhÆ° Ethereum lÃ  viá»‡c xÃ¡c thá»±c cÃ³ thá»ƒ xáº£y ra trong vÃ­. NhÆ°ng chÃºng tÃ´i cÅ©ng Ä‘Ã£ lÆ°u Ã½ ráº±ng má»™t giao dá»‹ch váº«n cÃ³ thá»ƒ khÃ´ng thÃ nh cÃ´ng on-chain sau khi xÃ¡c thá»±c, náº¿u khi giao dá»‹ch trÃªn blockchain, nÃ³ Ä‘Ã£ bá»‹ ngÆ°á»i khÃ¡c sá»­ dá»¥ng. Trong trÆ°á»ng há»£p nÃ y, giao dá»‹ch khÃ´ng thÃ nh cÃ´ng mÃ  khÃ´ng pháº£i tráº£ phÃ­.</p><p>Äiá»u khÃ´ng bao giá» nÃªn xáº£y ra trong cÃ¡c trÆ°á»ng há»£p bÃ¬nh thÆ°á»ng lÃ  má»™t táº­p lá»‡nh xÃ¡c thá»±c cháº¡y vÃ  sau Ä‘Ã³ khÃ´ng thÃ nh cÃ´ng. Äiá»u nÃ y lÃ  do báº¡n luÃ´n cÃ³ thá»ƒ cháº¡y xÃ¡c thá»±c trong cÃ¹ng má»™t Ä‘iá»u kiá»‡n trong vÃ­, vÃ¬ váº­y nÃ³ sáº½ khÃ´ng thÃ nh cÃ´ng trÆ°á»›c khi báº¡n gá»­i nÃ³.</p><p>VÃ¬ váº­y, Ä‘Ã³ lÃ  má»™t tÃ­nh nÄƒng ráº¥t hay, nhÆ°ng khÃ´ng rÃµ rÃ ng lÃ  lÃ m tháº¿ nÃ o Ä‘á»ƒ quáº£n lÃ½ thá»i gian trong context Ä‘Ã³. Thá»i gian ráº¥t quan trá»ng, bá»Ÿi vÃ¬ chÃºng tÃ´i muá»‘n thá»ƒ hiá»‡n ráº±ng má»™t giao dá»‹ch nháº¥t Ä‘á»‹nh chá»‰ cÃ³ hiá»‡u lá»±c trÆ°á»›c hoáº·c chá»‰ cÃ³ hiá»‡u lá»±c sau khi Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n má»™t thá»i Ä‘iá»ƒm nháº¥t Ä‘á»‹nh.</p><p>ChÃºng ta Ä‘Ã£ tháº¥y má»™t vÃ­ dá»¥ vá» Ä‘iá»u nÃ y trong bÃ i giáº£ng má»™t - vÃ­ dá»¥ Ä‘áº¥u giÃ¡ (bid), trong Ä‘Ã³ giÃ¡ tháº§u chá»‰ Ä‘Æ°á»£c phÃ©p cho Ä‘áº¿n khi Ä‘áº¡t Ä‘áº¿n thá»i háº¡n cuá»‘i cÃ¹ng vÃ  <code>close</code> chá»‰ khi cÃ³ thá»ƒ gá»i <em>Endpoint</em> sau khi thá»i háº¡n Ä‘Ã£ qua.</p><p>Äiá»u Ä‘Ã³ dÆ°á»ng nhÆ° lÃ  má»™t sá»± mÃ¢u thuáº«n, bá»Ÿi vÃ¬ thá»i gian rÃµ rÃ ng lÃ  Ä‘ang trÃ´i. VÃ¬ váº­y, khi báº¡n cá»‘ gáº¯ng xÃ¡c thá»±c má»™t giao dá»‹ch mÃ  báº¡n Ä‘ang táº¡o trong vÃ­ cá»§a mÃ¬nh, táº¥t nhiÃªn, thá»i gian báº¡n Ä‘ang thá»±c hiá»‡n cÃ³ thá»ƒ khÃ¡c vá»›i thá»i gian giao dá»‹ch Ä‘áº¿n má»™t nÃºt Ä‘á»ƒ xÃ¡c thá»±c. VÃ¬ váº­y, khÃ´ng rÃµ lÃ m tháº¿ nÃ o Ä‘á»ƒ káº¿t há»£p hai Ä‘iá»u nÃ y láº¡i vá»›i nhau Ä‘á»ƒ xÃ¡c thá»±c lÃ  xÃ¡c Ä‘á»‹nh vÃ  Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng náº¿u vÃ  chá»‰ khi, xÃ¡c thá»±c thÃ nh cÃ´ng trong vÃ­, thÃ¬ nÃ³ cÅ©ng sáº½ thÃ nh cÃ´ng trong nÃºt.</p><p>CÃ¡ch Cardano giáº£i quyáº¿t Ä‘iá»u Ä‘Ã³, lÃ  báº±ng cÃ¡ch thÃªm trÆ°á»ng pháº¡m vi vá»‹ trÃ­ <code>txInfoValidRange</code> vÃ o má»™t giao dá»‹ch, vá» cÆ¡ báº£n nÃ³i ráº±ng &quot;Giao dá»‹ch nÃ y há»£p lá»‡ giá»¯a vá»‹ trÃ­ nÃ y vÃ  vá»‹ trÃ­ kia &quot;.</p><p>Khi má»™t giao dá»‹ch Ä‘Æ°á»£c gá»­i Ä‘áº¿n blockchain vÃ  Ä‘Æ°á»£c xÃ¡c thá»±c bá»Ÿi má»™t nÃºt, sau Ä‘Ã³ trÆ°á»›c khi cháº¡y báº¥t ká»³ táº­p lá»‡nh nÃ o, má»™t sá»‘ kiá»ƒm tra chung sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n, cháº³ng háº¡n nhÆ° táº¥t cáº£ cÃ¡c Ä‘áº§u vÃ o Ä‘á»u cÃ³ máº·t vÃ  sá»‘ dÆ° cá»™ng láº¡i, phÃ­ Ä‘Æ°á»£c bao gá»“m, v.v.</p><p>Má»™t trong nhá»¯ng kiá»ƒm tra xáº£y ra trÆ°á»›c khi xÃ¡c thá»±c lÃ  kiá»ƒm tra xem pháº¡m vi vá»‹ trÃ­ cÃ³ há»£p lá»‡ hay khÃ´ng. NÃºt sáº½ xem xÃ©t thá»i Ä‘iá»ƒm hiá»‡n táº¡i vÃ  kiá»ƒm tra xem nÃ³ cÃ³ náº±m trong pháº¡m vi vá»‹ trÃ­ há»£p lá»‡ cá»§a giao dá»‹ch hay khÃ´ng. Náº¿u khÃ´ng, thÃ¬ xÃ¡c thá»±c khÃ´ng thÃ nh cÃ´ng ngay láº­p tá»©c mÃ  khÃ´ng bao giá» cháº¡y cÃ¡c táº­p lá»‡nh trÃ¬nh xÃ¡c thá»±c.</p><p>VÃ¬ váº­y, náº¿u kiá»ƒm tra trÆ°á»›c thÃ nh cÃ´ng, thÃ¬ Ä‘iá»u nÃ y cÃ³ nghÄ©a lÃ  thá»i gian hiá»‡n táº¡i rÆ¡i vÃ o pháº¡m vi vá»‹ trÃ­ há»£p lá»‡. Äáº¿n lÆ°á»£t nÃ³, Ä‘iá»u nÃ y cÃ³ nghÄ©a lÃ  chÃºng ta láº¡i hoÃ n toÃ n xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c. Táº­p lá»‡nh xÃ¡c thá»±c cÃ³ thá»ƒ Ä‘Æ¡n giáº£n giáº£ Ä‘á»‹nh ráº±ng nÃ³ Ä‘ang Ä‘Æ°á»£c cháº¡y táº¡i má»™t vá»‹ trÃ­ há»£p lá»‡.</p><p>Theo máº·c Ä‘á»‹nh, má»™t táº­p lá»‡nh sáº½ sá»­ dá»¥ng pháº¡m vi vá»‹ trÃ­ vÃ´ háº¡n, má»™t táº­p lá»‡nh bao gá»“m táº¥t cáº£ cÃ¡c vá»‹ trÃ­ báº¯t Ä‘áº§u tá»« khá»‘i gá»‘c vÃ  cháº¡y cho Ä‘áº¿n háº¿t thá»i gian.</p><p>CÃ³ má»™t sá»± phá»©c táº¡p nhá» vá»›i Ä‘iá»u nÃ y, Ä‘Ã³ lÃ  Ouroboros, giao thá»©c Ä‘á»“ng thuáº­n cung cáº¥p nÄƒng lÆ°á»£ng cho Cardano khÃ´ng sá»­ dá»¥ng thá»i gian POSIX, nÃ³ sá»­ dá»¥ng cÃ¡c khe cáº¯m. NhÆ°ng Plutus sá»­ dá»¥ng thá»i gian thá»±c, vÃ¬ váº­y chÃºng ta cáº§n cÃ³ kháº£ nÄƒng chuyá»ƒn Ä‘á»•i qua láº¡i giá»¯a thá»i gian thá»±c vÃ  thá»i Ä‘iá»ƒm. Äiá»u nÃ y khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬ miá»…n lÃ  thá»i gian rÃ£nh Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh. Ngay bÃ¢y giá» lÃ  má»™t giÃ¢y, vÃ¬ váº­y ngay bÃ¢y giá» nÃ³ lÃ  dá»… dÃ ng.</p><p>Tuy nhiÃªn, Ä‘iá»u nÃ y cÃ³ thá»ƒ thay Ä‘á»•i trong tÆ°Æ¡ng lai. CÃ³ thá»ƒ cÃ³ má»™t Ä‘á»£t hard fork vá»›i má»™t sá»‘ thay Ä‘á»•i thÃ´ng sá»‘ sáº½ thay Ä‘á»•i thá»i gian cá»§a vá»‹ trÃ­. ChÃºng tÃ´i khÃ´ng thá»ƒ biáº¿t trÆ°á»›c Ä‘iá»u Ä‘Ã³. VÃ­ dá»¥, chÃºng tÃ´i khÃ´ng biáº¿t Ä‘á»™ dÃ i vá»‹ trÃ­ sáº½ lÃ  bao nhiÃªu trong 10 nÄƒm ná»¯a.</p><p>Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  cÃ¡c khoáº£ng thá»i gian Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh cho cÃ¡c giao dá»‹ch khÃ´ng Ä‘Æ°á»£c cÃ³ giá»›i háº¡n trÃªn xÃ¡c Ä‘á»‹nh lÃ  quÃ¡ xa trong tÆ°Æ¡ng lai. Chá»‰ cÃ ng xa trong tÆ°Æ¡ng lai thÃ¬ ngÆ°á»i ta má»›i cÃ³ thá»ƒ biáº¿t Ä‘Æ°á»£c Ä‘á»™ dÃ i rÃ£nh sáº½ lÃ  bao nhiÃªu. Äiá»u nÃ y xáº£y ra tÆ°Æ¡ng tá»± nhÆ° 36 giá». ChÃºng tÃ´i biáº¿t ráº±ng náº¿u sáº¯p cÃ³ má»™t Ä‘á»£t hard fork, chÃºng tÃ´i sáº½ biáº¿t vá» nÃ³ trÆ°á»›c Ã­t nháº¥t 36 giá».</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="posixtimerange"></a>POSIXTimeRange<a class="hash-link" href="#posixtimerange" title="Direct link to heading">#</a></h3><p>HÃ£y xem <code>POSIXTimeRange</code> nÃ y , Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong <code>Plutus.V1.Ledger.Time</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type POSIXTimeRange = Interval POSIXTime.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NÃ³ lÃ  má»™t loáº¡i tá»« Ä‘á»“ng nghÄ©a vá»›i <code>Interval POSIXTime</code> vÃ  chÃºng ta tháº¥y ráº±ng nÃ³ <code>Interval</code> Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a bá»Ÿi  <code>LowerBound</code> vÃ  <code>UpperBound</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Interval</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      ivFrom :: LowerBound a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      inTo   :: UpperBound a      </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Náº¿u chÃºng ta Ä‘i sÃ¢u vÃ o, <code>LowerBound</code> chÃºng ta sáº½ tháº¥y hÃ m táº¡o</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data LowerBound a = LowerBound (Extended a) Closure</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>Closure</code> lÃ  má»™t tá»« Ä‘Ã´ng nghÄ©a vá»›i <code>Bool</code> vÃ  cháº¯c cháº¯n ráº±ng cÃ³ Ä‘Æ°a vÃ o <code>Interval</code> hay khÃ´ng.</p><p><code>Extended</code> cÃ³ thá»ƒ lÃ  <code>NegInf</code> Ã¢m vÃ´ cÃ¹ng, <code>PosInf</code> dÆ°Æ¡ng vÃ´ cÃ¹ng, hoáº·c <code>Finite</code>.</p><p>ChÃºng tÃ´i cÅ©ng tÃ¬m tháº¥y má»™t sá»‘ hÃ m trá»£ giÃºp bao gá»“m cáº£ hÃ m <code>member</code> kiá»ƒm tra xem má»™t cÃ¡i Ä‘Ã£ cho <code>a</code> cÃ³ pháº£i lÃ  má»™t pháº§n cá»§a má»™t cÃ¡i Ä‘Ã£ cho hay khÃ´ng <code>Interval</code>, miá»…n lÃ  kiá»ƒu cá»§a <code>a</code> lÃ  má»™t kiá»ƒu con cá»§a <code>Ord</code>, Ä‘Ã¢y lÃ  trÆ°á»ng há»£p cho <code>POSIXTime</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">member :: Ord a =&gt; a -&gt; Interval a -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">member a i = i `contains` singleton a</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>interval</code> lÃ  má»™t hÃ m táº¡o thÃ´ng minh cho <code>Interval</code> Kiá»ƒu nÃ y táº¡o <code>Interval</code> vá»›i giá»›i háº¡n trÃªn vÃ  dÆ°á»›i.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">interval :: a -&gt; a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">interval s s&#x27; = Interval (lowerBound s) (upperBound s&#x27;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Sau Ä‘Ã³ chÃºng ta cÃ³ <code>from</code> vá»›i <code>Interval</code> cÃ¡i nÃ y báº¯t Ä‘áº§u tá»« <code>a</code>
vÃ  kÃ©o dÃ i Ä‘áº¿n vÃ´ cÃ¹ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">from :: a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">from s = Interval (lowerBound s) (UpperBound PosInf True)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  chÃºng ta cÃ³ <code>to</code>, nÃ³ lÃ  ngÆ°á»›c láº¡i vá»›i <code>from</code>. NÃ³ cÅ©ng Ä‘Æ°á»£c dÃ¹ng <code>Interval</code>
nÃ³ báº¯t Ä‘áº§u block genesis tá»›i <code>a</code>, vÃ  bao gá»“m cáº£ <code>a</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">to :: a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">to s = Interval (LowerBound NegInf True) (upperBound s)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>always</code> luÃ´n máº·c Ä‘á»‹nh <code>Interval</code> bao gá»“m táº¥t cáº£ tá»« Ã¢m vÃ´ cÃ¹ng Ä‘áº¿n dÆ°Æ¡ng vÃ´ cÃ¹ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">always :: Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">always = Interval (LowerBound NegInf True) (UpperBound PosInf True)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>vÃ  cÃ³ Ä‘iá»u ngÆ°Æ¡c láº¡i, <code>never</code>, NÃ³ khÃ´ng chá»©a slots nÃ o.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">never :: Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">never = Interval (LowerBound PosInf True) (UpperBound NegInf True)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>NgoÃ i ra cÃ²n trÃ¬nh trá»£ giÃºp <code>singleton</code>, nÃ³ bao gá»“m má»™t slot</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">singleton :: a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">singleton s = interval s s      </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>hull</code> cho khoáº£ng nhá» nháº¥t chá»©a cáº£ hai khoáº£ng Ä‘Ã£ cho.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">hull :: Ord a =&gt; Interval a -&gt; Interval a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">hull (Interval l1 h1) (Interval l2 h2) = Interval (min l1 l2) (max h1 h2)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Chá»©c nÄƒng <code>intersection</code> xÃ¡c Ä‘á»‹nh khoáº£ng thá»i gian lá»›n nháº¥t Ä‘Æ°á»£c chá»©a trong cáº£ khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh. ÄÃ¢y lÃ  má»™t <code>Interval</code> báº¯t Ä‘áº§u tá»« giá»›i háº¡n dÆ°á»›i lá»›n nháº¥t cá»§a hai khoáº£ng vÃ  kÃ©o dÃ i cho Ä‘áº¿n giá»›i háº¡n trÃªn nhá» nháº¥t.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">intersection :: Ord a =&gt; Interval a -&gt; Interval a -&gt; Interval a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">intersection (Interval l1 h1) (Interval l2 h2) = Interval (max l1 l2) (min h1 h2)    </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ m <code>overlaps</code> kiá»ƒm tra chá»©c nÄƒng cho dÃ¹ hai khoáº£ng thá»i gian chá»“ng lÃªn nhau, cÃ³ nghÄ©a lÃ , cho dÃ¹ cÃ³ má»™t giÃ¡ trá»‹ chá»“ng lÃªn nhau cá»§a cáº£ hai khoáº£ng thá»i gian.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">overlaps :: Ord a =&gt; Interval a -&gt; Interval a -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">overlaps l r = isEmpty (l `intersection` r)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>contains</code> tláº¥y hai khoáº£ng vÃ  xÃ¡c Ä‘á»‹nh xem khoáº£ng thá»© hai cÃ³ hoÃ n toÃ n náº±m trong khoáº£ng thá»i gian Ä‘áº§u tiÃªn hay khÃ´ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">contains :: Ord a =&gt; Interval a -&gt; Interval a -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">contains (Interval l1 h1) (Interval l2 h2) = l1 &lt;= l2 &amp;&amp; h2 &lt;= h1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>VÃ  chÃºng tÃ´i cÃ³ cÃ¡c chá»©c nÄƒng <code>before</code> vÃ  <code>after</code> Ä‘á»ƒ xÃ¡c Ä‘á»‹nh náº¿u má»™t thá»i gian nháº¥t Ä‘á»‹nh tÆ°Æ¡ng á»©ng, trÆ°á»›c hoáº·c sau má»i thá»© trong má»™t thá»i gian nháº¥t Ä‘á»‹nh <code>Interval</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">before :: Ord a =&gt; a -&gt; Interval a -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">before h (Interval f _) = lowerBound h &lt; f</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">after :: Ord a =&gt; a -&gt; Interval a -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">after h (Interval _ t) = upperBound h &gt; t</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y vÃ o trong REPL.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week03.Homework1&gt; import Plutus.V1.Ledger.Interval</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>HÃ£y xÃ¢y dá»±ng <code>Interval</code> tá»« 10 Ä‘áº¿n 20, bao gá»“m cáº£ hai Ä‘áº§u.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Interval {ivFrom = LowerBound (Finite 10) True, ivTo = UpperBound (Finite 20) True}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cÃ³ thá»ƒ kiá»ƒm tra xem má»™t giÃ¡ trá»‹ cÃ³ pháº£i lÃ  thÃ nh viÃªn cá»§a má»™t khoáº£ng hay khÃ´ng:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 9 $ interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 10 $ interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 12 $ interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 20 $ interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 21 $ interval (10 :: Integer) 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m <code>from</code>. á» Ä‘Ã¢y giá»›i háº¡n dÆ°á»›i láº¡i lÃ  má»™t slot há»¯u háº¡n, nhÆ°ng giá»›i háº¡n trÃªn lÃ  dÆ°Æ¡ng vÃ´ cÃ¹ng.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 21 $ from (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 30 $ from (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 300000 $ from (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>And the <code>to</code> constructor. Here the lower bound is negative infinity,
while the upper bound is a finite slot number.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 300000 $ to (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 31 $ to (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 30 $ to (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; member 7 $ to (30 :: Integer)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, let\&#x27;s try the <code>intersection</code> function on the <code>Interval</code> from 10 to
20 and the <code>Interval</code> from 18 to 30.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; intersection (interval (10 :: Integer) 20) $ interval 18 30</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Interval {ivFrom = LowerBound (Finite 18) True, ivTo = UpperBound (Finite 20) True}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>As expected, we get the <code>Interval</code> that runs from 18 to 20, inclusive.</p><p>We can check whether one <code>Interval</code> contains another.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; contains (to (100 :: Integer)) $ interval 30 80</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; contains (to (100 :: Integer)) $ interval 30 100</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; contains (to (100 :: Integer)) $ interval 30 101</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We see that as soon as the second <code>Interval</code> extends to 101, it is no
longer fully contained within the <code>Interval</code> that runs to 100.</p><p>However, if we check with <code>overlaps</code>, then it will be true because there
are elements, such as 40, that are contained in both intervals.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; overlaps (to (100 :: Integer)) $ interval 30 101</span></div><div class="token-line" style="color:#393A34"><span class="token plain">True</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Plutus.V1.Ledger.Interval Week03.Homework1&gt; overlaps (to (100 :: Integer)) $ interval 101 110</span></div><div class="token-line" style="color:#393A34"><span class="token plain">False</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="example---vesting"></a>Example - Vesting<a class="hash-link" href="#example---vesting" title="Direct link to heading">#</a></h2><p>Imagine you want to give a gift of Ada to a child. You want the child to
own the Ada, but you only want the child to have access to it he or she
turns eighteen.</p><p>Using Plutus, it is very easy to implement. As our first contract that
will look at the context argument, we will implement a contract that
implements a vesting scheme. Money will be put into a script and then it
can be retrieved by a certain person, but only once a certain deadline
has been reached.</p><p>We start by copying the <code>IsData</code> contract from lecture two into a new
module called <code>Vesting</code>.</p><p>The first step is to think about the types for the datum and redeemer.</p><p>For datum, it makes sense to have two pieces of information, the
beneficiary and the deadline. So, let\&#x27;s define this type:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data VestingDatum = VestingDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   { beneficiary :: PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , deadline    :: POSIXTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   } deriving Show</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">PlutusTx.unstableMakeIsData &#x27;&#x27;VestingDatum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In order to know if someone can spend this script output, two pieces
information are required, i.e. the beneficiary\&#x27;s signature and the time
of the transaction. In this case, both those pieces of information are
contained in the transaction itself. This means that we don\&#x27;t need any
information in the redeemer, so we can just use <code>()</code> for the redeemer.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mkValidator :: VestingDatum -&gt; () -&gt; ScriptContext -&gt; Bool</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We need to check two conditions.</p><ol><li>That only the correct beneficiary can unlock a UTxO sitting at this
address. This we can validate by checking that the beneficiary\&#x27;s
signature is included in the transaction.</li><li>That this transaction is only executed after the deadline is
reached.</li></ol><p>We could probably just write this in one go, but we will write it in a
more top-down fashion and delegate to some helper functions.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mkValidator dat () ctx =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      mkValidator dat () ctx = traceIfFalse &quot;beneficiary&#x27;s signature missing&quot; signedByBeneficiary &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                               traceIfFalse &quot;deadline not reached&quot; deadlineReached</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      info = scriptContextTxInfo ctx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>To check that the transaction is signed by the beneficiary, we can get
the public key of the beneficiary from the datum and pass it, along with
the transaction information to the <code>txSignedBy</code> function.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">signedByBeneficiary :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">signedByBeneficiary = txSignedBy info $ beneficiary dat</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>How do we check that the deadline has passed?</p><p><img src="/assets/images/pic__00046-91ac81d2e6110ca563ef34a48b448bb4.png"></p><p>Let\&#x27;s consider a transaction with a validity that crosses the deadline,
which is shown as the uppermost range in the above diagram.</p><p>Recall that before the validator script is run, other checks are made,
including the time check. The node checks that the current time falls
into the valid range of the transaction and only then is the validator
run. So we know that, if we are in the validator, the current time lies
somewhere within the validity interval.</p><p>In the case of the range that crosses the deadline, the validator code
cannot know whether the current time is before or after the deadline. In
this case, the validator must declare that the transaction is invalid.</p><p>The second example in the diagram, however, is fine. We still don\&#x27;t
know what the current time is exactly, but we know that whatever the
time is, it will be after the deadline.</p><p>So, what we are checking for is that the whole validity interval is to
the right of the deadline. One way to do this is to use the <code>contains</code>
function to check whether the validity interval is fully contained
within the interval that starts from the deadline and extends until the
end of time.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">deadlineReached :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">deadlineReached = contains (from $ deadline dat) $ txInfoValidRange info</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>That completes the validation logic. Let\&#x27;s take care of some
boilerplate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ValidatorTypes Vesting where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Vesting = VestingDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Vesting = ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator :: Scripts.TypedValidator Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator = Scripts.mkTypedValidator @Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| mkValidator ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @VestingDatum @()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We will focus more on the wallet part of the script later, but here are
the changes.</p><p>In addition to some new <code>LANGUAGE</code> pragmas and some extra imports, we
have created a <code>GiveParams</code> type, and modified the <code>grab</code> endpoint to
require no parameters.</p><p>The <code>VestingSchema</code> type defines the endpoints that we want to expose to
the user. As in our last example, <code>give</code> will be used by the user who
puts funds into the contract, then <code>grab</code> will be used by the user
wanting to claim the funds.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type VestingSchema =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   .\/ Endpoint &quot;give&quot; GiveParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   .\/ Endpoint &quot;grab&quot; ()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>So what parameters do we need for <code>give</code>? The endpoint will create a
UTxO at the vesting script address with an amount and a datum. If you
recall, our datum contains the beneficiary and the deadline. So, there
are three pieces of information that we must pass to the <code>give</code>
endpoint.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data GiveParams = GiveParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   { gpBeneficiary :: !PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , gpDeadline    :: !POSIXTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   , gpAmount      :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   } deriving (Generic, ToJSON, FromJSON, ToSchema)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The <code>grab</code> endpoint doesn\&#x27;t require any parameters because the
beneficiary will just look for UTxOs sitting at the script address and
can then check whether they are the beneficiary and whether the deadline
has passed. If so, they can consume them.</p><p>Let\&#x27;s quickly look at the <code>give</code> endpoint.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">give :: AsContractError e =&gt; GiveParams -&gt; Contract w s e ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">give gp = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let dat = VestingDatum</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                { beneficiary = gpBeneficiary gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , deadline    = gpDeadline gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        tx  = mustPayToTheScript dat $ Ada.lovelaceValueOf $ gpAmount gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ledgerTx &lt;- submitTxConstraints typedValidator tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ printf &quot;made a gift of %d lovelace to %s with deadline %s&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (gpAmount gp)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (show $ gpBeneficiary gp)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (show $ gpDeadline gp)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>First we compute the datum we want to use, and we can get both pieces of
information from the <code>GiveParams</code> which is passed into the function.</p><p>Then, for the transaction, we add a constraint that there must be an
output at this script address with the datum that we just defined and a
certain number of lovelace, which we also get from the <code>GiveParams</code>.</p><p>The rest of the function is as before, just with a different log
message.</p><p>The <code>grab</code> endpoint is a bit more involved.</p><p>There can be many UTxOs at this script address and some of them might
not be suitable for us, either because we are not the beneficiary, or
because the deadline has not yet passed. If we try to submit a
transaction when there are no suitable UTxOs, we will pay fees, but get
nothing in return.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">grab :: forall w s e. AsContractError e =&gt; Contract w s e ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">grab = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    now   &lt;- currentTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    pkh   &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    utxos &lt;- Map.filter (isSuitable pkh now) &lt;$&gt; utxoAt scrAddress</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    if Map.null utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        then logInfo @String $ &quot;no gifts available&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            let orefs   = fst &lt;$&gt; Map.toList utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                lookups = Constraints.unspentOutputs utxos  &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          Constraints.otherScript validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx :: TxConstraints Void Void</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tx      = mconcat [mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | oref &lt;- orefs] &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          mustValidateIn (from now)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ledgerTx &lt;- submitTxConstraintsWith @Void lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            void $ awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            logInfo @String $ &quot;collected gifts&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    isSuitable :: PubKeyHash -&gt; POSIXTime -&gt; TxOutTx -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    isSuitable pkh now o = case txOutDatumHash $ txOutTxOut o of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; False</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Just h  -&gt; case Map.lookup h $ txData $ txOutTxTx o of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Nothing        -&gt; False</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Just (Datum e) -&gt; case PlutusTx.fromData e of</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Nothing -&gt; False</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Just d  -&gt; beneficiary d == pkh &amp;&amp; deadline d &lt;= now</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>First, we get the current time and calculate our public key hash. We
then look up all the UTxOs at this address and filter them using the
<code>isSuitable</code> helper function, which is defined in the <code>where</code> clause.</p><p>It first checks the datum hash, and, if it finds it, it attempts to look
up the corresponding datum. Recall that the producing transaction, in
this case <code>give</code> doesn\&#x27;t have to supply the datum, it need only supply
the datum hash. However, in our case we need to have the datum available
to the <code>grab</code> endpoint, so the <code>give</code> endpoint does provide the datum.</p><p>If the <code>grab</code> endpoint finds the datum, it must deserialise it to the
<code>Vesting</code> type.</p><p>If all of this succeeds we can check whether we are the beneficiary and
whether the deadline has passed.</p><p>At this point, <code>utxos</code> contains all the UTxOs that we can consume. If we
find none, then we just log a message to that effect. If there is at
least one, then we construct one transaction that consumes all of them
as inputs and pays the funds to our wallet.</p><p>As <code>lookups</code>, we provide the list of UTxOs as well as the validator
script. Recall that, in order to consume UTxOs at this address, the
spending transaction must provide the validation script.</p><p>We then create a transaction that spends all the suitable UTxOs along
with a constraint that it must validate in the <code>Interval</code> which
stretches from now until the end of time. If we don\&#x27;t provide the
interval here, then validation will fail, because the default interval
is from genesis until the end of time. The on-chain validation would
reject this as it needs an interval that is fully contained in the
interval stretching from the deadline until the end of time.</p><p>We could use the singleton <code>Interval</code> <code>now</code>, but, if there were any
issues, for example network delays, and the transaction arrived at a
node a slot or two later, then validation would no longer work.</p><p>The, we just bundle up the endpoints.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">endpoints :: Contract () VestingSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">endpoints = (give&#x27; `select` grab&#x27;) &gt;&gt; endpoints</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    give&#x27; = endpoint @&quot;give&quot; &gt;&gt;= give</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    grab&#x27; = endpoint @&quot;grab&quot; &gt;&gt;  grab</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Then there is some boilerplate which is just used in the playground.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">mkSchemaDefinitions &#x27;&#x27;VestingSchema</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkKnownCurrencies []</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="in-the-playground"></a>In the playground<a class="hash-link" href="#in-the-playground" title="Direct link to heading">#</a></h3><p>First, let\&#x27;s add a third wallet. We are going to create a scenario
where Wallet 1 makes two gifts to Wallet 2 with different deadlines and
also makes one gift to Wallet 3.</p><p><img src="/assets/images/pic__00043-90836e56ce8338b63ac410965d2cc39c.png"></p><p>Normally it would be possible to submit both <code>give</code> transactions in the
same slot, but the way our code is implemented, we wait for
confirmation, which means we need to add a wait action. This is maybe
not the best way to do it, but that\&#x27;s how it is for the time being.</p><p><img src="/assets/images/pic__00044-ae789cd0b18189a70d1c764d465b5002.png"></p><p>Here we run into our first problem. We need to supply the beneficiary
address, but there is no way in the playground to get the public key
hash of a wallet.</p><p>But we can get it from the REPL.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week03.Homework1&gt; :l src/Week03/Vesting.hs </span></div><div class="token-line" style="color:#393A34"><span class="token plain">Ok, one module loaded.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Week03.Vesting&gt; import Ledger</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Week03.Vesting&gt; import Wallet.Emulator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Week03.Vesting&gt; pubKeyHash $ walletPubKey $ Wallet 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">39f713d0a644253f04529421b9f51b9b08979d08295959c4f3990ee617f5139f</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Week03.Vesting&gt; pubKeyHash $ walletPubKey $ Wallet 3</span></div><div class="token-line" style="color:#393A34"><span class="token plain">dac073e0123bdea59dd9b3bda9cf6037f63aca82627d7abcd5c4ac29dd74003e</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><img src="/assets/images/pic__00047-e701ccc70650672796705049bc861960.png"></p><p>The next problem is the deadline. In the last lecture we saw how to
convert between slots and POSIX times. This has changed. Previously you
just needed a slot and out came a POSIX time. Now there is a second
argument.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Week03.Vesting&gt; import Ledger.TimeSlot </span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Week03.Vesting&gt; :t slotToBeginPOSIXTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">slotToBeginPOSIXTime :: SlotConfig -&gt; Slot -&gt; POSIXTime</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>There are also versions of <code>slotToBeginPOSIXTime</code> that have a begin and
an end time. This is because a slot is not just a point in time, it\&#x27;s a
duration in time.</p><p>So what is this <code>SlotConfig</code>?</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Week03.Vesting&gt; :i SlotConfig </span></div><div class="token-line" style="color:#393A34"><span class="token plain">type SlotConfig :: *</span></div><div class="token-line" style="color:#393A34"><span class="token plain">data SlotConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  = SlotConfig {scSlotLength :: Integer, scZeroSlotTime :: POSIXTime}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        -- Defined in â€˜Ledger.TimeSlotâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Eq SlotConfig -- Defined in â€˜Ledger.TimeSlotâ€™</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Show SlotConfig -- Defined in â€˜Ledger.TimeSlotâ€™</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>It takes the slot length and the time at which slot zero starts.</p><p>So now we have to find out what <code>SlotConfig</code> to use for the playground.
Luckily, it\&#x27;s the default. For that we need to use the <code>Data.Default</code>
module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Week03.Vesting&gt; import Data.Default</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Data.Default Week03.Vesting&gt; def :: SlotConfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">SlotConfig {scSlotLength = 1000, scZeroSlotTime = POSIXTime {getPOSIXTime = 1596059091000}}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now we can use <code>slotToBeginPOSIXTime</code> with the default config to get the
POSIX time for slot 10 and slot 20.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Data.Default Week03.Vesting&gt; slotToBeginPOSIXTime def 10</span></div><div class="token-line" style="color:#393A34"><span class="token plain">POSIXTime {getPOSIXTime = 1596059101000}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Prelude Ledger Wallet.Emulator Ledger.TimeSlot Data.Default Week03.Vesting&gt; slotToBeginPOSIXTime def 20</span></div><div class="token-line" style="color:#393A34"><span class="token plain">POSIXTime {getPOSIXTime = 1596059111000}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>And we can use these in the playground. We\&#x27;ll use slot 10 as the
deadline for the first and third <code>give</code>s and slot 20 for the second
<code>give</code>. We\&#x27;ll also give 10 Ada in each case.</p><p><img src="/assets/images/pic__00048-d7da99592a35e7501ca80f88da6366d0.png"></p><p>Let\&#x27;s create a scenario where everything works. Wallet 3 grabs at slot
10 when the deadline for Wallet 3 has passed, and Wallet 2 grabs at slot
20, when both the Wallet 2 deadlines have passed. We will use the
<code>Wait Until..</code> option for this.</p><p><img src="/assets/images/pic__00049-d73f83f7294dd0187da15f4eaa3c7247.png"></p><p>After evaluation, we first see the Genesis transaction.</p><p><img src="/assets/images/pic__00050-cd1459efe52e84b5c3fcebd8fb077b08.png"></p><p>If we look at the next transaction, we see the gift from Wallet 1 to
Wallet 2 with the deadline of 10. Here, ten Ada get locked in the script
address.</p><p><img src="/assets/images/pic__00051-74d33494d0e068519bd23ae9b42ae1ca.png"></p><p>The next transaction is the gift from Wallet 1 to Wallet 2 with the
deadline of 20. A new UTxO is now created at the script address with ten
Ada.</p><p><img src="/assets/images/pic__00052-baa346bdcdad8c6a6cf40acf94e227d3.png"></p><p>And the third gift, this time to Wallet 3, with a deadline of 10. Wallet
1 now has about 70 Ada, and another UTxO is created with 10 Ada locked
at the script address.</p><p><img src="/assets/images/pic__00053-95169853875b3a94d47aacb5be95d8f1.png"></p><p>At slot 10, Wallet 3 grabs successfully. The third UTxO is the input,
some fees are paid, and then the remainder of the lovelace is sent to
Wallet 3.</p><p><img src="/assets/images/pic__00054-914e9e6153e10e5200376f911ef80451.png"></p><p>Then at slot 20, Wallet 2 successfully grabs both the UTxOs for which
they are the beneficiary. This time the fee is higher because two
validators have to run.</p><p><img src="/assets/images/pic__00055-9d7a06572c0cabe917a527aa359cf8e8.png"></p><p>The final balances reflect the changes.</p><p><img src="/assets/images/pic__00056-ffd977106823023ce72d426f5bf57051.png"></p><p>Now let\&#x27;s look at the case where the grab happens too early. We\&#x27;ll
make Wallet 2 grab at slot 15 instead of slot 20.</p><p><img src="/assets/images/pic__00010-86ac7d37c76a594b6967b6f7648e5335.png"></p><p>Now we see that the first transactions are the same, but that the final
transaction at slot 15 has only one input, because the second UTxO is
not yet available.</p><p><img src="/assets/images/pic__00057-deaf409949adb584abc3ce5ca4253d5a.png"></p><p>And we can see that there are 10 Ada still locked at the script address.</p><p><img src="/assets/images/pic__00057-deaf409949adb584abc3ce5ca4253d5a.png"></p><p>Our off-chain code was written in such a way that it will only submit a
transaction if there is a suitable UTxO that can be grabbed. This means
that we don\&#x27;t really exercise the validator because we are only sending
transactions to the blockchain that will pass validation.</p><p>If you want to test the validator, you could modify the wallet code so
that the grab endpoint attempts to grab everything and then validation
will fail if you are not the beneficiary or the deadline has not been
reached.</p><p>You need to keep in mind that anybody can write off-chain code. So, even
though it works now as long as you use the <code>grab</code> endpoint that we wrote
ourselves, somebody could write a different piece of off-chain code that
doesn\&#x27;t filter the UTxOs as we did. In this case, if the validator is
not correct something could be horribly wrong.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="example-2---parameterized-contract"></a>Example 2 - Parameterized Contract<a class="hash-link" href="#example-2---parameterized-contract" title="Direct link to heading">#</a></h2><p>We\&#x27;ll start the next example by copying the code from the vesting
example into a new module called <code>Week03.Parameterized</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="on-chain"></a>On-Chain<a class="hash-link" href="#on-chain" title="Direct link to heading">#</a></h3><p>Note that in the vesting example we used the <code>Vesting</code> type as the
datum, but it was just fixed, it didn\&#x27;t change. Alternatively, we could
have baked it into the contract, so to speak, so that we have a contract
where the script itself already contains the beneficiary and deadline
information.</p><p>All the examples of contracts we have seen so far were fixed. We used a
<code>TypedValidator</code> as a compile-time constant. The idea of parameterized
scripts is that you can have a parameter and, depending on the value of
the parameter, you get different values of <code>TypedValidator</code>.</p><p>So, instead of defining one script, with a single script address, with
all UTxOs sitting at the same address, you can define a family of
scripts that are parameterized by a given parameter. In our case, this
will mean that UTxOs for different beneficiaries and/or deadlines will
be a different script addresses, as they will have parameterized
validators specific to their parameters rather than specific to the
datum of the UTxO.</p><p>We are going to demonstrate how to do this by, instead of using datum
for the beneficiary and deadline values, using a parameter.</p><p>Let\&#x27;s start by renaming <code>VestingDatum</code> to something more suitable.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data VestingParam = VestingParam</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      { beneficiary :: PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      , deadline    :: POSIXTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      } deriving Show</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We will also remove the <code>unstableMakeIsData</code> call as we don\&#x27;t need this
anymore.</p><p>The reason we don\&#x27;t need it, is because we are just going to use <code>()</code>
for the datum in the <code>mkValidator</code> function. All the information we
require will be in a new argument to <code>mkValidator</code>, of type
<code>VestingParam</code>, which we add at the beginning of the list of arguments.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# INLINABLE mkValidator #-}</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkValidator :: VestingParam -&gt; () -&gt; () -&gt; ScriptContext -&gt; Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">mkValidator p () () ctx = traceIfFalse &quot;beneficiary&#x27;s signature missing&quot; signedByBeneficiary &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          traceIfFalse &quot;deadline not reached&quot; deadlineReached</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info :: TxInfo</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    info = scriptContextTxInfo ctx</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    signedByBeneficiary :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    signedByBeneficiary = txSignedBy info $ beneficiary p</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deadlineReached :: Bool</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    deadlineReached = contains (from $ deadline p) $ txInfoValidRange info</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>We also change the <code>Vesting</code> type to reflect the change to the datum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">instance Scripts.ValidatorTypes Vesting where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance DatumType Vesting = ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    type instance RedeemerType Vesting = ()     </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, the <code>TypedValidator</code> will no longer be a constant value. Instead it
will take a parameter.</p><p>Recall that the function <code>mkTypedValidator</code> requires as its first
argument the compiled code of a function that takes three arguments and
returns a <code>Bool</code>. But now, it has four arguments, so we need to account
for that.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator :: VestingParam -&gt; Scripts.TypedValidator Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator p = Scripts.mkTypedValidator @Vesting      </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, what we would like to do is something like this, passing in the new
parameter <code>p</code> to <code>mkValidator</code> so that the compiled code within the
Oxford brackets would have the correct type.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-- this won&#x27;t work</span></div><div class="token-line" style="color:#393A34"><span class="token plain">$$(PlutusTx.compile [|| mkValidator p ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">$$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">wrap = Scripts.wrapValidator @() @()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>This code will not work, but before we investigate, let\&#x27;s leave the
code as it is for now and make some more changes to the rest of the
code.</p><p><code>validator</code> now will take a <code>VestingParam</code> and will return a composed
function. The returned function has the effect that any paramater passed
to <code>validator</code> would now effectively get passed to the <code>typedValidator</code>
function, whose return value would in turned get passed to the
<code>validatorScript</code> function.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">validator :: VestingParam -&gt; Validator</span></div><div class="token-line" style="color:#393A34"><span class="token plain">validator = Scripts.validatorScript . typedValidator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>And the same for <code>valHash</code> and <code>scrAddress</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">valHash :: VestingParam -&gt; Ledger.ValidatorHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">valHash = Scripts.validatorHash . typedValidator</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">scrAddress :: VestingParam -&gt; Ledger.Address</span></div><div class="token-line" style="color:#393A34"><span class="token plain">scrAddress = scriptAddress . validator</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now, let\&#x27;s find out what\&#x27;s wrong with out <code>typedValidator</code> function.</p><p>If we try to launch the REPL, we get a compile error.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">GHC Core to PLC plugin: E043:Error: Reference to a name which is not a local, a builtin, or an external INLINABLE function: Variable p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">No unfolding</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Context: Compiling expr: p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Context: Compiling expr: Week03.Parameterized.mkValidator p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Context: Compiling expr at &quot;plutus-pioneer-program-week03-0.1.0.0-inplace:Week03.Parameterized:(67,10)-(67,48)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The problem is this line.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-- this won&#x27;t work</span></div><div class="token-line" style="color:#393A34"><span class="token plain">$$(PlutusTx.compile [|| mkValidator p ||])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Recall that everything inside the Oxford brackets must be explicitly
known at compile time. Normally it would even need all the code to be
written explicitly, but by using the <code>INLINABLE</code> pragma on the
<code>mkValidator</code> function we can reference the function instead. However,
it must still be known at compile time, because that\&#x27;s how Template
Haskell works - it is executed before the main compiler.</p><p>The <code>p</code> is not known at compile time, because we intend to supply it at
runtime. Luckily there is a way around this.</p><p>On the Haskell side, we have our <code>mkValidator</code> function and we have <code>p</code>
of type <code>VestingParam</code>. We can compile <code>mkValidator</code> to Plutus, but we
can\&#x27;t compile <code>p</code> to Plutus because we don\&#x27;t know what it is. But, if
we could get our hands on the compiled version of <code>p</code>, we could apply
this compiled version to the compiled <code>mkValidator</code>, and this would give
us what we want.</p><p>This seems to solve nothing, because we still need a compiled version of
<code>p</code> and we have the same problem that <code>p</code> is not known at compile time.</p><p>However, <code>p</code> is not some arbitrary Haskell code, it\&#x27;s data, so it
doesn\&#x27;t contain any function types. If we make the type of <code>p</code> an
instance of a type class called <code>Lift</code>. We can use <code>liftCode</code> to compile
<code>p</code> at runtime to Plutus Core and then, using <code>applyCode</code> we can apply
the Plutus Core <code>p</code> to the Plutus Core <code>mkValidator</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-lift-class"></a>The Lift Class<a class="hash-link" href="#the-lift-class" title="Direct link to heading">#</a></h4><p>Let\&#x27;s briefly look at the <code>Lift</code> class. It is defined in package
<code>plutus-tx</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module PlutusTx.Lift.Class</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>It only has one function, <code>Lift</code>. However, we won\&#x27;t use this function
directly.</p><p>The importance of the class is that it allows us to, at runtime, lift
Haskell values into corresponding Plutus script values. And this is
exactly what we need to convert our parameter <code>p</code> into code.</p><p>We will use a different function, defined in the same package but in a
different module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">module PlutusTx.Lift</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The function we will use is called <code>liftCode</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-- | Get a Plutus Core program corresponding to the given value as a &#x27;CompiledCodeIn&#x27;, throwing any errors that occur as exceptions and ignoring fresh names.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">liftCode</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   :: (Lift.Lift uni a, Throwable uni fun, PLC.ToBuiltinMeaning uni fun)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   =&gt; a -&gt; CompiledCodeIn uni fun a</span></div><div class="token-line" style="color:#393A34"><span class="token plain">liftCode x = unsafely $ safeLiftCode x</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>It takes a Haskell value of type <code>a</code>, provided <code>a</code> is an instance of the
<code>Lift</code> class, and turns it into a piece of Plutus script code
corresponding to the same type.</p><p>Now we can fix our validator.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator :: VestingParam -&gt; Scripts.TypedValidator Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">typedValidator p = Scripts.mkTypedValidator @Vesting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ($$(PlutusTx.compile [|| mkValidator ||]) `PlutusTx.applyCode` PlutusTx.liftCode p)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    $$(PlutusTx.compile [|| wrap ||])</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    wrap = Scripts.wrapValidator @() @()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>This code is fine, but it won\&#x27;t yet compile, because <code>VestingParam</code> is
not an instance of <code>Lift</code>. To fix this, we can use <code>makeLift</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">PlutusTx.makeLift &#x27;&#x27;VestingParam</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>And, we need to enable a GHC extension.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">{-# LANGUAGE MultiParamTypeClasses #-}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>Now it will compile.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="off-chain"></a>Off-Chain<a class="hash-link" href="#off-chain" title="Direct link to heading">#</a></h3><p>The off-chain code hasn\&#x27;t changed much.</p><p>The <code>GiveParams</code> are still the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">data GiveParams = GiveParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      { gpBeneficiary :: !PubKeyHash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      , gpDeadline    :: !POSIXTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      , gpAmount      :: !Integer</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      } deriving (Generic, ToJSON, FromJSON, ToSchema)      </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p><code>VestingSchema</code> has slightly changed because the <code>grab</code> endpoint now
relies on knowing the beneficiary and deadline in order to know
determine the script address. We know the beneficiary because it will be
the public key hash of the wallet that calls <code>grab</code>, but we don\&#x27;t know
the deadline, so we must pass it to <code>grab</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">type VestingSchema =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          Endpoint &quot;give&quot; GiveParams</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      .\/ Endpoint &quot;grab&quot; POSIXTime</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The <code>give</code> endpoint is similar to the vesting example, but there are
some differences.</p><p>Instead of computing the datum, we will construct something of type
<code>VestingParam</code>. We also change the reference to the datum in
<code>mustPayToTheScript</code> to become <code>()</code>, and we provide the type <code>p</code> to
<code>typedValidator</code> as it is no longer a constant.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">give :: AsContractError e =&gt; GiveParams -&gt; Contract w s e ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">give gp = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    let p  = VestingParam</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                { beneficiary = gpBeneficiary gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                , deadline    = gpDeadline gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        tx = mustPayToTheScript () $ Ada.lovelaceValueOf $ gpAmount gp</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    ledgerTx &lt;- submitTxConstraints (typedValidator p) tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    void $ awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    logInfo @String $ printf &quot;made a gift of %d lovelace to %s with deadline %s&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (gpAmount gp)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (show $ gpBeneficiary gp)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        (show $ gpDeadline gp)      </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>In the <code>grab</code> endpoint, there are also some changes.</p><p>Recall that earlier we got all the UTxOs sitting at this one script
address and that they could be for arbitrary beneficiaries and for
arbitrary deadlines. For this reason, we had to filter those UTxOs which
were for us and where the deadline had been reached.</p><p>We now have the additional parameter, which we\&#x27;ll call <code>d</code>, which
represents the deadline. So we can immediately see if the deadline has
been reached or not.</p><p>If it has not been reached, we write a log message and stop, otherwise
we continue and construct the <code>VestingParam</code>.</p><p>Then, we look up the UTxOs that are sitting at this address. Address is
not a constant anymore, it takes a parameter. So, now, we will only get
UTxOs which are for us and that have a deadline that has been reached.
We don\&#x27;t need to filter anything.</p><p>If there are none, we log a message to that effect and stop, otherwise
we do more or less what we did before.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">grab d = do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">now   &lt;- currentTime</span></div><div class="token-line" style="color:#393A34"><span class="token plain">pkh   &lt;- pubKeyHash &lt;$&gt; ownPubKey</span></div><div class="token-line" style="color:#393A34"><span class="token plain">if now &lt; d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    then logInfo @String $ &quot;too early&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    else do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        let p = VestingParam</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    { beneficiary = pkh</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    , deadline    = d</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    utxos &lt;- utxoAt $ scrAddress p</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if Map.null utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        then logInfo @String $ &quot;no gifts available&quot;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        else do</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            let orefs   = fst &lt;$&gt; Map.toList utxos</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                lookups = Constraints.unspentOutputs utxos      &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                          Constraints.otherScript (validator p)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                tx :: TxConstraints Void Void</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                tx      = mconcat [mustSpendScriptOutput oref $ Redeemer $ PlutusTx.toData () | oref &lt;- orefs] &lt;&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                          mustValidateIn (from now)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            ledgerTx &lt;- submitTxConstraintsWith @Void lookups tx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            void $ awaitTxConfirmed $ txId ledgerTx</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            logInfo @String $ &quot;collected gifts&quot;                          </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>The <code>endpoints</code> function is slightly different due to the new parameter
for <code>grab</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI {.haskell}"><div tabindex="0" class="prism-code language-{.haskell} codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">endpoints :: Contract () VestingSchema Text ()</span></div><div class="token-line" style="color:#393A34"><span class="token plain">endpoints = (give&#x27; `select` grab&#x27;) &gt;&gt; endpoints</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  where</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    give&#x27; = endpoint @&quot;give&quot; &gt;&gt;= give</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    grab&#x27; = endpoint @&quot;grab&quot; &gt;&gt;= grab</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="back-to-the-playground"></a>Back to the playground<a class="hash-link" href="#back-to-the-playground" title="Direct link to heading">#</a></h3><p>We will now copy and paste this new contract into the playground and
setup a new scenario.</p><p>The <code>give</code> transactions are the same.</p><p><img src="/assets/images/pic__00059-7f45bb1aa7d141818049b51dd65f2e37.png"></p><p>The <code>grab</code> is slightly different. In our earlier implementation, one
wallet could grab UTxOs with different deadlines provided that the
deadlines had passed. Now the deadline is part of the script parameter,
so we need to specify it in order to get the script address. This means
that Wallet 2 cannot grab the gifts for slots 10 and 20 at the same
time, at least not in the way that we have implemented it.</p><p>First we can wait until slot 10 and then Wallet 2 should be able to grab
its first gift and Wallet 3 should be able to claim its single gift.</p><p>We\&#x27;ll add a <code>grab</code> for Wallets 2 and 3. Here, we don\&#x27;t need to wain in
between each transaction because it is two different wallets.</p><p>We then wait until slot 20 and perform Wallet 2\&#x27;s second <code>grab</code> and
then wait for 1 block, as usual.</p><p><img src="/assets/images/pic__00060-1d269ec56accfe952503077c80c645d2.png"></p><p>So let\&#x27;s see if it works by clicking <code>Evaluate</code>.</p><p><img src="/assets/images/pic__00061-34ad2459354578430639958932e6ab4e.png"></p><p>Take note of the script address for that transaction out at slot 1.</p><p><img src="/assets/images/pic__00062-e875c97dd2255764dd0f1526e5f9922a.png"></p><p>And compare this with the script address for the transaction output at
slot 2.</p><p><img src="/assets/images/pic__00063-3044e6b470677ac95cdbeeee08d43c7d.png"></p><p>Notice that the script address for the UTxOs is different. In our first
version of the vesting contract, the script address was a constant. This
meant that all our gifts ended up at the same script address and only
the datum in each UTxO was different.</p><p>Now, the datum is just <code>()</code> and the beneficiary and the deadline are
included as part of the script itself, so the addresses are now
different depending on the beneficiary and deadline parameters.</p><p>For the gift to Wallet 3 we see yet another address.</p><p><img src="/assets/images/pic__00064-a48c950dd5dece774d65874dc96f8994.png"></p><p>We see two grabs in slot 10, one by Wallets 2 and one by Wallet 3. The
order in which they are processed is not deterministic.</p><p>Then, finally in slot 20, Wallet 2 grabs its remaining gift.</p><p>And the final balances reflect the transactions that have occurred.</p><p><img src="/assets/images/pic__00065-00802007ba5f1b30c6122d3f2985f8fa.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/cardano2vn/cardanovn-portal/edit/main/docs/dr-lars-lession/week3.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/dr-lars-lession/week2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Week 02 - Validation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/dr-lars-lession/week4"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Week 04 - Monads Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#trÆ°á»›c-khi-chÃºng-ta-báº¯t-Ä‘áº§u" class="table-of-contents__link">TrÆ°á»›c khi chÃºng ta báº¯t Ä‘áº§u</a></li><li><a href="#tÃ³m-táº¯t-láº¡i" class="table-of-contents__link">TÃ³m táº¯t láº¡i</a></li><li><a href="#scriptcontext" class="table-of-contents__link">ScriptContext</a><ul><li><a href="#txinfovalidrange" class="table-of-contents__link">txInfoValidRange</a></li><li><a href="#posixtimerange" class="table-of-contents__link">POSIXTimeRange</a></li></ul></li><li><a href="#example---vesting" class="table-of-contents__link">Example - Vesting</a><ul><li><a href="#in-the-playground" class="table-of-contents__link">In the playground</a></li></ul></li><li><a href="#example-2---parameterized-contract" class="table-of-contents__link">Example 2 - Parameterized Contract</a><ul><li><a href="#on-chain" class="table-of-contents__link">On-Chain</a></li><li><a href="#off-chain" class="table-of-contents__link">Off-Chain</a></li><li><a href="#back-to-the-playground" class="table-of-contents__link">Back to the playground</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">TÃ i liá»‡u</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/overview">Báº¯t Ä‘áº§u</a></li></ul></div><div class="col footer__col"><div class="footer__title">Cá»™ng Ä‘á»“ng</div><ul class="footer__items"><li class="footer__item"><a href="https://t.me/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCJTdAQPGJntJet5v-nk9ebA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://github.com/cardano2vn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about-us">About Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 cardano2vn.io,. Break the blocks</div></div></div></footer></div>
<script src="/assets/js/runtime~main.00983322.js"></script>
<script src="/assets/js/main.349a1baa.js"></script>
</body>
</html>